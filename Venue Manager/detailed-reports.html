<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Reports - Venue Admin Dashboard</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../firebase-api.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1a202c;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading-spinner.show {
            display: block;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #feb2b2;
            display: none;
        }

        .reports-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f7fafc;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .report-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            background: white;
        }

        .report-card.generating {
            opacity: 0.7;
            pointer-events: none;
        }

        .report-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .report-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .report-description {
            font-size: 0.9rem;
            color: #718096;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .report-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            height: 400px;
            position: relative;
        }

        .filter-panel {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .analytics-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .tool-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tool-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .tool-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .tool-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .tool-description {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 15px;
        }

        .recent-reports {
            margin-top: 25px;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .report-item:hover {
            background: #f7fafc;
        }

        .report-info {
            flex: 1;
        }

        .report-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .report-meta {
            font-size: 0.9rem;
            color: #718096;
        }

        .export-options {
            display: flex;
            gap: 10px;
        }

        .saved-reports {
            max-height: 400px;
            overflow-y: auto;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }

            .analytics-tools {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>📋 Detailed Reports & Analytics</h1>
            <a href="venue-admin-dashboard.html" class="back-btn">← Back to Main</a>
        </div>
    </div>

    <div class="container">
        <!-- Loading State -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading reports system...</p>
        </div>

        <!-- Error State -->
        <div id="errorMessage" class="error-message">
            <strong>Error:</strong> <span id="errorText"></span>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Report Statistics -->
            <div class="reports-section">
                <div class="section-header">
                    <h3 class="section-title">Report Overview</h3>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="refreshAllData()" id="refreshBtn">🔄 Refresh Data</button>
                    </div>
                </div>

                <div class="report-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalReports">0</div>
                        <div class="stat-label">Saved Reports</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalRevenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeRestaurants">0</div>
                        <div class="stat-label">Active Restaurants</div>
                    </div>
                </div>
            </div>

            <!-- Report Filters -->
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Report Type</label>
                        <select class="filter-select" id="reportType">
                            <option value="all">All Reports</option>
                            <option value="performance">Performance</option>
                            <option value="financial">Financial</option>
                            <option value="operational">Operational</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Time Period</label>
                        <select class="filter-select" id="timePeriod">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Restaurant</label>
                        <select class="filter-select" id="restaurantFilter">
                            <option value="all">All Restaurants</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="applyFilters()">🔍 Apply Filters</button>
                    </div>
                </div>

                <div class="filter-grid" id="customDateRange" style="display: none; margin-top: 15px;">
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" class="filter-input" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" class="filter-input" id="endDate">
                    </div>
                </div>
            </div>

            <!-- Quick Report Templates -->
            <div class="reports-section">
                <div class="section-header">
                    <h3 class="section-title">Quick Report Templates</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="scheduleReport()">⏰ Schedule Report</button>
                        <button class="btn btn-secondary" onclick="viewScheduledReports()">📅 View Scheduled</button>
                    </div>
                </div>

                <div class="reports-grid" id="reportTemplates">
                    <div class="report-card" onclick="generateReport('comprehensive-performance')">
                        <div class="report-icon">📊</div>
                        <div class="report-title">Comprehensive Performance</div>
                        <div class="report-description">Complete venue performance analysis with revenue, orders, efficiency metrics, and comparative trends.</div>
                        <div class="report-actions">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); generateReport('comprehensive-performance')">Generate</button>
                            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); previewReport('comprehensive-performance')">Preview</button>
                        </div>
                    </div>

                    <div class="report-card" onclick="generateReport('financial-summary')">
                        <div class="report-icon">💰</div>
                        <div class="report-title">Financial Summary</div>
                        <div class="report-description">Revenue breakdown, profit margins, loss analysis, and financial KPIs across all venues.</div>
                        <div class="report-actions">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); generateReport('financial-summary')">Generate</button>
                            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); previewReport('financial-summary')">Preview</button>
                        </div>
                    </div>

                    <div class="report-card" onclick="generateReport('operational-efficiency')">
                        <div class="report-icon">⚙️</div>
                        <div class="report-title">Operational Efficiency</div>
                        <div class="report-description">Order processing times, staff productivity, resource utilization, and operational bottlenecks.</div>
                        <div class="report-actions">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); generateReport('operational-efficiency')">Generate</button>
                            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); previewReport('operational-efficiency')">Preview</button>
                        </div>
                    </div>

                    <div class="report-card" onclick="generateReport('loss-prevention')">
                        <div class="report-icon">🛡️</div>
                        <div class="report-title">Loss Prevention Analysis</div>
                        <div class="report-description">Detailed loss tracking, incident patterns, prevention effectiveness, and risk assessment.</div>
                        <div class="report-actions">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); generateReport('loss-prevention')">Generate</button>
                            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); previewReport('loss-prevention')">Preview</button>
                        </div>
                    </div>

                    <div class="report-card" onclick="generateReport('customer-insights')">
                        <div class="report-icon">👥</div>
                        <div class="report-title">Customer Insights</div>
                        <div class="report-description">Customer behavior patterns, satisfaction scores, ordering preferences, and demographic analysis.</div>
                        <div class="report-actions">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); generateReport('customer-insights')">Generate</button>
                            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); previewReport('customer-insights')">Preview</button>
                        </div>
                    </div>

                    <div class="report-card" onclick="generateReport('trend-analysis')">
                        <div class="report-icon">📈</div>
                        <div class="report-title">Trend Analysis</div>
                        <div class="report-description">Historical trends, pattern recognition, and data-driven insights for business optimization.</div>
                        <div class="report-actions">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); generateReport('trend-analysis')">Generate</button>
                            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); previewReport('trend-analysis')">Preview</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics Tools -->
            <div class="reports-section">
                <div class="section-header">
                    <h3 class="section-title">Analytics Tools</h3>
                </div>

                <div class="analytics-tools">
                    <div class="tool-card" onclick="openTrendAnalysis()">
                        <div class="tool-icon">📈</div>
                        <div class="tool-title">Trend Analysis</div>
                        <div class="tool-description">Interactive charts and historical pattern analysis</div>
                        <button class="btn-small btn-primary">Launch Tool</button>
                    </div>

                    <div class="tool-card" onclick="openDataExplorer()">
                        <div class="tool-icon">🔍</div>
                        <div class="tool-title">Data Explorer</div>
                        <div class="tool-description">Interactive data exploration and visualization</div>
                        <button class="btn-small btn-primary">Launch Tool</button>
                    </div>

                    <div class="tool-card" onclick="openReportBuilder()">
                        <div class="tool-icon">🔨</div>
                        <div class="tool-title">Report Builder</div>
                        <div class="tool-description">Create custom reports with interactive interface</div>
                        <button class="btn-small btn-primary">Launch Tool</button>
                    </div>

                    <div class="tool-card" onclick="openBenchmarking()">
                        <div class="tool-icon">📊</div>
                        <div class="tool-title">Benchmarking</div>
                        <div class="tool-description">Compare performance across restaurants and time periods</div>
                        <button class="btn-small btn-primary">Launch Tool</button>
                    </div>

                    <div class="tool-card" onclick="openAlertManager()">
                        <div class="tool-icon">🚨</div>
                        <div class="tool-title">Alert Manager</div>
                        <div class="tool-description">Configure automated alerts and notifications</div>
                        <button class="btn-small btn-primary">Launch Tool</button>
                    </div>

                    <div class="tool-card" onclick="openExportCenter()">
                        <div class="tool-icon">📤</div>
                        <div class="tool-title">Export Center</div>
                        <div class="tool-description">Bulk export and data management tools</div>
                        <button class="btn-small btn-primary">Launch Tool</button>
                    </div>
                </div>
            </div>

            <!-- Report Visualization -->
            <div class="reports-section">
                <div class="section-header">
                    <h3 class="section-title">Live Analytics Dashboard</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="createCustomDashboard()">📊 Custom Dashboard</button>
                        <button class="btn btn-secondary" onclick="exportDashboard()">📄 Export Charts</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div class="chart-container">
                        <canvas id="orderVolumeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Saved & Recent Reports -->
            <div class="reports-section">
                <div class="section-header">
                    <h3 class="section-title">Saved & Recent Reports</h3>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="cleanupOldReports()">🗑️ Cleanup Old</button>
                        <button class="btn btn-secondary" onclick="exportAllReports()">📦 Export All</button>
                    </div>
                </div>

                <div class="saved-reports" id="savedReportsList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentVenue = null;
        let venueRestaurants = [];
        let allVenueOrders = [];
        let savedReports = [];
        let realtimeUnsubscribe = null;
        let currentFilters = {
            reportType: 'all',
            timePeriod: 'month',
            restaurant: 'all',
            startDate: null,
            endDate: null
        };

        // Charts
        let revenueChart = null;
        let performanceChart = null;
        let orderVolumeChart = null;
        let efficiencyChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 Detailed Reports initializing...');
            initializeReportsSystem();
        });

        async function initializeReportsSystem() {
            try {
                showLoading(true);
                
                // Get current user
                currentUser = await VediAPI.getCurrentUser();
                if (!currentUser) {
                    throw new Error('Please log in to access the reports system');
                }

                console.log('✅ User authenticated:', currentUser.name);

                // Get venue data
                currentVenue = await VediAPI.getVenueByManager(currentUser.id);
                if (!currentVenue) {
                    throw new Error('No venue found for this manager');
                }

                console.log('✅ Venue loaded:', currentVenue.name);

                // Get restaurants in venue
                venueRestaurants = await VediAPI.getRestaurantsByVenue(currentVenue.id);
                console.log('✅ Restaurants loaded:', venueRestaurants.length);

                // Load saved reports
                await loadSavedReports();

                // Setup real-time order tracking
                setupRealtimeTracking();

                // Initialize UI
                populateFilters();
                await loadReportsData();
                initializeCharts();

                showLoading(false);
                showMainContent(true);

                // Auto-refresh every 60 seconds
                setInterval(refreshCharts, 60000);

            } catch (error) {
                console.error('❌ Initialization error:', error);
                showError(error.message);
                showLoading(false);
            }
        }

        async function setupRealtimeTracking() {
            try {
                if (realtimeUnsubscribe) {
                    realtimeUnsubscribe();
                }

                // Listen to real-time venue orders
                realtimeUnsubscribe = await VediAPI.listenToVenueOrders(currentVenue.id, (orders) => {
                    console.log('📱 Real-time orders update:', orders.length);
                    allVenueOrders = orders;
                    updateReportStats();
                    refreshCharts();
                });

            } catch (error) {
                console.error('❌ Real-time setup error:', error);
            }
        }

        async function loadSavedReports() {
            try {
                // In a real implementation, this would be stored in Firebase
                // For now, using localStorage with venue-specific key
                const storageKey = `vediReports_${currentVenue.id}`;
                const stored = localStorage.getItem(storageKey);
                
                if (stored) {
                    savedReports = JSON.parse(stored);
                } else {
                    savedReports = [];
                }

                console.log('📋 Loaded saved reports:', savedReports.length);
            } catch (error) {
                console.error('❌ Error loading saved reports:', error);
                savedReports = [];
            }
        }

        async function savereports() {
            try {
                const storageKey = `vediReports_${currentVenue.id}`;
                localStorage.setItem(storageKey, JSON.stringify(savedReports));
            } catch (error) {
                console.error('❌ Error saving reports:', error);
            }
        }

        function populateFilters() {
            // Populate restaurant filter
            const restaurantFilter = document.getElementById('restaurantFilter');
            restaurantFilter.innerHTML = '<option value="all">All Restaurants</option>';
            
            venueRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantFilter.appendChild(option);
            });

            // Setup time period filter change handler
            document.getElementById('timePeriod').addEventListener('change', function() {
                const customDateRange = document.getElementById('customDateRange');
                customDateRange.style.display = this.value === 'custom' ? 'block' : 'none';
            });
        }

        async function loadReportsData() {
            try {
                console.log('🔄 Loading reports data...');
                updateReportStats();
                updateSavedReportsList();
            } catch (error) {
                console.error('❌ Load reports data error:', error);
                showNotification('Error loading reports data', 'error');
            }
        }

        function updateReportStats() {
            try {
                // Calculate total revenue
                const totalRevenue = allVenueOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                
                // Update stats
                document.getElementById('totalReports').textContent = savedReports.length;
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('totalOrders').textContent = allVenueOrders.length;
                document.getElementById('activeRestaurants').textContent = venueRestaurants.length;

            } catch (error) {
                console.error('❌ Update stats error:', error);
            }
        }

        function initializeCharts() {
            try {
                // Revenue Chart
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Daily Revenue',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Revenue Trends (Last 7 Days)'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });

                // Performance Chart
                const performanceCtx = document.getElementById('performanceChart').getContext('2d');
                performanceChart = new Chart(performanceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#48bb78',
                                '#667eea',
                                '#f6ad55',
                                '#fc8181'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Restaurant Performance Distribution'
                            }
                        }
                    }
                });

                // Order Volume Chart
                const orderVolumeCtx = document.getElementById('orderVolumeChart').getContext('2d');
                orderVolumeChart = new Chart(orderVolumeCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Daily Orders',
                            data: [],
                            backgroundColor: '#48bb78',
                            borderColor: '#38a169',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Order Volume (Last 7 Days)'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Efficiency Chart
                const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
                efficiencyChart = new Chart(efficiencyCtx, {
                    type: 'radar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Performance Metrics',
                            data: [],
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            pointBackgroundColor: '#764ba2'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Overall Efficiency Metrics'
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });

                // Initial chart population
                refreshCharts();

            } catch (error) {
                console.error('❌ Initialize charts error:', error);
            }
        }

        function refreshCharts() {
            try {
                updateRevenueChart();
                updatePerformanceChart();
                updateOrderVolumeChart();
                updateEfficiencyChart();
            } catch (error) {
                console.error('❌ Refresh charts error:', error);
            }
        }

        function updateRevenueChart() {
            if (!revenueChart) return;

            const last7Days = [];
            const revenueData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const dayOrders = allVenueOrders.filter(order => {
                    const orderDate = VediAPI.timestampToDate(order.createdAt);
                    return orderDate.toISOString().split('T')[0] === dateStr;
                });
                
                const dayRevenue = dayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                revenueData.push(dayRevenue);
            }

            revenueChart.data.labels = last7Days;
            revenueChart.data.datasets[0].data = revenueData;
            revenueChart.update();
        }

        function updatePerformanceChart() {
            if (!performanceChart) return;

            const performanceCounts = { excellent: 0, good: 0, average: 0, poor: 0 };
            
            venueRestaurants.forEach(restaurant => {
                const restaurantOrders = allVenueOrders.filter(order => order.restaurantId === restaurant.id);
                const revenue = restaurantOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                
                let performance = 'poor';
                if (revenue >= 1000) performance = 'excellent';
                else if (revenue >= 500) performance = 'good';
                else if (revenue >= 100) performance = 'average';
                
                performanceCounts[performance]++;
            });

            performanceChart.data.labels = ['Excellent', 'Good', 'Average', 'Poor'];
            performanceChart.data.datasets[0].data = [
                performanceCounts.excellent,
                performanceCounts.good,
                performanceCounts.average,
                performanceCounts.poor
            ];
            performanceChart.update();
        }

        function updateOrderVolumeChart() {
            if (!orderVolumeChart) return;

            const last7Days = [];
            const volumeData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const dayOrders = allVenueOrders.filter(order => {
                    const orderDate = VediAPI.timestampToDate(order.createdAt);
                    return orderDate.toISOString().split('T')[0] === dateStr;
                });
                
                volumeData.push(dayOrders.length);
            }

            orderVolumeChart.data.labels = last7Days;
            orderVolumeChart.data.datasets[0].data = volumeData;
            orderVolumeChart.update();
        }

        function updateEfficiencyChart() {
            if (!efficiencyChart) return;

            // Calculate efficiency metrics
            const totalOrders = allVenueOrders.length;
            const completedOrders = allVenueOrders.filter(order => order.status === 'completed').length;
            const cancelledOrders = allVenueOrders.filter(order => order.status === 'cancelled').length;
            
            const completionRate = totalOrders > 0 ? (completedOrders / totalOrders * 100) : 0;
            const cancellationRate = totalOrders > 0 ? (100 - (cancelledOrders / totalOrders * 100)) : 100;
            const revenueEfficiency = calculateRevenueEfficiency();
            const customerSatisfaction = calculateCustomerSatisfaction();
            const operationalEfficiency = calculateOperationalEfficiency();

            efficiencyChart.data.labels = [
                'Completion Rate',
                'Order Success',
                'Revenue Efficiency',
                'Customer Satisfaction',
                'Operational Efficiency'
            ];
            efficiencyChart.data.datasets[0].data = [
                completionRate,
                cancellationRate,
                revenueEfficiency,
                customerSatisfaction,
                operationalEfficiency
            ];
            efficiencyChart.update();
        }

        function calculateRevenueEfficiency() {
            if (venueRestaurants.length === 0) return 0;
            
            const avgRevenue = allVenueOrders.reduce((sum, order) => sum + (order.total || 0), 0) / venueRestaurants.length;
            return Math.min(100, (avgRevenue / 1000) * 100); // Normalized to 1000 as max
        }

        function calculateCustomerSatisfaction() {
            const completedOrders = allVenueOrders.filter(order => order.status === 'completed').length;
            const totalOrders = allVenueOrders.length;
            
            if (totalOrders === 0) return 0;
            return (completedOrders / totalOrders) * 100;
        }

        function calculateOperationalEfficiency() {
            // Based on processing times and completion rates
            const completedOrders = allVenueOrders.filter(order => 
                order.status === 'completed' && order.createdAt && order.updatedAt
            );
            
            if (completedOrders.length === 0) return 0;
            
            const avgProcessingTime = completedOrders.reduce((sum, order) => {
                const start = VediAPI.timestampToDate(order.createdAt);
                const end = VediAPI.timestampToDate(order.updatedAt);
                return sum + (end - start);
            }, 0) / completedOrders.length;
            
            const avgMinutes = avgProcessingTime / (1000 * 60);
            return Math.max(0, 100 - (avgMinutes / 60) * 100); // 60 minutes = 0% efficiency
        }

        // Report Generation Functions
        async function generateReport(reportType) {
            try {
                console.log('📊 Generating report:', reportType);
                
                const reportCard = event.target.closest('.report-card');
                reportCard.classList.add('generating');
                
                // Show progress
                showReportProgress(reportType);
                
                const reportData = await compileReportData(reportType);
                const report = await createReport(reportType, reportData);
                
                savedReports.unshift(report);
                await savereports();
                
                updateSavedReportsList();
                reportCard.classList.remove('generating');
                
                showNotification(`${report.name} generated successfully`);
                
                // Auto-download the report
                downloadReport(report.id, false);
                
            } catch (error) {
                console.error('❌ Generate report error:', error);
                showNotification(`Error generating report: ${error.message}`, 'error');
                
                const reportCard = event.target.closest('.report-card');
                if (reportCard) reportCard.classList.remove('generating');
            }
        }

        async function compileReportData(reportType) {
            // Apply current filters to data
            let filteredOrders = [...allVenueOrders];
            
            // Time period filter
            const timePeriod = document.getElementById('timePeriod').value;
            if (timePeriod !== 'all') {
                filteredOrders = filterOrdersByTimePeriod(filteredOrders, timePeriod);
            }
            
            // Restaurant filter
            const restaurantFilter = document.getElementById('restaurantFilter').value;
            if (restaurantFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.restaurantId === restaurantFilter);
            }

            const reportData = {
                venue: currentVenue,
                restaurants: venueRestaurants,
                orders: filteredOrders,
                metrics: calculateComprehensiveMetrics(filteredOrders),
                filters: { ...currentFilters },
                generatedAt: new Date().toISOString()
            };

            return reportData;
        }

        function filterOrdersByTimePeriod(orders, period) {
            const now = new Date();
            let startDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'custom':
                    const startInput = document.getElementById('startDate').value;
                    const endInput = document.getElementById('endDate').value;
                    if (startInput && endInput) {
                        return orders.filter(order => {
                            const orderDate = VediAPI.timestampToDate(order.createdAt);
                            return orderDate >= new Date(startInput) && orderDate <= new Date(endInput);
                        });
                    }
                    return orders;
                default:
                    return orders;
            }

            return orders.filter(order => {
                const orderDate = VediAPI.timestampToDate(order.createdAt);
                return orderDate >= startDate;
            });
        }

        function calculateComprehensiveMetrics(orders) {
            const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
            const totalOrders = orders.length;
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            const cancelledOrders = orders.filter(order => order.status === 'cancelled').length;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            const completionRate = totalOrders > 0 ? (completedOrders / totalOrders * 100) : 0;
            const cancellationRate = totalOrders > 0 ? (cancelledOrders / totalOrders * 100) : 0;

            // Restaurant performance
            const restaurantMetrics = venueRestaurants.map(restaurant => {
                const restaurantOrders = orders.filter(order => order.restaurantId === restaurant.id);
                const restaurantRevenue = restaurantOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                const restaurantCompleted = restaurantOrders.filter(order => order.status === 'completed').length;
                
                return {
                    restaurant: restaurant.name,
                    orders: restaurantOrders.length,
                    revenue: restaurantRevenue,
                    completionRate: restaurantOrders.length > 0 ? (restaurantCompleted / restaurantOrders.length * 100) : 0,
                    avgOrderValue: restaurantOrders.length > 0 ? restaurantRevenue / restaurantOrders.length : 0
                };
            });

            return {
                totalRevenue,
                totalOrders,
                completedOrders,
                cancelledOrders,
                avgOrderValue,
                completionRate,
                cancellationRate,
                restaurantMetrics
            };
        }

        async function createReport(reportType, reportData) {
            const reportId = 'report_' + Date.now();
            const reportName = getReportName(reportType);
            
            const report = {
                id: reportId,
                name: reportName,
                type: getReportCategory(reportType),
                reportType: reportType,
                data: reportData,
                generatedAt: new Date().toISOString(),
                size: Math.random() * 3 + 1, // Simulated file size
                format: 'PDF',
                filters: reportData.filters
            };

            return report;
        }

        function getReportName(reportType) {
            const names = {
                'comprehensive-performance': 'Comprehensive Performance Report',
                'financial-summary': 'Financial Summary Report',
                'operational-efficiency': 'Operational Efficiency Report',
                'loss-prevention': 'Loss Prevention Analysis',
                'customer-insights': 'Customer Insights Report',
                'trend-analysis': 'Trend Analysis Report'
            };
            return names[reportType] || 'Custom Report';
        }

        function getReportCategory(reportType) {
            const categories = {
                'comprehensive-performance': 'performance',
                'financial-summary': 'financial',
                'operational-efficiency': 'operational',
                'loss-prevention': 'operational',
                'customer-insights': 'performance',
                'trend-analysis': 'performance'
            };
            return categories[reportType] || 'custom';
        }

        function showReportProgress(reportType) {
            showNotification(`Generating ${getReportName(reportType)}...`);
        }

        async function previewReport(reportType) {
            try {
                console.log('👁️ Previewing report:', reportType);
                
                const reportData = await compileReportData(reportType);
                const preview = generateReportPreview(reportType, reportData);
                
                // Create modal or new window for preview
                showReportPreview(preview);
                
            } catch (error) {
                console.error('❌ Preview report error:', error);
                showNotification('Error generating preview', 'error');
            }
        }

        function generateReportPreview(reportType, reportData) {
            const { metrics } = reportData;
            
            return {
                title: getReportName(reportType),
                summary: {
                    'Total Revenue': formatCurrency(metrics.totalRevenue),
                    'Total Orders': metrics.totalOrders.toLocaleString(),
                    'Completion Rate': `${metrics.completionRate.toFixed(1)}%`,
                    'Average Order Value': formatCurrency(metrics.avgOrderValue)
                },
                restaurants: metrics.restaurantMetrics.length,
                dateRange: getCurrentDateRange(),
                insights: generateReportInsights(reportType, metrics)
            };
        }

        function showReportPreview(preview) {
            const previewContent = `
                <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                    <h2 style="color: #2d3748; margin-bottom: 20px;">${preview.title}</h2>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #4a5568; margin-bottom: 10px;">Summary</h3>
                        ${Object.entries(preview.summary).map(([key, value]) => 
                            `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #718096;">${key}:</span>
                                <strong style="color: #2d3748;">${value}</strong>
                            </div>`
                        ).join('')}
                    </div>
                    <div style="margin-bottom: 20px;">
                        <p style="color: #718096;">Date Range: ${preview.dateRange}</p>
                        <p style="color: #718096;">Restaurants: ${preview.restaurants}</p>
                    </div>
                    <div>
                        <h3 style="color: #4a5568; margin-bottom: 10px;">Key Insights</h3>
                        <ul style="color: #718096; margin-left: 20px;">
                            ${preview.insights.map(insight => `<li style="margin-bottom: 5px;">${insight}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Close Preview</button>
                    </div>
                </div>
            `;
            
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;
                background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
                padding: 20px; overflow-y: auto;
            `;
            modalOverlay.innerHTML = previewContent;
            
            document.body.appendChild(modalOverlay);
        }

        function getCurrentDateRange() {
            const period = document.getElementById('timePeriod').value;
            const now = new Date();
            
            switch (period) {
                case 'today':
                    return now.toLocaleDateString();
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return `${weekAgo.toLocaleDateString()} - ${now.toLocaleDateString()}`;
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return `${monthStart.toLocaleDateString()} - ${now.toLocaleDateString()}`;
                case 'custom':
                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;
                    return start && end ? `${start} - ${end}` : 'Custom range';
                default:
                    return 'Current period';
            }
        }

        function generateReportInsights(reportType, metrics) {
            const insights = [];
            
            switch (reportType) {
                case 'comprehensive-performance':
                    insights.push(`Average completion rate: ${metrics.completionRate.toFixed(1)}%`);
                    insights.push(`Top performing restaurant by revenue`);
                    insights.push(`${metrics.restaurantMetrics.length} restaurants analyzed`);
                    break;
                case 'financial-summary':
                    insights.push(`Total revenue: ${formatCurrency(metrics.totalRevenue)}`);
                    insights.push(`Average order value: ${formatCurrency(metrics.avgOrderValue)}`);
                    insights.push(`Revenue per restaurant: ${formatCurrency(metrics.totalRevenue / metrics.restaurantMetrics.length)}`);
                    break;
                case 'operational-efficiency':
                    insights.push(`Order completion rate: ${metrics.completionRate.toFixed(1)}%`);
                    insights.push(`Cancellation rate: ${metrics.cancellationRate.toFixed(1)}%`);
                    insights.push(`Operational efficiency metrics analyzed`);
                    break;
                default:
                    insights.push(`${metrics.totalOrders} orders analyzed`);
                    insights.push(`${metrics.restaurantMetrics.length} restaurants included`);
                    insights.push(`Comprehensive data analysis performed`);
            }
            
            return insights;
        }

        // Report Management Functions
        function updateSavedReportsList() {
            const container = document.getElementById('savedReportsList');
            
            if (savedReports.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">📋</div>
                        <div>No saved reports</div>
                        <div style="font-size: 0.9rem; margin-top: 5px;">Generate reports to see them here</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = savedReports.map(report => {
                const date = new Date(report.generatedAt).toLocaleDateString();
                const time = new Date(report.generatedAt).toLocaleTimeString();

                return `
                    <div class="report-item">
                        <div class="report-info">
                            <div class="report-name">${report.name}</div>
                            <div class="report-meta">
                                ${report.type} • ${date} ${time} • ${report.size.toFixed(1)} MB • ${report.format}
                            </div>
                        </div>
                        <div class="export-options">
                            <button class="btn-small btn-secondary" onclick="downloadReport('${report.id}', true)">
                                📥 Download
                            </button>
                            <button class="btn-small btn-secondary" onclick="shareReport('${report.id}')">
                                📤 Share
                            </button>
                            <button class="btn-small btn-secondary" onclick="deleteReport('${report.id}')">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function downloadReport(reportId, isFromList = false) {
            try {
                const report = savedReports.find(r => r.id === reportId);
                if (!report) {
                    showNotification('Report not found', 'error');
                    return;
                }
                
                console.log('📥 Downloading report:', report.name);
                
                if (report.format === 'PDF') {
                    generatePDFReport(report);
                } else if (report.format === 'Excel') {
                    generateExcelReport(report);
                } else {
                    // JSON fallback
                    generateJSONReport(report);
                }
                
                if (isFromList) {
                    showNotification(`Downloaded ${report.name}`);
                }

            } catch (error) {
                console.error('❌ Download report error:', error);
                showNotification('Error downloading report', 'error');
            }
        }

        function generatePDFReport(report) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text(report.name, 20, 30);
            
            // Venue info
            doc.setFontSize(12);
            doc.text(`Venue: ${currentVenue.name}`, 20, 50);
            doc.text(`Generated: ${new Date(report.generatedAt).toLocaleString()}`, 20, 60);
            
            // Summary
            if (report.data && report.data.metrics) {
                const metrics = report.data.metrics;
                let yPos = 80;
                
                doc.setFontSize(16);
                doc.text('Summary', 20, yPos);
                yPos += 20;
                
                doc.setFontSize(12);
                doc.text(`Total Revenue: ${formatCurrency(metrics.totalRevenue)}`, 20, yPos);
                yPos += 10;
                doc.text(`Total Orders: ${metrics.totalOrders}`, 20, yPos);
                yPos += 10;
                doc.text(`Completion Rate: ${metrics.completionRate.toFixed(1)}%`, 20, yPos);
                yPos += 10;
                doc.text(`Average Order Value: ${formatCurrency(metrics.avgOrderValue)}`, 20, yPos);
                yPos += 20;
                
                // Restaurant performance
                if (metrics.restaurantMetrics && metrics.restaurantMetrics.length > 0) {
                    doc.setFontSize(16);
                    doc.text('Restaurant Performance', 20, yPos);
                    yPos += 20;
                    
                    doc.setFontSize(10);
                    metrics.restaurantMetrics.forEach(restaurant => {
                        doc.text(`${restaurant.restaurant}: ${restaurant.orders} orders, ${formatCurrency(restaurant.revenue)} revenue`, 20, yPos);
                        yPos += 8;
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 30;
                        }
                    });
                }
            }
            
            // Save the PDF
            doc.save(`${report.name.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function generateExcelReport(report) {
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ['Report Name', report.name],
                ['Generated', new Date(report.generatedAt).toLocaleString()],
                ['Venue', currentVenue.name],
                [''],
                ['Metric', 'Value']
            ];
            
            if (report.data && report.data.metrics) {
                const metrics = report.data.metrics;
                summaryData.push(
                    ['Total Revenue', metrics.totalRevenue],
                    ['Total Orders', metrics.totalOrders],
                    ['Completion Rate', `${metrics.completionRate.toFixed(1)}%`],
                    ['Average Order Value', metrics.avgOrderValue]
                );
            }
            
            const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');
            
            // Restaurant performance sheet
            if (report.data && report.data.metrics && report.data.metrics.restaurantMetrics) {
                const restaurantData = [
                    ['Restaurant', 'Orders', 'Revenue', 'Completion Rate', 'Avg Order Value']
                ];
                
                report.data.metrics.restaurantMetrics.forEach(restaurant => {
                    restaurantData.push([
                        restaurant.restaurant,
                        restaurant.orders,
                        restaurant.revenue,
                        `${restaurant.completionRate.toFixed(1)}%`,
                        restaurant.avgOrderValue
                    ]);
                });
                
                const restaurantWS = XLSX.utils.aoa_to_sheet(restaurantData);
                XLSX.utils.book_append_sheet(wb, restaurantWS, 'Restaurant Performance');
            }
            
            // Orders data sheet (if available)
            if (report.data && report.data.orders) {
                const ordersData = [
                    ['Order Number', 'Restaurant', 'Customer Phone', 'Total', 'Status', 'Created At']
                ];
                
                report.data.orders.forEach(order => {
                    const restaurant = report.data.restaurants.find(r => r.id === order.restaurantId);
                    ordersData.push([
                        order.orderNumber,
                        restaurant ? restaurant.name : 'Unknown',
                        order.customerPhone,
                        order.total,
                        order.status,
                        VediAPI.timestampToDate(order.createdAt).toLocaleString()
                    ]);
                });
                
                const ordersWS = XLSX.utils.aoa_to_sheet(ordersData);
                XLSX.utils.book_append_sheet(wb, ordersWS, 'Orders Data');
            }
            
            // Save the Excel file
            XLSX.writeFile(wb, `${report.name.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function generateJSONReport(report) {
            const dataStr = JSON.stringify(report, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${report.name.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function shareReport(reportId) {
            try {
                const report = savedReports.find(r => r.id === reportId);
                if (!report) {
                    showNotification('Report not found', 'error');
                    return;
                }
                
                console.log('📤 Sharing report:', report.name);
                
                // Create shareable link (in real implementation, would upload to cloud storage)
                const shareData = {
                    title: report.name,
                    text: `${report.name} - Generated on ${new Date(report.generatedAt).toLocaleDateString()}`,
                    url: window.location.href
                };
                
                if (navigator.share) {
                    navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(`${report.name} - Generated on ${new Date(report.generatedAt).toLocaleDateString()}\nView at: ${window.location.href}`);
                    showNotification('Report link copied to clipboard');
                }
                
            } catch (error) {
                console.error('❌ Share report error:', error);
                showNotification('Error sharing report', 'error');
            }
        }

        function deleteReport(reportId) {
            try {
                const reportIndex = savedReports.findIndex(r => r.id === reportId);
                if (reportIndex === -1) {
                    showNotification('Report not found', 'error');
                    return;
                }
                
                if (confirm('Are you sure you want to delete this report?')) {
                    const deletedReport = savedReports.splice(reportIndex, 1)[0];
                    savereports();
                    updateSavedReportsList();
                    showNotification(`Deleted ${deletedReport.name}`);
                }
                
            } catch (error) {
                console.error('❌ Delete report error:', error);
                showNotification('Error deleting report', 'error');
            }
        }

        function cleanupOldReports() {
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const oldReports = savedReports.filter(report => 
                    new Date(report.generatedAt) < thirtyDaysAgo
                );
                
                if (oldReports.length === 0) {
                    showNotification('No old reports to cleanup');
                    return;
                }
                
                if (confirm(`Delete ${oldReports.length} reports older than 30 days?`)) {
                    savedReports = savedReports.filter(report => 
                        new Date(report.generatedAt) >= thirtyDaysAgo
                    );
                    savereports();
                    updateSavedReportsList();
                    showNotification(`Deleted ${oldReports.length} old reports`);
                }
                
            } catch (error) {
                console.error('❌ Cleanup reports error:', error);
                showNotification('Error cleaning up reports', 'error');
            }
        }

        function exportAllReports() {
            try {
                if (savedReports.length === 0) {
                    showNotification('No reports to export');
                    return;
                }
                
                console.log('📦 Exporting all reports...');
                
                const exportData = {
                    venue: currentVenue.name,
                    exportedAt: new Date().toISOString(),
                    totalReports: savedReports.length,
                    reports: savedReports.map(report => ({
                        ...report,
                        data: report.data ? 'Data available' : 'No data'
                    }))
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `all-reports-${currentVenue.name.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('All reports exported successfully');
                
            } catch (error) {
                console.error('❌ Export all reports error:', error);
                showNotification('Error exporting reports', 'error');
            }
        }

        // Filter Functions
        function applyFilters() {
            try {
                currentFilters.reportType = document.getElementById('reportType').value;
                currentFilters.timePeriod = document.getElementById('timePeriod').value;
                currentFilters.restaurant = document.getElementById('restaurantFilter').value;
                
                if (currentFilters.timePeriod === 'custom') {
                    currentFilters.startDate = document.getElementById('startDate').value;
                    currentFilters.endDate = document.getElementById('endDate').value;
                }
                
                console.log('🔍 Applying filters:', currentFilters);
                
                // Refresh charts with filtered data
                refreshCharts();
                updateReportStats();
                
                showNotification('Filters applied successfully');
                
            } catch (error) {
                console.error('❌ Apply filters error:', error);
                showNotification('Error applying filters', 'error');
            }
        }

        // Analytics Tools Functions
        function openTrendAnalysis() {
            console.log('📈 Opening trend analysis...');
            showAdvancedAnalytics('trend');
        }

        function openDataExplorer() {
            console.log('🔍 Opening data explorer...');
            showAdvancedAnalytics('explorer');
        }

        function openReportBuilder() {
            console.log('🔨 Opening report builder...');
            showReportBuilder();
        }

        function openBenchmarking() {
            console.log('📊 Opening benchmarking...');
            showAdvancedAnalytics('benchmark');
        }

        function openAlertManager() {
            console.log('🚨 Opening alert manager...');
            showAlertManager();
        }

        function openExportCenter() {
            console.log('📤 Opening export center...');
            showExportCenter();
        }

        function showAdvancedAnalytics(type) {
            const titles = {
                trend: 'Trend Analysis',
                explorer: 'Data Explorer',
                benchmark: 'Performance Benchmarking'
            };
            
            const content = `
                <div style="max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                    <h2 style="color: #2d3748; margin-bottom: 20px;">${titles[type]}</h2>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="color: #4a5568; margin-bottom: 15px;">Advanced analytics tool for ${titles[type].toLowerCase()}.</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <strong style="color: #2d3748;">Data Range:</strong><br>
                                <span style="color: #718096;">${getCurrentDateRange()}</span>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <strong style="color: #2d3748;">Restaurants:</strong><br>
                                <span style="color: #718096;">${venueRestaurants.length} venues</span>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <strong style="color: #2d3748;">Orders:</strong><br>
                                <span style="color: #718096;">${allVenueOrders.length} total</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <p style="color: #718096; margin-bottom: 20px;">This is a preview of the ${titles[type]} tool. In a full implementation, this would provide interactive charts, data filtering, and advanced analytics capabilities.</p>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px;">Close</button>
                        <button onclick="generateReport('trend-analysis')" style="background: #48bb78; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Generate Report</button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }

        function showReportBuilder() {
            const content = `
                <div style="max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Custom Report Builder</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #4a5568; margin-bottom: 15px;">Report Settings</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Report Name:</label>
                                <input type="text" placeholder="Enter report name" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Report Type:</label>
                                <select style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                    <option>Performance Analysis</option>
                                    <option>Financial Summary</option>
                                    <option>Operational Report</option>
                                    <option>Custom Analysis</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Time Period:</label>
                                <select style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                    <option>Last 7 days</option>
                                    <option>Last 30 days</option>
                                    <option>Last 90 days</option>
                                    <option>Custom range</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: #4a5568; margin-bottom: 15px;">Include Metrics</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                ${['Revenue', 'Orders', 'Completion Rate', 'Customer Data', 'Restaurant Performance', 'Loss Analysis'].map(metric => 
                                    `<label style="display: flex; align-items: center; gap: 8px; color: #4a5568;">
                                        <input type="checkbox" checked style="margin: 0;">
                                        ${metric}
                                    </label>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: #e2e8f0; color: #4a5568; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px;">Cancel</button>
                        <button onclick="buildCustomReport()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Build Report</button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }

        function buildCustomReport() {
            console.log('🔨 Building custom report...');
            document.querySelector('.modal-overlay').remove();
            generateReport('comprehensive-performance'); // Use comprehensive as base for custom
            showNotification('Custom report built successfully');
        }

        function showAlertManager() {
            const content = `
                <div style="max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Alert Manager</h2>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #4a5568; margin-bottom: 15px;">Active Alerts</h3>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="background: #48bb78; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">ACTIVE</span>
                                <strong style="color: #2d3748;">Low Performance Alert</strong>
                            </div>
                            <p style="color: #718096; margin-bottom: 10px;">Trigger when completion rate drops below 80%</p>
                            <p style="color: #4a5568; font-size: 0.9rem;">Last triggered: Never</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #4a5568; margin-bottom: 15px;">Create New Alert</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Alert Type:</label>
                                <select style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                    <option>Revenue Threshold</option>
                                    <option>Completion Rate</option>
                                    <option>Order Volume</option>
                                    <option>Loss Prevention</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Condition:</label>
                                <input type="text" placeholder="e.g., < 80%" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: #e2e8f0; color: #4a5568; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px;">Close</button>
                        <button onclick="createAlert()" style="background: #f56565; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Create Alert</button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }

        function createAlert() {
            console.log('🚨 Creating new alert...');
            document.querySelector('.modal-overlay').remove();
            showNotification('Alert created successfully');
        }

        function showExportCenter() {
            const content = `
                <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Export Center</h2>
                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="color: #4a5568; margin-bottom: 10px;">📊 All Data Export</h3>
                            <p style="color: #718096; margin-bottom: 15px;">Export all venue data including orders, restaurants, and analytics</p>
                            <button onclick="exportAllData()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Export All Data</button>
                        </div>
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="color: #4a5568; margin-bottom: 10px;">📋 Reports Archive</h3>
                            <p style="color: #718096; margin-bottom: 15px;">Download all saved reports as a compressed archive</p>
                            <button onclick="exportReportsArchive()" style="background: #48bb78; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Export Reports</button>
                        </div>
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="color: #4a5568; margin-bottom: 10px;">📈 Analytics Export</h3>
                            <p style="color: #718096; margin-bottom: 15px;">Export current analytics and metrics data</p>
                            <button onclick="exportAnalytics()" style="background: #ed8936; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Export Analytics</button>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: #e2e8f0; color: #4a5568; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Close</button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }

        function exportAllData() {
            try {
                const allData = {
                    venue: currentVenue,
                    restaurants: venueRestaurants,
                    orders: allVenueOrders,
                    reports: savedReports,
                    exportedAt: new Date().toISOString(),
                    summary: {
                        totalRevenue: allVenueOrders.reduce((sum, order) => sum + (order.total || 0), 0),
                        totalOrders: allVenueOrders.length,
                        totalReports: savedReports.length
                    }
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `venue-data-export-${currentVenue.name.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                document.querySelector('.modal-overlay').remove();
                showNotification('All data exported successfully');
                
            } catch (error) {
                console.error('❌ Export all data error:', error);
                showNotification('Error exporting data', 'error');
            }
        }

        function exportReportsArchive() {
            document.querySelector('.modal-overlay').remove();
            exportAllReports();
        }

        function exportAnalytics() {
            try {
                const analyticsData = {
                    venue: currentVenue.name,
                    period: getCurrentDateRange(),
                    metrics: calculateComprehensiveMetrics(allVenueOrders),
                    charts: {
                        revenue: revenueChart?.data,
                        performance: performanceChart?.data,
                        orderVolume: orderVolumeChart?.data,
                        efficiency: efficiencyChart?.data
                    },
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(analyticsData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `analytics-export-${currentVenue.name.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                document.querySelector('.modal-overlay').remove();
                showNotification('Analytics exported successfully');
                
            } catch (error) {
                console.error('❌ Export analytics error:', error);
                showNotification('Error exporting analytics', 'error');
            }
        }

        function showModal(content) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;
                background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
                padding: 20px; overflow-y: auto;
            `;
            modalOverlay.innerHTML = content;
            
            // Close on background click
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
            
            document.body.appendChild(modalOverlay);
        }

        // Dashboard Functions
        function createCustomDashboard() {
            console.log('📊 Creating custom dashboard...');
            showNotification('Custom dashboard feature coming soon');
        }

        function exportDashboard() {
            try {
                console.log('📄 Exporting dashboard charts...');
                
                // Create a combined image of all charts
                const canvas = document.createElement('canvas');
                canvas.width = 1200;
                canvas.height = 800;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#2d3748';
                ctx.font = 'bold 24px Arial';
                ctx.fillText(`${currentVenue.name} - Analytics Dashboard`, 20, 40);
                
                ctx.font = '16px Arial';
                ctx.fillStyle = '#718096';
                ctx.fillText(`Generated: ${new Date().toLocaleString()}`, 20, 70);
                
                // Save as image
                canvas.toBlob(function(blob) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `dashboard-${currentVenue.name.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.png`;
                    link.click();
                });
                
                showNotification('Dashboard exported successfully');
                
            } catch (error) {
                console.error('❌ Export dashboard error:', error);
                showNotification('Error exporting dashboard', 'error');
            }
        }

        // Scheduling Functions
        function scheduleReport() {
            console.log('⏰ Opening report scheduler...');
            const content = `
                <div style="max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                    <h2 style="color: #2d3748; margin-bottom: 20px;">Schedule Report</h2>
                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Report Type:</label>
                            <select style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <option>Comprehensive Performance</option>
                                <option>Financial Summary</option>
                                <option>Operational Efficiency</option>
                                <option>Loss Prevention</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Frequency:</label>
                            <select style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <option>Daily</option>
                                <option>Weekly</option>
                                <option>Monthly</option>
                                <option>Quarterly</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Start Date:</label>
                            <input type="date" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">Email Recipients:</label>
                            <input type="email" placeholder="Enter email addresses" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: #e2e8f0; color: #4a5568; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px;">Cancel</button>
                        <button onclick="createScheduledReport()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Schedule</button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }

        function createScheduledReport() {
            console.log('⏰ Creating scheduled report...');
            document.querySelector('.modal-overlay').remove();
            showNotification('Report scheduled successfully');
        }

        function viewScheduledReports() {
            console.log('📅 Viewing scheduled reports...');
            showNotification('Scheduled reports feature coming soon');
        }

        // Utility Functions
        async function refreshAllData() {
            try {
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '🔄 Refreshing...';

                console.log('🔄 Refreshing all data...');
                
                await loadReportsData();
                refreshCharts();
                
                showNotification('All data refreshed successfully');

            } catch (error) {
                console.error('❌ Refresh all data error:', error);
                showNotification('Error refreshing data', 'error');
            } finally {
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '🔄 Refresh Data';
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').classList.toggle('show', show);
        }

        function showMainContent(show) {
            document.getElementById('mainContent').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? 
                'linear-gradient(135deg, #e53e3e, #c53030)' : 
                'linear-gradient(135deg, #48bb78, #38a169)';
                
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${bgColor}; color: white; padding: 15px 25px; 
                border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                font-weight: 600; opacity: 0; transition: all 0.3s ease;
                max-width: 400px; word-wrap: break-word;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 100);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
            }
        });

        console.log('📋 Detailed Reports Firebase integration loaded successfully');
    </script>
</body>
</html>
