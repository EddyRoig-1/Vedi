<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venue Financials - Restaurant Fee Management</title>
    
    <!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<!-- Firebase Configuration (must be after Firebase SDK) -->
<script src="../firebase-config.js"></script>

<!-- Core API Modules -->
<script src="../api/core/firebase-init.js"></script>
<script src="../api/core/utilities.js"></script>
<script src="../api/core/tracking.js"></script>

<!-- Authentication -->
<script src="../api/auth/email-auth.js"></script>

<!-- Business Management -->
<script src="../api/business/restaurants.js"></script>
<script src="../api/business/venues.js"></script>

<!-- Orders -->
<script src="../api/orders/order-tracking.js"></script>

<!-- Payments -->
<script src="../api/payments/fee-configurations.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 32px;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-info h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-info p {
            color: #718096;
            font-size: 1.1rem;
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Financial Overview Cards */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .overview-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .overview-card h3 {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .overview-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .overview-description {
            color: #718096;
            font-size: 0.9rem;
        }

        /* Restaurant Management Table */
        .restaurants-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bulk-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .bulk-action-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .bulk-action-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .bulk-action-btn.primary {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-color: transparent;
        }

        .bulk-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        /* Restaurant Table */
        .restaurant-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .restaurant-table th {
            background: #f8fafc;
            color: #4a5568;
            font-weight: 600;
            padding: 16px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .restaurant-table td {
            padding: 20px 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .restaurant-table tr:hover {
            background: #f8fafc;
        }

        .restaurant-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .restaurant-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .restaurant-details h4 {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .restaurant-meta {
            color: #718096;
            font-size: 0.9rem;
        }

        .fee-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fee-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .fee-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .fee-input.changed {
            border-color: #f6ad55;
            background: #fef5e7;
        }

        .fee-suffix {
            color: #718096;
            font-weight: 600;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            color: #2c7a7b;
            border: 1px solid #38b2ac;
        }

        .status-badge.pending {
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
            color: #c05621;
            border: 1px solid #f6ad55;
        }

        .status-badge.changed {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            color: #c53030;
            border: 1px solid #fc8181;
        }

        .revenue-amount {
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
        }

        .revenue-period {
            color: #718096;
            font-size: 0.8rem;
            display: block;
            margin-top: 2px;
        }

        .projected-amount {
            color: #48bb78;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .action-btn.save {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .action-btn.save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .action-btn.cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .action-btn.cancel:hover {
            background: #cbd5e0;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .action-btn.view-details {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-bottom: 4px;
        }

        .action-btn.view-details:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Fee Breakdown Styling */
        .fee-breakdown-container {
            position: relative;
        }

        .revenue-split-breakdown {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .revenue-split-breakdown:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: #cbd5e0;
        }

        .split-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 2px 0;
            transition: all 0.2s ease;
        }

        .split-item:hover {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            padding: 2px 4px;
        }

        .earnings-breakdown {
            position: relative;
        }

        .earnings-breakdown .projected-amount {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Enhanced Revenue Calculator */
        .calculator-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-top: 24px;
        }

        .calc-input-group {
            margin-bottom: 20px;
        }

        .calc-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .calc-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .calc-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .calc-results {
            background: #f8fafc;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
        }

        .calc-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .calc-result-item:last-child {
            border-bottom: none;
            font-weight: 700;
            color: #2d3748;
            padding-top: 16px;
            margin-top: 8px;
            border-top: 2px solid #e2e8f0;
        }

        .calc-result-label {
            color: #4a5568;
            font-weight: 500;
        }

        .calc-result-value {
            font-weight: 600;
            color: #2d3748;
        }

        /* Enhanced Calculator Results with Color Coding */
        .calc-result-item.restaurant {
            color: #059669;
        }

        .calc-result-item.venue {
            color: #667eea;
        }

        .calc-result-item.platform {
            color: #f59e0b;
        }

        .calc-result-item.stripe {
            color: #6b7280;
        }

        .calc-result-item.tax {
            color: #dc2626;
        }

        .calc-result-item.restaurant .calc-result-value {
            color: #059669;
            font-weight: 700;
        }

        .calc-result-item.venue .calc-result-value {
            color: #667eea;
            font-weight: 700;
        }

        .calc-result-item.platform .calc-result-value {
            color: #f59e0b;
            font-weight: 700;
        }

        .calc-result-item.stripe .calc-result-value {
            color: #6b7280;
            font-weight: 700;
        }

        .calc-result-item.tax .calc-result-value {
            color: #dc2626;
            font-weight: 700;
        }

        /* Loading and notifications */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 320px;
            width: 90%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateX(100%);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }

            .calculator-grid {
                grid-template-columns: 1fr;
            }

            .restaurant-table {
                font-size: 0.9rem;
            }

            .restaurant-table th,
            .restaurant-table td {
                padding: 12px 8px;
            }

            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 1024px) {
            .restaurant-table {
                overflow-x: auto;
                display: block;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading venue financials...</div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-info">
                    <h1>💰 <span id="venueName">Venue Financials</span></h1>
                    <p>Manage restaurant fee splits and revenue projections</p>
                </div>
                <a href="venue-admin-dashboard.html" class="back-btn">
                    <span>←</span>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Financial Overview -->
        <div class="overview-grid">
            <div class="overview-card">
                <h3>Monthly Venue Revenue</h3>
                <div class="overview-value" id="monthlyVenueRevenue">$0.00</div>
                <div class="overview-description">Your share from all restaurants</div>
            </div>
            <div class="overview-card">
                <h3>Average Fee Rate</h3>
                <div class="overview-value" id="averageFeeRate">0.0%</div>
                <div class="overview-description">Across all connected restaurants</div>
            </div>
            <div class="overview-card">
                <h3>Active Restaurants</h3>
                <div class="overview-value" id="activeRestaurants">0</div>
                <div class="overview-description">Currently connected to venue</div>
            </div>
            <div class="overview-card">
                <h3>Pending Changes</h3>
                <div class="overview-value" id="pendingChanges">0</div>
                <div class="overview-description">Unsaved fee modifications</div>
            </div>
        </div>

        <!-- Restaurant Fee Management -->
        <div class="restaurants-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span>🏪</span>
                    Restaurant Fee Management
                </h2>
                <div class="bulk-actions">
                    <button class="bulk-action-btn" onclick="resetAllChanges()">
                        Reset All
                    </button>
                    <button class="bulk-action-btn primary" onclick="saveAllChanges()" id="saveAllBtn" disabled>
                        Save All Changes
                    </button>
                </div>
            </div>

            <table class="restaurant-table">
                <thead>
                    <tr>
                        <th>Restaurant</th>
                        <th>Your Venue Fee</th>
                        <th>Platform Fees</th>
                        <th>Tax</th>
                        <th>Monthly Revenue</th>
                        <th>Your Earnings</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="restaurantsTableBody">
                    <!-- Restaurant rows will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Enhanced Revenue Calculator -->
        <div class="calculator-section">
            <h2 class="section-title">
                <span>🧮</span>
                Revenue Calculator
            </h2>
            <div class="calculator-grid">
                <div>
                    <div class="calc-input-group">
                        <label class="calc-label" for="calcOrderValue">Average Order Value ($)</label>
                        <input type="number" id="calcOrderValue" class="calc-input" value="25.00" step="0.01" onchange="updateCalculation()">
                    </div>
                    <div class="calc-input-group">
                        <label class="calc-label" for="calcOrdersPerDay">Orders Per Day</label>
                        <input type="number" id="calcOrdersPerDay" class="calc-input" value="50" onchange="updateCalculation()">
                    </div>
                    <div class="calc-input-group">
                        <label class="calc-label" for="calcVenueFeeRate">Your Fee Rate (%)</label>
                        <input type="number" id="calcVenueFeeRate" class="calc-input" value="2.0" step="0.1" onchange="updateCalculation()">
                    </div>
                </div>
                <div class="calc-results">
                    <div class="calc-result-item">
                        <span class="calc-result-label">Daily Restaurant Revenue:</span>
                        <span class="calc-result-value" id="calcDailyRevenue">$1,250.00</span>
                    </div>
                    <div class="calc-result-item restaurant">
                        <span class="calc-result-label">🏪 Restaurant Daily Net:</span>
                        <span class="calc-result-value" id="calcRestaurantDaily">$0.00</span>
                    </div>
                    <div class="calc-result-item venue">
                        <span class="calc-result-label">🏢 Your Daily Earnings:</span>
                        <span class="calc-result-value" id="calcDailyEarnings">$25.00</span>
                    </div>
                    <div class="calc-result-item platform">
                        <span class="calc-result-label">⚡ Platform Daily Fee:</span>
                        <span class="calc-result-value" id="calcPlatformDaily">$0.00</span>
                    </div>
                    <div class="calc-result-item stripe">
                        <span class="calc-result-label">💳 Stripe Daily Fee:</span>
                        <span class="calc-result-value" id="calcStripeDaily">$0.00</span>
                    </div>
                    <div class="calc-result-item tax">
                        <span class="calc-result-label">🧾 Tax Daily Fee:</span>
                        <span class="calc-result-value" id="calcTaxDaily">$0.00</span>
                    </div>
                    <div class="calc-result-item">
                        <span class="calc-result-label">Your Monthly Earnings:</span>
                        <span class="calc-result-value" id="calcMonthlyEarnings">$750.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let currentVenue = null;
        let allRestaurants = [];
        let restaurantFeeConfigs = {}; // Store fee configs by restaurant ID
        let originalFeeRates = {};
        let pendingChanges = {};
        let monthlyRevenueData = {};

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('💰 Venue Financials loading...');
            console.log('🕐 Timestamp:', new Date().toISOString());
            
            try {
                await initializeFinancials();
            } catch (error) {
                console.error('❌ Error loading venue financials:', error);
                showError('Failed to load venue financials: ' + error.message);
                hideLoading();
            }
        });

        // Enhanced initialization with real fee data integration
        async function initializeFinancials() {
            console.log('🚀 Starting venue financials initialization...');
            
            showLoading();
            
            try {
                // Check authentication
                console.log('🔐 Checking user authentication...');
                currentUser = await VediAPI.getCurrentUser();
                if (!currentUser) {
                    console.log('❌ No authenticated user found, redirecting to login');
                    window.location.href = '../Landing-Signup-Login/login.html';
                    return;
                }
                console.log('✅ User authenticated:', currentUser.id);

                // Load venue data
                console.log('🏢 Loading venue data for manager:', currentUser.id);
                currentVenue = await VediAPI.getVenueByManager(currentUser.id);
                if (!currentVenue) {
                    console.log('❌ No venue found for user, redirecting to setup');
                    window.location.href = '../Landing-Signup-Login/venue-setup.html';
                    return;
                }

                console.log('✅ Loaded venue:', {
                    id: currentVenue.id,
                    name: currentVenue.name,
                    defaultFeePercentage: currentVenue.defaultFeePercentage
                });
                document.getElementById('venueName').textContent = currentVenue.name + ' Financials';

                // Load restaurants and their fee configurations
                console.log('🏪 Loading restaurants data...');
                await loadRestaurantsData();
                
                // Load revenue data
                console.log('💰 Loading revenue data...');
                await loadRevenueData();
                
                // Update UI
                console.log('🔄 Updating UI components...');
                updateOverviewCards();
                renderRestaurantsTable();
                updateCalculation();
                
                hideLoading();
                console.log('✅ Venue financials loaded successfully!');
                showSuccess('Venue financials loaded successfully!');
                
            } catch (error) {
                console.error('❌ Financials initialization error:', error);
                showError('Failed to load venue financials: ' + error.message);
                hideLoading();
            }
        }

        // Load restaurants and their fee configurations from feeConfigurations collection
        async function loadRestaurantsData() {
            console.log('📊 Loading restaurants data for venue:', currentVenue.id);
            
            try {
                // Get restaurants associated with this venue
                allRestaurants = await VediAPI.getRestaurantsByVenue(currentVenue.id);
                console.log('📍 Found restaurants:', allRestaurants.length);
                
                // Load fee configurations for each restaurant from feeConfigurations collection
                for (const restaurant of allRestaurants) {
                    try {
                        console.log(`📋 Loading fee config for ${restaurant.name} (${restaurant.id})`);
                        const feeConfig = await VediAPI.getFeeConfig(restaurant.id);
                        restaurantFeeConfigs[restaurant.id] = feeConfig;
                        
                        // Get venue fee from fee config (now stored in feeConfigurations)
                        const venueFeePercentage = feeConfig.venueFeePercentage || currentVenue.defaultFeePercentage || 0;
                        originalFeeRates[restaurant.id] = venueFeePercentage;
                        
                        console.log(`💳 ${restaurant.name}: ${venueFeePercentage}% venue fee, Platform: ${feeConfig.feeType} ${feeConfig.serviceFeeFixed || 0}/${feeConfig.serviceFeePercentage || 0}%, Stripe: ${feeConfig.stripeFeePercentage}% + $${feeConfig.stripeFlatFee}, Tax: ${((feeConfig.taxRate || 0.085) * 100).toFixed(1)}%`);
                        
                    } catch (error) {
                        console.warn(`⚠️ Failed to load fee config for ${restaurant.name}:`, error);
                        // Use default fee config
                        restaurantFeeConfigs[restaurant.id] = {
                            serviceFeeFixed: 2.00,
                            serviceFeePercentage: 0,
                            feeType: 'fixed',
                            stripeFeePercentage: 2.9,
                            stripeFlatFee: 0.30,
                            venueFeePercentage: currentVenue.defaultFeePercentage || 0,
                            taxRate: 0.085, // Default 8.5% tax rate
                            isDefault: true
                        };
                        originalFeeRates[restaurant.id] = currentVenue.defaultFeePercentage || 0;
                    }
                }
                
                console.log('✅ Loaded fee configurations for all restaurants');
                
            } catch (error) {
                console.error('❌ Error loading restaurants:', error);
                allRestaurants = [];
            }
        }

        // Load revenue data for each restaurant
        async function loadRevenueData() {
            console.log('💰 Starting revenue data loading for', allRestaurants.length, 'restaurants');
            
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                for (const restaurant of allRestaurants) {
                    try {
                        console.log(`📊 Loading orders for ${restaurant.name} (${restaurant.id})`);
                        
                        const orders = await VediAPI.getOrders(restaurant.id, {
                            limit: 1000,
                            orderBy: 'createdAt'
                        });
                        
                        console.log(`📦 Found ${orders.length} total orders for ${restaurant.name}`);
                        
                        // Filter orders to last 30 days and completed status
                        const recentOrders = orders.filter(order => {
                            const orderDate = VediAPI.timestampToDate(order.createdAt);
                            return orderDate >= thirtyDaysAgo && order.status === 'completed';
                        });
                        
                        // Calculate monthly revenue
                        const monthlyRevenue = recentOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                        monthlyRevenueData[restaurant.id] = monthlyRevenue;
                        
                        console.log(`💰 ${restaurant.name}: $${monthlyRevenue.toFixed(2)} (${recentOrders.length} completed orders)`);
                        
                    } catch (error) {
                        console.warn(`⚠️ Failed to load revenue for ${restaurant.name}:`, error);
                        monthlyRevenueData[restaurant.id] = 0;
                    }
                }
                
                console.log('✅ Loaded revenue data for all restaurants:', monthlyRevenueData);
                
            } catch (error) {
                console.error('❌ Error loading revenue data:', error);
            }
        }

        // Calculate fee breakdown using real fee configuration data with tax included
        function calculateFeeSplit(restaurantId, venueFeePercentage, averageOrderValue) {
            const feeConfig = restaurantFeeConfigs[restaurantId];
            if (!feeConfig) {
                console.warn('No fee config found for restaurant:', restaurantId);
                return getDefaultFeeSplit(venueFeePercentage, averageOrderValue);
            }
            
            // Step 1: Calculate base order values (before tax)
            const taxRate = feeConfig.taxRate || 0.085; // Default 8.5%
            const subtotalBeforeTax = averageOrderValue / (1 + taxRate); // Remove tax to get subtotal
            const taxAmount = averageOrderValue - subtotalBeforeTax;
            
            // Step 2: Calculate Stripe fees (from total order amount including tax)
            const stripeFeeRate = (feeConfig.stripeFeePercentage || 2.9) / 100;
            const stripeFlatFee = feeConfig.stripeFlatFee || 0.30; // In dollars
            const stripeFeeAmount = (averageOrderValue * stripeFeeRate) + stripeFlatFee;
            const netAfterStripe = averageOrderValue - stripeFeeAmount;
            
            // Step 3: Calculate platform service fee (from subtotal before tax)
            let platformFeeAmount = 0;
            const feeType = feeConfig.feeType || 'fixed';
            
            switch (feeType) {
                case 'fixed':
                    platformFeeAmount = feeConfig.serviceFeeFixed || 0;
                    break;
                case 'percentage':
                    platformFeeAmount = subtotalBeforeTax * ((feeConfig.serviceFeePercentage || 0) / 100);
                    break;
                case 'hybrid':
                    platformFeeAmount = (feeConfig.serviceFeeFixed || 0) + 
                                      (subtotalBeforeTax * ((feeConfig.serviceFeePercentage || 0) / 100));
                    break;
            }
            
            // Step 4: Calculate venue fee (from subtotal before tax)
            const venueFeeAmount = subtotalBeforeTax * (venueFeePercentage / 100);
            
            // Step 5: Restaurant gets the remainder (net after all fees and tax)
            const restaurantAmount = netAfterStripe - platformFeeAmount - venueFeeAmount - taxAmount;
            
            // Create display strings for platform fee
            let platformFeeDisplay = '';
            if (feeType === 'fixed') {
                platformFeeDisplay = `$${(feeConfig.serviceFeeFixed || 0).toFixed(2)}`;
            } else if (feeType === 'percentage') {
                platformFeeDisplay = `${(feeConfig.serviceFeePercentage || 0).toFixed(1)}%`;
            } else {
                platformFeeDisplay = `$${(feeConfig.serviceFeeFixed || 0).toFixed(2)} + ${(feeConfig.serviceFeePercentage || 0).toFixed(1)}%`;
            }
            
            const stripeDisplay = `${(feeConfig.stripeFeePercentage || 2.9).toFixed(1)}% + $${(feeConfig.stripeFlatFee || 0.30).toFixed(2)}`;
            const taxDisplay = `${(taxRate * 100).toFixed(1)}%`;
            
            return {
                restaurant: {
                    amount: restaurantAmount,
                    percentage: (restaurantAmount / averageOrderValue) * 100
                },
                venue: {
                    amount: venueFeeAmount,
                    percentage: venueFeePercentage,
                    display: `${venueFeePercentage.toFixed(1)}%`
                },
                platform: {
                    amount: platformFeeAmount,
                    percentage: (platformFeeAmount / averageOrderValue) * 100,
                    display: platformFeeDisplay,
                    type: feeType
                },
                stripe: {
                    amount: stripeFeeAmount,
                    percentage: (stripeFeeAmount / averageOrderValue) * 100,
                    display: stripeDisplay
                },
                tax: {
                    amount: taxAmount,
                    percentage: (taxAmount / averageOrderValue) * 100,
                    rate: taxRate,
                    display: taxDisplay
                },
                subtotal: subtotalBeforeTax,
                feeConfig: feeConfig
            };
        }

        // Default fee split for when fee config is not available
        function getDefaultFeeSplit(venueFeePercentage, averageOrderValue) {
            const taxRate = 0.085; // Default 8.5%
            const subtotalBeforeTax = averageOrderValue / (1 + taxRate);
            const taxAmount = averageOrderValue - subtotalBeforeTax;
            
            const stripeFeeAmount = (averageOrderValue * 0.029) + 0.30;
            const netAfterStripe = averageOrderValue - stripeFeeAmount;
            const platformFeeAmount = 2.00; // Default fixed fee
            const venueFeeAmount = subtotalBeforeTax * (venueFeePercentage / 100);
            const restaurantAmount = netAfterStripe - platformFeeAmount - venueFeeAmount - taxAmount;
            
            return {
                restaurant: {
                    amount: restaurantAmount,
                    percentage: (restaurantAmount / averageOrderValue) * 100
                },
                venue: {
                    amount: venueFeeAmount,
                    percentage: venueFeePercentage,
                    display: `${venueFeePercentage.toFixed(1)}%`
                },
                platform: {
                    amount: platformFeeAmount,
                    percentage: (platformFeeAmount / averageOrderValue) * 100,
                    display: '$2.00 (default)',
                    type: 'fixed'
                },
                stripe: {
                    amount: stripeFeeAmount,
                    percentage: (stripeFeeAmount / averageOrderValue) * 100,
                    display: '2.9% + $0.30 (default)'
                },
                tax: {
                    amount: taxAmount,
                    percentage: (taxAmount / averageOrderValue) * 100,
                    rate: taxRate,
                    display: '8.5% (default)'
                },
                subtotal: subtotalBeforeTax
            };
        }

        // Update overview cards
        function updateOverviewCards() {
            console.log('📊 Updating overview cards...');
            
            let totalVenueRevenue = 0;
            let totalFeeRate = 0;
            let activeCount = 0;

            allRestaurants.forEach(restaurant => {
                const revenue = monthlyRevenueData[restaurant.id] || 0;
                const feeRate = (pendingChanges[restaurant.id] !== undefined ? 
                    pendingChanges[restaurant.id] : 
                    originalFeeRates[restaurant.id] || 0) / 100;
                
                totalVenueRevenue += revenue * feeRate;
                totalFeeRate += originalFeeRates[restaurant.id] || 0;
                activeCount++;
            });

            const averageFeeRate = activeCount > 0 ? totalFeeRate / activeCount : 0;
            const pendingChangesCount = Object.keys(pendingChanges).length;

            // Update cards
            document.getElementById('monthlyVenueRevenue').textContent = formatPrice(totalVenueRevenue);
            document.getElementById('averageFeeRate').textContent = averageFeeRate.toFixed(1) + '%';
            document.getElementById('activeRestaurants').textContent = activeCount.toString();
            document.getElementById('pendingChanges').textContent = pendingChangesCount.toString();

            // Update save button state
            const saveBtn = document.getElementById('saveAllBtn');
            saveBtn.disabled = pendingChangesCount === 0;
            if (pendingChangesCount > 0) {
                saveBtn.textContent = `Save ${pendingChangesCount} Changes`;
            } else {
                saveBtn.textContent = 'Save All Changes';
            }
        }

        // Render restaurants table with real fee data including tax
        function renderRestaurantsTable() {
            console.log('🏪 Rendering restaurants table...');
            const tbody = document.getElementById('restaurantsTableBody');
            
            if (allRestaurants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #718096;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">🏪</div>
                            <div style="font-weight: 600; margin-bottom: 8px;">No restaurants connected</div>
                            <div>Use the restaurant-venue sync system to connect restaurants to your venue</div>
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = allRestaurants.map(restaurant => {
                const currentFee = originalFeeRates[restaurant.id] || 0;
                const pendingFee = pendingChanges[restaurant.id];
                const displayFee = pendingFee !== undefined ? pendingFee : currentFee;
                const monthlyRevenue = monthlyRevenueData[restaurant.id] || 0;
                const monthlyEarnings = monthlyRevenue * (displayFee / 100);
                const hasChanges = pendingFee !== undefined;
                const currency = restaurant.currency || { symbol: '$', code: 'USD' };
                
                // Get fee configuration
                const feeConfig = restaurantFeeConfigs[restaurant.id];
                const averageOrderValue = monthlyRevenue > 0 ? monthlyRevenue / 40 : 25; // Estimate based on data
                const feeSplit = calculateFeeSplit(restaurant.id, displayFee, averageOrderValue);
                
                return `
                    <tr>
                        <td>
                            <div class="restaurant-info">
                                <div class="restaurant-avatar">
                                    ${restaurant.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="restaurant-details">
                                    <h4>${restaurant.name}</h4>
                                    <div class="restaurant-meta">
                                        ${restaurant.cuisineType || 'Restaurant'} • 
                                        ${currency.code} • 
                                        ${restaurant.status || 'Active'}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="fee-control">
                                <input 
                                    type="number" 
                                    class="fee-input ${hasChanges ? 'changed' : ''}" 
                                    value="${displayFee.toFixed(1)}" 
                                    step="0.1" 
                                    min="0" 
                                    max="10"
                                    onchange="handleFeeChange('${restaurant.id}', this.value)"
                                    id="fee-${restaurant.id}"
                                >
                                <span class="fee-suffix">%</span>
                            </div>
                            <div style="font-size: 0.8rem; color: #667eea; margin-top: 4px;">
                                Your share: ${feeSplit.venue.display}
                            </div>
                        </td>
                        <td>
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 0.8rem; color: #f59e0b; font-weight: 600;">Platform Service</div>
                                <div style="font-size: 0.9rem; font-weight: 600;">${feeSplit.platform.display}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${feeSplit.platform.type}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: #6b7280; font-weight: 600;">Stripe Processing</div>
                                <div style="font-size: 0.9rem; font-weight: 600;">${feeSplit.stripe.display}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${feeConfig?.isNegotiated ? 'Negotiated' : 'Standard'}</div>
                            </div>
                        </td>
                        <td>
                            <div style="margin-bottom: 4px;">
                                <div style="font-size: 0.8rem; color: #dc2626; font-weight: 600;">Tax Rate</div>
                                <div style="font-size: 0.9rem; font-weight: 600;">${feeSplit.tax.display}</div>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                Monthly: ${formatPrice(feeSplit.tax.amount * 40, currency)}
                            </div>
                        </td>
                        <td>
                            <div class="revenue-amount">${formatPrice(monthlyRevenue, currency)}</div>
                            <span class="revenue-period">Last 30 days</span>
                            <div style="margin-top: 8px; font-size: 0.8rem; color: #4a5568;">
                                <div>Avg Order: ${formatPrice(averageOrderValue, currency)}</div>
                                <div>Restaurant Net: ${formatPrice(feeSplit.restaurant.amount * 40, currency)}</div>
                                <div>Subtotal: ${formatPrice(feeSplit.subtotal * 40, currency)}</div>
                            </div>
                        </td>
                        <td>
                            <div class="earnings-breakdown">
                                <div class="projected-amount">${formatPrice(monthlyEarnings, currency)}</div>
                                <span class="revenue-period">${hasChanges ? '• Projected' : '• Current'}</span>
                                
                                <div style="margin-top: 12px; background: #f0f9ff; border-radius: 6px; padding: 8px; border: 1px solid #bae6fd;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #0369a1; margin-bottom: 6px;">Monthly Breakdown</div>
                                    <div style="font-size: 0.8rem; color: #0369a1; display: flex; justify-content: space-between;">
                                        <span>Your Share:</span>
                                        <span style="font-weight: 600;">${formatPrice(monthlyEarnings, currency)}</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6b7280; display: flex; justify-content: space-between;">
                                        <span>Platform:</span>
                                        <span>${formatPrice(feeSplit.platform.amount * 40, currency)}</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6b7280; display: flex; justify-content: space-between;">
                                        <span>Stripe:</span>
                                        <span>${formatPrice(feeSplit.stripe.amount * 40, currency)}</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #dc2626; display: flex; justify-content: space-between;">
                                        <span>Tax:</span>
                                        <span>${formatPrice(feeSplit.tax.amount * 40, currency)}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${hasChanges ? 'changed' : 'active'}">
                                ${hasChanges ? 'Changed' : 'Active'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${hasChanges ? `
                                    <button class="action-btn save" onclick="saveRestaurantFee('${restaurant.id}')">
                                        Save
                                    </button>
                                    <button class="action-btn cancel" onclick="cancelRestaurantChange('${restaurant.id}')">
                                        Cancel
                                    </button>
                                ` : `
                                    <button class="action-btn view-details" onclick="showFeeDetails('${restaurant.id}')">
                                        Details
                                    </button>
                                    <button class="action-btn" onclick="resetRestaurantFee('${restaurant.id}')">
                                        Reset
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows.join('');
            console.log('✅ Restaurant table rendered with real fee data including tax');
        }

        // Show fee configuration details for a restaurant including tax
        function showFeeDetails(restaurantId) {
            const restaurant = allRestaurants.find(r => r.id === restaurantId);
            const feeConfig = restaurantFeeConfigs[restaurantId];
            
            if (!restaurant || !feeConfig) return;
            
            const venueFee = originalFeeRates[restaurantId] || 0;
            const monthlyRevenue = monthlyRevenueData[restaurantId] || 0;
            const averageOrderValue = monthlyRevenue > 0 ? monthlyRevenue / 40 : 25;
            const feeSplit = calculateFeeSplit(restaurantId, venueFee, averageOrderValue);
            
            alert(`Fee Configuration for ${restaurant.name}:
            
Venue Fee: ${venueFee.toFixed(1)}% (Your earnings)
Platform Service Fee: ${feeSplit.platform.display} (${feeConfig.feeType})
Stripe Processing: ${feeSplit.stripe.display}
Tax Rate: ${feeSplit.tax.display}

Monthly Breakdown (40 orders average):
- Restaurant Net: ${formatPrice(feeSplit.restaurant.amount * 40)}
- Your Earnings: ${formatPrice(feeSplit.venue.amount * 40)}
- Platform Fee: ${formatPrice(feeSplit.platform.amount * 40)}
- Stripe Fee: ${formatPrice(feeSplit.stripe.amount * 40)}
- Tax Collected: ${formatPrice(feeSplit.tax.amount * 40)}

${feeConfig.isNegotiated ? 'This restaurant has negotiated rates.' : 'This restaurant uses standard rates.'}`);
        }

        // Handle fee change for a restaurant
        function handleFeeChange(restaurantId, newFee) {
            const originalFee = originalFeeRates[restaurantId];
            const feeValue = parseFloat(newFee);
            
            if (Math.abs(feeValue - originalFee) < 0.01) {
                delete pendingChanges[restaurantId];
            } else {
                pendingChanges[restaurantId] = feeValue;
            }
            
            updateOverviewCards();
            renderRestaurantsTable();
        }

        // Save individual restaurant fee using the new API method
        async function saveRestaurantFee(restaurantId) {
            try {
                const newFee = pendingChanges[restaurantId];
                if (newFee === undefined) return;
                
                console.log('💾 Updating venue fee percentage for restaurant:', restaurantId, newFee);
                
                // Use the new updateVenueFeePercentage method that updates feeConfigurations
                await VediAPI.updateVenueFeePercentage(restaurantId, newFee, currentUser.id);
                
                // Update local state
                originalFeeRates[restaurantId] = newFee;
                restaurantFeeConfigs[restaurantId].venueFeePercentage = newFee;
                delete pendingChanges[restaurantId];
                
                updateOverviewCards();
                renderRestaurantsTable();
                
                showSuccess(`Venue fee updated to ${newFee.toFixed(1)}%`);
                
            } catch (error) {
                console.error('❌ Error saving restaurant fee:', error);
                showError('Failed to save fee: ' + error.message);
            }
        }

        // Cancel individual restaurant change
        function cancelRestaurantChange(restaurantId) {
            delete pendingChanges[restaurantId];
            
            const input = document.getElementById(`fee-${restaurantId}`);
            if (input) {
                input.value = originalFeeRates[restaurantId].toFixed(1);
            }
            
            updateOverviewCards();
            renderRestaurantsTable();
            showSuccess('Changes cancelled');
        }

        // Reset restaurant fee to venue default
        async function resetRestaurantFee(restaurantId) {
            try {
                const defaultFee = currentVenue.defaultFeePercentage || 0;
                
                await VediAPI.updateVenueFeePercentage(restaurantId, defaultFee, currentUser.id);
                
                originalFeeRates[restaurantId] = defaultFee;
                restaurantFeeConfigs[restaurantId].venueFeePercentage = defaultFee;
                delete pendingChanges[restaurantId];
                
                updateOverviewCards();
                renderRestaurantsTable();
                
                showSuccess('Fee reset to venue default');
                
            } catch (error) {
                console.error('❌ Error resetting restaurant fee:', error);
                showError('Failed to reset fee: ' + error.message);
            }
        }

        // Save all pending changes using syncVenueFeeAcrossRestaurants for efficiency
        async function saveAllChanges() {
            try {
                const changeCount = Object.keys(pendingChanges).length;
                if (changeCount === 0) return;
                
                showLoading(`Saving ${changeCount} changes...`);
                
                // Save all changes individually (could be optimized with batch operations)
                const savePromises = Object.entries(pendingChanges).map(([restaurantId, newFee]) => 
                    VediAPI.updateVenueFeePercentage(restaurantId, newFee, currentUser.id)
                );
                
                await Promise.all(savePromises);
                
                // Update local state
                Object.entries(pendingChanges).forEach(([restaurantId, newFee]) => {
                    originalFeeRates[restaurantId] = newFee;
                    restaurantFeeConfigs[restaurantId].venueFeePercentage = newFee;
                });
                pendingChanges = {};
                
                updateOverviewCards();
                renderRestaurantsTable();
                
                hideLoading();
                showSuccess(`All ${changeCount} changes saved successfully!`);
                
            } catch (error) {
                console.error('❌ Error saving all changes:', error);
                showError('Failed to save changes: ' + error.message);
                hideLoading();
            }
        }

        // Reset all pending changes
        function resetAllChanges() {
            if (Object.keys(pendingChanges).length === 0) return;
            
            if (!confirm('Are you sure you want to reset all pending changes?')) return;
            
            pendingChanges = {};
            
            allRestaurants.forEach(restaurant => {
                const input = document.getElementById(`fee-${restaurant.id}`);
                if (input) {
                    input.value = originalFeeRates[restaurant.id].toFixed(1);
                }
            });
            
            updateOverviewCards();
            renderRestaurantsTable();
            showSuccess('All changes reset');
        }

        // Enhanced revenue calculator with real fee data including tax
        function updateCalculation() {
            const orderValue = parseFloat(document.getElementById('calcOrderValue').value) || 0;
            const ordersPerDay = parseInt(document.getElementById('calcOrdersPerDay').value) || 0;
            const feeRate = parseFloat(document.getElementById('calcVenueFeeRate').value) || 0;
            
            const dailyRevenue = orderValue * ordersPerDay;
            
            // Use real fee configuration for calculation if available
            let sampleFeeConfig = null;
            if (Object.keys(restaurantFeeConfigs).length > 0) {
                sampleFeeConfig = Object.values(restaurantFeeConfigs)[0];
            }
            
            if (sampleFeeConfig) {
                const feeSplit = calculateFeeSplit(Object.keys(restaurantFeeConfigs)[0], feeRate, orderValue);
                
                const dailyStripe = feeSplit.stripe.amount * ordersPerDay;
                const dailyPlatform = feeSplit.platform.amount * ordersPerDay;
                const dailyVenue = feeSplit.venue.amount * ordersPerDay;
                const dailyRestaurant = feeSplit.restaurant.amount * ordersPerDay;
                const dailyTax = feeSplit.tax.amount * ordersPerDay;
                
                document.getElementById('calcDailyRevenue').textContent = formatPrice(dailyRevenue);
                document.getElementById('calcRestaurantDaily').textContent = formatPrice(dailyRestaurant);
                document.getElementById('calcDailyEarnings').textContent = formatPrice(dailyVenue);
                document.getElementById('calcPlatformDaily').textContent = formatPrice(dailyPlatform);
                document.getElementById('calcStripeDaily').textContent = formatPrice(dailyStripe);
                document.getElementById('calcTaxDaily').textContent = formatPrice(dailyTax);
                document.getElementById('calcMonthlyEarnings').textContent = formatPrice(dailyVenue * 30);
            } else {
                // Fallback calculation with tax
                const taxRate = 0.085; // Default 8.5%
                const subtotalBeforeTax = orderValue / (1 + taxRate);
                const taxAmount = orderValue - subtotalBeforeTax;
                
                const stripeFee = (orderValue * 0.029 + 0.30) * ordersPerDay;
                const platformFee = 2.00 * ordersPerDay;
                const venueFee = (subtotalBeforeTax * (feeRate / 100)) * ordersPerDay;
                const dailyTax = taxAmount * ordersPerDay;
                const restaurantNet = dailyRevenue - stripeFee - platformFee - venueFee - dailyTax;
                
                document.getElementById('calcDailyRevenue').textContent = formatPrice(dailyRevenue);
                document.getElementById('calcRestaurantDaily').textContent = formatPrice(restaurantNet);
                document.getElementById('calcDailyEarnings').textContent = formatPrice(venueFee);
                document.getElementById('calcPlatformDaily').textContent = formatPrice(platformFee);
                document.getElementById('calcStripeDaily').textContent = formatPrice(stripeFee);
                document.getElementById('calcTaxDaily').textContent = formatPrice(dailyTax);
                document.getElementById('calcMonthlyEarnings').textContent = formatPrice(venueFee * 30);
            }
        }

        // Utility functions
        function formatPrice(amount, currency = null) {
            if (!currency) {
                currency = { symbol: '$', code: 'USD' };
            }
            const formattedAmount = Number(amount || 0).toFixed(2);
            return `${currency.symbol}${formattedAmount}`;
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('.loading-text');
            text.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type}`;
            notification.innerHTML = `${type === 'success' ? '✅' : '❌'} ${message}`;
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        console.log('💰 Enhanced Venue Financials page loaded with real fee data integration INCLUDING TAX');
        console.log('🔧 Features: Real-time fee reading from feeConfigurations, venue fee sync across pages');
        console.log('📊 Integration: Uses updateVenueFeePercentage API for cross-page sync');
        console.log('💳 Enhanced: Displays actual platform, Stripe fees, and TAX from restaurant configurations');
        console.log('🧾 NEW: Tax calculations integrated from restaurant tax rates');
        console.log('📊 NEW: Tax column added to management table with monthly breakdown');
        console.log('🧮 NEW: Tax included in revenue calculator with proper fee separation');
    </script>
</body>
</html>
