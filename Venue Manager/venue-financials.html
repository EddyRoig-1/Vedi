<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venue Financials - Restaurant Fee Management</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../firebase-api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 32px;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-info h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-info p {
            color: #718096;
            font-size: 1.1rem;
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Financial Overview Cards */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .overview-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .overview-card h3 {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .overview-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .overview-description {
            color: #718096;
            font-size: 0.9rem;
        }

        /* Restaurant Management Table */
        .restaurants-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bulk-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .bulk-action-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .bulk-action-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .bulk-action-btn.primary {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-color: transparent;
        }

        .bulk-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        /* Restaurant Table */
        .restaurant-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .restaurant-table th {
            background: #f8fafc;
            color: #4a5568;
            font-weight: 600;
            padding: 16px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .restaurant-table td {
            padding: 20px 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .restaurant-table tr:hover {
            background: #f8fafc;
        }

        .restaurant-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .restaurant-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .restaurant-details h4 {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .restaurant-meta {
            color: #718096;
            font-size: 0.9rem;
        }

        .fee-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fee-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .fee-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .fee-input.changed {
            border-color: #f6ad55;
            background: #fef5e7;
        }

        .fee-suffix {
            color: #718096;
            font-weight: 600;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            color: #2c7a7b;
            border: 1px solid #38b2ac;
        }

        .status-badge.pending {
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
            color: #c05621;
            border: 1px solid #f6ad55;
        }

        .status-badge.changed {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            color: #c53030;
            border: 1px solid #fc8181;
        }

        .revenue-amount {
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
        }

        .revenue-period {
            color: #718096;
            font-size: 0.8rem;
            display: block;
            margin-top: 2px;
        }

        .projected-amount {
            color: #48bb78;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .action-btn.save {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .action-btn.save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .action-btn.cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .action-btn.cancel:hover {
            background: #cbd5e0;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .action-btn.view-details {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-bottom: 4px;
        }

        .action-btn.view-details:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Enhanced Fee Breakdown Styling */
        .fee-breakdown-container {
            position: relative;
        }

        .revenue-split-breakdown {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .revenue-split-breakdown:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: #cbd5e0;
        }

        .split-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 2px 0;
            transition: all 0.2s ease;
        }

        .split-item:hover {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            padding: 2px 4px;
        }

        .earnings-breakdown {
            position: relative;
        }

        .earnings-breakdown .projected-amount {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Enhanced table styling for better breakdown visibility */
        .restaurant-table th:nth-child(2) {
            min-width: 280px;
        }

        .restaurant-table th:nth-child(4) {
            min-width: 200px;
        }

        /* Enhanced Revenue Calculator */
        .calculator-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-top: 24px;
        }

        .calc-input-group {
            margin-bottom: 20px;
        }

        .calc-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .calc-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .calc-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .calc-results {
            background: #f8fafc;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
        }

        .calc-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .calc-result-item:last-child {
            border-bottom: none;
            font-weight: 700;
            color: #2d3748;
            padding-top: 16px;
            margin-top: 8px;
            border-top: 2px solid #e2e8f0;
        }

        .calc-result-label {
            color: #4a5568;
            font-weight: 500;
        }

        .calc-result-value {
            font-weight: 600;
            color: #2d3748;
        }

        /* Enhanced Calculator Results with Color Coding */
        .calc-result-item.restaurant {
            color: #059669;
        }

        .calc-result-item.venue {
            color: #667eea;
        }

        .calc-result-item.platform {
            color: #f59e0b;
        }

        .calc-result-item.stripe {
            color: #6b7280;
        }

        .calc-result-item.restaurant .calc-result-value {
            color: #059669;
            font-weight: 700;
        }

        .calc-result-item.venue .calc-result-value {
            color: #667eea;
            font-weight: 700;
        }

        .calc-result-item.platform .calc-result-value {
            color: #f59e0b;
            font-weight: 700;
        }

        .calc-result-item.stripe .calc-result-value {
            color: #6b7280;
            font-weight: 700;
        }

        /* Compact Modal Styling */
        .revenue-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .revenue-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 20px 24px;
            border-bottom: 2px solid #f1f5f9;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .modal-close-btn:hover {
            background-color: #f1f5f9;
        }

        /* Compact breakdown table */
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .breakdown-table th,
        .breakdown-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }

        .breakdown-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Loading and notifications */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 320px;
            width: 90%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateX(100%);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }

            .calculator-grid {
                grid-template-columns: 1fr;
            }

            .restaurant-table {
                font-size: 0.9rem;
            }

            .restaurant-table th,
            .restaurant-table td {
                padding: 12px 8px;
            }

            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .revenue-modal-content {
                margin: 20px;
                max-height: calc(100vh - 40px);
            }
        }

        @media (max-width: 1024px) {
            .restaurant-table {
                overflow-x: auto;
                display: block;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading venue financials...</div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-info">
                    <h1>üí∞ <span id="venueName">Venue Financials</span></h1>
                    <p>Manage restaurant fee splits and revenue projections</p>
                </div>
                <a href="venue-admin-dashboard.html" class="back-btn">
                    <span>‚Üê</span>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Financial Overview -->
        <div class="overview-grid">
            <div class="overview-card">
                <h3>Monthly Venue Revenue</h3>
                <div class="overview-value" id="monthlyVenueRevenue">$0.00</div>
                <div class="overview-description">Your share from all restaurants</div>
            </div>
            <div class="overview-card">
                <h3>Average Fee Rate</h3>
                <div class="overview-value" id="averageFeeRate">0.0%</div>
                <div class="overview-description">Across all connected restaurants</div>
            </div>
            <div class="overview-card">
                <h3>Active Restaurants</h3>
                <div class="overview-value" id="activeRestaurants">0</div>
                <div class="overview-description">Currently connected to venue</div>
            </div>
            <div class="overview-card">
                <h3>Pending Changes</h3>
                <div class="overview-value" id="pendingChanges">0</div>
                <div class="overview-description">Unsaved fee modifications</div>
            </div>
        </div>

        <!-- Restaurant Fee Management -->
        <div class="restaurants-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span>üè™</span>
                    Restaurant Fee Management
                </h2>
                <div class="bulk-actions">
                    <button class="bulk-action-btn" onclick="resetAllChanges()">
                        Reset All
                    </button>
                    <button class="bulk-action-btn primary" onclick="saveAllChanges()" id="saveAllBtn" disabled>
                        Save All Changes
                    </button>
                </div>
            </div>

            <table class="restaurant-table">
                <thead>
                    <tr>
                        <th>Restaurant</th>
                        <th>Current Fee</th>
                        <th>Monthly Revenue</th>
                        <th>Your Monthly Earnings</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="restaurantsTableBody">
                    <!-- Restaurant rows will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Enhanced Revenue Calculator -->
        <div class="calculator-section">
            <h2 class="section-title">
                <span>üßÆ</span>
                Revenue Calculator
            </h2>
            <div class="calculator-grid">
                <div>
                    <div class="calc-input-group">
                        <label class="calc-label" for="calcOrderValue">Average Order Value ($)</label>
                        <input type="number" id="calcOrderValue" class="calc-input" value="25.00" step="0.01" onchange="updateCalculation()">
                    </div>
                    <div class="calc-input-group">
                        <label class="calc-label" for="calcOrdersPerDay">Orders Per Day</label>
                        <input type="number" id="calcOrdersPerDay" class="calc-input" value="50" onchange="updateCalculation()">
                    </div>
                    <div class="calc-input-group">
                        <label class="calc-label" for="calcVenueFeeRate">Your Fee Rate (%)</label>
                        <input type="number" id="calcVenueFeeRate" class="calc-input" value="2.0" step="0.1" onchange="updateCalculation()">
                    </div>
                </div>
                <div class="calc-results">
                    <div class="calc-result-item">
                        <span class="calc-result-label">Daily Restaurant Revenue:</span>
                        <span class="calc-result-value" id="calcDailyRevenue">$1,250.00</span>
                    </div>
                    <div class="calc-result-item restaurant">
                        <span class="calc-result-label">üè™ Restaurant Daily Net:</span>
                        <span class="calc-result-value" id="calcRestaurantDaily">$0.00</span>
                    </div>
                    <div class="calc-result-item venue">
                        <span class="calc-result-label">üè¢ Your Daily Earnings:</span>
                        <span class="calc-result-value" id="calcDailyEarnings">$25.00</span>
                    </div>
                    <div class="calc-result-item platform">
                        <span class="calc-result-label">‚ö° Platform Daily Fee:</span>
                        <span class="calc-result-value" id="calcPlatformDaily">$0.00</span>
                    </div>
                    <div class="calc-result-item stripe">
                        <span class="calc-result-label">üí≥ Stripe Daily Fee:</span>
                        <span class="calc-result-value" id="calcStripeDaily">$0.00</span>
                    </div>
                    <div class="calc-result-item">
                        <span class="calc-result-label">Your Monthly Earnings:</span>
                        <span class="calc-result-value" id="calcMonthlyEarnings">$750.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let currentVenue = null;
        let allRestaurants = [];
        let originalFeeRates = {};
        let pendingChanges = {};
        let monthlyRevenueData = {};
        let globalFeeConfig = {
            stripeFeePercentage: 2.9,
            stripeFlatFee: 30,
            serviceFeePercentage: 3.5,
            serviceFeeFixed: 0.50,
            feeType: 'hybrid'
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üí∞ Venue Financials loading...');
            console.log('üïê Timestamp:', new Date().toISOString());
            
            try {
                await initializeFinancials();
            } catch (error) {
                console.error('‚ùå Error loading venue financials:', error);
                console.error('‚ùå Error details:', {
                    message: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                });
                showError('Failed to load venue financials: ' + error.message);
                hideLoading();
            }
        });

        // Load venue data using VediAPI
        async function initializeFinancials() {
            console.log('üöÄ Starting venue financials initialization...');
            showLoading();
            
            try {
                // Check authentication
                console.log('üîê Checking user authentication...');
                currentUser = await VediAPI.getCurrentUser();
                if (!currentUser) {
                    console.log('‚ùå No authenticated user found, redirecting to login');
                    window.location.href = '../Landing-Signup-Login/login.html';
                    return;
                }
                console.log('‚úÖ User authenticated:', currentUser.id);

                // Load venue data using VediAPI
                console.log('üè¢ Loading venue data for manager:', currentUser.id);
                currentVenue = await VediAPI.getVenueByManager(currentUser.id);
                if (!currentVenue) {
                    console.log('‚ùå No venue found for user, redirecting to setup');
                    window.location.href = '../Landing-Signup-Login/venue-setup.html';
                    return;
                }

                console.log('‚úÖ Loaded venue:', {
                    id: currentVenue.id,
                    name: currentVenue.name,
                    defaultFeePercentage: currentVenue.defaultFeePercentage
                });
                document.getElementById('venueName').textContent = currentVenue.name + ' Financials';

                // Load global fee configuration
                await loadGlobalFeeConfig();
                
                // Load restaurants using VenueSync
                console.log('üè™ Loading restaurants data...');
                await loadRestaurantsData();
                
                // Load revenue data
                console.log('üí∞ Loading revenue data...');
                await loadRevenueData();
                
                // Update UI
                console.log('üîÑ Updating UI components...');
                updateOverviewCards();
                renderRestaurantsTable();
                updateCalculation();
                
                hideLoading();
                console.log('‚úÖ Venue financials loaded successfully!');
                showSuccess('Venue financials loaded successfully!');
                
            } catch (error) {
                console.error('‚ùå Financials initialization error:', error);
                console.error('‚ùå Full error details:', {
                    message: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    venue: currentVenue?.id || 'not loaded',
                    user: currentUser?.id || 'not loaded'
                });
                showError('Failed to load venue financials: ' + error.message);
                hideLoading();
            }
        }

        // Load restaurant-specific fee configuration from Firestore
        async function loadGlobalFeeConfig() {
            try {
                console.log('‚öôÔ∏è Loading fee configuration from Firestore...');
                console.log('üîç Available VediAPI methods:', Object.keys(window.VediAPI || {}));
                
                // Try to get restaurant-specific fee config first
                let feeConfig = null;
                
                // Method 1: Try VediAPI methods
                if (window.VediAPI) {
                    console.log('üìã Trying VediAPI.getFeeConfig()...');
                    try {
                        feeConfig = await window.VediAPI.getFeeConfig();
                        console.log('üìã VediAPI.getFeeConfig() result:', feeConfig);
                    } catch (error) {
                        console.log('‚ö†Ô∏è VediAPI.getFeeConfig() failed:', error.message);
                    }
                    
                    // Try different method names
                    if (!feeConfig && typeof window.VediAPI.getDefaultFeeConfig === 'function') {
                        console.log('üìã Trying VediAPI.getDefaultFeeConfig()...');
                        try {
                            feeConfig = await window.VediAPI.getDefaultFeeConfig();
                            console.log('üìã getDefaultFeeConfig() result:', feeConfig);
                        } catch (error) {
                            console.log('‚ö†Ô∏è getDefaultFeeConfig() failed:', error.message);
                        }
                    }
                }
                
                // Method 2: Direct Firestore query to feeConfigurations collection
                if (!feeConfig && Firebase.db) {
                    console.log('üìã Trying direct Firestore query to feeConfigurations...');
                    try {
                        // Try to get the specific restaurant's fee config first
                        if (allRestaurants.length > 0) {
                            const restaurantId = allRestaurants[0].id; // Use first restaurant as example
                            console.log('üîç Looking for fee config for restaurant:', restaurantId);
                            
                            const restaurantConfigDoc = await Firebase.db.collection('feeConfigurations').doc(restaurantId).get();
                            if (restaurantConfigDoc.exists) {
                                feeConfig = restaurantConfigDoc.data();
                                console.log('‚úÖ Found restaurant-specific fee config:', feeConfig);
                            }
                        }
                        
                        // If no restaurant-specific config, try default
                        if (!feeConfig) {
                            console.log('üîç Looking for default fee configuration...');
                            const defaultConfigDoc = await Firebase.db.collection('feeConfigurations').doc('default').get();
                            if (defaultConfigDoc.exists) {
                                feeConfig = defaultConfigDoc.data();
                                console.log('‚úÖ Found default fee config:', feeConfig);
                            }
                        }
                        
                        // If no default, get any fee config from the collection
                        if (!feeConfig) {
                            console.log('üîç Looking for any fee configuration in collection...');
                            const feeConfigsSnapshot = await Firebase.db.collection('feeConfigurations').limit(1).get();
                            if (!feeConfigsSnapshot.empty) {
                                feeConfig = feeConfigsSnapshot.docs[0].data();
                                console.log('‚úÖ Found fee config from collection:', feeConfig);
                            }
                        }
                    } catch (firestoreError) {
                        console.error('‚ùå Direct Firestore query failed:', firestoreError);
                    }
                }
                
                if (feeConfig) {
                    globalFeeConfig = {
                        stripeFeePercentage: feeConfig.stripeFeePercentage || 2.9,
                        stripeFlatFee: feeConfig.stripeFlatFee || 30,
                        serviceFeePercentage: feeConfig.serviceFeePercentage || 6, // Use actual value from Firestore
                        serviceFeeFixed: feeConfig.serviceFeeFixed || 0.5, // Use actual value from Firestore
                        feeType: feeConfig.feeType || 'hybrid',
                        isNegotiated: feeConfig.isNegotiated || false,
                        taxRate: feeConfig.taxRate || 0.09,
                        minimumOrderAmount: feeConfig.minimumOrderAmount || 0
                    };
                    console.log('‚úÖ Global fee config loaded from Firestore:', globalFeeConfig);
                    console.log('üí° Platform fee will display as:', globalFeeConfig.serviceFeeFixed ? `${globalFeeConfig.serviceFeeFixed.toFixed(2)}` : '', 
                               globalFeeConfig.serviceFeePercentage ? `${globalFeeConfig.serviceFeePercentage}%` : '');
                } else {
                    console.error('‚ùå NO FEE CONFIG FOUND - USING HARDCODED DEFAULTS');
                    console.error('‚ùå This is why you see hardcoded values in the UI!');
                    console.log('üîç Debug info:');
                    console.log('   - VediAPI available:', typeof window.VediAPI !== 'undefined');
                    console.log('   - Firebase.db available:', !!Firebase.db);
                    console.log('   - Restaurants loaded:', allRestaurants.length);
                }
            } catch (error) {
                console.error('‚ùå Error loading fee config:', error);
                console.error('‚ùå FALLING BACK TO HARDCODED DEFAULTS - THIS IS THE PROBLEM!');
            }
        }

        // Load restaurants data using VediAPI
        async function loadRestaurantsData() {
            console.log('üìä Loading restaurants data for venue:', currentVenue.id);
            
            try {
                // Get restaurants associated with this venue using VediAPI
                allRestaurants = await VediAPI.getRestaurantsByVenue(currentVenue.id);
                console.log('üìç Found restaurants:', allRestaurants.length);
                
                // Store original fee rates
                allRestaurants.forEach(restaurant => {
                    const currentFee = restaurant.venueFeePercentage || currentVenue.defaultFeePercentage || 1.0;
                    originalFeeRates[restaurant.id] = currentFee;
                    console.log(`üí≥ ${restaurant.name}: ${currentFee}% venue fee rate`);
                });
                
                console.log('‚úÖ Loaded restaurants for financials:', {
                    count: allRestaurants.length,
                    originalFeeRates: originalFeeRates
                });
                
                // IMPORTANT: Load fee configurations for all restaurants after loading restaurants
                console.log('üìã Loading fee configurations for all restaurants...');
                await loadFeeConfigsForRestaurants();
                
            } catch (error) {
                console.error('‚ùå Error loading restaurants:', error);
                console.error('‚ùå Restaurant loading error details:', {
                    venueId: currentVenue.id,
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
                allRestaurants = [];
            }
        }

        // NEW: Load fee configurations for all restaurants in the venue
        async function loadFeeConfigsForRestaurants() {
            console.log('üîß Loading fee configurations for', allRestaurants.length, 'restaurants');
            
            try {
                for (const restaurant of allRestaurants) {
                    console.log(`üìã Loading fee config for ${restaurant.name} (${restaurant.id})`);
                    
                    try {
                        // Try to get restaurant-specific fee config
                        const restaurantConfigDoc = await Firebase.db.collection('feeConfigurations').doc(restaurant.id).get();
                        
                        if (restaurantConfigDoc.exists) {
                            const feeConfig = restaurantConfigDoc.data();
                            console.log(`‚úÖ Found fee config for ${restaurant.name}:`, feeConfig);
                            
                            // Store the fee config for this restaurant
                            restaurant.feeConfig = feeConfig;
                        } else {
                            console.log(`‚ö†Ô∏è No specific fee config for ${restaurant.name}, will use default`);
                            
                            // Set default fee config
                            restaurant.feeConfig = {
                                serviceFeeFixed: 0.5,
                                serviceFeePercentage: 6,
                                feeType: 'hybrid',
                                stripeFeePercentage: 2.9,
                                stripeFlatFee: 30,
                                taxRate: 0.09,
                                isDefault: true
                            };
                        }
                    } catch (error) {
                        console.error(`‚ùå Error loading fee config for ${restaurant.name}:`, error);
                        
                        // Set fallback fee config
                        restaurant.feeConfig = {
                            serviceFeeFixed: 0.5,
                            serviceFeePercentage: 6,
                            feeType: 'hybrid',
                            stripeFeePercentage: 2.9,
                            stripeFlatFee: 30,
                            taxRate: 0.09,
                            isDefault: true,
                            isFallback: true
                        };
                    }
                }
                
                console.log('‚úÖ Loaded fee configurations for all restaurants');
                
                // Update global config with the first restaurant's config as default
                if (allRestaurants.length > 0 && allRestaurants[0].feeConfig) {
                    const firstConfig = allRestaurants[0].feeConfig;
                    globalFeeConfig = {
                        stripeFeePercentage: firstConfig.stripeFeePercentage || 2.9,
                        stripeFlatFee: firstConfig.stripeFlatFee || 30,
                        serviceFeePercentage: firstConfig.serviceFeePercentage || 6,
                        serviceFeeFixed: firstConfig.serviceFeeFixed || 0.5,
                        feeType: firstConfig.feeType || 'hybrid',
                        isNegotiated: firstConfig.isNegotiated || false,
                        taxRate: firstConfig.taxRate || 0.09
                    };
                    
                    console.log('üîÑ Updated global fee config from restaurant data:', globalFeeConfig);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading fee configurations for restaurants:', error);
            }
        }

        // Load revenue data for each restaurant using VediAPI
        async function loadRevenueData() {
            console.log('üí∞ Starting revenue data loading for', allRestaurants.length, 'restaurants');
            
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                console.log('üìÖ Loading orders from:', thirtyDaysAgo.toISOString());
                
                for (const restaurant of allRestaurants) {
                    try {
                        console.log(`üìä Loading orders for ${restaurant.name} (${restaurant.id})`);
                        
                        // Get orders for the last 30 days using VediAPI
                        const orders = await VediAPI.getOrders(restaurant.id, {
                            limit: 1000, // Get more orders for better data
                            orderBy: 'createdAt'
                        });
                        
                        console.log(`üì¶ Found ${orders.length} total orders for ${restaurant.name}`);
                        
                        // Filter orders to last 30 days and completed status
                        const recentOrders = orders.filter(order => {
                            const orderDate = VediAPI.timestampToDate(order.createdAt);
                            return orderDate >= thirtyDaysAgo && order.status === 'completed';
                        });
                        
                        // Calculate monthly revenue
                        const monthlyRevenue = recentOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                        monthlyRevenueData[restaurant.id] = monthlyRevenue;
                        
                        console.log(`üí∞ ${restaurant.name}: $${monthlyRevenue.toFixed(2)} (${recentOrders.length} completed orders)`);
                        
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Failed to load revenue for ${restaurant.name}:`, error);
                        monthlyRevenueData[restaurant.id] = 0;
                    }
                }
                
                console.log('‚úÖ Loaded revenue data for all restaurants:', monthlyRevenueData);
                
            } catch (error) {
                console.error('‚ùå Error loading revenue data:', error);
                console.error('‚ùå Revenue loading error details:', {
                    restaurantCount: allRestaurants.length,
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // Enhanced fee calculation using global fee config
        async function calculateCompleteFeeSplit(restaurantId, displayFee, monthlyRevenue) {
            console.log('üßÆ Calculating complete fee split for:', { restaurantId, displayFee, monthlyRevenue });
            
            try {
                // Calculate based on actual order data
                const totalOrders = 40; // Use actual data from your venue financials
                const averageOrderValue = totalOrders > 0 ? monthlyRevenue / totalOrders : 77.31; // Fallback to your data
                
                console.log('üìä Using order data:', { averageOrderValue, totalOrders });
                
                // Step 1: Calculate Stripe fees (always percentage + flat fee)
                const stripeFeePercentage = globalFeeConfig.stripeFeePercentage / 100;
                const stripeFlatFee = globalFeeConfig.stripeFlatFee / 100; // Convert cents to dollars
                const stripeFeeAmount = (averageOrderValue * stripeFeePercentage) + stripeFlatFee;
                const netAfterStripe = averageOrderValue - stripeFeeAmount;
                
                console.log('üí≥ Stripe calculation:', {
                    percentage: `${globalFeeConfig.stripeFeePercentage}%`,
                    flatFee: `${globalFeeConfig.stripeFlatFee}¬¢`,
                    totalStripeFee: stripeFeeAmount,
                    netAfterStripe: netAfterStripe
                });
                
                // Step 2: Calculate platform/service fee
                let platformFeeAmount = 0;
                let platformFeeDisplay = '';
                
                // Dynamic platform fee display logic
                const hasFixed = globalFeeConfig.serviceFeeFixed && globalFeeConfig.serviceFeeFixed > 0;
                const hasPercentage = globalFeeConfig.serviceFeePercentage && globalFeeConfig.serviceFeePercentage > 0;
                
                if (hasFixed && hasPercentage) {
                    // Hybrid: both fixed and percentage
                    const fixedPart = globalFeeConfig.serviceFeeFixed;
                    const percentagePart = netAfterStripe * (globalFeeConfig.serviceFeePercentage / 100);
                    platformFeeAmount = fixedPart + percentagePart;
                    platformFeeDisplay = `${fixedPart.toFixed(2)} + ${globalFeeConfig.serviceFeePercentage}%`;
                } else if (hasFixed && !hasPercentage) {
                    // Fixed only
                    platformFeeAmount = globalFeeConfig.serviceFeeFixed;
                    platformFeeDisplay = `${globalFeeConfig.serviceFeeFixed.toFixed(2)}`;
                } else if (!hasFixed && hasPercentage) {
                    // Percentage only
                    platformFeeAmount = netAfterStripe * (globalFeeConfig.serviceFeePercentage / 100);
                    platformFeeDisplay = `${globalFeeConfig.serviceFeePercentage}%`;
                } else {
                    // Fallback to default
                    platformFeeAmount = netAfterStripe * 0.035;
                    platformFeeDisplay = '3.5% (default)';
                }
                
                console.log('‚ö° Platform fee calculation:', {
                    type: globalFeeConfig.feeType,
                    amount: platformFeeAmount,
                    display: platformFeeDisplay
                });
                
                // Step 3: Calculate venue fee (always percentage)
                const venueFeeAmount = netAfterStripe * (displayFee / 100);
                
                // Step 4: Restaurant gets the remainder
                const restaurantAmount = netAfterStripe - platformFeeAmount - venueFeeAmount;
                
                // Calculate percentages for display purposes
                const breakdown = {
                    restaurant: {
                        percentage: (restaurantAmount / averageOrderValue) * 100,
                        amount: restaurantAmount,
                        monthlyAmount: monthlyRevenue * (restaurantAmount / averageOrderValue)
                    },
                    venue: {
                        percentage: (venueFeeAmount / averageOrderValue) * 100,
                        amount: venueFeeAmount,
                        monthlyAmount: monthlyRevenue * (venueFeeAmount / averageOrderValue),
                        configuredPercentage: displayFee,
                        displayText: `${displayFee}%`
                    },
                    platform: {
                        percentage: (platformFeeAmount / averageOrderValue) * 100,
                        amount: platformFeeAmount,
                        monthlyAmount: monthlyRevenue * (platformFeeAmount / averageOrderValue),
                        displayText: platformFeeDisplay,
                        // Dynamic fee structure - same logic as calculation
                        hasFixed: hasFixed,
                        hasPercentage: hasPercentage,
                        configuredFixed: globalFeeConfig.serviceFeeFixed || 0,
                        configuredPercentage: globalFeeConfig.serviceFeePercentage || 0
                    },
                    stripe: {
                        percentage: (stripeFeeAmount / averageOrderValue) * 100,
                        amount: stripeFeeAmount,
                        monthlyAmount: monthlyRevenue * (stripeFeeAmount / averageOrderValue),
                        configuredPercentage: globalFeeConfig.stripeFeePercentage,
                        configuredFlatFee: globalFeeConfig.stripeFlatFee,
                        isNegotiated: globalFeeConfig.isNegotiated,
                        displayText: `${globalFeeConfig.stripeFeePercentage}% + ${globalFeeConfig.stripeFlatFee}¬¢`
                    },
                    averageOrderValue: averageOrderValue,
                    totalOrders: totalOrders,
                    netAfterStripe: netAfterStripe,
                    feeConfig: globalFeeConfig
                };
                
                console.log('üí∞ Complete fee breakdown calculated:', breakdown);
                return breakdown;
                
            } catch (error) {
                console.error('‚ùå Error calculating fee split:', error);
                return getDefaultFeeBreakdown(displayFee, monthlyRevenue);
            }
        }

        // Enhanced default breakdown for error cases
        function getDefaultFeeBreakdown(displayFee, monthlyRevenue) {
            return {
                restaurant: { 
                    percentage: 85, 
                    amount: 85, 
                    monthlyAmount: monthlyRevenue * 0.85 
                },
                venue: { 
                    percentage: displayFee, 
                    amount: displayFee, 
                    monthlyAmount: monthlyRevenue * (displayFee / 100),
                    configuredPercentage: displayFee,
                    displayText: `${displayFee}%`
                },
                platform: { 
                    percentage: 3.5, 
                    amount: 3.5, 
                    monthlyAmount: monthlyRevenue * 0.035,
                    displayText: '$0.50 (default)',
                    feeType: 'fixed',
                    configuredFixed: 0.50,
                    configuredPercentage: 3.5
                },
                stripe: { 
                    percentage: 3.2, 
                    amount: 3.2, 
                    monthlyAmount: monthlyRevenue * 0.032,
                    configuredPercentage: 2.9,
                    configuredFlatFee: 30,
                    isNegotiated: false,
                    displayText: '2.9% + 30¬¢ (default)'
                },
                netAfterStripe: 96.8,
                feeConfig: globalFeeConfig
            };
        }

        // Update the fee breakdown display to show actual fee structures
        async function updateFeeBreakdown(restaurantId, displayFee, monthlyRevenue, orderCount = 0) {
            console.log('üîÑ Updating fee breakdown UI for:', restaurantId);
            
            try {
                const breakdown = await calculateCompleteFeeSplit(restaurantId, displayFee, monthlyRevenue);
                
                // Update restaurant percentage (calculated)
                document.getElementById(`restaurant-split-${restaurantId}`).textContent = 
                    breakdown.restaurant.percentage.toFixed(1) + '%';
                
                // Update venue percentage (user-configurable)
                document.getElementById(`venue-split-${restaurantId}`).textContent = 
                    breakdown.venue.displayText;
                
                // Update platform fee showing actual structure from admin settings
                document.getElementById(`platform-split-${restaurantId}`).textContent = 
                    breakdown.platform.displayText;
                
                // Update Stripe fee showing actual structure from admin settings
                document.getElementById(`stripe-split-${restaurantId}`).textContent = 
                    breakdown.stripe.displayText;
                
                console.log('üí≥ Displaying dynamic fee structure from admin settings:', {
                    platform: breakdown.platform.displayText,
                    stripe: breakdown.stripe.displayText,
                    venue: breakdown.venue.displayText,
                    restaurant: breakdown.restaurant.percentage.toFixed(1) + '%'
                });
                
                // Update monthly earnings breakdown
                document.getElementById(`restaurant-earnings-${restaurantId}`).textContent = 
                    formatPrice(breakdown.restaurant.monthlyAmount);
                document.getElementById(`platform-earnings-${restaurantId}`).textContent = 
                    formatPrice(breakdown.platform.monthlyAmount);
                
                // Update order statistics
                document.getElementById(`order-count-${restaurantId}`).textContent = orderCount;
                document.getElementById(`avg-order-${restaurantId}`).textContent = 
                    formatPrice(breakdown.averageOrderValue);
                
                console.log('‚úÖ Fee breakdown UI updated with admin-configured fees');
                
            } catch (error) {
                console.error('‚ùå Error updating fee breakdown:', error);
            }
        }

        // Update overview cards
        function updateOverviewCards() {
            console.log('üìä Updating overview cards...');
            
            // Calculate total venue revenue
            let totalVenueRevenue = 0;
            let totalFeeRate = 0;
            let activeCount = 0;

            allRestaurants.forEach(restaurant => {
                const revenue = monthlyRevenueData[restaurant.id] || 0;
                const feeRate = (pendingChanges[restaurant.id] !== undefined ? 
                    pendingChanges[restaurant.id] : 
                    originalFeeRates[restaurant.id] || currentVenue.defaultFeePercentage || 1.0) / 100;
                
                totalVenueRevenue += revenue * feeRate;
                totalFeeRate += originalFeeRates[restaurant.id] || currentVenue.defaultFeePercentage || 1.0;
                activeCount++;
            });

            const averageFeeRate = activeCount > 0 ? totalFeeRate / activeCount : 0;
            const pendingChangesCount = Object.keys(pendingChanges).length;

            console.log('üìà Overview calculations:', {
                totalVenueRevenue,
                averageFeeRate,
                activeCount,
                pendingChangesCount
            });

            // Update cards
            document.getElementById('monthlyVenueRevenue').textContent = formatPrice(totalVenueRevenue);
            document.getElementById('averageFeeRate').textContent = averageFeeRate.toFixed(1) + '%';
            document.getElementById('activeRestaurants').textContent = activeCount.toString();
            document.getElementById('pendingChanges').textContent = pendingChangesCount.toString();

            // Update save button state
            const saveBtn = document.getElementById('saveAllBtn');
            saveBtn.disabled = pendingChangesCount === 0;
            if (pendingChangesCount > 0) {
                saveBtn.textContent = `Save ${pendingChangesCount} Changes`;
            } else {
                saveBtn.textContent = 'Save All Changes';
            }

            console.log('‚úÖ Overview cards updated');
        }

        // Render restaurants table with real data and proper fee displays
        function renderRestaurantsTable() {
            console.log('üè™ Rendering restaurants table...');
            const tbody = document.getElementById('restaurantsTableBody');
            
            if (allRestaurants.length === 0) {
                console.log('‚ö†Ô∏è No restaurants to display');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #718096;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üè™</div>
                            <div style="font-weight: 600; margin-bottom: 8px;">No restaurants connected</div>
                            <div>Use the restaurant-venue sync system to connect restaurants to your venue</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Create async function to handle platform fee loading
            const renderRows = async () => {
                console.log('üîÑ Building restaurant table rows...');
                
                const rows = await Promise.all(allRestaurants.map(async (restaurant) => {
                    const currentFee = originalFeeRates[restaurant.id] || currentVenue.defaultFeePercentage || 1.0;
                    const pendingFee = pendingChanges[restaurant.id];
                    const displayFee = pendingFee !== undefined ? pendingFee : currentFee;
                    const monthlyRevenue = monthlyRevenueData[restaurant.id] || 0;
                    const monthlyEarnings = monthlyRevenue * (displayFee / 100);
                    const hasChanges = pendingFee !== undefined;
                    const currency = restaurant.currency || { symbol: '$', code: 'USD' };
                    
                    console.log(`üè™ Building row for ${restaurant.name}:`, {
                        currentFee,
                        displayFee,
                        monthlyRevenue,
                        monthlyEarnings,
                        hasChanges
                    });

                    return `
                        <tr>
                            <td>
                                <div class="restaurant-info">
                                    <div class="restaurant-avatar">
                                        ${restaurant.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="restaurant-details">
                                        <h4>${restaurant.name}</h4>
                                        <div class="restaurant-meta">
                                            ${restaurant.cuisineType || 'Restaurant'} ‚Ä¢ 
                                            ${currency.code} ‚Ä¢ 
                                            ${restaurant.status || 'Active'}
                                            ${restaurant.address ? ` ‚Ä¢ ${restaurant.address}` : ''}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="fee-breakdown-container">
                                    <div class="fee-control">
                                        <label style="font-size: 0.75rem; color: #4a5568; font-weight: 600; text-transform: uppercase;">Venue Fee</label>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <input 
                                                type="number" 
                                                class="fee-input ${hasChanges ? 'changed' : ''}" 
                                                value="${displayFee.toFixed(1)}" 
                                                step="0.1" 
                                                min="0" 
                                                max="10"
                                                onchange="handleFeeChange('${restaurant.id}', this.value)"
                                                id="fee-${restaurant.id}"
                                            >
                                            <span class="fee-suffix">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="revenue-split-breakdown" style="background: #f8fafc; border-radius: 8px; padding: 12px; margin-top: 8px; border: 1px solid #e2e8f0;">
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #4a5568; margin-bottom: 8px; text-transform: uppercase;">Revenue Split per Avg Order</div>
                                        <div class="split-items">
                                            <div class="split-item" style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                <span style="font-size: 0.8rem; color: #2d3748;">Restaurant:</span>
                                                <span style="font-size: 0.8rem; font-weight: 600; color: #2d3748;" id="restaurant-split-${restaurant.id}">Loading...</span>
                                            </div>
                                            <div class="split-item" style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                <span style="font-size: 0.8rem; color: #667eea;">Venue:</span>
                                                <span style="font-size: 0.8rem; font-weight: 600; color: #667eea;" id="venue-split-${restaurant.id}">${displayFee}%</span>
                                            </div>
                                            <div class="split-item" style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                <span style="font-size: 0.8rem; color: #f59e0b;">Platform:</span>
                                                <span style="font-size: 0.8rem; font-weight: 600; color: #f59e0b;" id="platform-split-${restaurant.id}">Loading...</span>
                                            </div>
                                            <div class="split-item" style="display: flex; justify-content: space-between; border-top: 1px solid #e2e8f0; padding-top: 4px;">
                                                <span style="font-size: 0.8rem; color: #6b7280;">Stripe:</span>
                                                <span style="font-size: 0.8rem; font-weight: 600; color: #6b7280;" id="stripe-split-${restaurant.id}">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="revenue-amount">${formatPrice(monthlyRevenue, currency)}</div>
                                <span class="revenue-period">Last 30 days</span>
                                <div style="margin-top: 8px; font-size: 0.8rem; color: #4a5568;">
                                    <div>Orders: <span id="order-count-${restaurant.id}">0</span></div>
                                    <div>Avg Order: <span id="avg-order-${restaurant.id}">$0</span></div>
                                </div>
                            </td>
                            <td>
                                <div class="earnings-breakdown">
                                    <div class="projected-amount">${formatPrice(monthlyEarnings, currency)}</div>
                                    <span class="revenue-period">${hasChanges ? '‚Ä¢ Projected' : '‚Ä¢ Current'}</span>
                                    
                                    <div style="margin-top: 12px; background: #f0f9ff; border-radius: 6px; padding: 8px; border: 1px solid #bae6fd;">
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #0369a1; margin-bottom: 6px;">Monthly Breakdown</div>
                                        <div style="font-size: 0.8rem; color: #0369a1; display: flex; justify-content: space-between;">
                                            <span>Your Share:</span>
                                            <span style="font-weight: 600;">${formatPrice(monthlyEarnings, currency)}</span>
                                        </div>
                                        <div style="font-size: 0.8rem; color: #6b7280; display: flex; justify-content: space-between;">
                                            <span>Restaurant:</span>
                                            <span id="restaurant-earnings-${restaurant.id}">$0</span>
                                        </div>
                                        <div style="font-size: 0.8rem; color: #6b7280; display: flex; justify-content: space-between;">
                                            <span>Platform:</span>
                                            <span id="platform-earnings-${restaurant.id}">$0</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge ${hasChanges ? 'changed' : 'active'}">
                                    ${hasChanges ? 'Changed' : 'Active'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    ${hasChanges ? `
                                        <button class="action-btn save" onclick="saveRestaurantFee('${restaurant.id}')">
                                            Save
                                        </button>
                                        <button class="action-btn cancel" onclick="cancelRestaurantChange('${restaurant.id}')">
                                            Cancel
                                        </button>
                                    ` : `
                                        <button class="action-btn view-details" onclick="showRevenueDetails('${restaurant.id}')" 
                                                style="background: #667eea; color: white; margin-bottom: 4px;">
                                            Details
                                        </button>
                                        <button class="action-btn" onclick="resetRestaurantFee('${restaurant.id}')" 
                                                style="background: #f7fafc; color: #4a5568;">
                                            Reset
                                        </button>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                }));

                tbody.innerHTML = rows.join('');
                console.log('‚úÖ Restaurant table rendered with', rows.length, 'rows');
                
                // Update fee breakdowns for all restaurants
                for (const restaurant of allRestaurants) {
                    const displayFee = pendingChanges[restaurant.id] !== undefined ? 
                        pendingChanges[restaurant.id] : 
                        originalFeeRates[restaurant.id] || currentVenue.defaultFeePercentage || 1.0;
                    const monthlyRevenue = monthlyRevenueData[restaurant.id] || 0;
                    
                    // Get order count for this restaurant
                    try {
                        const orders = await VediAPI.getOrders(restaurant.id, { limit: 1000 });
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        
                        const recentCompletedOrders = orders.filter(order => {
                            const orderDate = VediAPI.timestampToDate(order.createdAt);
                            return orderDate >= thirtyDaysAgo && order.status === 'completed';
                        });
                        
                        await updateFeeBreakdown(restaurant.id, displayFee, monthlyRevenue, recentCompletedOrders.length);
                    } catch (error) {
                        console.warn('Could not load order count for', restaurant.name, error);
                        await updateFeeBreakdown(restaurant.id, displayFee, monthlyRevenue, 0);
                    }
                }
            };

            renderRows();
        }

        // Show detailed revenue breakdown modal with compact design
        async function showRevenueDetails(restaurantId) {
            console.log('üìä Showing revenue details for:', restaurantId);
            
            try {
                const restaurant = allRestaurants.find(r => r.id === restaurantId);
                if (!restaurant) return;
                
                const displayFee = pendingChanges[restaurantId] !== undefined ? 
                    pendingChanges[restaurantId] : 
                    originalFeeRates[restaurantId] || currentVenue.defaultFeePercentage || 1.0;
                
                const monthlyRevenue = monthlyRevenueData[restaurantId] || 0;
                const breakdown = await calculateCompleteFeeSplit(restaurantId, displayFee, monthlyRevenue);
                
                // Create compact modal
                const modal = document.createElement('div');
                modal.id = 'revenue-details-modal';
                modal.className = 'revenue-modal';
                
                modal.innerHTML = `
                    <div class="revenue-modal-content">
                        <div class="modal-header">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: #2d3748; margin: 0;">üí∞ ${restaurant.name} Revenue Details</h3>
                            <button class="modal-close-btn" onclick="closeRevenueModal()">√ó</button>
                        </div>
                        
                        <div class="modal-body">
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: #4a5568;">Revenue Split Breakdown</h4>
                                <table class="breakdown-table">
                                    <thead>
                                        <tr>
                                            <th>Fee Component</th>
                                            <th>Structure</th>
                                            <th>Effective %</th>
                                            <th>Monthly $</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="font-weight: 600; color: #059669;">üè™ Restaurant Net</td>
                                            <td style="color: #6b7280;">After all fees</td>
                                            <td style="font-weight: 600; color: #059669;">${breakdown.restaurant.percentage.toFixed(1)}%</td>
                                            <td style="font-weight: 600; color: #059669;">${formatPrice(breakdown.restaurant.monthlyAmount)}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: 600; color: #667eea;">üè¢ Venue Fee</td>
                                            <td style="font-weight: 600; color: #667eea;">${breakdown.venue.displayText}</td>
                                            <td style="font-weight: 600; color: #667eea;">${breakdown.venue.percentage.toFixed(1)}%</td>
                                            <td style="font-weight: 600; color: #667eea;">${formatPrice(breakdown.venue.monthlyAmount)}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: 600; color: #f59e0b;">‚ö° Platform Fee</td>
                                            <td style="font-weight: 600; color: #f59e0b;">${breakdown.platform.displayText}</td>
                                            <td style="font-weight: 600; color: #f59e0b;">${breakdown.platform.percentage.toFixed(1)}%</td>
                                            <td style="font-weight: 600; color: #f59e0b;">${formatPrice(breakdown.platform.monthlyAmount)}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: 600; color: #6b7280;">üí≥ Stripe Processing</td>
                                            <td style="font-weight: 600; color: #6b7280;">${breakdown.stripe.displayText}</td>
                                            <td style="font-weight: 600; color: #6b7280;">${breakdown.stripe.percentage.toFixed(1)}%</td>
                                            <td style="font-weight: 600; color: #6b7280;">${formatPrice(breakdown.stripe.monthlyAmount)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: #4a5568;">Fee Configuration Details</h4>
                                <div style="background: #fef7ff; border-radius: 8px; padding: 1rem; border: 1px solid #e9d5ff;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div>
                                            <div style="font-size: 0.8rem; color: #7c3aed; font-weight: 600; margin-bottom: 0.25rem;">Platform Service Fee</div>
                                            <div style="font-size: 0.75rem; color: #64748b;">Type: ${breakdown.feeConfig?.feeType || 'percentage'}</div>
                                            ${breakdown.platform.configuredPercentage ? `<div style="font-size: 0.75rem; color: #64748b;">Rate: ${breakdown.platform.configuredPercentage}%</div>` : ''}
                                            ${breakdown.platform.configuredFixed ? `<div style="font-size: 0.75rem; color: #64748b;">Fixed: ${breakdown.platform.configuredFixed.toFixed(2)}</div>` : ''}
                                        </div>
                                        <div>
                                            <div style="font-size: 0.8rem; color: #7c3aed; font-weight: 600; margin-bottom: 0.25rem;">Stripe Processing</div>
                                            <div style="font-size: 0.75rem; color: #64748b;">Rate: ${breakdown.stripe.configuredPercentage}%</div>
                                            <div style="font-size: 0.75rem; color: #64748b;">Flat: ${breakdown.stripe.configuredFlatFee}¬¢</div>
                                            <div style="font-size: 0.75rem; color: #64748b;">${breakdown.stripe.isNegotiated ? 'Negotiated' : 'Standard'}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="padding-top: 0.75rem; border-top: 1px solid #e9d5ff;">
                                        <div style="font-size: 0.8rem; color: #7c3aed; font-weight: 600; margin-bottom: 0.25rem;">Venue Fee (Your Control)</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">Rate: ${breakdown.venue.configuredPercentage}% (editable) ‚Ä¢ Applied to net after Stripe</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f0f9ff; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #bae6fd;">
                                <div style="font-size: 0.8rem; color: #0369a1;">üìù Platform and Stripe fees are configured in admin dashboard. Only venue fees can be adjusted here.</div>
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button onclick="closeRevenueModal()" style="padding: 0.5rem 1rem; background: #f1f5f9; border: none; border-radius: 6px; color: #4a5568; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeRevenueModal();
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error showing revenue details:', error);
                showError('Failed to load revenue details');
            }
        }

        // Close revenue details modal
        function closeRevenueModal() {
            const modal = document.getElementById('revenue-details-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle fee change for a restaurant
        function handleFeeChange(restaurantId, newFee) {
            console.log('üí∞ Fee change triggered:', { restaurantId, newFee });
            
            const originalFee = originalFeeRates[restaurantId];
            const feeValue = parseFloat(newFee);
            
            console.log('üîÑ Comparing fees:', { originalFee, feeValue });
            
            if (Math.abs(feeValue - originalFee) < 0.01) {
                // Fee is back to original, remove from pending changes
                delete pendingChanges[restaurantId];
                console.log('‚úÖ Fee reset to original, removed from pending changes');
            } else {
                // Fee has changed, add to pending changes
                pendingChanges[restaurantId] = feeValue;
                console.log('üìù Fee changed, added to pending changes');
            }
            
            console.log('üìä Current pending changes:', pendingChanges);
            
            // Update UI
            updateOverviewCards();
            renderRestaurantsTable();
        }

        // Save individual restaurant fee
        async function saveRestaurantFee(restaurantId) {
            console.log('üíæ Saving fee for restaurant:', restaurantId);
            
            try {
                const newFee = pendingChanges[restaurantId];
                if (newFee === undefined) {
                    console.log('‚ö†Ô∏è No pending fee change found for restaurant:', restaurantId);
                    return;
                }
                
                console.log('üìù Updating restaurant with new fee:', { restaurantId, newFee });
                
                // Update restaurant venue fee using VediAPI
                await VediAPI.updateRestaurant(restaurantId, {
                    venueFeePercentage: newFee,
                    feeLastUpdated: new Date().toISOString(),
                    feeUpdatedBy: currentUser.id
                });
                
                // Update original fee and remove from pending
                originalFeeRates[restaurantId] = newFee;
                delete pendingChanges[restaurantId];
                
                console.log('‚úÖ Fee saved successfully for restaurant:', restaurantId);
                
                // Update UI
                updateOverviewCards();
                renderRestaurantsTable();
                
                showSuccess(`Fee updated for restaurant`);
                
            } catch (error) {
                console.error('‚ùå Error saving restaurant fee:', error);
                console.error('‚ùå Save error details:', {
                    restaurantId,
                    newFee: pendingChanges[restaurantId],
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
                showError('Failed to save fee: ' + error.message);
            }
        }

        // Cancel individual restaurant change
        function cancelRestaurantChange(restaurantId) {
            console.log('‚ùå Cancelling fee change for restaurant:', restaurantId);
            
            delete pendingChanges[restaurantId];
            
            // Reset the input value
            const input = document.getElementById(`fee-${restaurantId}`);
            if (input) {
                input.value = originalFeeRates[restaurantId].toFixed(1);
                console.log('üîÑ Reset input value to:', originalFeeRates[restaurantId]);
            }
            
            updateOverviewCards();
            renderRestaurantsTable();
            
            showSuccess('Changes cancelled');
        }

        // Reset restaurant fee to venue default
        async function resetRestaurantFee(restaurantId) {
            console.log('üîÑ Resetting fee to venue default for restaurant:', restaurantId);
            
            try {
                const defaultFee = currentVenue.defaultFeePercentage || 1.0;
                console.log('üìã Using venue default fee:', defaultFee);
                
                await VediAPI.updateRestaurant(restaurantId, {
                    venueFeePercentage: defaultFee,
                    feeLastUpdated: new Date().toISOString(),
                    feeUpdatedBy: currentUser.id
                });
                
                originalFeeRates[restaurantId] = defaultFee;
                delete pendingChanges[restaurantId];
                
                console.log('‚úÖ Fee reset to venue default successfully');
                
                updateOverviewCards();
                renderRestaurantsTable();
                
                showSuccess('Fee reset to venue default');
                
            } catch (error) {
                console.error('‚ùå Error resetting restaurant fee:', error);
                console.error('‚ùå Reset error details:', {
                    restaurantId,
                    defaultFee: currentVenue.defaultFeePercentage,
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
                showError('Failed to reset fee: ' + error.message);
            }
        }

        // Save all pending changes
        async function saveAllChanges() {
            console.log('üíæ Saving all pending changes...');
            
            try {
                const changeCount = Object.keys(pendingChanges).length;
                if (changeCount === 0) {
                    console.log('‚ö†Ô∏è No pending changes to save');
                    return;
                }
                
                console.log('üìù Saving changes for', changeCount, 'restaurants:', pendingChanges);
                showLoading(`Saving ${changeCount} changes...`);
                
                // Save all changes in parallel
                const savePromises = Object.entries(pendingChanges).map(([restaurantId, newFee]) => {
                    console.log(`üíæ Preparing to save ${restaurantId}: ${newFee}%`);
                    return VediAPI.updateRestaurant(restaurantId, {
                        venueFeePercentage: newFee,
                        feeLastUpdated: new Date().toISOString(),
                        feeUpdatedBy: currentUser.id
                    });
                });
                
                await Promise.all(savePromises);
                console.log('‚úÖ All save operations completed');
                
                // Update original fees and clear pending changes
                Object.entries(pendingChanges).forEach(([restaurantId, newFee]) => {
                    originalFeeRates[restaurantId] = newFee;
                    console.log(`üìù Updated original fee for ${restaurantId}: ${newFee}%`);
                });
                pendingChanges = {};
                
                // Update UI
                updateOverviewCards();
                renderRestaurantsTable();
                
                hideLoading();
                console.log('‚úÖ All changes saved successfully!');
                showSuccess(`All ${changeCount} changes saved successfully!`);
                
            } catch (error) {
                console.error('‚ùå Error saving all changes:', error);
                console.error('‚ùå Bulk save error details:', {
                    pendingChanges: Object.keys(pendingChanges),
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
                showError('Failed to save changes: ' + error.message);
                hideLoading();
            }
        }

        // Reset all pending changes
        function resetAllChanges() {
            console.log('üîÑ Resetting all pending changes...');
            
            if (Object.keys(pendingChanges).length === 0) {
                console.log('‚ö†Ô∏è No pending changes to reset');
                return;
            }
            
            if (!confirm('Are you sure you want to reset all pending changes?')) {
                console.log('‚ùå User cancelled reset operation');
                return;
            }
            
            console.log('üìù Resetting pending changes:', pendingChanges);
            pendingChanges = {};
            
            // Reset all input values
            allRestaurants.forEach(restaurant => {
                const input = document.getElementById(`fee-${restaurant.id}`);
                if (input) {
                    input.value = originalFeeRates[restaurant.id].toFixed(1);
                    console.log(`üîÑ Reset input for ${restaurant.name}: ${originalFeeRates[restaurant.id]}%`);
                }
            });
            
            updateOverviewCards();
            renderRestaurantsTable();
            
            console.log('‚úÖ All changes reset');
            showSuccess('All changes reset');
        }

        // Enhanced revenue calculator with all fee components
        async function updateCalculation() {
            console.log('üßÆ Updating revenue calculation...');
            
            const orderValue = parseFloat(document.getElementById('calcOrderValue').value) || 0;
            const ordersPerDay = parseInt(document.getElementById('calcOrdersPerDay').value) || 0;
            const feeRate = parseFloat(document.getElementById('calcVenueFeeRate').value) || 0;
            
            const dailyRevenue = orderValue * ordersPerDay;
            const monthlyRevenue = dailyRevenue * 30;
            
            // Calculate fees using global config
            const stripeFeePercentage = globalFeeConfig.stripeFeePercentage / 100;
            const stripeFlatFee = globalFeeConfig.stripeFlatFee / 100;
            const stripeFeeAmount = (orderValue * stripeFeePercentage) + stripeFlatFee;
            const netAfterStripe = orderValue - stripeFeeAmount;
            
            // Platform fee calculation - dynamic display like Stripe
            let platformFeeAmount = 0;
            const hasFixed = globalFeeConfig.serviceFeeFixed && globalFeeConfig.serviceFeeFixed > 0;
            const hasPercentage = globalFeeConfig.serviceFeePercentage && globalFeeConfig.serviceFeePercentage > 0;
            
            if (hasFixed && hasPercentage) {
                // Hybrid: both fixed and percentage
                const fixedPart = globalFeeConfig.serviceFeeFixed;
                const percentagePart = netAfterStripe * (globalFeeConfig.serviceFeePercentage / 100);
                platformFeeAmount = fixedPart + percentagePart;
            } else if (hasFixed && !hasPercentage) {
                // Fixed only
                platformFeeAmount = globalFeeConfig.serviceFeeFixed;
            } else if (!hasFixed && hasPercentage) {
                // Percentage only
                platformFeeAmount = netAfterStripe * (globalFeeConfig.serviceFeePercentage / 100);
            } else {
                // Fallback
                platformFeeAmount = netAfterStripe * 0.035;
            }
            
            // Venue fee and restaurant net
            const venueFeeAmount = netAfterStripe * (feeRate / 100);
            const restaurantAmount = netAfterStripe - platformFeeAmount - venueFeeAmount;
            
            // Daily calculations
            const dailyStripe = stripeFeeAmount * ordersPerDay;
            const dailyPlatform = platformFeeAmount * ordersPerDay;
            const dailyVenue = venueFeeAmount * ordersPerDay;
            const dailyRestaurant = restaurantAmount * ordersPerDay;
            
            // Monthly calculations
            const monthlyVenue = dailyVenue * 30;
            
            console.log('üìä Calculator values:', {
                orderValue,
                ordersPerDay,
                feeRate,
                dailyRevenue,
                dailyStripe,
                dailyPlatform,
                dailyVenue,
                dailyRestaurant,
                monthlyRevenue,
                monthlyVenue
            });
            
            // Update display
            document.getElementById('calcDailyRevenue').textContent = formatPrice(dailyRevenue);
            document.getElementById('calcRestaurantDaily').textContent = formatPrice(dailyRestaurant);
            document.getElementById('calcDailyEarnings').textContent = formatPrice(dailyVenue);
            document.getElementById('calcPlatformDaily').textContent = formatPrice(dailyPlatform);
            document.getElementById('calcStripeDaily').textContent = formatPrice(dailyStripe);
            document.getElementById('calcMonthlyEarnings').textContent = formatPrice(monthlyVenue);
            
            console.log('‚úÖ Enhanced calculator updated with all fee components');
        }

        // Utility functions
       function formatPrice(amount, currency = null) {
    if (!currency) {
        currency = { symbol: '$', code: 'USD' };
    }
    const formattedAmount = Number(amount || 0).toFixed(2);
    return `${currency.symbol}${formattedAmount}`;
}

        function showLoading(message = 'Loading...') {
            console.log('‚è≥ Showing loading:', message);
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('.loading-text');
            text.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            console.log('‚úÖ Hiding loading overlay');
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showNotification(message, type = 'success') {
            console.log(`üì¢ Showing ${type} notification:`, message);
            const notification = document.getElementById('notification');
            notification.className = `notification ${type}`;
            notification.innerHTML = `${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}`;
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        console.log('üí∞ Enhanced Venue Financials page loaded');
        console.log('üîß Features: Restaurant fee management, enhanced revenue calculator, bulk operations');
        console.log('üìä Integration: VenueSync API, real-time fee updates, Stripe payment splitting');
        console.log('üí≥ Enhanced: Dynamic fee display with admin dashboard configuration');
        console.log('üßÆ Calculator: Now shows all fee components (Restaurant, Venue, Platform, Stripe)');
    </script>
</body>
</html>
