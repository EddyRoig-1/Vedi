<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loss Tracking - Venue Admin Dashboard</title>
    
    <!-- Firebase SDK Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<!-- Firebase Configuration -->
<script src="../firebase-config.js"></script>

<!-- Core Modules -->
<script src="../Api/core/firebase-init.js"></script>
<script src="../Api/core/utilities.js"></script>
<script src="../Api/core/tracking.js"></script>

<!-- Authentication Modules -->
<script src="../Api/auth/email-auth.js"></script>

<!-- Business Modules -->
<script src="../Api/business/restaurants.js"></script>
<script src="../Api/business/venues.js"></script>

<!-- Operations Modules -->
<script src="../Api/operations/loss-incidents.js"></script>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1a202c;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading-spinner.show {
            display: block;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #feb2b2;
            display: none;
        }

        .loss-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f7fafc;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loss-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .loss-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            border-left: 4px solid #e53e3e;
            transition: all 0.3s ease;
        }

        .loss-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .loss-card.recall {
            border-left-color: #d69e2e;
        }

        .loss-card.accident {
            border-left-color: #e53e3e;
        }

        .loss-card.walkout {
            border-left-color: #805ad5;
        }

        .loss-card.theft {
            border-left-color: #f56565;
        }

        .loss-card.waste {
            border-left-color: #38a169;
        }

        .loss-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .loss-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e53e3e;
            margin-bottom: 8px;
        }

        .loss-incidents {
            font-size: 0.9rem;
            color: #718096;
        }

        .loss-trend {
            font-size: 0.8rem;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .trend-up {
            background: #fed7d7;
            color: #742a2a;
        }

        .trend-down {
            background: #c6f6d5;
            color: #22543d;
        }

        .trend-stable {
            background: #e2e8f0;
            color: #4a5568;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-low {
            background: #c6f6d5;
            color: #22543d;
        }

        .severity-medium {
            background: #faf089;
            color: #744210;
        }

        .severity-high {
            background: #feb2b2;
            color: #742a2a;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-reported {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-investigating {
            background: #faf089;
            color: #744210;
        }

        .status-resolved {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-closed {
            background: #e2e8f0;
            color: #4a5568;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            height: 350px;
            position: relative;
        }

        .filter-bar {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .recent-incidents {
            max-height: 400px;
            overflow-y: auto;
        }

        .incident-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .incident-item:hover {
            background: #f7fafc;
        }

        .incident-info {
            flex: 1;
        }

        .incident-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .incident-meta {
            font-size: 0.9rem;
            color: #718096;
        }

        .incident-amount {
            font-weight: 700;
            color: #e53e3e;
            font-size: 1.1rem;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #718096;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .loss-categories {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .chart-container {
                height: 250px;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üìâ Loss Tracking</h1>
            <a href="venue-admin-dashboard.html" class="back-btn">‚Üê Back to Main</a>
        </div>
    </div>

    <div class="container">
        <!-- Loading State -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading loss tracking data...</p>
        </div>

        <!-- Error State -->
        <div id="errorMessage" class="error-message">
            <strong>Error:</strong> <span id="errorText"></span>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Loss Tracking Filters -->
            <div class="filter-bar">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Time Period</label>
                        <select class="filter-select" id="timePeriod">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Restaurant</label>
                        <select class="filter-select" id="restaurantFilter">
                            <option value="all">All Restaurants</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Loss Type</label>
                        <select class="filter-select" id="lossType">
                            <option value="all">All Types</option>
                            <option value="theft">Theft</option>
                            <option value="accident">Accidents</option>
                            <option value="walkout">Walkouts</option>
                            <option value="recall">Recalls</option>
                            <option value="waste">Food Waste</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="applyLossFilters()" id="applyFiltersBtn">üîç Apply Filters</button>
                    </div>
                </div>
            </div>

            <!-- Loss Categories Overview -->
            <div class="loss-section">
                <div class="section-header">
                    <h3 class="section-title">Loss Categories Overview</h3>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="refreshLossData()" id="refreshBtn">üîÑ Refresh</button>
                        <button class="btn btn-secondary" onclick="exportLossReport()">üìÑ Export Report</button>
                    </div>
                </div>

                <div class="loss-categories">
                    <div class="loss-card theft">
                        <div class="loss-title">
                            üîí Theft/Missing Items
                        </div>
                        <div class="loss-amount" id="theftLosses">$0</div>
                        <div class="loss-incidents" id="theftIncidents">0 incidents</div>
                        <div class="loss-trend trend-stable" id="theftTrend">No change</div>
                    </div>

                    <div class="loss-card accident">
                        <div class="loss-title">
                            ‚ö†Ô∏è Kitchen Accidents
                        </div>
                        <div class="loss-amount" id="accidentLosses">$0</div>
                        <div class="loss-incidents" id="accidentIncidents">0 incidents</div>
                        <div class="loss-trend trend-stable" id="accidentTrend">No change</div>
                    </div>

                    <div class="loss-card walkout">
                        <div class="loss-title">
                            üö∂ Customer Walkouts
                        </div>
                        <div class="loss-amount" id="walkoutLosses">$0</div>
                        <div class="loss-incidents" id="walkoutIncidents">0 incidents</div>
                        <div class="loss-trend trend-stable" id="walkoutTrend">No change</div>
                    </div>

                    <div class="loss-card recall">
                        <div class="loss-title">
                            üîÑ Menu Item Recalls
                        </div>
                        <div class="loss-amount" id="recallLosses">$0</div>
                        <div class="loss-incidents" id="recallIncidents">0 incidents</div>
                        <div class="loss-trend trend-stable" id="recallTrend">No change</div>
                    </div>

                    <div class="loss-card waste">
                        <div class="loss-title">
                            üóëÔ∏è Food Waste
                        </div>
                        <div class="loss-amount" id="wasteLosses">$0</div>
                        <div class="loss-incidents" id="wasteIncidents">0 incidents</div>
                        <div class="loss-trend trend-stable" id="wasteTrend">No change</div>
                    </div>

                    <div class="loss-card other">
                        <div class="loss-title">
                            üìù Other Losses
                        </div>
                        <div class="loss-amount" id="otherLosses">$0</div>
                        <div class="loss-incidents" id="otherIncidents">0 incidents</div>
                        <div class="loss-trend trend-stable" id="otherTrend">No change</div>
                    </div>
                </div>
            </div>

            <!-- Loss Trends Chart -->
            <div class="loss-section">
                <div class="section-header">
                    <h3 class="section-title">Loss Trends Analysis</h3>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="chart-container">
                        <canvas id="lossTypeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="lossTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Loss Breakdown -->
            <div class="loss-section">
                <div class="section-header">
                    <h3 class="section-title">Loss Breakdown by Restaurant</h3>
                </div>

                <table class="data-table" id="lossBreakdownTable">
                    <thead>
                        <tr>
                            <th>Restaurant</th>
                            <th>Total Incidents</th>
                            <th>Total Loss</th>
                            <th>Avg Loss/Incident</th>
                            <th>Most Common Type</th>
                            <th>% of Revenue</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody id="lossBreakdownTableBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Recent Incidents -->
            <div class="loss-section">
                <div class="section-header">
                    <h3 class="section-title">Recent Loss Incidents</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="viewAllIncidents()">üìã View All</button>
                    </div>
                </div>

                <div class="recent-incidents" id="recentIncidentsList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- All Incidents Table -->
            <div class="loss-section">
                <div class="section-header">
                    <h3 class="section-title">All Loss Incidents</h3>
                </div>

                <table class="data-table" id="incidentsTable">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Restaurant</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="incidentsTableBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentVenue = null;
        let venueRestaurants = [];
        let allVenueIncidents = [];
        let currentAnalytics = {};
        let realtimeUnsubscribe = null;
        let lossTypeChart = null;
        let lossTrendChart = null;
        let currentFilters = {
            timePeriod: 'month',
            restaurant: 'all',
            lossType: 'all'
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìâ Loss Tracking initializing...');
            initializeLossTracking();
        });

        async function initializeLossTracking() {
            try {
                showLoading(true);
                
                // Get current user
                currentUser = await VediAPI.getCurrentUser();
                if (!currentUser) {
                    throw new Error('Please log in to access the loss tracking system');
                }

                console.log('‚úÖ User authenticated:', currentUser.name);

                // Get venue data
                currentVenue = await VediAPI.getVenueByManager(currentUser.id);
                if (!currentVenue) {
                    throw new Error('No venue found for this manager');
                }

                console.log('‚úÖ Venue loaded:', currentVenue.name);

                // Get restaurants in venue
                venueRestaurants = await VediAPI.getRestaurantsByVenue(currentVenue.id);
                console.log('‚úÖ Restaurants loaded:', venueRestaurants.length);

                // Setup real-time incident tracking
                setupRealtimeTracking();

                // Initialize UI
                populateFilters();
                await loadLossData();
                initializeCharts();

                showLoading(false);
                showMainContent(true);

                // Auto-refresh every 60 seconds
                setInterval(loadLossData, 60000);

            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                showError(error.message);
                showLoading(false);
            }
        }

        async function setupRealtimeTracking() {
            try {
                if (realtimeUnsubscribe) {
                    realtimeUnsubscribe();
                }

                // Listen to real-time venue incident updates
                realtimeUnsubscribe = VediAPI.listenToVenueLossIncidents(currentVenue.id, (incidents) => {
                    console.log('üì± Real-time incidents update:', incidents.length);
                    allVenueIncidents = incidents;
                    updateLossDashboard();
                });

            } catch (error) {
                console.error('‚ùå Real-time setup error:', error);
            }
        }

        function populateFilters() {
            // Populate restaurant filter
            const restaurantFilter = document.getElementById('restaurantFilter');
            restaurantFilter.innerHTML = '<option value="all">All Restaurants</option>';
            
            venueRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                restaurantFilter.appendChild(option);
            });

            // Setup filter change handlers
            document.getElementById('timePeriod').addEventListener('change', applyLossFilters);
            document.getElementById('restaurantFilter').addEventListener('change', applyLossFilters);
            document.getElementById('lossType').addEventListener('change', applyLossFilters);
        }

        async function loadLossData() {
            try {
                console.log('üîÑ Loading loss data...');
                
                // Get filtered incidents
                const filterOptions = {
                    timePeriod: currentFilters.timePeriod,
                    type: currentFilters.lossType !== 'all' ? currentFilters.lossType : undefined,
                    limit: 1000 // Get comprehensive data
                };

                if (currentFilters.restaurant !== 'all') {
                    allVenueIncidents = await VediAPI.getLossIncidents(currentFilters.restaurant, filterOptions);
                } else {
                    allVenueIncidents = await VediAPI.getLossIncidentsByVenue(currentVenue.id, filterOptions);
                }

                // Get analytics
                currentAnalytics = await VediAPI.getVenueLossAnalytics(currentVenue.id, currentFilters.timePeriod);

                console.log('‚úÖ Loss data loaded:', {
                    incidents: allVenueIncidents.length,
                    analytics: currentAnalytics
                });

                updateLossDashboard();

            } catch (error) {
                console.error('‚ùå Load loss data error:', error);
                showNotification('Error loading loss data', 'error');
            }
        }

        function updateLossDashboard() {
            updateLossCategories();
            updateRecentIncidents();
            updateIncidentsTable();
            updateLossBreakdownTable();
            updateCharts();
        }

        function updateLossCategories() {
            const categories = ['theft', 'accident', 'walkout', 'recall', 'waste', 'other'];
            
            categories.forEach(type => {
                const typeIncidents = allVenueIncidents.filter(incident => incident.type === type);
                const totalLoss = typeIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);
                const incidentCount = typeIncidents.length;
                
                // Update UI elements
                document.getElementById(`${type}Losses`).textContent = formatCurrency(totalLoss);
                document.getElementById(`${type}Incidents`).textContent = `${incidentCount} incidents`;
                
                // Calculate and update trend
                updateTrendIndicator(type, typeIncidents);
            });
        }

        function updateTrendIndicator(type, incidents) {
            const trendElement = document.getElementById(`${type}Trend`);
            
            if (incidents.length === 0) {
                trendElement.textContent = 'No incidents';
                trendElement.className = 'loss-trend trend-stable';
                return;
            }

            // Simple trend calculation based on recent vs older incidents
            const now = new Date();
            const recentThreshold = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); // Last 7 days
            
            const recentIncidents = incidents.filter(incident => 
                VediAPI.timestampToDate(incident.createdAt) >= recentThreshold
            );
            
            const olderIncidents = incidents.filter(incident => 
                VediAPI.timestampToDate(incident.createdAt) < recentThreshold
            );

            const recentLoss = recentIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);
            const olderLoss = olderIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);

            let trendClass = 'trend-stable';
            let trendText = 'Stable';

            if (recentLoss > olderLoss * 1.2) {
                trendClass = 'trend-up';
                trendText = '‚ÜóÔ∏è Increasing';
            } else if (recentLoss < olderLoss * 0.8) {
                trendClass = 'trend-down';
                trendText = '‚ÜòÔ∏è Decreasing';
            }

            trendElement.textContent = trendText;
            trendElement.className = `loss-trend ${trendClass}`;
        }

        function updateRecentIncidents() {
            const container = document.getElementById('recentIncidentsList');
            
            if (allVenueIncidents.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìã</div>
                        <div>No recent incidents</div>
                        <div style="font-size: 0.9rem; margin-top: 5px;">Loss incidents will appear here when reported</div>
                    </div>
                `;
                return;
            }

            // Show most recent 10 incidents
            const recentIncidents = allVenueIncidents
                .sort((a, b) => VediAPI.timestampToDate(b.createdAt) - VediAPI.timestampToDate(a.createdAt))
                .slice(0, 10);

            container.innerHTML = recentIncidents.map(incident => {
                const date = VediAPI.timestampToDate(incident.createdAt).toLocaleString();
                const restaurant = venueRestaurants.find(r => r.id === incident.restaurantId);
                const restaurantName = restaurant?.name || 'Unknown Restaurant';

                return `
                    <div class="incident-item">
                        <div class="incident-info">
                            <div class="incident-title">${incident.title || 'Loss Incident'}</div>
                            <div class="incident-meta">
                                ${restaurantName} ‚Ä¢ ${date} ‚Ä¢ ${formatIncidentType(incident.type)}
                            </div>
                        </div>
                        <div class="incident-amount">${formatCurrency(incident.amount || 0)}</div>
                    </div>
                `;
            }).join('');
        }

        function updateIncidentsTable() {
            const tbody = document.getElementById('incidentsTableBody');
            
            if (allVenueIncidents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">
                            No incidents recorded for the selected period
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allVenueIncidents
                .sort((a, b) => VediAPI.timestampToDate(b.createdAt) - VediAPI.timestampToDate(a.createdAt))
                .map(incident => {
                    const date = VediAPI.timestampToDate(incident.createdAt).toLocaleString();
                    const restaurant = venueRestaurants.find(r => r.id === incident.restaurantId);
                    const restaurantName = restaurant?.name || 'Unknown';

                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${restaurantName}</td>
                            <td>${formatIncidentType(incident.type)}</td>
                            <td>${truncateText(incident.description || 'No description', 50)}</td>
                            <td>${formatCurrency(incident.amount || 0)}</td>
                            <td><span class="severity-badge severity-${incident.severity || 'medium'}">${incident.severity || 'Medium'}</span></td>
                            <td><span class="status-badge status-${incident.status || 'reported'}">${incident.status || 'Reported'}</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewIncidentDetails('${incident.id}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                    View
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        function updateLossBreakdownTable() {
            const tbody = document.getElementById('lossBreakdownTableBody');
            
            if (venueRestaurants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            No restaurant data available
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = venueRestaurants.map(restaurant => {
                const restaurantIncidents = allVenueIncidents.filter(incident => 
                    incident.restaurantId === restaurant.id
                );
                
                const totalIncidents = restaurantIncidents.length;
                const totalLoss = restaurantIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);
                const avgLoss = totalIncidents > 0 ? totalLoss / totalIncidents : 0;
                
                // Find most common type
                const typeCounts = {};
                restaurantIncidents.forEach(incident => {
                    const type = incident.type || 'other';
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
                
                const mostCommonType = Object.keys(typeCounts).reduce((a, b) => 
                    typeCounts[a] > typeCounts[b] ? a : b, 'none'
                );

                // Calculate percentage of revenue (would need actual revenue data)
                const revenuePercentage = '0.0'; // Placeholder - would calculate from actual revenue

                const trendClass = totalLoss > 1000 ? 'trend-up' : totalLoss > 0 ? 'trend-stable' : 'trend-down';

                return `
                    <tr>
                        <td><strong>${restaurant.name}</strong></td>
                        <td>${totalIncidents}</td>
                        <td>${formatCurrency(totalLoss)}</td>
                        <td>${formatCurrency(avgLoss)}</td>
                        <td>${formatIncidentType(mostCommonType)}</td>
                        <td>${revenuePercentage}%</td>
                        <td><span class="loss-trend ${trendClass}">${getTrendText(trendClass)}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function initializeCharts() {
            // Loss Type Chart (Doughnut)
            const lossTypeCtx = document.getElementById('lossTypeChart').getContext('2d');
            lossTypeChart = new Chart(lossTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#f56565', // theft
                            '#e53e3e', // accident
                            '#805ad5', // walkout
                            '#d69e2e', // recall
                            '#38a169', // waste
                            '#718096'  // other
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Loss Distribution by Type'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Loss Trend Chart (Line)
            const lossTrendCtx = document.getElementById('lossTrendChart').getContext('2d');
            lossTrendChart = new Chart(lossTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Losses',
                        data: [],
                        borderColor: '#e53e3e',
                        backgroundColor: 'rgba(229, 62, 62, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Loss Trends Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            updateLossTypeChart();
            updateLossTrendChart();
        }

        function updateLossTypeChart() {
            if (!lossTypeChart) return;

            const typeData = {};
            allVenueIncidents.forEach(incident => {
                const type = incident.type || 'other';
                typeData[type] = (typeData[type] || 0) + (incident.amount || 0);
            });

            const labels = Object.keys(typeData).map(type => formatIncidentType(type));
            const data = Object.values(typeData);

            lossTypeChart.data.labels = labels;
            lossTypeChart.data.datasets[0].data = data;
            lossTypeChart.update();
        }

        function updateLossTrendChart() {
            if (!lossTrendChart) return;

            // Get last 30 days of data
            const dailyData = {};
            const now = new Date();
            
            // Initialize with zeros for last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                const dateKey = date.toISOString().split('T')[0];
                dailyData[dateKey] = 0;
            }

            // Populate with actual incident data
            allVenueIncidents.forEach(incident => {
                if (incident.createdAt) {
                    const date = VediAPI.timestampToDate(incident.createdAt);
                    const dateKey = date.toISOString().split('T')[0];
                    if (dailyData.hasOwnProperty(dateKey)) {
                        dailyData[dateKey] += incident.amount || 0;
                    }
                }
            });

            const labels = Object.keys(dailyData).map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const data = Object.values(dailyData);

            lossTrendChart.data.labels = labels;
            lossTrendChart.data.datasets[0].data = data;
            lossTrendChart.update();
        }

        // Filter and action functions
        async function applyLossFilters() {
            try {
                const applyBtn = document.getElementById('applyFiltersBtn');
                applyBtn.disabled = true;
                applyBtn.innerHTML = 'üîç Applying...';

                currentFilters = {
                    timePeriod: document.getElementById('timePeriod').value,
                    restaurant: document.getElementById('restaurantFilter').value,
                    lossType: document.getElementById('lossType').value
                };

                console.log('üîç Applying filters:', currentFilters);
                await loadLossData();
                
                showNotification('Filters applied successfully');

            } catch (error) {
                console.error('‚ùå Apply filters error:', error);
                showNotification('Error applying filters', 'error');
            } finally {
                const applyBtn = document.getElementById('applyFiltersBtn');
                applyBtn.disabled = false;
                applyBtn.innerHTML = 'üîç Apply Filters';
            }
        }

        async function refreshLossData() {
            try {
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = 'üîÑ Refreshing...';

                console.log('üîÑ Manual refresh triggered...');
                await loadLossData();
                
                showNotification('Loss data refreshed successfully');

            } catch (error) {
                console.error('‚ùå Refresh error:', error);
                showNotification('Error refreshing data', 'error');
            } finally {
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Refresh';
            }
        }

        function exportLossReport() {
            try {
                console.log('üìÑ Exporting loss report...');
                
                const reportData = {
                    generatedAt: new Date().toISOString(),
                    venue: {
                        id: currentVenue.id,
                        name: currentVenue.name
                    },
                    filters: currentFilters,
                    summary: currentAnalytics,
                    incidents: allVenueIncidents,
                    restaurants: venueRestaurants,
                    reportType: 'loss_tracking'
                };

                const dataStr = JSON.stringify(reportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `loss-report-${currentVenue.name.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('Loss report exported successfully');

            } catch (error) {
                console.error('‚ùå Export error:', error);
                showNotification('Error exporting report', 'error');
            }
        }

        function viewAllIncidents() {
            console.log('üìã Viewing all incidents...');
            document.getElementById('incidentsTable').scrollIntoView({ behavior: 'smooth' });
            showNotification('Showing all incidents in table below');
        }

        function viewIncidentDetails(incidentId) {
            try {
                const incident = allVenueIncidents.find(inc => inc.id === incidentId);
                if (!incident) {
                    showNotification('Incident not found', 'error');
                    return;
                }
                
                console.log('üëÅÔ∏è Viewing incident details:', incident.title);
                
                // Create details modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000; display: flex;
                    align-items: center; justify-content: center; padding: 20px;
                `;
                
                const restaurant = venueRestaurants.find(r => r.id === incident.restaurantId);
                const restaurantName = restaurant?.name || 'Unknown Restaurant';
                const date = VediAPI.timestampToDate(incident.createdAt).toLocaleString();
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px; color: #2d3748;">Incident Details</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Type</label>
                                <div style="padding: 8px; background: #f7fafc; border-radius: 6px;">${formatIncidentType(incident.type)}</div>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Severity</label>
                                <div style="padding: 8px; background: #f7fafc; border-radius: 6px;">
                                    <span class="severity-badge severity-${incident.severity || 'medium'}">${incident.severity || 'Medium'}</span>
                                </div>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Restaurant</label>
                                <div style="padding: 8px; background: #f7fafc; border-radius: 6px;">${restaurantName}</div>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Date/Time</label>
                                <div style="padding: 8px; background: #f7fafc; border-radius: 6px;">${date}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Loss Amount</label>
                            <div style="padding: 12px; background: #fed7d7; border-radius: 6px; color: #742a2a; font-weight: 600; font-size: 1.2rem;">
                                ${formatCurrency(incident.amount || 0)}
                            </div>
                        </div>
                        
                        ${incident.title ? `
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Title</label>
                                <div style="padding: 12px; background: #f7fafc; border-radius: 6px; font-weight: 600;">
                                    ${incident.title}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">Description</label>
                            <div style="padding: 12px; background: #f7fafc; border-radius: 6px; line-height: 1.5;">
                                ${incident.description || 'No description provided'}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeDetailsModal()" style="padding: 10px 20px; border: 2px solid #e2e8f0; background: white; color: #4a5568; border-radius: 8px; cursor: pointer;">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.id = 'detailsModal';
                
                // Close modal when clicking outside
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeDetailsModal();
                    }
                };

            } catch (error) {
                console.error('‚ùå View incident details error:', error);
                showNotification('Error viewing incident details', 'error');
            }
        }

        function closeDetailsModal() {
            const modal = document.getElementById('detailsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Utility functions
        function formatIncidentType(type) {
            const typeMap = {
                'theft': 'üîí Theft',
                'accident': '‚ö†Ô∏è Accident',
                'walkout': 'üö∂ Walkout',
                'recall': 'üîÑ Recall',
                'waste': 'üóëÔ∏è Food Waste',
                'other': 'üìù Other'
            };
            return typeMap[type] || 'üìù ' + (type || 'Unknown');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function getTrendText(trendClass) {
            switch(trendClass) {
                case 'trend-up': return '‚ÜóÔ∏è Increasing';
                case 'trend-down': return '‚ÜòÔ∏è Decreasing';
                case 'trend-stable': return '‚Üí Stable';
                default: return 'No change';
            }
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').classList.toggle('show', show);
        }

        function showMainContent(show) {
            document.getElementById('mainContent').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? 
                'linear-gradient(135deg, #e53e3e, #c53030)' : 
                'linear-gradient(135deg, #48bb78, #38a169)';
                
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${bgColor}; color: white; padding: 15px 25px; 
                border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                font-weight: 600; opacity: 0; transition: all 0.3s ease;
                max-width: 400px; word-wrap: break-word;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 100);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
            }
        });

        console.log('üìâ Loss Tracking Firebase integration loaded successfully');
    </script>
</body>
</html>
