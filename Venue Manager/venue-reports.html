<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Venue Manager</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="../firebase-config.js"></script>
    
    <!-- VediAPI Core -->
    <script src="../Api/core/firebase-init.js"></script>
    <script src="../Api/core/utilities.js"></script>
    <script src="../Api/core/tracking.js"></script>
    
    <!-- Authentication -->
    <script src="../Api/auth/email-auth.js"></script>
    
    <!-- Business APIs -->
    <script src="../Api/business/venues.js"></script>
    <script src="../Api/business/restaurants.js"></script>
    <script src="../Api/orders/order-management.js"></script>
    <script src="../Api/operations/loss-incidents.js"></script>
    
    <!-- Financial APIs -->
    <script src="../Api/payments/revenue-analytics.js"></script>
    <script src="../Api/payments/payment-processing.js"></script>
    <script src="../Api/payments/fee-configurations.js"></script>
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* iOS Design System */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', sans-serif;
            background-color: #F8F9FA;
            color: #1D1D1F;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background-color: #FFFFFF;
            border-bottom: 1px solid #E5E5E7;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .venue-info h1 {
            font-size: 28px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .venue-info p {
            font-size: 15px;
            color: #86868B;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-size: 15px;
            font-weight: 500;
            color: #1D1D1F;
        }

        .user-role {
            font-size: 13px;
            color: #86868B;
        }

        .logout-btn {
            background-color: #FF3B30;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background-color: #D70015;
            transform: translateY(-1px);
        }

        /* Navigation */
        .navigation {
            background-color: #FFFFFF;
            border-bottom: 1px solid #E5E5E7;
            padding: 0 24px;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 32px;
        }

        .nav-item {
            padding: 16px 0;
            font-size: 17px;
            font-weight: 500;
            color: #86868B;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
        }

        .nav-item:hover {
            color: #007AFF;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 34px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 17px;
            color: #86868B;
        }

        /* Report Controls */
        .report-controls {
            background-color: #FFFFFF;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 13px;
            font-weight: 500;
            color: #86868B;
        }

        .control-input {
            height: 44px;
            border: 1px solid #E5E5E7;
            border-radius: 8px;
            padding: 0 16px;
            font-size: 17px;
            background-color: #FFFFFF;
            transition: border-color 0.2s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .generate-btn {
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 44px;
        }

        .generate-btn:hover {
            background-color: #0056CC;
        }

        .generate-btn:disabled {
            background-color: #86868B;
            cursor: not-allowed;
        }

        /* Report Sections */
        .report-section {
            background-color: #FFFFFF;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #E5E5E7;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #000000;
        }

        .export-btn {
            background-color: #F1F3F4;
            color: #007AFF;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            background-color: #E5E5E7;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .summary-card {
            background-color: #F8F9FA;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 13px;
            color: #86868B;
        }

        .summary-change {
            font-size: 13px;
            margin-top: 8px;
        }

        .summary-change.positive {
            color: #30D158;
        }

        .summary-change.negative {
            color: #FF3B30;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 24px;
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .data-table th {
            background-color: #F8F9FA;
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #86868B;
            border-bottom: 1px solid #E5E5E7;
        }

        .data-table td {
            padding: 12px 16px;
            font-size: 15px;
            border-bottom: 1px solid #E5E5E7;
        }

        .data-table tr:hover {
            background-color: #F8F9FA;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-completed {
            background-color: #30D158;
        }

        .status-pending {
            background-color: #FF9500;
        }

        .status-cancelled {
            background-color: #FF3B30;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 48px;
            color: #86868B;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #E5E5E7;
            border-top: 2px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(248, 249, 250, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-circle {
            width: 48px;
            height: 48px;
            border: 3px solid #E5E5E7;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .loading-text {
            font-size: 17px;
            color: #86868B;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message */
        .message {
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 15px;
        }

        .message.error {
            background-color: #FFE5E5;
            color: #D70015;
        }

        .message.success {
            background-color: #D1F2EB;
            color: #00A86B;
        }

        .message.info {
            background-color: #E3F2FD;
            color: #1976D2;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: #86868B;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .section-header {
                flex-direction: column;
                gap: 16px;
                align-items: start;
            }

            .chart-container {
                height: 300px;
            }
        }

        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="venue-info">
                <h1 id="venueName">Loading...</h1>
                <p id="venueLocation">Loading venue information...</p>
            </div>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name" id="userName">Venue Manager</div>
                    <div class="user-role">Detailed Reports</div>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="navigation">
        <div class="nav-content">
            <a href="venue-overview.html" class="nav-item" onclick="handleNavigation(event, 'venue-overview.html')">Overview</a>
            <a href="performance.html" class="nav-item" onclick="handleNavigation(event, 'performance.html')">Performance</a>
            <a href="loss-tracking.html" class="nav-item" onclick="handleNavigation(event, 'loss-tracking.html')">Loss Tracking</a>
            <a href="venue-reports.html" class="nav-item active">Reports</a>
            <a href="venue-management.html" class="nav-item" onclick="handleNavigation(event, 'venue-management.html')">Management</a>
            <a href="venue-financials.html" class="nav-item" onclick="handleNavigation(event, 'venue-financials.html')">Financials</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <h1 class="page-title">Detailed Reports</h1>
            <p class="page-subtitle">Comprehensive analytics and reporting across all venue operations</p>
        </section>

        <!-- Report Controls -->
        <section class="report-controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label class="control-label">Report Type</label>
                    <select class="control-input" id="reportType">
                        <option value="financial">Financial Summary</option>
                        <option value="orders">Order Analysis</option>
                        <option value="performance">Restaurant Performance</option>
                        <option value="loss">Loss Incidents</option>
                        <option value="revenue-trends">Revenue Trends</option>
                        <option value="comprehensive">Comprehensive Report</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Time Period</label>
                    <select class="control-input" id="timePeriod">
                        <option value="today">Today</option>
                        <option value="week">Past 7 Days</option>
                        <option value="month" selected>Past Month</option>
                        <option value="quarter">Past Quarter</option>
                        <option value="year">Past Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <div class="control-group" id="customDateGroup" style="display: none;">
                    <label class="control-label">Start Date</label>
                    <input type="date" class="control-input" id="startDate">
                </div>
                
                <div class="control-group" id="customDateGroup2" style="display: none;">
                    <label class="control-label">End Date</label>
                    <input type="date" class="control-input" id="endDate">
                </div>
                
                <div class="control-group">
                    <label class="control-label">Restaurant Filter</label>
                    <select class="control-input" id="restaurantFilter">
                        <option value="all">All Restaurants</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <button class="generate-btn" onclick="generateReport()">Generate Report</button>
                </div>
            </div>
        </section>

        <!-- Financial Summary Report -->
        <section class="report-section" id="financialSummarySection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Financial Summary</h2>
                <button class="export-btn" onclick="exportReport('financial')">Export CSV</button>
            </div>
            
            <div class="summary-grid" id="financialSummaryCards">
                <!-- Summary cards will be populated by JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
            
            <table class="data-table" id="financialBreakdownTable">
                <thead>
                    <tr>
                        <th>Restaurant</th>
                        <th>Orders</th>
                        <th>Revenue</th>
                        <th>Platform Fees</th>
                        <th>Venue Fees</th>
                        <th>Net Payout</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </section>

        <!-- Order Analysis Report -->
        <section class="report-section" id="orderAnalysisSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Order Analysis</h2>
                <button class="export-btn" onclick="exportReport('orders')">Export CSV</button>
            </div>
            
            <div class="summary-grid" id="orderSummaryCards">
                <!-- Summary cards will be populated by JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="orderTrendsChart"></canvas>
            </div>
            
            <table class="data-table" id="orderDetailsTable">
                <thead>
                    <tr>
                        <th>Order Number</th>
                        <th>Restaurant</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </section>

        <!-- Performance Report -->
        <section class="report-section" id="performanceSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Restaurant Performance</h2>
                <button class="export-btn" onclick="exportReport('performance')">Export CSV</button>
            </div>
            
            <div class="summary-grid" id="performanceSummaryCards">
                <!-- Summary cards will be populated by JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            
            <table class="data-table" id="performanceTable">
                <thead>
                    <tr>
                        <th>Restaurant</th>
                        <th>Orders</th>
                        <th>Revenue</th>
                        <th>Avg Order Value</th>
                        <th>Growth</th>
                        <th>Rating</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </section>

        <!-- Loss Incidents Report -->
        <section class="report-section" id="lossIncidentsSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Loss Incidents</h2>
                <button class="export-btn" onclick="exportReport('loss')">Export CSV</button>
            </div>
            
            <div class="summary-grid" id="lossSummaryCards">
                <!-- Summary cards will be populated by JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="lossChart"></canvas>
            </div>
            
            <table class="data-table" id="lossIncidentsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Restaurant</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </section>

        <!-- Revenue Trends Report -->
        <section class="report-section" id="revenueTrendsSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Revenue Trends</h2>
                <button class="export-btn" onclick="exportReport('trends')">Export CSV</button>
            </div>
            
            <div class="summary-grid" id="trendsSummaryCards">
                <!-- Summary cards will be populated by JavaScript -->
            </div>
            
            <div class="chart-container">
                <canvas id="trendsChart"></canvas>
            </div>
        </section>

        <!-- Comprehensive Report -->
        <section class="report-section" id="comprehensiveSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Comprehensive Venue Report</h2>
                <button class="export-btn" onclick="exportReport('comprehensive')">Export PDF</button>
            </div>
            
            <div id="comprehensiveReportContent">
                <!-- Comprehensive report content will be generated by JavaScript -->
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-circle"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentVenue = null;
        let venueRestaurants = [];
        let reportData = null;
        let activeCharts = [];

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                console.log('🚀 Initializing reports dashboard...');
                
                await waitForFirebase();
                await checkAuthentication();
                await loadVenueData();
                await loadRestaurants();
                
                setupEventListeners();
                
                console.log('✅ Reports dashboard initialized successfully');
                
            } catch (error) {
                console.error('❌ Dashboard initialization error:', error);
                showMessage('Failed to load reports dashboard. Please refresh the page.', 'error');
            }
        }

        // Wait for Firebase
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkFirebase = () => {
                    attempts++;
                    
                    if (window.firebase && window.firebaseAuth && window.firebaseDb && window.VediAPI) {
                        console.log('✅ Firebase and VediAPI ready for reports');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Firebase initialization timeout'));
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                
                checkFirebase();
            });
        }

        // Check authentication
        async function checkAuthentication() {
            return new Promise((resolve, reject) => {
                const auth = firebase.auth();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const db = firebase.firestore();
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            
                            if (!userDoc.exists) {
                                throw new Error('User profile not found');
                            }
                            
                            const userData = userDoc.data();
                            
                            if (userData.accountType !== 'venue') {
                                throw new Error('Access denied. Venue manager account required.');
                            }
                            
                            currentUser = { ...userData, uid: user.uid };
                            updateUserDisplay();
                            resolve();
                            
                        } catch (error) {
                            console.error('❌ User verification error:', error);
                            reject(error);
                        }
                    } else {
                        window.location.href = '/login.html';
                    }
                });
            });
        }

        // Load venue data
        async function loadVenueData() {
            try {
                let venue;
                
                if (VediAPI.getVenueByManager) {
                    venue = await VediAPI.getVenueByManager(currentUser.uid);
                } else {
                    const db = firebase.firestore();
                    const venueQuery = await db.collection('venues')
                        .where('managerUserId', '==', currentUser.uid)
                        .limit(1)
                        .get();
                    
                    if (venueQuery.empty) {
                        throw new Error('No venue found for this manager');
                    }
                    
                    const venueDoc = venueQuery.docs[0];
                    venue = { id: venueDoc.id, ...venueDoc.data() };
                }
                
                currentVenue = venue;
                
                document.getElementById('venueName').textContent = venue.name;
                document.getElementById('venueLocation').textContent = 
                    `${venue.city}, ${venue.state}`;
                
                console.log('✅ Venue loaded for reports:', venue.name);
                
            } catch (error) {
                console.error('❌ Load venue error:', error);
                throw error;
            }
        }

        // Load restaurants
        async function loadRestaurants() {
            try {
                if (VediAPI.getRestaurantsByVenue) {
                    venueRestaurants = await VediAPI.getRestaurantsByVenue(currentVenue.id);
                } else {
                    venueRestaurants = [];
                }
                
                // Populate restaurant filter
                const restaurantFilter = document.getElementById('restaurantFilter');
                venueRestaurants.forEach(restaurant => {
                    const option = document.createElement('option');
                    option.value = restaurant.id;
                    option.textContent = restaurant.name;
                    restaurantFilter.appendChild(option);
                });
                
                console.log('✅ Restaurants loaded for reports:', venueRestaurants.length);
                
            } catch (error) {
                console.error('❌ Load restaurants error:', error);
                showMessage('Failed to load restaurants', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('timePeriod').addEventListener('change', handleTimePeriodChange);
            document.getElementById('reportType').addEventListener('change', handleReportTypeChange);
        }

        // Handle time period change
        function handleTimePeriodChange() {
            const timePeriod = document.getElementById('timePeriod').value;
            const customDateGroup = document.getElementById('customDateGroup');
            const customDateGroup2 = document.getElementById('customDateGroup2');
            
            if (timePeriod === 'custom') {
                customDateGroup.style.display = 'block';
                customDateGroup2.style.display = 'block';
            } else {
                customDateGroup.style.display = 'none';
                customDateGroup2.style.display = 'none';
            }
        }

        // Handle report type change
        function handleReportTypeChange() {
            // Clear any existing report data when changing types
            hideAllReportSections();
        }

        // Generate report
        async function generateReport() {
            try {
                const reportType = document.getElementById('reportType').value;
                const timePeriod = document.getElementById('timePeriod').value;
                const restaurantFilter = document.getElementById('restaurantFilter').value;
                
                showMessage('Generating report...', 'info');
                
                // Hide all sections first
                hideAllReportSections();
                
                // Clean up existing charts
                activeCharts.forEach(chart => chart.destroy());
                activeCharts = [];
                
                // Generate specific report
                switch (reportType) {
                    case 'financial':
                        await generateFinancialReport(timePeriod, restaurantFilter);
                        break;
                    case 'orders':
                        await generateOrderAnalysisReport(timePeriod, restaurantFilter);
                        break;
                    case 'performance':
                        await generatePerformanceReport(timePeriod, restaurantFilter);
                        break;
                    case 'loss':
                        await generateLossIncidentsReport(timePeriod, restaurantFilter);
                        break;
                    case 'revenue-trends':
                        await generateRevenueTrendsReport(timePeriod, restaurantFilter);
                        break;
                    case 'comprehensive':
                        await generateComprehensiveReport(timePeriod, restaurantFilter);
                        break;
                }
                
                showMessage('Report generated successfully!', 'success');
                
            } catch (error) {
                console.error('❌ Generate report error:', error);
                showMessage('Failed to generate report: ' + error.message, 'error');
            }
        }

        // Generate financial report
        async function generateFinancialReport(timePeriod, restaurantFilter) {
            if (!VediAPI.getFeeAnalytics) {
                throw new Error('Revenue analytics API not available');
            }
            
            const analytics = await VediAPI.getFeeAnalytics(timePeriod, 
                restaurantFilter === 'all' ? null : restaurantFilter);
            
            // Show section
            document.getElementById('financialSummarySection').style.display = 'block';
            
            // Populate summary cards
            const summaryCards = document.getElementById('financialSummaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${VediAPI.formatCurrency ? VediAPI.formatCurrency(analytics.totalRevenue) : '$' + analytics.totalRevenue.toFixed(2)}</div>
                    <div class="summary-label">Total Revenue</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${analytics.orderCount}</div>
                    <div class="summary-label">Total Orders</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${VediAPI.formatCurrency ? VediAPI.formatCurrency(analytics.averageOrderValue) : '$' + analytics.averageOrderValue.toFixed(2)}</div>
                    <div class="summary-label">Average Order Value</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${VediAPI.formatCurrency ? VediAPI.formatCurrency(analytics.totalVenueFees || 0) : '$' + (analytics.totalVenueFees || 0).toFixed(2)}</div>
                    <div class="summary-label">Venue Fees Earned</div>
                </div>
            `;
            
            // Create revenue chart
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const revenueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Platform Fees', 'Venue Fees', 'Restaurant Revenue'],
                    datasets: [{
                        data: [
                            analytics.totalServiceFees || 0,
                            analytics.totalVenueFees || 0,
                            analytics.totalRevenue - (analytics.totalServiceFees || 0) - (analytics.totalVenueFees || 0)
                        ],
                        backgroundColor: ['#007AFF', '#30D158', '#FF9500']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            activeCharts.push(revenueChart);
            
            // Populate breakdown table
            const tableBody = document.querySelector('#financialBreakdownTable tbody');
            tableBody.innerHTML = '';
            
            Object.entries(analytics.revenueByRestaurant || {}).forEach(([restaurantId, data]) => {
                const restaurant = venueRestaurants.find(r => r.id === restaurantId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${restaurant ? restaurant.name : 'Unknown Restaurant'}</td>
                    <td>${data.orders}</td>
                    <td>${VediAPI.formatCurrency ? VediAPI.formatCurrency(data.revenue) : '$' + data.revenue.toFixed(2)}</td>
                    <td>${VediAPI.formatCurrency ? VediAPI.formatCurrency(data.serviceFees || 0) : '$' + (data.serviceFees || 0).toFixed(2)}</td>
                    <td>${VediAPI.formatCurrency ? VediAPI.formatCurrency(data.venueFees || 0) : '$' + (data.venueFees || 0).toFixed(2)}</td>
                    <td>${VediAPI.formatCurrency ? VediAPI.formatCurrency(data.revenue - (data.serviceFees || 0) - (data.venueFees || 0)) : '$' + (data.revenue - (data.serviceFees || 0) - (data.venueFees || 0)).toFixed(2)}</td>
                `;
                tableBody.appendChild(row);
            });
            
            reportData = { type: 'financial', data: analytics };
        }

        // Generate order analysis report
        async function generateOrderAnalysisReport(timePeriod, restaurantFilter) {
            // This would use order-management.js APIs to get order data
            // For now, we'll create a placeholder implementation
            
            document.getElementById('orderAnalysisSection').style.display = 'block';
            
            // Placeholder data
            const orderData = {
                totalOrders: 234,
                completedOrders: 210,
                pendingOrders: 15,
                cancelledOrders: 9,
                averageProcessingTime: 18 // minutes
            };
            
            const summaryCards = document.getElementById('orderSummaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${orderData.totalOrders}</div>
                    <div class="summary-label">Total Orders</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${orderData.completedOrders}</div>
                    <div class="summary-label">Completed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${orderData.pendingOrders}</div>
                    <div class="summary-label">Pending</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${orderData.averageProcessingTime} min</div>
                    <div class="summary-label">Avg Processing Time</div>
                </div>
            `;
            
            // Create order trends chart
            const ctx = document.getElementById('orderTrendsChart').getContext('2d');
            const trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Orders',
                        data: [45, 62, 58, 69],
                        borderColor: '#007AFF',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            activeCharts.push(trendsChart);
            
            reportData = { type: 'orders', data: orderData };
        }

        // Generate performance report
        async function generatePerformanceReport(timePeriod, restaurantFilter) {
            if (!VediAPI.getTopPerformingRestaurants) {
                throw new Error('Performance analytics API not available');
            }
            
            const topRestaurants = await VediAPI.getTopPerformingRestaurants(timePeriod, 10);
            
            document.getElementById('performanceSection').style.display = 'block';
            
            const summaryCards = document.getElementById('performanceSummaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${topRestaurants.length}</div>
                    <div class="summary-label">Active Restaurants</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${topRestaurants[0] ? topRestaurants[0].restaurantName : 'N/A'}</div>
                    <div class="summary-label">Top Performer</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${topRestaurants.reduce((sum, r) => sum + r.orders, 0)}</div>
                    <div class="summary-label">Total Orders</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${VediAPI.formatCurrency ? VediAPI.formatCurrency(topRestaurants.reduce((sum, r) => sum + r.revenue, 0)) : '$' + topRestaurants.reduce((sum, r) => sum + r.revenue, 0).toFixed(2)}</div>
                    <div class="summary-label">Total Revenue</div>
                </div>
            `;
            
            // Create performance chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topRestaurants.slice(0, 5).map(r => r.restaurantName),
                    datasets: [{
                        label: 'Revenue',
                        data: topRestaurants.slice(0, 5).map(r => r.revenue),
                        backgroundColor: '#007AFF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            activeCharts.push(performanceChart);
            
            // Populate performance table
            const tableBody = document.querySelector('#performanceTable tbody');
            tableBody.innerHTML = '';
            
            topRestaurants.forEach(restaurant => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${restaurant.restaurantName}</td>
                    <td>${restaurant.orders}</td>
                    <td>${VediAPI.formatCurrency ? VediAPI.formatCurrency(restaurant.revenue) : '$' + restaurant.revenue.toFixed(2)}</td>
                    <td>${VediAPI.formatCurrency ? VediAPI.formatCurrency(restaurant.averagePayment) : '$' + restaurant.averagePayment.toFixed(2)}</td>
                    <td>+12%</td>
                    <td>4.5 ⭐</td>
                `;
                tableBody.appendChild(row);
            });
            
            reportData = { type: 'performance', data: topRestaurants };
        }

        // Generate loss incidents report
        async function generateLossIncidentsReport(timePeriod, restaurantFilter) {
            if (!VediAPI.getVenueLossAnalytics) {
                throw new Error('Loss incidents API not available');
            }
            
            const lossAnalytics = await VediAPI.getVenueLossAnalytics(currentVenue.id, timePeriod);
            
            document.getElementById('lossIncidentsSection').style.display = 'block';
            
            const summaryCards = document.getElementById('lossSummaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${lossAnalytics.totalIncidents}</div>
                    <div class="summary-label">Total Incidents</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${VediAPI.formatCurrency ? VediAPI.formatCurrency(lossAnalytics.totalLoss) : '$' + lossAnalytics.totalLoss.toFixed(2)}</div>
                    <div class="summary-label">Total Loss</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${VediAPI.formatCurrency ? VediAPI.formatCurrency(lossAnalytics.averageLoss) : '$' + lossAnalytics.averageLoss.toFixed(2)}</div>
                    <div class="summary-label">Average Loss</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${lossAnalytics.byStatus.resolved || 0}</div>
                    <div class="summary-label">Resolved</div>
                </div>
            `;
            
            // Create loss chart
            const ctx = document.getElementById('lossChart').getContext('2d');
            const lossChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(lossAnalytics.byType),
                    datasets: [{
                        data: Object.values(lossAnalytics.byType),
                        backgroundColor: ['#FF3B30', '#FF9500', '#30D158', '#007AFF']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            activeCharts.push(lossChart);
            
            reportData = { type: 'loss', data: lossAnalytics };
        }

        // Generate revenue trends report
        async function generateRevenueTrendsReport(timePeriod, restaurantFilter) {
            if (!VediAPI.getRevenueTrends) {
                throw new Error('Revenue trends API not available');
            }
            
            const trends = await VediAPI.getRevenueTrends(timePeriod, 'day');
            
            document.getElementById('revenueTrendsSection').style.display = 'block';
            
            const trendEntries = Object.entries(trends.trends);
            const totalRevenue = trendEntries.reduce((sum, [, data]) => sum + data.revenue, 0);
            const totalPayments = trendEntries.reduce((sum, [, data]) => sum + data.payments, 0);
            
            const summaryCards = document.getElementById('trendsSummaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${VediAPI.formatCurrency ? VediAPI.formatCurrency(totalRevenue) : '$' + totalRevenue.toFixed(2)}</div>
                    <div class="summary-label">Period Revenue</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${totalPayments}</div>
                    <div class="summary-label">Total Payments</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${trendEntries.length}</div>
                    <div class="summary-label">Days Analyzed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${totalPayments > 0 ? (totalRevenue / totalPayments).toFixed(2) : '0'}</div>
                    <div class="summary-label">Avg per Payment</div>
                </div>
            `;
            
            // Create trends chart
            const ctx = document.getElementById('trendsChart').getContext('2d');
            const trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendEntries.map(([date]) => date),
                    datasets: [{
                        label: 'Revenue',
                        data: trendEntries.map(([, data]) => data.revenue),
                        borderColor: '#007AFF',
                        tension: 0.1
                    }, {
                        label: 'Payments',
                        data: trendEntries.map(([, data]) => data.payments),
                        borderColor: '#30D158',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            activeCharts.push(trendsChart);
            
            reportData = { type: 'trends', data: trends };
        }

        // Generate comprehensive report
        async function generateComprehensiveReport(timePeriod, restaurantFilter) {
            document.getElementById('comprehensiveSection').style.display = 'block';
            
            // Generate all report types and compile into comprehensive view
            const content = document.getElementById('comprehensiveReportContent');
            content.innerHTML = `
                <div class="empty-state">
                    <h3>Comprehensive Report</h3>
                    <p>Generating comprehensive venue analysis...</p>
                    <p>This feature aggregates data from all report types into a single executive summary.</p>
                </div>
            `;
            
            reportData = { type: 'comprehensive', data: {} };
        }

        // Hide all report sections
        function hideAllReportSections() {
            const sections = [
                'financialSummarySection',
                'orderAnalysisSection', 
                'performanceSection',
                'lossIncidentsSection',
                'revenueTrendsSection',
                'comprehensiveSection'
            ];
            
            sections.forEach(sectionId => {
                document.getElementById(sectionId).style.display = 'none';
            });
        }

        // Export report
        function exportReport(type) {
            if (!reportData) {
                showMessage('Please generate a report first', 'error');
                return;
            }
            
            // Convert report data to CSV format
            let csvContent = '';
            
            switch (type) {
                case 'financial':
                    csvContent = generateFinancialCSV();
                    break;
                case 'orders':
                    csvContent = generateOrdersCSV();
                    break;
                case 'performance':
                    csvContent = generatePerformanceCSV();
                    break;
                case 'loss':
                    csvContent = generateLossCSV();
                    break;
                case 'trends':
                    csvContent = generateTrendsCSV();
                    break;
                case 'comprehensive':
                    generateComprehensivePDF();
                    return;
            }
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentVenue.name}_${type}_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showMessage('Report exported successfully!', 'success');
        }

        // Generate CSV content for different report types
        function generateFinancialCSV() {
            const data = reportData.data;
            let csv = 'Restaurant,Orders,Revenue,Platform Fees,Venue Fees,Net Payout\n';
            
            Object.entries(data.revenueByRestaurant || {}).forEach(([restaurantId, restaurantData]) => {
                const restaurant = venueRestaurants.find(r => r.id === restaurantId);
                const netPayout = restaurantData.revenue - (restaurantData.serviceFees || 0) - (restaurantData.venueFees || 0);
                csv += `"${restaurant ? restaurant.name : 'Unknown'}",${restaurantData.orders},${restaurantData.revenue.toFixed(2)},${(restaurantData.serviceFees || 0).toFixed(2)},${(restaurantData.venueFees || 0).toFixed(2)},${netPayout.toFixed(2)}\n`;
            });
            
            return csv;
        }

        function generateOrdersCSV() {
            return 'Order Number,Restaurant,Date,Type,Status,Total\n';
        }

        function generatePerformanceCSV() {
            const data = reportData.data;
            let csv = 'Restaurant,Orders,Revenue,Average Order Value,Growth,Rating\n';
            
            data.forEach(restaurant => {
                csv += `"${restaurant.restaurantName}",${restaurant.orders},${restaurant.revenue.toFixed(2)},${restaurant.averagePayment.toFixed(2)},+12%,4.5\n`;
            });
            
            return csv;
        }

        function generateLossCSV() {
            return 'Date,Restaurant,Type,Severity,Amount,Status,Description\n';
        }

        function generateTrendsCSV() {
            const data = reportData.data;
            let csv = 'Date,Revenue,Payments,Platform Fees,Venue Fees\n';
            
            Object.entries(data.trends).forEach(([date, dayData]) => {
                csv += `${date},${dayData.revenue.toFixed(2)},${dayData.payments},${dayData.platformFees.toFixed(2)},${dayData.venueFees.toFixed(2)}\n`;
            });
            
            return csv;
        }

        function generateComprehensivePDF() {
            showMessage('PDF export feature coming soon!', 'info');
        }

        // Utility functions
        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || 'Venue Manager';
            }
        }

        async function handleLogout() {
            try {
                const auth = firebase.auth();
                await auth.signOut();
                window.location.href = '/login.html';
            } catch (error) {
                console.error('❌ Logout error:', error);
                showMessage('Failed to sign out', 'error');
            }
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(messageDiv, mainContent.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Handle navigation with loading indicator
        function handleNavigation(event, url) {
            event.preventDefault();
            
            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            
            // Simulate brief loading time for smooth UX, then navigate
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }

        // Hide loading overlay when page loads
        window.addEventListener('load', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        });

        // Show loading overlay on page unload
        window.addEventListener('beforeunload', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('active');
            }
        }); // Fixed: Added missing closing brace here

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📊 Reports Dashboard starting...');
            initializeDashboard();
        });
    </script>
</body>
</html>
