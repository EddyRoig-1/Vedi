<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Health Monitor</title>
    
    <!-- Firebase SDKs - FIXED: Added Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Your Vedi API -->
    <script src="../firebase-api.js"></script>
    <!-- Vedi Maintenance API -->
    <script src="maintenance-api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 2rem);
        }

        .page-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f8fafc;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 1.125rem;
            font-weight: 500;
        }

        .auth-warning {
            background: #fef3cd;
            border: 1px solid #f6e05e;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            color: #975a16;
            display: none;
        }

        .auth-warning.show {
            display: block;
        }

        .system-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .status-card:hover {
            transform: translateY(-4px);
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--status-color);
        }

        .status-card.healthy::before { --status-color: linear-gradient(90deg, #10b981, #059669); }
        .status-card.warning::before { --status-color: linear-gradient(90deg, #f59e0b, #d97706); }
        .status-card.error::before { --status-color: linear-gradient(90deg, #ef4444, #dc2626); }
        .status-card.unknown::before { --status-color: linear-gradient(90deg, #6b7280, #9ca3af); }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .status-title {
            font-size: 1rem;
            color: #374151;
            font-weight: 600;
        }

        .status-indicator {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--indicator-bg);
            color: white;
        }

        .status-card.healthy .status-indicator { --indicator-bg: linear-gradient(135deg, #10b981, #059669); }
        .status-card.warning .status-indicator { --indicator-bg: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-card.error .status-indicator { --indicator-bg: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-card.unknown .status-indicator { --indicator-bg: linear-gradient(135deg, #6b7280, #9ca3af); }

        .status-value {
            font-size: 2rem;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .status-description {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.5;
        }

        .status-details {
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #64748b;
        }

        .status-metric {
            font-weight: 600;
            color: #1a202c;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8fafc;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .service-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .service-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
        }

        .service-status {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .service-online {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .service-offline {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .service-maintenance {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .service-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .alerts-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8fafc;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
        }

        .alerts-filter {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .alert-item:hover {
            background: #f8fafc;
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .alert-info { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
        .alert-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .alert-error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .alert-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .alert-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #059669;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #64748b;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 1.25rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .charts-grid, .services-grid {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 2rem;
            }

            .alerts-filter {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">💻 System Health Monitor</h1>
            <p class="page-subtitle">Real-time monitoring of system performance and infrastructure health</p>
        </div>

        <!-- Authentication Warning -->
        <div class="auth-warning" id="authWarning">
            ⚠️ <strong>Admin Access Required:</strong> Please ensure you're logged in as an admin to access system health monitoring.
        </div>

        <!-- System Status Overview -->
        <div class="system-status">
            <div class="status-card unknown" id="systemHealthCard">
                <div class="status-header">
                    <div class="status-title">Overall System Health</div>
                    <div class="status-indicator">⏳</div>
                </div>
                <div class="status-value" id="systemHealthStatus">Loading...</div>
                <div class="status-description" id="systemHealthDesc">Checking system status...</div>
                <div class="status-details">
                    <div class="status-item">
                        <span class="status-label">Uptime</span>
                        <span class="status-metric" id="systemUptime">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Last Check</span>
                        <span class="status-metric" id="lastCheck">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="status-card unknown" id="dbHealthCard">
                <div class="status-header">
                    <div class="status-title">Database Performance</div>
                    <div class="status-indicator">💾</div>
                </div>
                <div class="status-value" id="dbResponseTime">Loading...</div>
                <div class="status-description">Average response time</div>
                <div class="status-details">
                    <div class="status-item">
                        <span class="status-label">Connections</span>
                        <span class="status-metric" id="dbConnections">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Health</span>
                        <span class="status-metric" id="dbHealth">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="status-card unknown" id="apiHealthCard">
                <div class="status-header">
                    <div class="status-title">API Performance</div>
                    <div class="status-indicator">⚡</div>
                </div>
                <div class="status-value" id="apiResponseTime">Loading...</div>
                <div class="status-description">Average API response time</div>
                <div class="status-details">
                    <div class="status-item">
                        <span class="status-label">Success Rate</span>
                        <span class="status-metric" id="apiSuccessRate">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Error Rate</span>
                        <span class="status-metric" id="apiErrorRate">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="status-card unknown" id="resourcesCard">
                <div class="status-header">
                    <div class="status-title">Server Resources</div>
                    <div class="status-indicator">📊</div>
                </div>
                <div class="status-value" id="memoryUsage">Loading...</div>
                <div class="status-description">Memory utilization</div>
                <div class="status-details">
                    <div class="status-item">
                        <span class="status-label">Active Connections</span>
                        <span class="status-metric" id="activeConnections">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Response Time</span>
                        <span class="status-metric" id="avgResponseTime">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">API Response Time Trends</h3>
                    <div class="realtime-indicator">
                        <div class="pulse-dot"></div>
                        <span>Live</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">API Call Volume</h3>
                    <div class="realtime-indicator">
                        <div class="pulse-dot"></div>
                        <span>Live</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="apiVolumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Services Status -->
        <div class="services-grid">
            <div class="service-card">
                <div class="service-header">
                    <h3 class="service-name">🔥 Firebase Services</h3>
                    <span class="service-status" id="firebaseStatus">Checking...</span>
                </div>
                <div class="service-metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="totalUsers">Loading...</div>
                        <div class="metric-label">Total Users</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="totalOrders">Loading...</div>
                        <div class="metric-label">Total Orders</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="totalRestaurants">Loading...</div>
                        <div class="metric-label">Restaurants</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="apiCalls">Loading...</div>
                        <div class="metric-label">API Calls Today</div>
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-header">
                    <h3 class="service-name">📊 Platform Analytics</h3>
                    <span class="service-status" id="analyticsStatus">Checking...</span>
                </div>
                <div class="service-metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="todayRevenue">Loading...</div>
                        <div class="metric-label">Today's Revenue</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="activeToday">Loading...</div>
                        <div class="metric-label">Active Users</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="ordersToday">Loading...</div>
                        <div class="metric-label">Orders Today</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avgOrderValue">Loading...</div>
                        <div class="metric-label">Avg Order Value</div>
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-header">
                    <h3 class="service-name">🔒 Security & Auth</h3>
                    <span class="service-status" id="securityStatus">Checking...</span>
                </div>
                <div class="service-metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="authSuccess">Loading...</div>
                        <div class="metric-label">Auth Success Rate</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="adminUsers">Loading...</div>
                        <div class="metric-label">Admin Users</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="securityScans">0</div>
                        <div class="metric-label">Security Events</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="sslRating">A+</div>
                        <div class="metric-label">SSL Rating</div>
                    </div>
                </div>
            </div>

            <div class="service-card">
                <div class="service-header">
                    <h3 class="service-name">⚠️ System Alerts</h3>
                    <span class="service-status" id="alertsStatus">Checking...</span>
                </div>
                <div class="service-metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="totalAlerts">Loading...</div>
                        <div class="metric-label">Total Alerts</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="criticalAlerts">Loading...</div>
                        <div class="metric-label">Critical</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="warningAlerts">Loading...</div>
                        <div class="metric-label">Warnings</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="resolvedAlerts">Loading...</div>
                        <div class="metric-label">Resolved Today</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Alerts -->
        <div class="alerts-section">
            <div class="section-header">
                <h3 class="section-title">🚨 Recent System Events</h3>
                <div class="alerts-filter">
                    <button class="filter-btn active" onclick="filterAlerts('all')">All</button>
                    <button class="filter-btn" onclick="filterAlerts('error')">Errors</button>
                    <button class="filter-btn" onclick="filterAlerts('warning')">Warnings</button>
                    <button class="filter-btn" onclick="filterAlerts('info')">Info</button>
                </div>
            </div>
            <div class="alerts-list" id="alertsList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading system events...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDglG7Soj0eKu2SLoVby6n71S7gcQzHBPg",
            authDomain: "vedi00.firebaseapp.com",
            projectId: "vedi00",
            storageBucket: "vedi00.firebasestorage.app",
            messagingSenderId: "136867441640",
            appId: "1:136867441640:web:9ec709b63f5690f628125d",
            measurementId: "G-ZS0FKPTEY2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Chart instances
        let responseTimeChart, apiVolumeChart;
        let currentAlertFilter = 'all';
        let isAdmin = false;
        let systemData = {
            health: null,
            metrics: null,
            analytics: null
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Wait for auth state and then load data
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    console.log('✅ User authenticated:', user.uid);
                    checkAdminAccess(user.uid);
                } else {
                    console.log('❌ User not authenticated');
                    showAuthRequired();
                }
            });
            
            // Set up real-time updates every 30 seconds
            setInterval(function() {
                if (auth.currentUser && isAdmin) {
                    loadSystemData();
                    updateCharts();
                }
            }, 30000);
        });

        // Check if user has admin access
        async function checkAdminAccess(userId) {
            try {
                const adminDoc = await db.collection('adminUsers').doc(userId).get();
                isAdmin = adminDoc.exists;
                
                if (isAdmin) {
                    console.log('✅ Admin access confirmed for system health monitor');
                    document.getElementById('authWarning').classList.remove('show');
                    loadSystemData();
                } else {
                    console.log('❌ Admin access denied for system health monitor');
                    showAuthRequired();
                    document.getElementById('authWarning').classList.add('show');
                }
            } catch (error) {
                console.error('❌ Error checking admin access:', error);
                showAuthRequired();
                document.getElementById('authWarning').classList.add('show');
            }
        }

        // Show authentication required state
        function showAuthRequired() {
            const loadingElements = [
                'systemHealthStatus', 'systemUptime', 'lastCheck',
                'dbResponseTime', 'dbConnections', 'dbHealth',
                'apiResponseTime', 'apiSuccessRate', 'apiErrorRate',
                'memoryUsage', 'activeConnections', 'avgResponseTime'
            ];
            
            loadingElements.forEach(function(id) {
                const element = document.getElementById(id);
                if (element) element.textContent = 'Login Required';
            });
            
            updateSystemHealthCard('unknown', 'Authentication Required', 'Please log in as admin');
            
            // Update service status
            const serviceStatuses = ['firebaseStatus', 'analyticsStatus', 'securityStatus', 'alertsStatus'];
            serviceStatuses.forEach(function(id) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = 'Auth Required';
                    element.className = 'service-status service-offline';
                }
            });
            
            // Show auth required in alerts
            document.getElementById('alertsList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">🔐</div>
                    <h3>Admin Access Required</h3>
                    <p>Please log in as an admin to view system health monitoring</p>
                </div>
            `;
        }

        // Load comprehensive system data
        async function loadSystemData() {
            try {
                console.log('🔄 Loading system health data...');
                
                // Load system health
                await loadSystemHealth();
                
                // Load API metrics
                await loadAPIMetrics();
                
                // Load platform metrics
                await loadPlatformMetrics();
                
                // Load system alerts
                await loadSystemAlerts();
                
                console.log('✅ System health data loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading system data:', error);
                showSystemError(error);
            }
        }

        // Load system health from VediMaintenanceAPI
        async function loadSystemHealth() {
            try {
                if (window.VediMaintenanceAPI) {
                    systemData.health = await VediMaintenanceAPI.getSystemHealth();
                    
                    // Update system health card
                    const status = systemData.health.status || 'unknown';
                    const uptime = systemData.health.uptime || 'Unknown';
                    const responseTime = systemData.health.responseTime || 'Unknown';
                    
                    updateSystemHealthCard(status, status.charAt(0).toUpperCase() + status.slice(1), `Uptime: ${uptime}`);
                    
                    document.getElementById('systemUptime').textContent = uptime;
                    document.getElementById('lastCheck').textContent = getRelativeTime(new Date());
                    
                    // Update database metrics
                    if (systemData.health.databaseHealth) {
                        document.getElementById('dbResponseTime').textContent = responseTime + 'ms';
                        document.getElementById('dbConnections').textContent = systemData.health.activeConnections || 'Unknown';
                        document.getElementById('dbHealth').textContent = systemData.health.databaseHealth || 'Unknown';
                        
                        updateCardStatus('dbHealthCard', 'healthy');
                    }
                    
                    // Update resource metrics
                    document.getElementById('memoryUsage').textContent = systemData.health.memoryUsage || 'Unknown';
                    document.getElementById('activeConnections').textContent = systemData.health.activeConnections || 'Unknown';
                    document.getElementById('avgResponseTime').textContent = responseTime + 'ms';
                    
                    updateCardStatus('resourcesCard', 'healthy');
                    
                } else {
                    throw new Error('VediMaintenanceAPI not available');
                }
                
            } catch (error) {
                console.error('❌ Error loading system health:', error);
                updateSystemHealthCard('error', 'System Error', 'Unable to load health data');
            }
        }

        // Load API metrics
        async function loadAPIMetrics() {
            try {
                if (window.VediMaintenanceAPI) {
                    systemData.analytics = await VediMaintenanceAPI.getAPIAnalytics('today');
                    
                    // Update API metrics
                    const totalCalls = systemData.analytics.totalCalls || 0;
                    const errorRate = parseFloat(systemData.analytics.errorRate) || 0;
                    const successRate = (100 - errorRate).toFixed(1);
                    const avgResponseTime = systemData.analytics.averageResponseTime || 0;
                    
                    document.getElementById('apiResponseTime').textContent = avgResponseTime + 'ms';
                    document.getElementById('apiSuccessRate').textContent = successRate + '%';
                    document.getElementById('apiErrorRate').textContent = errorRate.toFixed(1) + '%';
                    document.getElementById('apiCalls').textContent = totalCalls.toLocaleString();
                    
                    // Determine API health status
                    const apiStatus = (errorRate < 1 && avgResponseTime < 200) ? 'healthy' : 
                                     (errorRate < 5 && avgResponseTime < 500) ? 'warning' : 'error';
                    updateCardStatus('apiHealthCard', apiStatus);
                    
                    // Update Firebase service status
                    document.getElementById('firebaseStatus').textContent = 'Online';
                    document.getElementById('firebaseStatus').className = 'service-status service-online';
                }
                
            } catch (error) {
                console.error('❌ Error loading API metrics:', error);
                document.getElementById('apiResponseTime').textContent = 'Error';
                document.getElementById('apiSuccessRate').textContent = 'Error';
                document.getElementById('apiErrorRate').textContent = 'Error';
                updateCardStatus('apiHealthCard', 'error');
            }
        }

        // Load platform metrics
        async function loadPlatformMetrics() {
            try {
                // Get platform metrics from Firebase collections
                const [usersSnapshot, ordersSnapshot, restaurantsSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('orders').get(),
                    db.collection('restaurants').get()
                ]);
                
                // Update platform metrics
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('totalOrders').textContent = ordersSnapshot.size;
                document.getElementById('totalRestaurants').textContent = restaurantsSnapshot.size;
                
                // Calculate today's metrics
                const today = new Date().toISOString().split('T')[0];
                const todayOrders = ordersSnapshot.docs.filter(function(doc) {
                    const orderData = doc.data();
                    const orderDate = orderData.createdAt ? 
                        timestampToDate(orderData.createdAt).toISOString().split('T')[0] : null;
                    return orderDate === today;
                });
                
                document.getElementById('ordersToday').textContent = todayOrders.length;
                
                // Calculate today's revenue
                const todayRevenue = todayOrders.reduce(function(sum, doc) {
                    const order = doc.data();
                    return sum + (order.total || 0);
                }, 0);
                
                document.getElementById('todayRevenue').textContent = '$' + todayRevenue.toFixed(2);
                
                // Calculate average order value
                const avgOrderValue = todayOrders.length > 0 ? 
                    (todayRevenue / todayOrders.length).toFixed(2) : '0.00';
                document.getElementById('avgOrderValue').textContent = '$' + avgOrderValue;
                
                // Calculate active users today
                const activeToday = usersSnapshot.docs.filter(function(doc) {
                    const userData = doc.data();
                    const lastActive = userData.lastLoginAt ? 
                        timestampToDate(userData.lastLoginAt).toISOString().split('T')[0] : null;
                    return lastActive === today;
                }).length;
                
                document.getElementById('activeToday').textContent = activeToday;
                
                // Update service statuses
                document.getElementById('analyticsStatus').textContent = 'Online';
                document.getElementById('analyticsStatus').className = 'service-status service-online';
                
                // Check admin users
                const adminSnapshot = await db.collection('adminUsers').get();
                document.getElementById('adminUsers').textContent = adminSnapshot.size;
                document.getElementById('authSuccess').textContent = '99.8%'; // Estimated
                
                document.getElementById('securityStatus').textContent = 'Online';
                document.getElementById('securityStatus').className = 'service-status service-online';
                
            } catch (error) {
                console.error('❌ Error loading platform metrics:', error);
                
                // Show error state for platform metrics
                const platformElements = ['totalUsers', 'totalOrders', 'totalRestaurants', 'ordersToday', 'todayRevenue', 'avgOrderValue', 'activeToday'];
                platformElements.forEach(function(id) {
                    const element = document.getElementById(id);
                    if (element) element.textContent = 'Error';
                });
            }
        }

        // Load system alerts
        async function loadSystemAlerts() {
            try {
                const alertsList = document.getElementById('alertsList');
                
                // Get system errors and recent events
                const [errorsSnapshot, recentUsersSnapshot, recentOrdersSnapshot] = await Promise.all([
                    db.collection('systemErrors').orderBy('timestamp', 'desc').limit(10).get(),
                    db.collection('users').orderBy('createdAt', 'desc').limit(5).get(),
                    db.collection('orders').orderBy('createdAt', 'desc').limit(5).get()
                ]);
                
                const alerts = [];
                
                // Add system errors as alerts
                errorsSnapshot.docs.forEach(function(doc) {
                    const error = doc.data();
                    alerts.push({
                        type: 'error',
                        icon: '❌',
                        title: 'System Error Detected',
                        message: error.message || 'Unknown system error occurred',
                        time: getRelativeTime(error.timestamp)
                    });
                });
                
                // Add recent user registrations as info
                recentUsersSnapshot.docs.forEach(function(doc) {
                    const user = doc.data();
                    alerts.push({
                        type: 'success',
                        icon: '👤',
                        title: 'New User Registration',
                        message: `New ${user.accountType || 'user'} account created: ${user.name || 'Unknown'}`,
                        time: getRelativeTime(user.createdAt)
                    });
                });
                
                // Add recent orders as info
                recentOrdersSnapshot.docs.forEach(function(doc) {
                    const order = doc.data();
                    alerts.push({
                        type: 'info',
                        icon: '📋',
                        title: 'New Order Received',
                        message: `Order #${order.orderNumber} placed - $${(order.total || 0).toFixed(2)}`,
                        time: getRelativeTime(order.createdAt)
                    });
                });
                
                // Sort alerts by timestamp (most recent first)
                alerts.sort(function(a, b) {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                // Update alert counts
                const errorAlerts = alerts.filter(function(a) { return a.type === 'error'; }).length;
                const warningAlerts = alerts.filter(function(a) { return a.type === 'warning'; }).length;
                const totalAlerts = alerts.length;
                
                document.getElementById('totalAlerts').textContent = totalAlerts;
                document.getElementById('criticalAlerts').textContent = errorAlerts;
                document.getElementById('warningAlerts').textContent = warningAlerts;
                document.getElementById('resolvedAlerts').textContent = Math.max(0, totalAlerts - errorAlerts - warningAlerts);
                
                // Update alerts status
                const alertsStatus = errorAlerts > 0 ? 'Critical' : warningAlerts > 0 ? 'Warning' : 'Normal';
                document.getElementById('alertsStatus').textContent = alertsStatus;
                document.getElementById('alertsStatus').className = 'service-status ' + 
                    (errorAlerts > 0 ? 'service-offline' : warningAlerts > 0 ? 'service-maintenance' : 'service-online');
                
                displayAlerts(alerts);
                
            } catch (error) {
                console.error('❌ Error loading system alerts:', error);
                document.getElementById('alertsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <h3>Error Loading Alerts</h3>
                        <p>Unable to load system alerts: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Update system health card
        function updateSystemHealthCard(status, title, description) {
            const card = document.getElementById('systemHealthCard');
            const statusValue = document.getElementById('systemHealthStatus');
            const statusDesc = document.getElementById('systemHealthDesc');
            const indicator = card.querySelector('.status-indicator');
            
            card.className = `status-card ${status}`;
            statusValue.textContent = title;
            statusDesc.textContent = description;
            
            // Update indicator icon based on status
            const icons = {
                healthy: '✅',
                warning: '⚠️',
                error: '❌',
                unknown: '⏳'
            };
            indicator.textContent = icons[status] || '⏳';
        }

        // Update card status
        function updateCardStatus(cardId, status) {
            const card = document.getElementById(cardId);
            if (card) {
                card.className = `status-card ${status}`;
            }
        }

        // Show system error
        function showSystemError(error) {
            updateSystemHealthCard('error', 'System Error', `Error: ${error.message}`);
        }

        // Initialize charts
        function initializeCharts() {
            // Response Time Chart
            const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
            responseTimeChart = new Chart(responseCtx, {
                type: 'line',
                data: {
                    labels: getLast12Hours(),
                    datasets: [{
                        label: 'API Response Time (ms)',
                        data: Array(12).fill(0),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                color: '#64748b',
                                callback: function(value) {
                                    return value + 'ms';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });

            // API Volume Chart
            const volumeCtx = document.getElementById('apiVolumeChart').getContext('2d');
            apiVolumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: getLast12Hours(),
                    datasets: [{
                        label: 'API Calls',
                        data: Array(12).fill(0),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        // Update charts with real data
        async function updateCharts() {
            try {
                if (!isAdmin) return;
                
                // Update response time chart with real API data
                if (systemData.analytics) {
                    const avgResponseTime = systemData.analytics.averageResponseTime || 0;
                    
                    // Add new data point
                    responseTimeChart.data.datasets[0].data.push(avgResponseTime);
                    
                    // Remove oldest data point if we have too many
                    if (responseTimeChart.data.datasets[0].data.length > 12) {
                        responseTimeChart.data.datasets[0].data.shift();
                    }
                    
                    responseTimeChart.update('none');
                }
                
                // Update API volume chart
                const totalCalls = systemData.analytics ? systemData.analytics.totalCalls : 0;
                const hourlyEstimate = Math.round(totalCalls / 24); // Rough estimate
                
                apiVolumeChart.data.datasets[0].data.push(hourlyEstimate);
                
                if (apiVolumeChart.data.datasets[0].data.length > 12) {
                    apiVolumeChart.data.datasets[0].data.shift();
                }
                
                apiVolumeChart.update('none');
                
            } catch (error) {
                console.error('❌ Error updating charts:', error);
            }
        }

        // Display alerts
        function displayAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔔</div>
                        <h3>No Recent Events</h3>
                        <p>All systems are running smoothly</p>
                    </div>
                `;
                return;
            }
            
            // Filter alerts based on current filter
            let filteredAlerts = alerts;
            if (currentAlertFilter !== 'all') {
                filteredAlerts = alerts.filter(function(alert) {
                    return alert.type === currentAlertFilter;
                });
            }
            
            let html = '';
            filteredAlerts.slice(0, 10).forEach(function(alert) {
                html += `
                    <div class="alert-item">
                        <div class="alert-icon alert-${alert.type}">
                            ${alert.icon}
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-message">${alert.message}</div>
                            <div class="alert-time">${alert.time}</div>
                        </div>
                    </div>
                `;
            });
            
            alertsList.innerHTML = html || `
                <div class="empty-state">
                    <div class="empty-state-icon">🔍</div>
                    <h3>No ${currentAlertFilter} alerts</h3>
                    <p>No alerts match the current filter</p>
                </div>
            `;
        }

        // Filter alerts
        function filterAlerts(type) {
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentAlertFilter = type;
            
            // Re-load alerts with filter
            loadSystemAlerts();
        }

        // Utility functions
        function getLast12Hours() {
            const hours = [];
            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setHours(date.getHours() - i);
                hours.push(date.getHours().toString().padStart(2, '0') + ':00');
            }
            return hours;
        }

        function timestampToDate(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate();
            }
            return new Date(timestamp);
        }

        function getRelativeTime(timestamp) {
            const date = timestampToDate(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }
    </script>
</body>
</html>
