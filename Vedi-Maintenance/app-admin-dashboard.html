<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedi Admin Dashboard</title>
    
    <!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Firebase Configuration (MUST be first after Firebase SDKs) -->
<script src="../firebase-config.js"></script>

<!-- Core API Modules -->
<script src="../api/core/firebase-init.js"></script>
<script src="../api/core/utilities.js"></script>
<script src="../api/core/tracking.js"></script>

<!-- Admin API Modules -->
<script src="../api/admin/system-analytics.js"></script>
<script src="../api/admin/user-administration.js"></script>
<script src="../api/admin/monitoring.js"></script>

<!-- User Management API -->
<script src="../api/auth/user-management.js"></script>

<!-- Chart.js for analytics (loaded last before inline scripts) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
        }

        /* Glassmorphism container */
        .dashboard-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            margin: 20px;
            min-height: calc(100vh - 40px);
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1.25rem;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Navigation */
        .nav-tabs {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0 2rem;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
        }

        .nav-tab {
            padding: 1.25rem 0;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .nav-tab.active {
            color: white;
            border-bottom-color: #ff6b6b;
        }

        .nav-tab:hover {
            color: white;
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            min-height: calc(100vh - 200px);
            border-radius: 24px 24px 0 0;
            margin-top: 1rem;
        }

        /* Dashboard Overview */
        .dashboard-overview {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 1.125rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-gradient);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .stat-card.users::before { --card-gradient: linear-gradient(90deg, #4facfe, #00f2fe); }
        .stat-card.restaurants::before { --card-gradient: linear-gradient(90deg, #43e97b, #38f9d7); }
        .stat-card.orders::before { --card-gradient: linear-gradient(90deg, #fa709a, #fee140); }
        .stat-card.api::before { --card-gradient: linear-gradient(90deg, #a8edea, #fed6e3); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--icon-bg);
            color: white;
        }

        .stat-card.users .stat-icon { --icon-bg: linear-gradient(135deg, #4facfe, #00f2fe); }
        .stat-card.restaurants .stat-icon { --icon-bg: linear-gradient(135deg, #43e97b, #38f9d7); }
        .stat-card.orders .stat-icon { --icon-bg: linear-gradient(135deg, #fa709a, #fee140); }
        .stat-card.api .stat-icon { --icon-bg: linear-gradient(135deg, #a8edea, #fed6e3); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .stat-change.positive {
            color: #059669;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .trend-indicator {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .trend-up {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .trend-down {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        /* Chart Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8fafc;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
        }

        .chart-period {
            background: #f1f5f9;
            color: #475569;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Activity Feed */
        .activity-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8fafc;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #059669;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .activity-feed::-webkit-scrollbar {
            width: 6px;
        }

        .activity-feed::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .activity-feed::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f8fafc;
            transition: all 0.2s ease;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background: #f8fafc;
            margin: 0 -1rem;
            padding: 1rem;
            border-radius: 12px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            background: var(--activity-bg);
            color: white;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .activity-time {
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: 500;
        }

        /* iframe styles */
        .page-iframe {
            width: 100%;
            height: 80vh;
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            background: white;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #64748b;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 0.875rem;
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                margin: 10px;
                border-radius: 16px;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 1rem;
            }

            .nav-content {
                padding: 0 1rem;
                gap: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .stat-card {
                padding: 1.5rem;
            }
        }

        /* Hidden class */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">🍽️</div>
                    <span>VEDI Admin</span>
                </div>
                <div class="header-info">
                    <div class="user-info">
                        <div class="user-avatar">👋</div>
                        <span>Welcome, <span id="adminName">Admin</span></span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">
                        <span>🚪</span>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <div class="nav-content">
                <div class="nav-tab active" onclick="showSection('overview')">
                    <span>📊</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-tab" onclick="showSection('fee-management')">
                    <span>💰</span>
                    <span>Fee Management</span>
                </div>
                <div class="nav-tab" onclick="showSection('api-analytics')">
                    <span>🔌</span>
                    <span>API Analytics</span>
                </div>
                <div class="nav-tab" onclick="showSection('user-management')">
                    <span>👥</span>
                    <span>Users</span>
                </div>
                <div class="nav-tab" onclick="showSection('system-health')">
                    <span>💻</span>
                    <span>System Health</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <section id="overview-section" class="dashboard-overview">
                <h1 class="page-title">Dashboard Overview</h1>
                <p class="page-subtitle">Monitor your platform's performance and key metrics in real-time</p>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card users">
                        <div class="stat-header">
                            <div class="stat-title">Total Users</div>
                            <div class="stat-icon">👥</div>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-change positive">
                            <span class="trend-indicator trend-up">↗ +12%</span>
                            <span id="userGrowth">Getting started</span>
                        </div>
                    </div>

                    <div class="stat-card restaurants">
                        <div class="stat-header">
                            <div class="stat-title">Active Restaurants</div>
                            <div class="stat-icon">🏪</div>
                        </div>
                        <div class="stat-value" id="totalRestaurants">0</div>
                        <div class="stat-change positive">
                            <span class="trend-indicator trend-up">↗ +8%</span>
                            <span id="restaurantGrowth">Getting started</span>
                        </div>
                    </div>

                    <div class="stat-card orders">
                        <div class="stat-header">
                            <div class="stat-title">Today's Orders</div>
                            <div class="stat-icon">📋</div>
                        </div>
                        <div class="stat-value" id="todayOrders">0</div>
                        <div class="stat-change positive">
                            <span class="trend-indicator trend-up">↗ +24%</span>
                            <span id="orderGrowth">Getting started</span>
                        </div>
                    </div>

                    <div class="stat-card api">
                        <div class="stat-header">
                            <div class="stat-title">API Calls Today</div>
                            <div class="stat-icon">⚡</div>
                        </div>
                        <div class="stat-value" id="apiCalls">0</div>
                        <div class="stat-change positive">
                            <span class="trend-indicator trend-up">↗ +15%</span>
                            <span id="apiGrowth">Getting started</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">User Growth Analytics</h3>
                            <div class="chart-period">Last 7 Days</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">API Usage</h3>
                            <div class="chart-period">24 Hours</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="apiUsageChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Live Activity Feed -->
                <div class="activity-section">
                    <div class="activity-header">
                        <h3 class="chart-title">Live Activity Feed</h3>
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>Live</span>
                        </div>
                    </div>
                    <div class="activity-feed" id="activityFeed">
                        <div class="empty-state">
                            <div class="empty-state-icon">📡</div>
                            <h3>No Activity Yet</h3>
                            <p>Real-time activity will appear here as users interact with your platform</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Fee Management Section -->
            <section id="fee-management-section" class="hidden">
                <iframe 
                    src="fee-management.html" 
                    class="page-iframe"
                    title="Fee Management System">
                </iframe>
            </section>

            <!-- API Analytics Section -->
            <section id="api-analytics-section" class="hidden">
                <iframe 
                    src="api-analytics.html" 
                    class="page-iframe"
                    title="API Analytics Dashboard">
                </iframe>
            </section>

            <!-- User Management Section -->
            <section id="user-management-section" class="hidden">
                <iframe 
                    src="user-management.html" 
                    class="page-iframe"
                    title="User Management System">
                </iframe>
            </section>

            <!-- System Health Section -->
            <section id="system-health-section" class="hidden">
                <iframe 
                    src="system-health.html" 
                    class="page-iframe"
                    title="System Health Monitor">
                </iframe>
            </section>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDglG7Soj0eKu2SLoVby6n71S7gcQzHBPg",
            authDomain: "vedi00.firebaseapp.com",
            projectId: "vedi00",
            storageBucket: "vedi00.firebasestorage.app",
            messagingSenderId: "136867441640",
            appId: "1:136867441640:web:9ec709b63f5690f628125d",
            measurementId: "G-ZS0FKPTEY2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Chart instances
        let userGrowthChart, apiUsageChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
        });

        // Check admin authentication
        async function checkAdminAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const isAdmin = await checkIfAdmin(user.uid);
                    if (isAdmin) {
                        const adminData = await getAdminData(user.uid);
                        document.getElementById('adminName').textContent = adminData.name;
                        initializeDashboard();
                    } else {
                        alert('Access denied. Redirecting to login...');
                        window.location.href = 'admin-auth.html';
                    }
                } else {
                    window.location.href = 'admin-auth.html';
                }
            });
        }

        // Check if user is admin
        async function checkIfAdmin(userId) {
            try {
                const adminDoc = await db.collection('adminUsers').doc(userId).get();
                return adminDoc.exists;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // Get admin data
        async function getAdminData(userId) {
            try {
                const adminDoc = await db.collection('adminUsers').doc(userId).get();
                return adminDoc.data();
            } catch (error) {
                console.error('Error getting admin data:', error);
                return { name: 'Admin' };
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            await loadDashboardData();
            initializeCharts();
            loadActivityFeed();
            
            // Set up real-time updates
            setInterval(loadDashboardData, 30000); // Update every 30 seconds
            setInterval(loadActivityFeed, 10000); // Update activity every 10 seconds
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Check if APIs are available
                if (!window.VediAPI || !window.VediMaintenanceAPI) {
                    console.error('APIs not loaded');
                    // Set to zero and show API not loaded message
                    document.getElementById('totalUsers').textContent = '0';
                    document.getElementById('totalRestaurants').textContent = '0';
                    document.getElementById('todayOrders').textContent = '0';
                    document.getElementById('apiCalls').textContent = '0';
                    
                    document.getElementById('userGrowth').textContent = 'APIs not loaded';
                    document.getElementById('restaurantGrowth').textContent = 'APIs not loaded';
                    document.getElementById('orderGrowth').textContent = 'APIs not loaded';
                    document.getElementById('apiGrowth').textContent = 'APIs not loaded';
                    return;
                }

                // Use VediMaintenanceAPI for comprehensive system metrics
                const systemMetrics = await VediMaintenanceAPI.getSystemMetrics('today');
                
                // Update stats with comprehensive data
                document.getElementById('totalUsers').textContent = systemMetrics.totalUsers;
                document.getElementById('totalRestaurants').textContent = systemMetrics.totalRestaurants;
                document.getElementById('todayOrders').textContent = systemMetrics.ordersInPeriod;

                // Get API analytics
                const apiAnalytics = await VediMaintenanceAPI.getAPIAnalytics('today');
                document.getElementById('apiCalls').textContent = apiAnalytics.totalCalls;

                // Update growth indicators with detailed metrics
                const usersByType = systemMetrics.usersByType;
                const restaurantsByStatus = systemMetrics.restaurantsByStatus;
                
                document.getElementById('userGrowth').textContent = systemMetrics.totalUsers > 0 ? 
                    `${usersByType.restaurant || 0} restaurants, ${usersByType.venue || 0} venues` : 'No users yet';
                document.getElementById('restaurantGrowth').textContent = systemMetrics.totalRestaurants > 0 ? 
                    `${restaurantsByStatus.active || 0} active, ${restaurantsByStatus.pending || 0} pending` : 'No restaurants yet';
                document.getElementById('orderGrowth').textContent = systemMetrics.ordersInPeriod > 0 ? 
                    `Revenue: ${systemMetrics.revenueMetrics.total.toFixed(2)}` : 'No orders today';
                document.getElementById('apiGrowth').textContent = apiAnalytics.totalCalls > 0 ? 
                    `${apiAnalytics.errorRate}% error rate` : 'No API calls today';

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Fallback to basic Firebase queries if Maintenance API fails
                await loadBasicDashboardData();
            }
        }

        // Fallback method for basic data loading
        async function loadBasicDashboardData() {
            try {
                // Get real data from Firestore using basic queries
                const [usersSnapshot, restaurantsSnapshot, venuesSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('restaurants').get(),
                    db.collection('venues').get()
                ]);

                // Get today's orders
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const ordersSnapshot = await db.collection('orders')
                    .where('createdAt', '>=', today)
                    .get();

                // Get today's API calls
                const todayStr = new Date().toISOString().split('T')[0];
                const apiCallsSnapshot = await db.collection('apiCalls')
                    .where('date', '==', todayStr)
                    .get();

                // Update stats with real data
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('totalRestaurants').textContent = restaurantsSnapshot.size;
                document.getElementById('todayOrders').textContent = ordersSnapshot.size;
                document.getElementById('apiCalls').textContent = apiCallsSnapshot.size;

                // Update growth indicators
                document.getElementById('userGrowth').textContent = usersSnapshot.size > 0 ? 
                    `${usersSnapshot.size} total registered` : 'No users yet';
                document.getElementById('restaurantGrowth').textContent = restaurantsSnapshot.size > 0 ? 
                    `${restaurantsSnapshot.size} restaurants active` : 'No restaurants yet';
                document.getElementById('orderGrowth').textContent = ordersSnapshot.size > 0 ? 
                    `${ordersSnapshot.size} orders today` : 'No orders today';
                document.getElementById('apiGrowth').textContent = apiCallsSnapshot.size > 0 ? 
                    `${apiCallsSnapshot.size} API calls today` : 'No API calls today';

            } catch (error) {
                console.error('Error loading basic dashboard data:', error);
                // Set fallback values
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('totalRestaurants').textContent = '0';
                document.getElementById('todayOrders').textContent = '0';
                document.getElementById('apiCalls').textContent = '0';
                
                document.getElementById('userGrowth').textContent = 'Error loading data';
                document.getElementById('restaurantGrowth').textContent = 'Error loading data';
                document.getElementById('orderGrowth').textContent = 'Error loading data';
                document.getElementById('apiGrowth').textContent = 'Error loading data';
            }
        }

        // Initialize charts with real data
        function initializeCharts() {
            // User Growth Chart
            const userCtx = document.getElementById('userGrowthChart').getContext('2d');
            userGrowthChart = new Chart(userCtx, {
                type: 'line',
                data: {
                    labels: getLast7Days(),
                    datasets: [{
                        label: 'New Users',
                        data: [0, 0, 0, 0, 0, 0, 0], // Will be updated with real data
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#64748b',
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#64748b',
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });

            // API Usage Chart
            const apiCtx = document.getElementById('apiUsageChart').getContext('2d');
            apiUsageChart = new Chart(apiCtx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e5e7eb'],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    }
                }
            });

            // Load real chart data
            updateChartsWithRealData();
        }

        // Update charts with real data
        async function updateChartsWithRealData() {
            try {
                if (!window.VediAPI) {
                    console.log('VediAPI not available for chart updates');
                    return;
                }

                // Get user growth data for last 7 days
                const last7Days = getLast7Days();
                const userGrowthData = await Promise.all(last7Days.map(async (day, index) => {
                    const dayStart = new Date();
                    dayStart.setDate(dayStart.getDate() - (6 - index));
                    dayStart.setHours(0, 0, 0, 0);
                    
                    const dayEnd = new Date(dayStart);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const usersSnapshot = await db.collection('users')
                        .where('createdAt', '>=', dayStart)
                        .where('createdAt', '<=', dayEnd)
                        .get();
                    
                    return usersSnapshot.size;
                }));

                // Update user growth chart only if we have data
                const hasUserData = userGrowthData.some(val => val > 0);
                if (hasUserData) {
                    userGrowthChart.data.datasets[0].data = userGrowthData;
                    userGrowthChart.update();
                }

                // Get API usage data by method
                const apiCallsSnapshot = await db.collection('apiCalls').get();
                
                if (!apiCallsSnapshot.empty) {
                    const methodCounts = {};
                    apiCallsSnapshot.docs.forEach(doc => {
                        const call = doc.data();
                        const method = call.method || 'unknown';
                        methodCounts[method] = (methodCounts[method] || 0) + 1;
                    });

                    const topMethods = Object.entries(methodCounts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5);

                    if (topMethods.length > 0) {
                        apiUsageChart.data.labels = topMethods.map(([method]) => method);
                        apiUsageChart.data.datasets[0].data = topMethods.map(([,count]) => count);
                        apiUsageChart.data.datasets[0].backgroundColor = [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ];
                        apiUsageChart.update();
                    }
                }

            } catch (error) {
                console.error('Error updating charts with real data:', error);
            }
        }

        // Load activity feed with real data
        async function loadActivityFeed() {
            try {
                const activityFeed = document.getElementById('activityFeed');
                
                if (!window.VediMaintenanceAPI) {
                    activityFeed.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">⚠️</div>
                            <h3>Maintenance API Not Loaded</h3>
                            <p>Please ensure maintenance-api.js is loaded properly</p>
                        </div>
                    `;
                    return;
                }

                // Use VediMaintenanceAPI for real-time activity
                const activities = await VediMaintenanceAPI.getRealtimeActivity(10);
                
                if (activities.length === 0) {
                    activityFeed.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📡</div>
                            <h3>No Recent Activity</h3>
                            <p>Real-time activity will appear here as users interact with your platform</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                activities.forEach(activity => {
                    html += `
                        <div class="activity-item">
                            <div class="activity-icon" style="background: ${activity.color};">
                                ${activity.icon}
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">${activity.text}</div>
                                <div class="activity-time">${activity.time}</div>
                            </div>
                        </div>
                    `;
                });
                
                activityFeed.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading activity feed:', error);
                document.getElementById('activityFeed').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <h3>Unable to Load Activity</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            const sections = ['overview', 'fee-management', 'api-analytics', 'user-management', 'system-health'];
            sections.forEach(section => {
                document.getElementById(`${section}-section`).classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            
            // Add active class to clicked tab
            event.target.closest('.nav-tab').classList.add('active');
        }

        // Utility functions
        function getStartOfDay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }

        function getLast7Days() {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }
            return days;
        }

        function timestampToDate(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate();
            }
            return new Date(timestamp);
        }

        function getRelativeTime(timestamp) {
            const date = timestampToDate(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        // Handle logout
        async function handleLogout() {
            try {
                await auth.signOut();
                window.location.href = 'admin-auth.html';
            } catch (error) {
                alert('Error signing out. Please try again.');
            }
        }
    </script>
</body>
</html>
