<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Complete Your Order</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../firebase-api.js"></script>
    
    <!-- VediAPI Pricing Extensions -->
    <script src="../vediapi-pricing-extensions.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 320px;
            width: 90%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #2d3748;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-subtext {
            color: #718096;
            font-size: 0.9rem;
        }

        /* Session Warning */
        .session-warning {
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
            border: 1px solid #f6ad55;
            color: #c05621;
            padding: 16px 20px;
            display: none;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(246, 173, 85, 0.2);
        }

        .session-warning.show {
            display: flex;
        }

        .session-warning-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .session-warning-text {
            flex: 1;
            line-height: 1.4;
        }

        .reauth-btn {
            background: #c05621;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .reauth-btn:hover {
            background: #9c4221;
            transform: translateY(-1px);
        }

        /* Header Styles */
        .checkout-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-2px);
        }

        .header-info {
            flex: 1;
        }

        .restaurant-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .customer-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .auth-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(46, 204, 113, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .auth-indicator.social {
            background: rgba(52, 152, 219, 0.2);
            border-color: rgba(52, 152, 219, 0.3);
        }

        .auth-indicator.phone {
            background: rgba(155, 89, 182, 0.2);
            border-color: rgba(155, 89, 182, 0.3);
        }

        /* Content Styles */
        .checkout-content {
            padding: 24px 20px;
            padding-bottom: 120px;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Cart Items */
        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .cart-item {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .cart-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .cart-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .cart-item:hover::before {
            transform: scaleX(1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .item-name {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
            line-height: 1.3;
        }

        .item-unit-price {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .item-description {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .item-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #f7fafc;
            padding: 8px 16px;
            border-radius: 16px;
        }

        .qty-btn {
            width: 36px;
            height: 36px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .qty-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .qty-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .qty-display {
            font-weight: 700;
            font-size: 1.2rem;
            min-width: 32px;
            text-align: center;
            color: #2d3748;
        }

        .item-total {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .item-total-price {
            font-weight: 700;
            font-size: 1.2rem;
            color: #2d3748;
        }

        .remove-btn {
            background: #fed7d7;
            color: #c53030;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .remove-btn:hover {
            background: #feb2b2;
            transform: translateY(-1px);
        }

        /* Order Summary */
        .order-summary {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row.total {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin: 16px -24px -24px -24px;
            padding: 20px 24px;
            border-radius: 0 0 20px 20px;
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Service Fee Breakdown */
        .fee-breakdown {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            border: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .fee-breakdown-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fee-breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            color: #718096;
        }

        .fee-breakdown-item:last-child {
            margin-bottom: 0;
        }

        .breakdown-label {
            font-size: 0.8rem;
        }

        .breakdown-value {
            font-weight: 600;
        }

        .your-margin {
            color: #10b981;
        }

        .stripe-fees {
            color: #6366f1;
        }

        /* Pricing Status Indicator */
        .pricing-status {
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pricing-status.success {
            background: #f0fdf4;
            border-color: #16a34a;
            color: #166534;
        }

        .pricing-status.error {
            background: #fef2f2;
            border-color: #dc2626;
            color: #991b1b;
        }

        .pricing-status.warning {
            background: #fffbeb;
            border-color: #d97706;
            color: #92400e;
        }

        /* Special Instructions */
        .form-textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
            font-family: inherit;
            background: white;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .allergen-notice {
            background: linear-gradient(135deg, #fed7e2, #fbb6ce);
            color: #97266d;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            margin-bottom: 12px;
            border: 1px solid #f687b3;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .allergen-notice-icon {
            font-size: 1.1rem;
        }

        /* Place Order Button */
        .place-order-section {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 380px;
            z-index: 1000;
        }

        .place-order-btn {
            width: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 20px 24px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 20px 50px rgba(72, 187, 120, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .place-order-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 25px 60px rgba(72, 187, 120, 0.5);
        }

        .place-order-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #9ca3af;
        }

        /* Empty Cart */
        .empty-cart {
            text-align: center;
            padding: 80px 20px;
            color: #718096;
        }

        .empty-cart-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .empty-cart h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .empty-cart p {
            margin-bottom: 32px;
            font-size: 1.1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        /* Error States */
        .error-message {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #c53030;
            padding: 20px;
            border-radius: 16px;
            margin: 16px;
            border: 1px solid #fc8181;
            text-align: center;
        }

        .button-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateX(100%);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Debug Panel */
        .debug-panel {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-title {
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .debug-item {
            margin-bottom: 4px;
        }

        .debug-label {
            color: #fbbf24;
        }

        .debug-value {
            color: #34d399;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                border-radius: 0;
            }

            .checkout-header {
                padding: 20px 16px;
            }

            .checkout-content {
                padding: 20px 16px;
                padding-bottom: 120px;
            }

            .cart-item {
                padding: 20px;
            }

            .restaurant-title {
                font-size: 1.5rem;
            }

            .place-order-section {
                width: calc(100% - 20px);
                bottom: 10px;
            }

            .customer-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .auth-indicator {
                font-size: 0.7rem;
                padding: 2px 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading checkout...</div>
            <div class="loading-subtext">Calculating protected pricing</div>
        </div>
    </div>

    <div class="container">
        <!-- Session Warning -->
        <div class="session-warning" id="sessionWarning">
            <div class="session-warning-icon">⚠️</div>
            <div class="session-warning-text">
                Your session has expired. Please sign in again to complete your order.
            </div>
            <button class="reauth-btn" onclick="redirectToLogin()">Sign In</button>
        </div>

        <!-- Header -->
        <div class="checkout-header">
            <div class="header-content">
                <button class="back-btn" onclick="goBackToMenu()">←</button>
                <div class="header-info">
                    <h1 class="restaurant-title" id="restaurantName">Loading...</h1>
                    <div class="customer-info" id="customerInfoDisplay">
                        <span id="customerText">Loading...</span>
                        <div class="auth-indicator" id="authIndicator">
                            <span id="authIcon">🔐</span>
                            <span id="authText">Secured</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="checkout-content" id="checkoutContent" style="display: none;">
            <!-- Pricing Status Indicator -->
            <div class="pricing-status" id="pricingStatus" style="display: none;">
                <span id="pricingStatusIcon">🔄</span>
                <span id="pricingStatusText">Calculating pricing...</span>
            </div>

            <!-- Cart Items Section -->
            <div class="section">
                <h2 class="section-title" id="orderSectionTitle">🛒 Your Order</h2>
                <div class="cart-items" id="cartItemsList">
                    <!-- Cart items will be populated here -->
                </div>
            </div>

            <!-- Order Summary -->
            <div class="section">
                <h2 class="section-title">📊 Order Summary</h2>
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="summary-row" id="taxRow">
                        <span id="taxLabel">Tax:</span>
                        <span id="tax">$0.00</span>
                    </div>
                    <div class="summary-row" id="serviceFeeRow">
                        <span id="serviceFeeLabel">Service Fee:</span>
                        <span id="serviceFee">$0.00</span>
                    </div>
                    <!-- Service Fee Breakdown for Testing -->
                    <div class="fee-breakdown" id="feeBreakdown" style="display: none;">
                        <div class="fee-breakdown-title">
                            <span>🔍</span>
                            <span>Fee Breakdown (Testing)</span>
                        </div>
                        <div class="fee-breakdown-item">
                            <span class="breakdown-label your-margin">• Your Margin:</span>
                            <span class="breakdown-value your-margin" id="yourMargin">$0.00</span>
                        </div>
                        <div class="fee-breakdown-item">
                            <span class="breakdown-label stripe-fees">• Stripe Fees:</span>
                            <span class="breakdown-value stripe-fees" id="stripeFees">$0.00</span>
                        </div>
                        <div class="fee-breakdown-item">
                            <span class="breakdown-label">• Gross-up Amount:</span>
                            <span class="breakdown-value" id="grossupAmount">$0.00</span>
                        </div>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>

                <!-- Debug Panel -->
                <div class="debug-panel" id="debugPanel">
                    <div class="debug-title">🔧 Pricing Debug Information</div>
                    <div id="debugContent">
                        <!-- Debug info will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Special Instructions -->
            <div class="section">
                <h2 class="section-title">💬 Special Instructions</h2>
                <div id="allergenNotice" class="allergen-notice" style="display: none;">
                    <span class="allergen-notice-icon">🛡️</span>
                    <span>Your allergen preferences have been automatically added below.</span>
                </div>
                <textarea class="form-textarea" id="specialInstructions" placeholder="Any special requests or dietary restrictions? (Optional)"></textarea>
            </div>
        </div>

        <!-- Empty Cart State -->
        <div class="empty-cart" id="emptyCart" style="display: none;">
            <div class="empty-cart-icon">🛒</div>
            <h3>Your cart is empty</h3>
            <p>Add some delicious items from our menu to get started!</p>
            <button class="btn-primary" onclick="goBackToMenu()">
                Browse Menu
            </button>
        </div>

        <!-- Error State -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <h3>⚠️ Unable to load checkout</h3>
            <p>Please try refreshing the page or go back to the menu.</p>
            <button onclick="location.reload()" style="margin-top: 16px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">
                Try Again
            </button>
        </div>

        <!-- Place Order Button -->
        <div class="place-order-section" id="placeOrderSection" style="display: none;">
            <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">
                <span id="orderBtnText">Place Order</span>
                <div class="button-spinner" id="orderBtnSpinner" style="display: none;"></div>
            </button>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // ============================================================================
        // GLOBAL VARIABLES & STATE
        // ============================================================================
        
        let currentRestaurant = null;
        let cart = {};
        let menuItems = {};
        let customerData = {};
        let customerSession = {};
        let currentUser = null;
        let customerAllergenInfo = null;
        let orderBreakdown = null;
        let protectedPricingCalculated = false;
        let pricingCalculationAttempts = 0;

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Protected pricing checkout initializing...');
            
            try {
                await initializeCheckoutPage();
            } catch (error) {
                console.error('Error initializing checkout page:', error);
                showErrorMessage('Failed to load checkout. Please try refreshing the page.');
                hideLoading();
            }
        });

        async function initializeCheckoutPage() {
            showLoading();
            
            try {
                // Step 1: Check authentication
                await checkAuthenticationAndSession();
                
                // Step 2: Get customer data from URL
                getCustomerDataFromURL();
                
                // Step 3: Load restaurant and menu data
                await loadRestaurantAndMenuData();
                
                // Step 4: Load cart and allergen data
                loadCartData();
                loadAllergenInfo();
                
                // Step 5: Calculate protected pricing using VediAPI extensions
                await calculateProtectedPricing();
                
                // Step 6: Update UI
                updateCustomerDisplay();
                renderCheckout();
                
                hideLoading();
                console.log('✅ Checkout loaded successfully');
                
            } catch (error) {
                console.error('Checkout initialization error:', error);
                showErrorMessage('Failed to load checkout: ' + error.message);
                hideLoading();
            }
        }

        // ============================================================================
        // AUTHENTICATION & SESSION MANAGEMENT
        // ============================================================================
        
        async function checkAuthenticationAndSession() {
            return new Promise((resolve, reject) => {
                firebase.auth().onAuthStateChanged(async function(user) {
                    if (user) {
                        console.log('✅ User is authenticated for checkout');
                        currentUser = user;
                        await loadCustomerSession();
                        
                        if (!verifySessionConsistency()) {
                            console.warn('⚠️ Session inconsistency detected');
                            showSessionWarning();
                            redirectToLogin();
                            reject(new Error('Session inconsistency'));
                            return;
                        }
                        
                        resolve(user);
                        
                    } else {
                        console.log('❌ User not authenticated for checkout');
                        showSessionWarning();
                        redirectToLogin();
                        reject(new Error('User not authenticated'));
                    }
                });
            });
        }

        async function loadCustomerSession() {
            try {
                const sessionData = sessionStorage.getItem('customerSession');
                if (sessionData) {
                    customerSession = JSON.parse(sessionData);
                    if (customerSession.firebaseUID !== currentUser.uid) {
                        console.warn('⚠️ Session UID mismatch in checkout');
                        customerSession = {};
                    }
                } else {
                    customerSession = {};
                }
                
                try {
                    const profile = await VediAPI.getCustomerProfile(currentUser.uid);
                    if (profile) {
                        customerSession = { ...customerSession, ...profile };
                    }
                } catch (profileError) {
                    console.log('ℹ️ No customer profile found for checkout');
                }
                
            } catch (error) {
                console.error('❌ Error loading customer session:', error);
                customerSession = {};
            }
        }

        function verifySessionConsistency() {
            const hasUserAuth = currentUser && currentUser.uid;
            const hasCartData = Object.keys(cart).length > 0 || sessionStorage.getItem('customerCart');
            return hasUserAuth && hasCartData;
        }

        function showSessionWarning() {
            const warning = document.getElementById('sessionWarning');
            if (warning) {
                warning.classList.add('show');
            }
        }

        function redirectToLogin() {
            const currentParams = new URLSearchParams(window.location.search);
            const loginUrl = `customer-login.html?${currentParams.toString()}`;
            setTimeout(() => {
                window.location.href = loginUrl;
            }, 2000);
        }

        // ============================================================================
        // DATA LOADING
        // ============================================================================
        
        function getCustomerDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            
            customerData = {
                restaurantId: urlParams.get('restaurant') || customerSession.restaurantId,
                tableNumber: urlParams.get('table') || customerSession.tableNumber,
                location: urlParams.get('location') || customerSession.location,
                name: urlParams.get('name') || customerSession.name || currentUser?.displayName,
                phone: urlParams.get('phone') || customerSession.phone || currentUser?.phoneNumber
            };
            
            if (!customerData.restaurantId) {
                const savedData = sessionStorage.getItem('customerData');
                if (savedData) {
                    const sessionCustomer = JSON.parse(savedData);
                    customerData = { ...sessionCustomer, ...customerData };
                }
            }
            
            if (!customerData.restaurantId) {
                throw new Error('No restaurant ID found. Please start from the menu page.');
            }
            
            if (customerData.location === 'counter') {
                customerData.tableDisplay = 'At Counter';
            } else if (customerData.tableNumber) {
                customerData.tableDisplay = `Table ${customerData.tableNumber}`;
            } else {
                customerData.tableDisplay = 'Restaurant Order';
            }
        }

        async function loadRestaurantAndMenuData() {
            try {
                currentRestaurant = await VediAPI.getRestaurant(customerData.restaurantId);
                console.log('🏪 Loaded restaurant for checkout:', currentRestaurant.name);
                
                const menuItemsData = await VediAPI.getMenuItems(customerData.restaurantId);
                menuItems = {};
                menuItemsData.forEach(item => {
                    menuItems[item.id] = item;
                });

                console.log('📊 Loaded menu items for checkout:', Object.keys(menuItems).length);

            } catch (error) {
                console.error('Error loading restaurant/menu data:', error);
                throw error;
            }
        }

        function loadCartData() {
            try {
                const savedCartData = sessionStorage.getItem('customerCart');
                if (savedCartData) {
                    const cartData = JSON.parse(savedCartData);
                    
                    if (cartData.customerUID && 
                        currentUser && 
                        cartData.customerUID === currentUser.uid &&
                        cartData.restaurantId === customerData.restaurantId) {
                        
                        cart = cartData.items || {};
                        console.log('🛒 Loaded verified cart for authenticated user:', cart);
                    } else if (!cartData.customerUID) {
                        cart = cartData.items || cartData || {};
                        console.log('🛒 Loaded legacy cart for checkout:', cart);
                    } else {
                        console.log('🛒 Cart verification failed in checkout, starting fresh');
                        cart = {};
                    }
                } else {
                    console.log('🛒 No cart found in checkout');
                    cart = {};
                }
            } catch (error) {
                console.error('Error loading cart in checkout:', error);
                cart = {};
            }
        }

        function loadAllergenInfo() {
            try {
                const savedAllergenInfo = sessionStorage.getItem('customerAllergenInfo');
                if (savedAllergenInfo) {
                    customerAllergenInfo = JSON.parse(savedAllergenInfo);
                    console.log('🛡️ Customer allergen info loaded for checkout:', customerAllergenInfo);
                    populateAllergenInstructions();
                } else {
                    console.log('🛡️ No allergen info found for checkout');
                    customerAllergenInfo = null;
                }
            } catch (error) {
                console.error('Error loading allergen info:', error);
                customerAllergenInfo = null;
            }
        }

        function populateAllergenInstructions() {
            if (!customerAllergenInfo) return;

            const specialInstructionsTextarea = document.getElementById('specialInstructions');
            const allergenNotice = document.getElementById('allergenNotice');
            
            const { allergenNames, customAllergens } = customerAllergenInfo;
            
            if (allergenNames.length > 0 || customAllergens) {
                let allergenText = '';
                
                if (allergenNames.length > 0) {
                    allergenText += `🛡️ ALLERGIES: Please avoid ${allergenNames.join(', ')}`;
                }
                
                if (customAllergens) {
                    if (allergenText) allergenText += '. ';
                    allergenText += `Additional restrictions: ${customAllergens}`;
                }
                
                if (allergenText) {
                    allergenText += '.';
                    specialInstructionsTextarea.value = allergenText;
                    allergenNotice.style.display = 'flex';
                    console.log('🛡️ Auto-populated allergen instructions for checkout:', allergenText);
                }
            }
        }

        // ============================================================================
        // PROTECTED PRICING CALCULATION
        // ============================================================================
        
        async function calculateProtectedPricing() {
            const cartItemsCount = Object.values(cart).reduce((sum, qty) => sum + (qty || 0), 0);
            
            if (cartItemsCount === 0) {
                console.log('ℹ️ No items in cart, skipping pricing calculation');
                return;
            }

            // Calculate subtotal
            let subtotal = 0;
            for (let itemId in cart) {
                if (cart[itemId] > 0 && menuItems[itemId]) {
                    subtotal += menuItems[itemId].price * cart[itemId];
                }
            }

            pricingCalculationAttempts++;
            showPricingStatus('calculating', 'Calculating protected pricing...');

            try {
                console.log('🔄 Calculating protected pricing via VediAPI extensions...');
                console.log('📊 Restaurant ID:', customerData.restaurantId);
                console.log('💰 Subtotal:', subtotal);
                
                // Wait for VediAPI extensions to be available with the new robust system
                let attempts = 0;
                const maxAttempts = 150; // 15 seconds to match new extension timeout
                
                while (attempts < maxAttempts) {
                    // Check if VediAPI and extensions are available
                    if (typeof VediAPI !== 'undefined' && 
                        VediAPI && 
                        typeof VediAPI.getProtectedPricingBreakdown === 'function') {
                        console.log('✅ VediAPI extensions found after', attempts * 100, 'ms');
                        break;
                    }
                    
                    // Try manual initialization if available
                    if (typeof window.initializeVediAPIExtensions === 'function' && attempts === 30) {
                        console.log('🔄 Attempting manual VediAPI extension initialization...');
                        try {
                            await window.initializeVediAPIExtensions();
                            console.log('✅ Manual initialization succeeded');
                            break;
                        } catch (error) {
                            console.warn('⚠️ Manual initialization failed:', error.message);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!VediAPI || typeof VediAPI.getProtectedPricingBreakdown !== 'function') {
                    throw new Error('VediAPI pricing extensions not available after 15 seconds');
                }
                
                console.log('🧮 Using VediAPI extensions for protected pricing calculation...');
                
                // Use the VediAPI extension method
                const breakdown = await VediAPI.getProtectedPricingBreakdown(
                    customerData.restaurantId,
                    Math.round(subtotal * 100)
                );
                
                console.log('✅ VediAPI calculation successful:', breakdown);
                
                // Store the VediAPI result
                orderBreakdown = {
                    subtotal: breakdown.subtotal,
                    taxAmount: breakdown.taxAmount,
                    taxRate: breakdown.taxRate,
                    serviceFee: breakdown.serviceFee,
                    serviceFeePercentage: breakdown.serviceFeePercentage,
                    total: breakdown.total,
                    backendData: breakdown.breakdown,
                    marginProtected: true,
                    calculationSource: 'vediapi-extensions-v2',
                    feeConfig: breakdown.feeConfig
                };

                protectedPricingCalculated = true;
                
                console.log('🛡️ Using VediAPI protected pricing:', orderBreakdown);
                console.log('📊 Tax rate from VediAPI:', breakdown.taxRate + '%');
                console.log('💰 Customer total:', orderBreakdown.total);
                console.log('🔍 Fee breakdown available:', !!breakdown.breakdown);
                
                showPricingStatus('success', `Protected pricing calculated successfully (attempt ${pricingCalculationAttempts})`);
                updateDebugPanel(breakdown);
                
            } catch (error) {
                console.error('❌ VediAPI calculation failed:', error);
                console.error('📊 Available diagnostics:', typeof window.getVediAPIDiagnostics === 'function' ? 
                    window.getVediAPIDiagnostics() : 'Diagnostics not available');
                
                showPricingStatus('error', `Pricing calculation failed: ${error.message}`);
                
                // Show error to user and don't use fallback to avoid masking the real problem
                showError('Unable to calculate pricing. Please refresh the page and try again.');
                
                // Set a flag to prevent order placement
                protectedPricingCalculated = false;
                orderBreakdown = null;
                
                // Log detailed error information for debugging
                console.error('🚨 PRICING CALCULATION FAILED - Order placement should be disabled');
                console.error('🔧 Troubleshooting steps:');
                console.error('   1. Check browser console for VediAPI loading errors');
                console.error('   2. Run: window.getVediAPIDiagnostics()');
                console.error('   3. Run: window.testVediAPIPricing("' + customerData.restaurantId + '")');
                console.error('   4. Try: window.initializeVediAPIExtensions()');
                
                updateDebugPanel(null, error);
                
                throw error; // Re-throw to prevent further processing
            }
        }

        // ============================================================================
        // UI DISPLAY FUNCTIONS
        // ============================================================================
        
        function updateCustomerDisplay() {
            document.getElementById('restaurantName').textContent = currentRestaurant.name;
            
            let displayName = 'Guest';
            if (customerData.name) {
                displayName = customerData.name.split(' ')[0];
            } else if (customerSession.name) {
                displayName = customerSession.name.split(' ')[0];
            } else if (currentUser?.displayName) {
                displayName = currentUser.displayName.split(' ')[0];
            }
            
            let customerText = `${displayName} • ${customerData.tableDisplay}`;
            document.getElementById('customerText').textContent = customerText;
            
            updateAuthenticationIndicator();
        }

        function updateAuthenticationIndicator() {
            const authIndicator = document.getElementById('authIndicator');
            const authIcon = document.getElementById('authIcon');
            const authText = document.getElementById('authText');
            
            if (!currentUser) {
                authIndicator.className = 'auth-indicator';
                authIcon.textContent = '❌';
                authText.textContent = 'Not Signed In';
                return;
            }
            
            const providerId = currentUser.providerData[0]?.providerId;
            
            if (providerId === 'phone') {
                authIndicator.className = 'auth-indicator phone';
                authIcon.textContent = '📱';
                authText.textContent = 'Phone';
            } else if (providerId === 'google.com') {
                authIndicator.className = 'auth-indicator social';
                authIcon.textContent = '🔍';
                authText.textContent = 'Google';
            } else if (providerId === 'facebook.com') {
                authIndicator.className = 'auth-indicator social';
                authIcon.textContent = '📘';
                authText.textContent = 'Facebook';
            } else if (providerId === 'apple.com') {
                authIndicator.className = 'auth-indicator social';
                authIcon.textContent = '🍎';
                authText.textContent = 'Apple';
            } else {
                authIndicator.className = 'auth-indicator';
                authIcon.textContent = '🔐';
                authText.textContent = 'Secured';
            }
        }

        function showPricingStatus(type, message) {
            const statusElement = document.getElementById('pricingStatus');
            const statusIcon = document.getElementById('pricingStatusIcon');
            const statusText = document.getElementById('pricingStatusText');
            
            statusElement.className = `pricing-status ${type}`;
            statusText.textContent = message;
            
            switch (type) {
                case 'calculating':
                    statusIcon.textContent = '🔄';
                    break;
                case 'success':
                    statusIcon.textContent = '✅';
                    break;
                case 'error':
                    statusIcon.textContent = '❌';
                    break;
                case 'warning':
                    statusIcon.textContent = '⚠️';
                    break;
            }
            
            statusElement.style.display = 'flex';
        }

        function updateDebugPanel(breakdown, error = null) {
            const debugPanel = document.getElementById('debugPanel');
            const debugContent = document.getElementById('debugContent');
            
            let debugHTML = '';
            
            if (error) {
                debugHTML += `<div class="debug-item"><span class="debug-label">Error:</span> <span style="color: #ef4444;">${error.message}</span></div>`;
            }
            
            if (breakdown) {
                debugHTML += `<div class="debug-item"><span class="debug-label">Source:</span> <span class="debug-value">${breakdown.meta?.version || 'vediapi-extensions'}</span></div>`;
                debugHTML += `<div class="debug-item"><span class="debug-label">Restaurant ID:</span> <span class="debug-value">${customerData.restaurantId}</span></div>`;
                debugHTML += `<div class="debug-item"><span class="debug-label">Fee Type:</span> <span class="debug-value">${breakdown.feeConfig?.feeType || 'unknown'}</span></div>`;
                debugHTML += `<div class="debug-item"><span class="debug-label">Tax Rate:</span> <span class="debug-value">${breakdown.taxRate}%</span></div>`;
                debugHTML += `<div class="debug-item"><span class="debug-label">Service Fee %:</span> <span class="debug-value">${breakdown.serviceFeePercentage.toFixed(2)}%</span></div>`;
                debugHTML += `<div class="debug-item"><span class="debug-label">Margin Protected:</span> <span class="debug-value">${breakdown.breakdown?.marginProtected || false}</span></div>`;
                debugHTML += `<div class="debug-item"><span class="debug-label">Calculation Time:</span> <span class="debug-value">${new Date(breakdown.meta?.timestamp || Date.now()).toLocaleTimeString()}</span></div>`;
            }
            
            debugHTML += `<div class="debug-item"><span class="debug-label">Attempts:</span> <span class="debug-value">${pricingCalculationAttempts}</span></div>`;
            debugHTML += `<div class="debug-item"><span class="debug-label">VediAPI Available:</span> <span class="debug-value">${typeof VediAPI !== 'undefined'}</span></div>`;
            debugHTML += `<div class="debug-item"><span class="debug-label">Extensions Available:</span> <span class="debug-value">${typeof VediAPI?.getProtectedPricingBreakdown === 'function'}</span></div>`;
            
            debugContent.innerHTML = debugHTML;
            debugPanel.classList.add('show');
        }

        function renderCheckout() {
            const cartItemsCount = Object.values(cart).reduce((sum, qty) => sum + (qty || 0), 0);
            
            console.log('🎨 Rendering checkout with protected pricing:', protectedPricingCalculated);
            
            if (cartItemsCount === 0) {
                showEmptyCart();
                return;
            }

            renderCartItems();
            displayProtectedPricing();
            
            // Show checkout content and conditionally show place order button
            document.getElementById('checkoutContent').style.display = 'block';
            
            if (protectedPricingCalculated && orderBreakdown) {
                document.getElementById('placeOrderSection').style.display = 'block';
            } else {
                document.getElementById('placeOrderSection').style.display = 'none';
            }
        }

        function displayProtectedPricing() {
            if (!protectedPricingCalculated || !orderBreakdown) {
                console.warn('⚠️ Protected pricing not calculated yet');
                showPricingStatus('warning', 'Pricing calculation pending...');
                return;
            }

            console.log('💰 Displaying protected pricing:', orderBreakdown);

            // Update display with protected values
            document.getElementById('subtotal').textContent = formatPrice(orderBreakdown.subtotal);
            document.getElementById('tax').textContent = formatPrice(orderBreakdown.taxAmount);
            document.getElementById('serviceFee').textContent = formatPrice(orderBreakdown.serviceFee);
            document.getElementById('total').textContent = formatPrice(orderBreakdown.total);

            // Update labels with dynamic rates
            const taxRate = orderBreakdown.taxRate.toFixed(1);
            document.getElementById('taxLabel').innerHTML = `Tax (${taxRate}%):`;

            // Update service fee label with dynamic percentage
            const serviceFeePercentage = orderBreakdown.serviceFeePercentage.toFixed(1);
            document.getElementById('serviceFeeLabel').innerHTML = `Service Fee (${serviceFeePercentage}%):`;

            // Show fee breakdown for testing if we have backend data
            if (orderBreakdown.backendData) {
                displayFeeBreakdown();
            }

            // Update place order button text
            document.getElementById('orderBtnText').textContent = `Place Order • ${formatPrice(orderBreakdown.total)}`;

            console.log('✅ Protected pricing displayed - Customer pays:', formatPrice(orderBreakdown.total));
            console.log('🏛️ Tax rate:', taxRate + '%');
        }

        function displayFeeBreakdown() {
            const breakdown = orderBreakdown.backendData;
            if (!breakdown) return;

            const feeBreakdownElement = document.getElementById('feeBreakdown');
            
            // Calculate the breakdown amounts
            const yourMargin = breakdown.desiredServiceFee || 0;
            const stripeFees = (breakdown.stripeFeePercentage || 2.9) * orderBreakdown.subtotal / 100 + (breakdown.stripeFlatFee || 30) / 100;
            const grossupAmount = breakdown.grossUpAmount || 0;

            // Update the breakdown display
            document.getElementById('yourMargin').textContent = formatPrice(yourMargin);
            document.getElementById('stripeFees').textContent = formatPrice(stripeFees);
            document.getElementById('grossupAmount').textContent = formatPrice(grossupAmount);

            // Show the breakdown
            feeBreakdownElement.style.display = 'block';

            console.log('🔍 Fee breakdown displayed:', {
                yourMargin: formatPrice(yourMargin),
                stripeFees: formatPrice(stripeFees),
                grossupAmount: formatPrice(grossupAmount),
                totalServiceFee: formatPrice(orderBreakdown.serviceFee)
            });
        }

        function renderCartItems() {
            const cartItemsList = document.getElementById('cartItemsList');
            let html = '';

            for (let itemId in cart) {
                if (cart[itemId] > 0 && menuItems[itemId]) {
                    const item = menuItems[itemId];
                    const quantity = cart[itemId];
                    const itemTotal = item.price * quantity;

                    html += `
                        <div class="cart-item" data-item-id="${itemId}">
                            <div class="item-header">
                                <div class="item-name">${item.name}</div>
                                <div class="item-unit-price">${formatPrice(item.price)}</div>
                            </div>
                            <div class="item-description">${item.description || ''}</div>
                            <div class="item-controls">
                                <div class="quantity-controls">
                                    <button class="qty-btn" onclick="updateQuantity('${itemId}', -1)" ${quantity <= 1 ? 'disabled' : ''}>−</button>
                                    <span class="qty-display">${quantity}</span>
                                    <button class="qty-btn" onclick="updateQuantity('${itemId}', 1)">+</button>
                                </div>
                                <div class="item-total">
                                    <div class="item-total-price">${formatPrice(itemTotal)}</div>
                                    <button class="remove-btn" onclick="removeItem('${itemId}')">Remove</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            cartItemsList.innerHTML = html;
        }

        function showEmptyCart() {
            document.getElementById('checkoutContent').style.display = 'none';
            document.getElementById('placeOrderSection').style.display = 'none';
            document.getElementById('emptyCart').style.display = 'block';
        }

        // ============================================================================
        // CART MANIPULATION
        // ============================================================================
        
        async function updateQuantity(itemId, change) {
            console.log(`🔢 Updating quantity for item ${itemId} by ${change}`);
            
            if (!cart[itemId]) cart[itemId] = 0;
            
            cart[itemId] += change;
            
            if (cart[itemId] <= 0) {
                delete cart[itemId];
            }

            saveCart();
            
            // Recalculate protected pricing immediately
            await calculateProtectedPricing();
            
            // Re-render with new protected pricing
            renderCheckout();
        }

        async function removeItem(itemId) {
            if (confirm('Remove this item from your cart?')) {
                console.log(`🗑️ Removing item ${itemId}`);
                delete cart[itemId];
                saveCart();
                
                // Recalculate protected pricing immediately
                await calculateProtectedPricing();
                
                // Re-render with new protected pricing
                renderCheckout();
            }
        }

        function saveCart() {
            const cartData = {
                items: cart,
                customerUID: currentUser ? currentUser.uid : null,
                restaurantId: customerData.restaurantId,
                timestamp: new Date().toISOString()
            };
            sessionStorage.setItem('customerCart', JSON.stringify(cartData));
        }

        // ============================================================================
        // ORDER PLACEMENT - MODIFIED TO GO DIRECTLY TO ORDER PROGRESS
        // ============================================================================
        
        async function placeOrder() {
            console.log('📝 Placing order directly and redirecting to order progress...');
            
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            const orderBtnText = document.getElementById('orderBtnText');
            const orderBtnSpinner = document.getElementById('orderBtnSpinner');
            
            // Disable button and show loading
            placeOrderBtn.disabled = true;
            orderBtnText.style.display = 'none';
            orderBtnSpinner.style.display = 'block';

            try {
                if (!currentUser) {
                    throw new Error('Authentication required. Please sign in to place an order.');
                }

                // CRITICAL: Check if protected pricing calculation succeeded
                if (!orderBreakdown || !protectedPricingCalculated) {
                    throw new Error('Pricing calculation failed. Cannot place order without proper pricing.');
                }

                // Verify we have a valid calculation source
                if (!orderBreakdown.calculationSource || orderBreakdown.calculationSource !== 'vediapi-extensions-v2') {
                    console.warn('⚠️ Order breakdown not from VediAPI extensions v2:', orderBreakdown);
                    throw new Error('Invalid pricing calculation source. Please refresh and try again.');
                }

                // Check if cart has items
                const cartItemsCount = Object.values(cart).reduce((sum, qty) => sum + (qty || 0), 0);
                if (cartItemsCount === 0) {
                    throw new Error('No items in cart to order');
                }

                // Log the pricing calculation for verification
                console.log('🔍 Order breakdown verification:', {
                    source: orderBreakdown.calculationSource,
                    marginProtected: orderBreakdown.marginProtected,
                    taxRate: orderBreakdown.taxRate,
                    serviceFeePercentage: orderBreakdown.serviceFeePercentage,
                    total: orderBreakdown.total
                });

                // Get special instructions
                const specialInstructions = document.getElementById('specialInstructions').value.trim();

                // Prepare order data with protected pricing
                const orderData = {
                    restaurantId: customerData.restaurantId,
                    customerUID: currentUser.uid,
                    customerName: customerData.name || currentUser.displayName || 'Guest',
                    customerPhone: customerData.phone || currentUser.phoneNumber || '',
                    tableNumber: customerData.tableNumber || '',
                    location: customerData.location || '',
                    items: Object.keys(cart).map(itemId => ({
                        id: itemId,
                        name: menuItems[itemId].name,
                        price: menuItems[itemId].price,
                        quantity: cart[itemId],
                        description: menuItems[itemId].description || ''
                    })),
                    subtotal: orderBreakdown.subtotal,
                    tax: orderBreakdown.taxAmount,
                    taxRate: orderBreakdown.taxRate,
                    serviceFee: orderBreakdown.serviceFee,
                    serviceFeePercentage: orderBreakdown.serviceFeePercentage,
                    total: orderBreakdown.total,
                    specialInstructions: specialInstructions || '',
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    pricingSource: orderBreakdown.calculationSource,
                    marginProtected: orderBreakdown.marginProtected,
                    // Include the protected pricing breakdown for future reference
                    pricingBreakdown: orderBreakdown.backendData
                };

                console.log('🔄 Creating order with protected pricing:', {
                    total: formatPrice(orderBreakdown.total),
                    subtotal: formatPrice(orderBreakdown.subtotal),
                    tax: formatPrice(orderBreakdown.taxAmount),
                    serviceFee: formatPrice(orderBreakdown.serviceFee),
                    taxRate: orderBreakdown.taxRate + '%',
                    serviceFeePercentage: orderBreakdown.serviceFeePercentage.toFixed(2) + '%',
                    source: orderBreakdown.calculationSource,
                    itemCount: orderData.items.length
                });

                // Create the order using VediAPI
                let orderResult;
                if (typeof VediAPI !== 'undefined' && VediAPI.createOrder) {
                    orderResult = await VediAPI.createOrder(orderData);
                } else {
                    // Fallback to direct Firestore creation
                    // Generate order number first
                    const orderNumber = Math.floor(Math.random() * 9000) + 1000;
                    const orderDataWithNumber = {
                        ...orderData,
                        orderNumber: orderNumber
                    };
                    
                    const orderRef = await firebase.firestore().collection('orders').add(orderDataWithNumber);
                    orderResult = {
                        id: orderRef.id,
                        orderNumber: orderNumber,
                        ...orderDataWithNumber
                    };
                }

                console.log('✅ Order created successfully:', orderResult);

                // Clear the cart after successful order creation
                cart = {};
                saveCart();
                sessionStorage.removeItem('customerCart');

                // Save order data for order progress tracking
                const orderTrackingData = {
                    orderId: orderResult.id,
                    orderNumber: orderResult.orderNumber,
                    restaurantId: customerData.restaurantId,
                    customerUID: currentUser.uid,
                    timestamp: new Date().toISOString()
                };
                sessionStorage.setItem('currentOrder', JSON.stringify(orderTrackingData));

                // Update customer session with successful order
                const updatedSession = {
                    ...customerSession,
                    name: orderData.customerName,
                    phone: orderData.customerPhone,
                    restaurantId: orderData.restaurantId,
                    tableNumber: orderData.tableNumber,
                    location: orderData.location,
                    firebaseUID: currentUser.uid,
                    lastOrderNumber: orderResult.orderNumber
                };
                sessionStorage.setItem('customerSession', JSON.stringify(updatedSession));

                console.log('🎯 Redirecting to order progress page...');

                // Create URL parameters for order progress
                const progressParams = new URLSearchParams({
                    orderNumber: orderResult.orderNumber,
                    restaurant: customerData.restaurantId,
                    table: customerData.tableNumber || '',
                    location: customerData.location || '',
                    name: orderData.customerName,
                    phone: orderData.customerPhone
                });

                // Show success message briefly before redirect
                showSuccess('Order placed successfully! Redirecting to order tracking...');

                // Redirect to order progress page
                setTimeout(() => {
                    window.location.href = `order-progress.html?${progressParams.toString()}`;
                }, 1500);

            } catch (error) {
                console.error('❌ Error placing order:', error);
                
                // Show specific error messages
                if (error.message.includes('Pricing calculation failed')) {
                    showError('Pricing calculation error. Please refresh the page and try again.');
                    console.error('🔧 Debug: Run window.getVediAPIDiagnostics() for more info');
                } else if (error.message.includes('Authentication required')) {
                    showError('Please sign in to place your order.');
                    redirectToLogin();
                } else {
                    showError('Failed to place order: ' + error.message);
                }
                
                // Re-enable button
                placeOrderBtn.disabled = false;
                orderBtnText.style.display = 'block';
                orderBtnSpinner.style.display = 'none';
            }
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function getRestaurantCurrency() {
    if (currentRestaurant && currentRestaurant.currency) {
        return currentRestaurant.currency;
    }
    return { code: 'USD', symbol: '$', name: 'US Dollar' };
}

        function formatPrice(amount, showCode = false) {
            const currency = getRestaurantCurrency();
            const formattedAmount = Number(amount).toFixed(2);
            
            if (showCode) {
                return `${currency.symbol}${formattedAmount} ${currency.code}`;
            }
            
            return `${currency.symbol}${formattedAmount}`;
        }

        function goBackToMenu() {
            console.log('🔙 Going back to menu from checkout...');
            const params = new URLSearchParams();
            params.set('restaurant', customerData.restaurantId);
            params.set('table', customerData.tableNumber);
            if (customerData.location) params.set('location', customerData.location);
            if (customerData.name) params.set('name', customerData.name);
            if (customerData.phone) params.set('phone', customerData.phone);
            
            window.location.href = `menu.html?${params.toString()}`;
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showErrorMessage(message) {
            hideLoading();
            document.getElementById('errorMessage').innerHTML = `
                <h3>⚠️ Unable to load checkout</h3>
                <p>${message}</p>
                <button onclick="location.reload()" style="margin-top: 16px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">
                    Try Again
                </button>
            `;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('checkoutContent').style.display = 'none';
            document.getElementById('emptyCart').style.display = 'none';
            document.getElementById('placeOrderSection').style.display = 'none';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type}`;
            notification.innerHTML = `${type === 'success' ? '✅' : '❌'} ${message}`;
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        // ============================================================================
        // DEBUG FUNCTIONS (GLOBAL ACCESS)
        // ============================================================================
        
        // Make debug functions globally accessible
        window.debugCheckout = {
            testPricing: async () => {
                if (typeof window.testVediAPIPricing === 'function') {
                    await window.testVediAPIPricing(customerData.restaurantId);
                } else {
                    console.log('❌ testVediAPIPricing function not available');
                }
            },
            
            getDiagnostics: () => {
                if (typeof window.getVediAPIDiagnostics === 'function') {
                    return window.getVediAPIDiagnostics();
                } else {
                    console.log('❌ getVediAPIDiagnostics function not available');
                    return null;
                }
            },
            
            retryPricing: async () => {
                console.log('🔄 Manually retrying pricing calculation...');
                try {
                    await calculateProtectedPricing();
                    renderCheckout();
                    console.log('✅ Manual pricing retry completed');
                } catch (error) {
                    console.error('❌ Manual pricing retry failed:', error);
                }
            },
            
            showOrderBreakdown: () => {
                console.log('📊 Current order breakdown:', orderBreakdown);
                return orderBreakdown;
            },
            
            getCurrentState: () => {
                return {
                    restaurantId: customerData.restaurantId,
                    cartItems: Object.keys(cart).length,
                    protectedPricingCalculated,
                    orderBreakdown,
                    pricingCalculationAttempts,
                    vediAPIAvailable: typeof VediAPI !== 'undefined',
                    extensionsAvailable: typeof VediAPI?.getProtectedPricingBreakdown === 'function'
                };
            },

            testOrderCreation: async () => {
                console.log('🧪 Testing order creation flow...');
                try {
                    if (!protectedPricingCalculated || !orderBreakdown) {
                        console.error('❌ Cannot test order creation without pricing calculation');
                        return;
                    }

                    const testOrderData = {
                        restaurantId: customerData.restaurantId,
                        customerUID: currentUser?.uid || 'test-uid',
                        customerName: 'Test Customer',
                        customerPhone: '+1234567890',
                        items: Object.keys(cart).map(itemId => ({
                            id: itemId,
                            name: menuItems[itemId].name,
                            price: menuItems[itemId].price,
                            quantity: cart[itemId]
                        })),
                        subtotal: orderBreakdown.subtotal,
                        tax: orderBreakdown.taxAmount,
                        serviceFee: orderBreakdown.serviceFee,
                        total: orderBreakdown.total,
                        status: 'pending',
                        timestamp: new Date().toISOString(),
                        test: true
                    };

                    console.log('📝 Test order data:', testOrderData);
                    console.log('✅ Order creation data looks valid');
                    return testOrderData;
                } catch (error) {
                    console.error('❌ Test order creation failed:', error);
                }
            }
        };

        // ============================================================================
        // SESSION MONITORING & CLEANUP
        // ============================================================================
        
        // Monitor authentication state changes
        function monitorAuthenticationState() {
            firebase.auth().onAuthStateChanged(function(user) {
                if (!user && currentUser) {
                    console.warn('⚠️ User signed out unexpectedly during checkout');
                    showSessionWarning();
                    currentUser = null;
                    updateAuthenticationIndicator();
                } else if (user && !currentUser) {
                    console.log('✅ User signed in during checkout session');
                    currentUser = user;
                    updateAuthenticationIndicator();
                    hideSessionWarning();
                }
            });
        }

        function hideSessionWarning() {
            const warning = document.getElementById('sessionWarning');
            if (warning) {
                warning.classList.remove('show');
            }
        }

        // Start monitoring authentication state after initial load
        setTimeout(() => {
            monitorAuthenticationState();
        }, 1000);

        // ============================================================================
        // CLEANUP ON PAGE UNLOAD
        // ============================================================================
        
        window.addEventListener('beforeunload', function() {
            console.log('🧹 Cleaning up checkout page resources');
            
            // Save current state before leaving
            if (Object.keys(cart).length > 0) {
                saveCart();
                console.log('💾 Cart saved before page unload');
            }
            
            // Clear any pending timeouts or intervals
            // (Add any cleanup for timers if you have them)
        });

        // ============================================================================
        // ERROR RECOVERY FUNCTIONS
        // ============================================================================
        
        // Global error handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('❌ Unhandled promise rejection in checkout:', event.reason);
            
            // Prevent the default behavior (which would log to console)
            event.preventDefault();
            
            // Show user-friendly error
            if (event.reason && event.reason.message) {
                if (event.reason.message.includes('VediAPI') || event.reason.message.includes('pricing')) {
                    showError('Pricing calculation error. Please refresh the page.');
                } else if (event.reason.message.includes('auth') || event.reason.message.includes('permission')) {
                    showError('Authentication error. Please sign in again.');
                    showSessionWarning();
                } else {
                    showError('Something went wrong. Please refresh the page.');
                }
            }
        });

        // Global error handler for JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('❌ JavaScript error in checkout:', event.error);
            
            // Don't show errors for network issues or external script failures
            if (event.error && event.error.message) {
                const message = event.error.message.toLowerCase();
                if (message.includes('network') || 
                    message.includes('fetch') || 
                    message.includes('script error') ||
                    message.includes('loading chunk')) {
                    return; // Silently handle these
                }
                
                // Only show critical errors that affect checkout functionality
                if (message.includes('vediapi') || 
                    message.includes('firebase') || 
                    message.includes('pricing')) {
                    showError('Critical error detected. Please refresh the page.');
                }
            }
        });

        // ============================================================================
        // KEYBOARD SHORTCUTS (OPTIONAL DEBUGGING)
        // ============================================================================
        
        document.addEventListener('keydown', function(event) {
            // Only enable shortcuts in development/testing
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('test')) {
                
                // Ctrl+Shift+D = Toggle Debug Panel
                if (event.ctrlKey && event.shiftKey && event.key === 'D') {
                    event.preventDefault();
                    const debugPanel = document.getElementById('debugPanel');
                    if (debugPanel.style.display === 'none' || !debugPanel.classList.contains('show')) {
                        debugPanel.classList.add('show');
                        console.log('🔧 Debug panel shown');
                    } else {
                        debugPanel.classList.remove('show');
                        console.log('🔧 Debug panel hidden');
                    }
                }
                
                // Ctrl+Shift+P = Retry Pricing
                if (event.ctrlKey && event.shiftKey && event.key === 'P') {
                    event.preventDefault();
                    console.log('⌨️ Keyboard shortcut: Retrying pricing calculation...');
                    window.debugCheckout.retryPricing();
                }
                
                // Ctrl+Shift+C = Show Current State
                if (event.ctrlKey && event.shiftKey && event.key === 'C') {
                    event.preventDefault();
                    console.log('⌨️ Keyboard shortcut: Current checkout state');
                    console.table(window.debugCheckout.getCurrentState());
                }
            }
        });

        // ============================================================================
        // FINAL INITIALIZATION CONFIRMATION
        // ============================================================================
        
        // Set a flag when everything is loaded
        window.checkoutInitialized = true;
        
        // Expose key functions globally for testing
        window.checkoutAPI = {
            calculatePricing: calculateProtectedPricing,
            renderCheckout: renderCheckout,
            getOrderBreakdown: () => orderBreakdown,
            getCurrentCart: () => cart,
            getCustomerData: () => customerData,
            getRestaurantData: () => currentRestaurant
        };

        // ============================================================================
        // INITIALIZATION LOGGING
        // ============================================================================
        
        console.log('🛒✅ VediAPI-powered protected pricing checkout loaded');
        console.log('🔄 Uses VediAPI extensions v2.0.0 for all pricing calculations');
        console.log('🛡️ Margins protected using VediAPI gross-up calculation');
        console.log('📊 Displays actual tax rates from fee configurations');
        console.log('🎯 Direct order creation - no payment page redirect');
        console.log('📈 Goes directly to order progress after successful placement');
        console.log('💾 Cart cleared after successful order creation');
        console.log('🔍 Testing: Fee breakdown shows your margin vs Stripe fees');
        console.log('🔧 VediAPI extended via vediapi-pricing-extensions.js v2.0.0');
        console.log('🚫 NO FALLBACK - Prevents orders with incorrect pricing');
        console.log('📊 Enhanced debugging with pricing status indicators');
        console.log('🔧 Debug functions: window.debugCheckout.testPricing(), window.debugCheckout.getDiagnostics()');
        console.log('🔄 Manual retry: window.debugCheckout.retryPricing()');
        console.log('📊 Current state: window.debugCheckout.getCurrentState()');
        console.log('🧪 Test order: window.debugCheckout.testOrderCreation()');
        console.log('🎯 Checkout initialization complete - Order placement will redirect to order-progress.html');
        console.log('🔧 Testing shortcuts (localhost only): Ctrl+Shift+D (debug), Ctrl+Shift+P (retry pricing), Ctrl+Shift+C (state)');
        console.log('🌐 Global API: window.checkoutAPI available for testing');
        console.log('✅ Ready for order placement and redirect to order tracking');
        
    </script>
</body>
</html>
