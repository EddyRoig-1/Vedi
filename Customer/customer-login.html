<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>Table Order - Login</title>
    
    <!-- Performance Optimizations: Preconnect to critical domains -->
    <link rel="preconnect" href="https://www.googleapis.com">
    <link rel="preconnect" href="https://accounts.google.com">
    <link rel="preconnect" href="https://www.facebook.com">
    <link rel="preconnect" href="https://appleid.apple.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <!-- DNS prefetch for faster domain resolution -->
    <link rel="dns-prefetch" href="//www.googleapis.com">
    <link rel="dns-prefetch" href="//accounts.google.com">
    <link rel="dns-prefetch" href="//www.facebook.com">
    
    <!-- Firebase Scripts with optimized loading -->
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Load analytics conditionally -->
    <script>
    // Only load analytics if supported
    if (typeof Storage !== "undefined" && !window.navigator.webdriver) {
        const analyticsScript = document.createElement('script');
        analyticsScript.defer = true;
        analyticsScript.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js';
        analyticsScript.onerror = () => console.log('üìä Analytics blocked (normal with ad blockers)');
        document.head.appendChild(analyticsScript);
    }
    </script>
    
    <!-- API Scripts - Main Firebase API and Customer Auth API -->
    <script defer src="../firebase-config.js"></script>
    <script defer src="../firebase-api.js"></script>
    <script defer src="customer-auth-api.js"></script>
    
    <!-- Critical CSS inline for faster rendering -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 400px;
            min-height: 500px;
            position: relative;
        }

        .login-page {
            padding: 40px 30px;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .restaurant-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .restaurant-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .table-info {
            color: #666;
            font-size: 0.9rem;
        }

        /* Social Login Section */
        .social-login {
            margin-bottom: 30px;
        }

        .social-login h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .social-btn {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-decoration: none;
            color: #333;
            background: white;
            position: relative;
        }

        .social-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .social-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .social-btn.google {
            border-color: #db4437;
            color: #db4437;
        }

        .social-btn.google:hover:not(:disabled) {
            background: #db4437;
            color: white;
        }

        .social-btn.facebook {
            border-color: #3b5998;
            color: #3b5998;
        }

        .social-btn.facebook:hover:not(:disabled) {
            background: #3b5998;
            color: white;
        }

        .social-btn.apple {
            border-color: #000;
            color: #000;
        }

        .social-btn.apple:hover:not(:disabled) {
            background: #000;
            color: white;
        }

        .social-icon {
            width: 20px;
            height: 20px;
            font-size: 1.2rem;
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            padding: 0 15px;
        }

        /* Phone Auth Section */
        .phone-auth {
            margin-bottom: 20px;
        }

        .phone-auth h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Phone Input Group with Country Code */
        .phone-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .country-select {
            min-width: 100px;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        .country-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .phone-number-input {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Messages */
        .error-message, .success-message, .info-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .error-message {
            background: #ffe6e6;
            color: #d63031;
            border: 1px solid #feb2b2;
        }

        .success-message {
            background: #e8f5e8;
            color: #27ae60;
            border: 1px solid #a2d5a2;
        }

        .info-message {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        /* Step Indicator */
        .step-indicator {
            display: none;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 0 10px;
            position: relative;
        }

        .step.active {
            background: #667eea;
            color: white;
        }

        .step.completed {
            background: #27ae60;
            color: white;
        }

        /* Multi-step form phases */
        .form-phase {
            display: none;
        }

        .form-phase.active {
            display: block;
        }

        .verification-input {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5em;
            font-weight: 600;
        }

        .resend-timer {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        .recaptcha-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        #recaptcha-container {
            transform: scale(0.85);
            transform-origin: center;
        }

        /* Phone Number Collection for Social Users */
        .phone-collection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .phone-collection h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .phone-collection p {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .skip-phone {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }

        .skip-phone:hover {
            background: #667eea;
            color: white;
        }

        /* Initial loader */
        .initial-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loader-content {
            color: white;
            text-align: center;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                max-width: none;
            }
            
            .login-page {
                padding: 30px 20px;
            }

            .social-buttons {
                gap: 10px;
            }

            .social-btn {
                padding: 12px;
                font-size: 0.9rem;
            }

            .phone-input-group {
                flex-direction: column;
                gap: 10px;
            }

            .country-select {
                min-width: unset;
            }

            #recaptcha-container {
                transform: scale(0.75);
            }
        }
    </style>
</head>
<body>
    <!-- Initial Loading Screen -->
    <div class="initial-loader" id="initialLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div>Loading Vedi...</div>
        </div>
    </div>

    <div class="container">
        <div class="login-page">
            <div class="logo">üçΩÔ∏è</div>
            <h1>Welcome!</h1>
            <p class="subtitle">Sign in to start ordering delicious food</p>
            
            <div class="restaurant-info" id="restaurantInfo">
                <div class="restaurant-name" id="restaurantName">Loading restaurant...</div>
                <div class="table-info" id="tableInfo">Table #--</div>
            </div>

            <!-- Messages -->
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            <div class="info-message" id="infoMessage"></div>
            
            <!-- Main Social Login Phase -->
            <div class="form-phase active" id="socialPhase">
                <div class="social-login">
                    <h3>Quick Sign In</h3>
                    <div class="social-buttons">
                        <button class="social-btn google" id="googleSignInBtn" onclick="signInWithGoogle()">
                            <span class="social-icon">üîç</span>
                            <span>Continue with Google</span>
                            <div class="loading-spinner" id="googleSpinner"></div>
                        </button>
                        
                        <button class="social-btn facebook" id="facebookSignInBtn" onclick="signInWithFacebook()">
                            <span class="social-icon">üìò</span>
                            <span>Continue with Facebook</span>
                            <div class="loading-spinner" id="facebookSpinner"></div>
                        </button>
                        
                        <button class="social-btn apple" id="appleSignInBtn" onclick="signInWithApple()">
                            <span class="social-icon">üçé</span>
                            <span>Continue with Apple</span>
                            <div class="loading-spinner" id="appleSpinner"></div>
                        </button>
                    </div>
                </div>

                <div class="divider">
                    <span>or</span>
                </div>

                <div class="phone-auth">
                    <h3>Use Phone Number</h3>
                    <button class="btn" onclick="switchToPhoneAuth()">
                        üì± Sign in with Phone
                    </button>
                </div>
            </div>

            <!-- Phone Collection for Social Users -->
            <div class="form-phase" id="phoneCollectionPhase">
                <div class="phone-collection">
                    <h4>üì± Add Your Phone Number</h4>
                    <p>To ensure we can reach you about your order, please add your phone number. This helps with order updates and notifications.</p>
                    
                    <div class="form-group">
                        <label for="socialUserPhone">Phone Number</label>
                        <div class="phone-input-group">
                            <select class="country-select" id="socialCountryCode">
                                <option value="+1">üá∫üá∏ +1</option>
                            </select>
                            <input type="tel" id="socialUserPhone" class="phone-number-input" placeholder="123-456-7890">
                        </div>
                    </div>
                    
                    <button class="btn" onclick="saveSocialUserPhone()">
                        <span class="loading-spinner" id="phoneCollectionSpinner"></span>
                        <span>Save & Continue</span>
                    </button>
                    
                    <button class="btn skip-phone" onclick="skipPhoneCollection()">
                        Skip for Now
                    </button>
                </div>
            </div>

            <!-- Step Indicator (for phone auth) -->
            <div class="step-indicator" id="stepIndicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
            </div>

            <!-- Phase 1: Name Input (Phone Auth) -->
            <div class="form-phase" id="namePhase">
                <div class="form-group">
                    <label for="customerName">Your Name</label>
                    <input type="text" id="customerName" name="customerName" placeholder="Enter your full name" required>
                </div>
                <button type="button" class="btn" id="nameNextBtn" onclick="proceedToPhone()">
                    <span class="loading-spinner" id="nameSpinner"></span>
                    <span>Continue</span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="goBackToSocial()">
                    ‚Üê Back to Sign In Options
                </button>
            </div>

            <!-- Phase 2: Phone Verification -->
            <div class="form-phase" id="phonePhase">
                <div class="form-group">
                    <label for="phoneNumber">Phone Number</label>
                    <div class="phone-input-group">
                        <select class="country-select" id="countryCode">
                            <option value="+1">üá∫üá∏ +1</option>
                        </select>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="phone-number-input" placeholder="123-456-7890" required>
                    </div>
                </div>
                
                <!-- reCAPTCHA container -->
                <div class="recaptcha-container" id="recaptcha-container"></div>
                
                <button type="button" class="btn" id="sendCodeBtn" onclick="sendVerificationCode()">
                    <span class="loading-spinner" id="phoneSpinner"></span>
                    <span id="sendCodeText">Send Verification Code</span>
                </button>
                
                <button type="button" class="btn btn-secondary" onclick="goBackToName()">
                    ‚Üê Back
                </button>
            </div>

            <!-- Phase 3: Code Verification -->
            <div class="form-phase" id="codePhase">
                <div class="form-group">
                    <label for="verificationCode">Verification Code</label>
                    <input type="text" id="verificationCode" name="verificationCode" 
                           placeholder="123456" maxlength="6" class="verification-input" required>
                    <div class="resend-timer" id="resendTimer"></div>
                </div>
                
                <button type="button" class="btn" id="verifyCodeBtn" onclick="verifyCode()">
                    <span class="loading-spinner" id="codeSpinner"></span>
                    <span>Verify & Start Ordering</span>
                </button>
                
                <button type="button" class="btn btn-secondary" id="resendBtn" onclick="resendCode()" 
                        style="margin-top: 10px;" disabled>
                    Resend Code
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // ENHANCED PROMISE HANDLING AND STATE MANAGEMENT
        // =============================================================================

        // Global variables
        let restaurantData = null;
        let tableNumber = null;
        let restaurantId = null;
        let tableLocation = null;
        let customerName = '';
        let customerPhone = '';
        let selectedCountryCode = '+1';
        let resendTimer = null;
        let resendCountdown = 60;
        let currentSocialUser = null;
        let performanceStartTime = Date.now();

        // Promise state management
        class PromiseStateManager {
            constructor() {
                this.pendingOperations = new Set();
                this.verificationState = {
                    verificationId: null,
                    confirmationResult: null,
                    isInProgress: false
                };
            }

            async execute(operationId, promise) {
                if (this.pendingOperations.has(operationId)) {
                    throw new Error(`Operation ${operationId} already in progress`);
                }

                this.pendingOperations.add(operationId);
                
                try {
                    const result = await promise;
                    return result;
                } finally {
                    this.pendingOperations.delete(operationId);
                }
            }

            isOperationPending(operationId) {
                return this.pendingOperations.has(operationId);
            }

            setVerificationState(verificationId, confirmationResult) {
                this.verificationState = {
                    verificationId,
                    confirmationResult,
                    isInProgress: true
                };
            }

            clearVerificationState() {
                this.verificationState = {
                    verificationId: null,
                    confirmationResult: null,
                    isInProgress: false
                };
            }

            getVerificationState() {
                return this.verificationState;
            }

            cancelAllOperations() {
                this.pendingOperations.clear();
                this.clearVerificationState();
            }
        }

        // Initialize global promise manager
        const promiseManager = new PromiseStateManager();

        // Promise timeout wrapper
        function withTimeout(promise, timeoutMs, errorMessage) {
            return Promise.race([
                promise,
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
                )
            ]);
        }

        // Enhanced error handler
        function handleError(error, context = 'Unknown operation') {
            console.error(`‚ùå Error in ${context}:`, error);
            
            // Handle specific error types
            if (error.message.includes('timeout') || error.message.includes('timed out')) {
                showError('Operation timed out. Please check your connection and try again.');
            } else if (error.code && error.code.startsWith('auth/')) {
                showError(error.message || 'Authentication error. Please try again.');
            } else if (error.message.includes('Network')) {
                showError('Network error. Please check your connection and try again.');
            } else {
                showError(error.message || 'An unexpected error occurred. Please try again.');
            }
        }

        // Performance monitoring
        function addPerformanceMonitoring() {
            const loadTime = Date.now() - performanceStartTime;
            console.log(`üìä Page initialization: ${loadTime}ms`);
            
            // Monitor Firebase connection
            performance.mark('firebase-start');
        }

        // Optimize button clicks with debouncing
        function optimizeButtonClicks() {
            const buttons = document.querySelectorAll('.social-btn, .btn');
            
            buttons.forEach(button => {
                let lastClick = 0;
                const originalHandler = button.onclick;
                
                button.onclick = function(e) {
                    const now = Date.now();
                    if (now - lastClick < 1000) {
                        console.log('üö´ Click ignored - too fast');
                        return false;
                    }
                    lastClick = now;
                    
                    if (originalHandler) {
                        return originalHandler.call(this, e);
                    }
                };
            });
        }

        // Hide initial loader with promise
        function hideInitialLoader() {
            return new Promise((resolve) => {
                const loader = document.getElementById('initialLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.remove();
                        resolve();
                    }, 300);
                } else {
                    resolve();
                }
            });
        }

        // Enhanced wait for APIs with timeout
        function waitForAPIs() {
            return new Promise((resolve, reject) => {
                const maxWait = 15000; // 15 second timeout
                const startTime = Date.now();
                
                const checkAPIs = () => {
                    if (Date.now() - startTime > maxWait) {
                        reject(new Error('Timeout waiting for APIs to load. Please refresh the page.'));
                        return;
                    }
                    
                    if (typeof VediAPI !== 'undefined' && typeof CustomerAuthAPI !== 'undefined') {
                        console.log('‚úÖ Both APIs loaded successfully');
                        resolve();
                    } else {
                        console.log('‚è≥ Waiting for APIs to load...');
                        setTimeout(checkAPIs, 100);
                    }
                };
                
                checkAPIs();
            });
        }

        // Enhanced redirect result handling with timeout
        async function handleRedirectResult() {
            try {
                console.log('üîÑ Checking for redirect authentication result...');
                
                const redirectResult = await withTimeout(
                    firebase.auth().getRedirectResult(),
                    15000,
                    'Redirect authentication timed out'
                );
                
                if (redirectResult && redirectResult.user) {
                    console.log('‚úÖ Redirect sign-in successful:', redirectResult.user.displayName);
                    await hideInitialLoader();
                    await handleSocialSignInSuccess(redirectResult.user, 'redirect');
                    return true;
                }
                
                return false;
                
            } catch (redirectError) {
                console.warn('‚ö†Ô∏è Redirect result error (normal if no redirect):', redirectError);
                // Don't throw - this is expected if no redirect occurred
                return false;
            }
        }

        // Enhanced initialization with comprehensive error handling
        async function initializeApp() {
            try {
                // Parse URL parameters
                parseURLParameters();
                updateTableDisplay();
                
                if (restaurantId) {
                    await loadRestaurantInfo();
                } else {
                    throw new Error('Restaurant not found. Please scan a valid QR code.');
                }

                // Setup phone formatting and optimizations
                setupPhoneFormatting();
                optimizeButtonClicks();
                
                // Debug: Add click listener to send code button for debugging
                const sendCodeBtn = document.getElementById('sendCodeBtn');
                if (sendCodeBtn) {
                    console.log('‚úÖ Send code button found and event listener attached');
                    
                    // Add a direct event listener for debugging
                    sendCodeBtn.addEventListener('click', function(e) {
                        console.log('üîÑ Send code button clicked directly via event listener');
                        e.preventDefault();
                        sendVerificationCode();
                    });
                } else {
                    console.error('‚ùå Send code button not found!');
                }
                
                console.log('‚úÖ Enhanced customer login loaded successfully');
                
            } catch (error) {
                console.error('‚ùå App initialization error:', error);
                showError(error.message || 'Failed to load application');
                throw error;
            }
        }

        // Enhanced initialization with error boundaries
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Enhanced customer login initializing...');
            addPerformanceMonitoring();
            
            try {
                // Wait for APIs to load with timeout
                await promiseManager.execute('waitForAPIs', waitForAPIs());
                
                // Check for redirect result first (for social auth)
                const hasRedirectResult = await handleRedirectResult();
                if (hasRedirectResult) return;

                // Normal initialization
                await promiseManager.execute('initializeApp', initializeApp());
                
                // Hide loader after successful initialization
                await hideInitialLoader();

            } catch (error) {
                console.error('‚ùå Page initialization error:', error);
                handleError(error, 'Page initialization');
                await hideInitialLoader();
                
                // Show fallback UI or retry option
                showError('Failed to load page. Please refresh to try again.');
            }
        });

        // Parse URL parameters
        function parseURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            restaurantId = urlParams.get('restaurant') || urlParams.get('r');
            tableNumber = urlParams.get('table');
            tableLocation = urlParams.get('location');
            
            console.log('üìç URL Parameters:', {
                restaurant: restaurantId,
                table: tableNumber,
                location: tableLocation
            });
        }

        // Load restaurant information using VediAPI with error handling
        async function loadRestaurantInfo() {
            try {
                console.log('üè™ Loading restaurant data for ID:', restaurantId);
                document.getElementById('restaurantName').textContent = 'Loading...';
                
                if (typeof VediAPI !== 'undefined') {
                    restaurantData = await withTimeout(
                        VediAPI.getRestaurant(restaurantId),
                        10000,
                        'Failed to load restaurant information'
                    );
                    document.getElementById('restaurantName').textContent = restaurantData.name || 'Restaurant';
                    console.log('‚úÖ Restaurant loaded:', restaurantData.name);
                } else {
                    console.warn('‚ö†Ô∏è VediAPI not available');
                    document.getElementById('restaurantName').textContent = 'Restaurant';
                }
            } catch (error) {
                console.error('‚ùå Failed to load restaurant:', error);
                document.getElementById('restaurantName').textContent = 'Restaurant';
                // Don't throw - this is not critical for the auth flow
            }
        }

        // Update table display
        function updateTableDisplay() {
            const tableInfoElement = document.getElementById('tableInfo');
            
            if (tableLocation === 'counter' || tableNumber === 'counter') {
                tableInfoElement.textContent = 'Counter Order';
            } else if (tableNumber) {
                tableInfoElement.textContent = `Table #${tableNumber}`;
            } else {
                tableInfoElement.textContent = 'Restaurant Order';
            }
        }

        // =============================================================================
        // ENHANCED SOCIAL AUTHENTICATION WITH PROMISE HANDLING
        // =============================================================================

        // Google Sign-In with comprehensive error handling using firebase-api.js
        async function signInWithGoogle() {
            try {
                if (promiseManager.isOperationPending('googleSignIn')) {
                    console.log('üö´ Google sign-in already in progress');
                    return;
                }

                await promiseManager.execute('googleSignIn', async () => {
                    setLoading('google', true);
                    hideMessages();
                    
                    console.log('üîç Initiating Google sign-in via firebase-api.js...');
                    
                    try {
                        // Use firebase-api.js for Google sign-in with timeout
                        if (typeof window.signInWithGoogle === 'function') {
                            const result = await withTimeout(
                                window.signInWithGoogle(),
                                30000,
                                'Google sign-in timed out. Please try again.'
                            );
                            console.log('‚úÖ Google sign-in successful:', result.user.displayName);
                            await handleSocialSignInSuccess(result.user, 'google');
                        } else {
                            // Fallback to VediAPI if firebase-api.js not available
                            const result = await withTimeout(
                                VediAPI.signInWithGoogle(),
                                30000,
                                'Google sign-in timed out. Please try again.'
                            );
                            console.log('‚úÖ Google sign-in successful via VediAPI:', result.user.displayName);
                            await handleSocialSignInSuccess(result.user, 'google');
                        }
                        
                    } catch (error) {
                        console.log('üîÑ Primary method failed, trying direct Firebase:', error.code);
                        
                        if (error.message.includes('popup') || error.message.includes('blocked') || error.message.includes('timeout')) {
                            // Fallback to direct Firebase redirect
                            const provider = new firebase.auth.GoogleAuthProvider();
                            provider.addScope('profile');
                            provider.addScope('email');
                            
                            showInfo('Redirecting to Google sign-in...');
                            await firebase.auth().signInWithRedirect(provider);
                            
                        } else {
                            throw error;
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Google sign-in error:', error);
                handleSocialSignInError(error, 'Google');
            } finally {
                setLoading('google', false);
            }
        }

        // Facebook Sign-In with comprehensive error handling using firebase-api.js
        async function signInWithFacebook() {
            try {
                if (promiseManager.isOperationPending('facebookSignIn')) {
                    console.log('üö´ Facebook sign-in already in progress');
                    return;
                }

                await promiseManager.execute('facebookSignIn', async () => {
                    setLoading('facebook', true);
                    hideMessages();
                    
                    console.log('üìò Initiating Facebook sign-in via firebase-api.js...');
                    
                    try {
                        // Use firebase-api.js for Facebook sign-in with timeout
                        if (typeof window.signInWithFacebook === 'function') {
                            const result = await withTimeout(
                                window.signInWithFacebook(),
                                30000,
                                'Facebook sign-in timed out. Please try again.'
                            );
                            console.log('‚úÖ Facebook sign-in successful:', result.user.displayName);
                            await handleSocialSignInSuccess(result.user, 'facebook');
                        } else {
                            // Fallback to VediAPI if firebase-api.js not available
                            const result = await withTimeout(
                                VediAPI.signInWithFacebook(),
                                30000,
                                'Facebook sign-in timed out. Please try again.'
                            );
                            console.log('‚úÖ Facebook sign-in successful via VediAPI:', result.user.displayName);
                            await handleSocialSignInSuccess(result.user, 'facebook');
                        }
                        
                    } catch (error) {
                        console.log('üîÑ Primary method failed, trying direct Firebase:', error.code);
                        
                        if (error.message.includes('popup') || error.message.includes('blocked') || error.message.includes('timeout')) {
                            // Fallback to direct Firebase redirect
                            const provider = new firebase.auth.FacebookAuthProvider();
                            provider.addScope('email');
                            
                            showInfo('Redirecting to Facebook sign-in...');
                            await firebase.auth().signInWithRedirect(provider);
                            
                        } else {
                            throw error;
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Facebook sign-in error:', error);
                handleSocialSignInError(error, 'Facebook');
            } finally {
                setLoading('facebook', false);
            }
        }

        // Apple Sign-In with comprehensive error handling using firebase-api.js
        async function signInWithApple() {
            try {
                if (promiseManager.isOperationPending('appleSignIn')) {
                    console.log('üö´ Apple sign-in already in progress');
                    return;
                }

                await promiseManager.execute('appleSignIn', async () => {
                    setLoading('apple', true);
                    hideMessages();
                    
                    console.log('üçé Initiating Apple sign-in via firebase-api.js...');
                    
                    try {
                        // Use firebase-api.js for Apple sign-in with timeout
                        if (typeof window.signInWithApple === 'function') {
                            const result = await withTimeout(
                                window.signInWithApple(),
                                30000,
                                'Apple sign-in timed out. Please try again.'
                            );
                            console.log('‚úÖ Apple sign-in successful:', result.user.displayName);
                            await handleSocialSignInSuccess(result.user, 'apple');
                        } else {
                            // Fallback to VediAPI if firebase-api.js not available
                            const result = await withTimeout(
                                VediAPI.signInWithApple(),
                                30000,
                                'Apple sign-in timed out. Please try again.'
                            );
                            console.log('‚úÖ Apple sign-in successful via VediAPI:', result.user.displayName);
                            await handleSocialSignInSuccess(result.user, 'apple');
                        }
                        
                    } catch (error) {
                        console.log('üîÑ Primary method failed, trying direct Firebase:', error.code);
                        
                        if (error.message.includes('popup') || error.message.includes('blocked') || error.message.includes('timeout')) {
                            // Fallback to direct Firebase redirect
                            const provider = new firebase.auth.OAuthProvider('apple.com');
                            provider.addScope('email');
                            provider.addScope('name');
                            
                            showInfo('Redirecting to Apple sign-in...');
                            await firebase.auth().signInWithRedirect(provider);
                            
                        } else {
                            throw error;
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Apple sign-in error:', error);
                handleSocialSignInError(error, 'Apple');
            } finally {
                setLoading('apple', false);
            }
        }

        // Handle successful social sign-in with error handling
        async function handleSocialSignInSuccess(user, provider) {
            try {
                currentSocialUser = user;
                
                // Extract user information
                const userName = user.displayName || 'Guest User';
                const userEmail = user.email || '';
                const userPhone = user.phoneNumber || '';
                
                console.log('üë§ Social user info:', {
                    name: userName,
                    email: userEmail,
                    phone: userPhone,
                    provider: provider
                });

                // Check if user has a phone number
                if (!userPhone) {
                    // Show phone collection phase
                    switchToPhase('phoneCollectionPhase');
                    return;
                }

                // Proceed directly to menu if phone number exists
                await completeSocialSignIn(userName, userPhone, userEmail, provider);
                
            } catch (error) {
                console.error('‚ùå Social sign-in completion error:', error);
                handleError(error, 'Social sign-in completion');
                // Reset to safe state
                switchToPhase('socialPhase');
            }
        }

        // Handle social sign-in errors
        function handleSocialSignInError(error, provider) {
            if (error.message.includes('cancelled') || error.message.includes('closed')) {
                showInfo(`${provider} sign-in was cancelled. Please try again.`);
            } else if (error.message.includes('popup') || error.message.includes('blocked')) {
                showError('Popup was blocked. Please allow popups and try again.');
            } else if (error.message.includes('account already exists')) {
                showError('An account already exists with the same email. Please try signing in with a different method.');
            } else if (error.message.includes('network') || error.message.includes('timeout')) {
                showError('Network error or timeout. Please check your connection and try again.');
            } else {
                showError(`${provider} sign-in failed. Please try again or use phone authentication.`);
            }
        }

        // Save phone number for social user with error handling
        async function saveSocialUserPhone() {
            try {
                if (promiseManager.isOperationPending('savePhoneNumber')) {
                    console.log('üö´ Phone number save already in progress');
                    return;
                }

                await promiseManager.execute('savePhoneNumber', async () => {
                    const countryCode = document.getElementById('socialCountryCode').value;
                    const phoneNumber = document.getElementById('socialUserPhone').value.trim();
                    
                    if (!phoneNumber) {
                        showError('Please enter your phone number');
                        return;
                    }

                    // Use CustomerAuthAPI to format and validate phone number
                    let fullPhoneNumber;
                    try {
                        fullPhoneNumber = CustomerAuthAPI.formatPhoneNumber(phoneNumber, 'US');
                        
                        if (!CustomerAuthAPI.validatePhoneNumber(fullPhoneNumber)) {
                            showError('Please enter a valid phone number');
                            return;
                        }
                    } catch (error) {
                        showError('Invalid phone number format');
                        return;
                    }

                    setLoading('phoneCollection', true);
                    
                    const userName = currentSocialUser.displayName || 'Guest User';
                    const userEmail = currentSocialUser.email || '';
                    
                    await completeSocialSignIn(userName, fullPhoneNumber, userEmail, 'social');
                });
                
            } catch (error) {
                console.error('‚ùå Error saving phone number:', error);
                handleError(error, 'Phone number save');
            } finally {
                setLoading('phoneCollection', false);
            }
        }

        // Skip phone collection with error handling
        async function skipPhoneCollection() {
            try {
                const userName = currentSocialUser.displayName || 'Guest User';
                const userEmail = currentSocialUser.email || '';
                
                await completeSocialSignIn(userName, '', userEmail, 'social');
                
            } catch (error) {
                console.error('‚ùå Error completing sign-in without phone:', error);
                handleError(error, 'Skip phone collection');
            }
        }

        // Complete social sign-in process with comprehensive error handling
        async function completeSocialSignIn(userName, userPhone, userEmail, provider) {
            try {
                // Save customer profile using VediAPI if available
                try {
                    if (typeof VediAPI !== 'undefined' && currentSocialUser) {
                        await withTimeout(
                            VediAPI.saveCustomerProfile(currentSocialUser.uid, {
                                name: userName,
                                email: userEmail,
                                phone: userPhone,
                                phoneFormatted: userPhone ? CustomerAuthAPI.maskPhoneNumber(userPhone) : '',
                                authProvider: provider,
                                restaurantId: restaurantId,
                                tableNumber: tableNumber,
                                location: tableLocation
                            }),
                            10000,
                            'Failed to save customer profile'
                        );
                        console.log('‚úÖ Customer profile saved via VediAPI');
                    }
                } catch (profileError) {
                    console.warn('‚ö†Ô∏è Could not save customer profile via VediAPI:', profileError);
                    // Continue anyway - profile save is not critical
                }

                // Create customer session data
                const customerSession = {
                    name: userName,
                    email: userEmail,
                    phone: userPhone,
                    phoneFormatted: userPhone ? CustomerAuthAPI.maskPhoneNumber(userPhone) : '',
                    restaurantId: restaurantId,
                    restaurantName: restaurantData?.name || 'Restaurant',
                    tableNumber: tableNumber,
                    location: tableLocation,
                    sessionStart: new Date().toISOString(),
                    firebaseUID: currentSocialUser.uid,
                    authProvider: provider,
                    isAuthenticated: true,
                    isSocialAuth: true
                };

                // Store in sessionStorage for immediate use
                sessionStorage.setItem('customerSession', JSON.stringify(customerSession));

                showSuccess(`Welcome ${userName.split(' ')[0]}! Redirecting to menu...`);
                
                // Build redirect URL
                const urlParams = new URLSearchParams();
                urlParams.set('restaurant', restaurantId);
                if (tableNumber) urlParams.set('table', tableNumber);
                if (tableLocation) urlParams.set('location', tableLocation);
                urlParams.set('name', encodeURIComponent(userName));
                if (userPhone) urlParams.set('phone', userPhone);
                urlParams.set('session', 'social');
                
                const redirectUrl = `menu.html?${urlParams.toString()}`;
                
                console.log('üîÑ Redirecting to menu:', redirectUrl);
                
                // Redirect after a short delay with error handling
                setTimeout(() => {
                    try {
                        window.location.href = redirectUrl;
                    } catch (redirectError) {
                        console.error('‚ùå Redirect error:', redirectError);
                        showError('Failed to redirect to menu. Please try manually refreshing the page.');
                    }
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error completing social sign-in:', error);
                handleError(error, 'Complete social sign-in');
            }
        }

        // =============================================================================
        // ENHANCED PHONE AUTHENTICATION WITH PROMISE HANDLING
        // =============================================================================

        // Switch to phone auth
        function switchToPhoneAuth() {
            try {
                document.getElementById('stepIndicator').style.display = 'flex';
                switchToPhase('namePhase');
                
                // Update step indicator
                document.getElementById('step1').classList.add('active');
            } catch (error) {
                console.error('‚ùå Error switching to phone auth:', error);
                handleError(error, 'Switch to phone auth');
            }
        }

        // Go back to social options with cleanup
        function goBackToSocial() {
            try {
                document.getElementById('stepIndicator').style.display = 'none';
                switchToPhase('socialPhase');
                
                // Clear any reCAPTCHA
                if (CustomerAuthAPI) {
                    CustomerAuthAPI.clearRecaptcha();
                }
                
                // Clear verification state
                promiseManager.clearVerificationState();
                
                // Reset step indicator
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                
                hideMessages();
            } catch (error) {
                console.error('‚ùå Error going back to social:', error);
                handleError(error, 'Go back to social');
            }
        }

        // Setup phone formatting with error handling
        function setupPhoneFormatting() {
            try {
                const phoneInputs = [
                    { number: 'phoneNumber', country: 'countryCode' },
                    { number: 'socialUserPhone', country: 'socialCountryCode' }
                ];
                
                phoneInputs.forEach(({ number, country }) => {
                    const phoneInput = document.getElementById(number);
                    const countrySelect = document.getElementById(country);
                    
                    if (!phoneInput || !countrySelect) return;
                    
                    // Update selected country code when dropdown changes
                    countrySelect.addEventListener('change', function() {
                        selectedCountryCode = this.value;
                        console.log('üìç Country code changed to:', selectedCountryCode);
                    });
                    
                    // Format phone number input using CustomerAuthAPI
                    phoneInput.addEventListener('input', function(e) {
                        try {
                            let value = e.target.value.replace(/\D/g, '');
                            
                            // US formatting: (123) 456-7890
                            if (value.length >= 7) {
                                value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
                            } else if (value.length >= 4) {
                                value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                            } else if (value.length >= 1) {
                                value = `(${value}`;
                            }
                            
                            e.target.value = value;
                        } catch (formatError) {
                            console.warn('‚ö†Ô∏è Phone formatting error:', formatError);
                        }
                    });
                });
            } catch (error) {
                console.error('‚ùå Error setting up phone formatting:', error);
                // Non-critical error, continue
            }
        }

        // Phone auth step navigation with error handling
        async function proceedToPhone() {
            try {
                const name = document.getElementById('customerName').value.trim();
                
                if (!name) {
                    showError('Please enter your name');
                    return;
                }

                if (name.length < 2) {
                    showError('Please enter a valid name');
                    return;
                }

                customerName = name;
                
                // Update steps
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step1').classList.add('completed');
                document.getElementById('step2').classList.add('active');
                
                // Switch phases
                switchToPhase('phonePhase');
                
                console.log('üì± Proceeding to phone verification, initializing reCAPTCHA...');
                
                // Initialize reCAPTCHA using CustomerAuthAPI with timeout and debugging
                setTimeout(async () => {
                    try {
                        console.log('üîê Starting reCAPTCHA initialization...');
                        
                        // Check if container exists
                        const container = document.getElementById('recaptcha-container');
                        if (!container) {
                            throw new Error('reCAPTCHA container not found');
                        }
                        console.log('‚úÖ reCAPTCHA container found');
                        
                        // Initialize with debugging
                        const verifier = await withTimeout(
                            CustomerAuthAPI.initializeRecaptcha('recaptcha-container'),
                            20000,
                            'reCAPTCHA initialization timed out'
                        );
                        
                        console.log('‚úÖ reCAPTCHA initialized successfully via CustomerAuthAPI');
                        console.log('üîß Verifier details:', {
                            hasVerifier: !!verifier,
                            hasGlobalVerifier: !!window.recaptchaVerifier,
                            hasWidgetId: !!window.recaptchaWidgetId
                        });
                        
                        // Enable the send button
                        const sendBtn = document.getElementById('sendCodeBtn');
                        if (sendBtn) {
                            sendBtn.disabled = false;
                            console.log('‚úÖ Send code button enabled');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå reCAPTCHA initialization failed:', error);
                        showError('Failed to initialize phone verification. Please refresh the page and try again.');
                        
                        // Try alternative initialization
                        console.log('üîÑ Attempting alternative reCAPTCHA initialization...');
                        try {
                            // Clear any existing
                            if (window.recaptchaVerifier) {
                                window.recaptchaVerifier.clear();
                                window.recaptchaVerifier = null;
                            }
                            
                            // Try direct Firebase initialization
                            const container = document.getElementById('recaptcha-container');
                            if (container) {
                                container.innerHTML = '';
                                
                                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                                    'size': 'normal',
                                    'callback': function(response) {
                                        console.log('‚úÖ reCAPTCHA solved (direct method)');
                                        const sendBtn = document.getElementById('sendCodeBtn');
                                        if (sendBtn) sendBtn.disabled = false;
                                    },
                                    'expired-callback': function() {
                                        console.log('‚è∞ reCAPTCHA expired (direct method)');
                                        const sendBtn = document.getElementById('sendCodeBtn');
                                        if (sendBtn) sendBtn.disabled = true;
                                    }
                                });
                                
                                await window.recaptchaVerifier.render();
                                console.log('‚úÖ reCAPTCHA initialized using direct Firebase method');
                            }
                        } catch (fallbackError) {
                            console.error('‚ùå Fallback reCAPTCHA initialization also failed:', fallbackError);
                            showError('Unable to initialize phone verification. Please refresh the page.');
                        }
                    }
                }, 100);
                
                console.log('üì± Proceeding to phone verification');
                
            } catch (error) {
                console.error('‚ùå Error proceeding to phone:', error);
                handleError(error, 'Proceed to phone');
            }
        }

        function goBackToName() {
            try {
                // Clear reCAPTCHA using CustomerAuthAPI
                if (CustomerAuthAPI) {
                    CustomerAuthAPI.clearRecaptcha();
                }

                // Clear verification state
                promiseManager.clearVerificationState();

                document.getElementById('step2').classList.remove('active');
                document.getElementById('step1').classList.remove('completed');
                document.getElementById('step1').classList.add('active');
                
                switchToPhase('namePhase');
                hideMessages();
            } catch (error) {
                console.error('‚ùå Error going back to name:', error);
                handleError(error, 'Go back to name');
            }
        }

        // Send verification code with comprehensive error handling and debugging
        async function sendVerificationCode() {
            console.log('üîÑ sendVerificationCode() called - ENTRY POINT');
            
            try {
                // Check if operation is already pending
                if (promiseManager.isOperationPending('sendVerificationCode')) {
                    console.log('üö´ Verification code send already in progress');
                    showInfo('Verification code already being sent. Please wait.');
                    return;
                }
                console.log('‚úÖ No pending operation, proceeding...');

                await promiseManager.execute('sendVerificationCode', async () => {
                    console.log('üöÄ Inside promise manager execute block');
                    
                    const countryCode = document.getElementById('countryCode').value;
                    const phoneNumber = document.getElementById('phoneNumber').value.trim();
                    
                    console.log('üì± Phone verification details:', {
                        countryCode,
                        phoneNumber: phoneNumber ? phoneNumber.substring(0, 5) + '****' : 'empty',
                        hasRecaptcha: !!window.recaptchaVerifier,
                        hasCustomerAuthAPI: typeof CustomerAuthAPI !== 'undefined',
                        hasFirebase: typeof firebase !== 'undefined'
                    });
                    
                    if (!phoneNumber) {
                        console.log('‚ùå Phone number is empty');
                        showError('Please enter your phone number');
                        return;
                    }
                    console.log('‚úÖ Phone number provided');

                    // Format and validate using CustomerAuthAPI
                    let fullPhoneNumber;
                    try {
                        console.log('üîß Formatting phone number...');
                        fullPhoneNumber = CustomerAuthAPI.formatPhoneNumber(phoneNumber, 'US');
                        console.log('‚úÖ Phone formatted to:', CustomerAuthAPI.maskPhoneNumber(fullPhoneNumber));
                        
                        if (!CustomerAuthAPI.validatePhoneNumber(fullPhoneNumber)) {
                            console.log('‚ùå Phone validation failed');
                            showError('Please enter a valid phone number');
                            return;
                        }
                        console.log('‚úÖ Phone validation passed');
                    } catch (error) {
                        console.error('‚ùå Phone formatting error:', error);
                        showError('Invalid phone number format. Please check your number.');
                        return;
                    }
                    
                    customerPhone = fullPhoneNumber;
                    console.log('üì± Ready to send verification to:', CustomerAuthAPI.maskPhoneNumber(fullPhoneNumber));

                    // Check reCAPTCHA status before proceeding
                    console.log('üîê Checking reCAPTCHA status...');
                    if (!window.recaptchaVerifier) {
                        console.warn('‚ö†Ô∏è reCAPTCHA verifier not found, attempting to initialize...');
                        try {
                            await CustomerAuthAPI.initializeRecaptcha('recaptcha-container');
                            console.log('‚úÖ reCAPTCHA initialized successfully');
                        } catch (recaptchaError) {
                            console.error('‚ùå Failed to initialize reCAPTCHA:', recaptchaError);
                            showError('Failed to initialize phone verification. Please refresh the page and try again.');
                            return;
                        }
                    } else {
                        console.log('‚úÖ reCAPTCHA verifier ready');
                    }

                    // Set loading state and show progress
                    console.log('üîÑ Setting loading state and sending verification...');
                    setLoading('phone', true);
                    hideMessages();
                    showInfo('Sending verification code...');
                    
                    try {
                        console.log('üì§ Calling CustomerAuthAPI.sendPhoneVerification...');
                        console.log('üîß Parameters:', {
                            phone: CustomerAuthAPI.maskPhoneNumber(fullPhoneNumber),
                            hasVerifier: !!window.recaptchaVerifier,
                            verifierType: window.recaptchaVerifier?.constructor?.name
                        });
                        
                        // Send verification using CustomerAuthAPI with timeout
                        const confirmationResult = await withTimeout(
                            CustomerAuthAPI.sendPhoneVerification(fullPhoneNumber, window.recaptchaVerifier),
                            30000,
                            'Phone verification timed out. Please try again.'
                        );
                        
                        console.log('‚úÖ CustomerAuthAPI.sendPhoneVerification completed successfully');
                        console.log('üîë Confirmation result:', {
                            hasVerificationId: !!confirmationResult.verificationId,
                            hasConfirm: typeof confirmationResult.confirm === 'function',
                            resultKeys: Object.keys(confirmationResult)
                        });
                        
                        // Store verification state
                        promiseManager.setVerificationState(confirmationResult.verificationId, confirmationResult);
                        console.log('üíæ Verification state stored in promise manager');
                        
                        console.log('‚úÖ Verification code sent successfully');
                        showSuccess('Verification code sent! Please check your phone.');
                        
                        // Update steps
                        console.log('üîÑ Updating UI steps...');
                        document.getElementById('step2').classList.remove('active');
                        document.getElementById('step2').classList.add('completed');
                        document.getElementById('step3').classList.add('active');
                        
                        switchToPhase('codePhase');
                        startResendTimer();
                        console.log('‚úÖ UI updated, switched to code verification phase');
                        
                        setTimeout(() => {
                            const codeInput = document.getElementById('verificationCode');
                            if (codeInput) {
                                codeInput.focus();
                                console.log('‚úÖ Code input focused');
                            }
                        }, 100);
                        
                    } catch (verificationError) {
                        console.error('‚ùå Verification send error:', verificationError);
                        console.error('üîç Error details:', {
                            code: verificationError.code,
                            message: verificationError.message,
                            stack: verificationError.stack,
                            name: verificationError.name
                        });
                        
                        // Show specific error messages
                        if (verificationError.code === 'auth/captcha-check-failed') {
                            showError('reCAPTCHA verification failed. Please solve the reCAPTCHA and try again.');
                        } else if (verificationError.code === 'auth/too-many-requests') {
                            showError('Too many verification attempts. Please wait 24 hours or try a different phone number.');
                        } else if (verificationError.code === 'auth/invalid-phone-number') {
                            showError('Invalid phone number. Please check the format and try again.');
                        } else if (verificationError.code === 'auth/quota-exceeded') {
                            showError('SMS quota exceeded. Please try again later or contact support.');
                        } else if (verificationError.message.includes('timeout')) {
                            showError('Request timed out. Please check your internet connection and try again.');
                        } else if (verificationError.message.includes('network')) {
                            showError('Network error. Please check your internet connection and try again.');
                        } else {
                            showError(verificationError.message || 'Failed to send verification code. Please try again.');
                        }
                        
                        // Reset reCAPTCHA for retry
                        console.log('üîÑ Resetting reCAPTCHA for retry...');
                        setTimeout(async () => {
                            try {
                                if (CustomerAuthAPI.resetRecaptcha) {
                                    await CustomerAuthAPI.resetRecaptcha();
                                    console.log('‚úÖ reCAPTCHA reset successfully');
                                } else {
                                    // Fallback - reinitialize
                                    await CustomerAuthAPI.initializeRecaptcha('recaptcha-container');
                                    console.log('‚úÖ reCAPTCHA reinitialized');
                                }
                            } catch (resetError) {
                                console.warn('‚ö†Ô∏è Could not reset reCAPTCHA:', resetError);
                                // Try full reinitialize as last resort
                                setTimeout(async () => {
                                    try {
                                        CustomerAuthAPI.clearRecaptcha();
                                        await CustomerAuthAPI.initializeRecaptcha('recaptcha-container');
                                        console.log('‚úÖ reCAPTCHA fully reinitialized');
                                    } catch (reinitError) {
                                        console.error('‚ùå Full reCAPTCHA reinit failed:', reinitError);
                                        showError('Please refresh the page to reset phone verification.');
                                    }
                                }, 1000);
                            }
                        }, 500);
                        
                        // Don't re-throw here, we've handled the error
                        return;
                    }
                });
                
                console.log('‚úÖ sendVerificationCode completed successfully');
                
            } catch (error) {
                console.error('‚ùå Outer error in sendVerificationCode:', error);
                console.error('üîç Outer error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                handleError(error, 'Send verification code');
            } finally {
                console.log('üèÅ sendVerificationCode finally block - cleaning up');
                setLoading('phone', false);
            }
        }

        // Verify code with enhanced error handling and multiple methods
        async function verifyCode() {
            try {
                if (promiseManager.isOperationPending('verifyCode')) {
                    console.log('üö´ Code verification already in progress');
                    return;
                }

                await promiseManager.execute('verifyCode', async () => {
                    const code = document.getElementById('verificationCode').value.trim();
                    
                    if (!code) {
                        showError('Please enter the verification code');
                        return;
                    }

                    if (code.length !== 6 || !/^\d+$/.test(code)) {
                        showError('Please enter the 6-digit verification code');
                        return;
                    }

                    setLoading('code', true);
                    hideMessages();
                    
                    console.log('üîê Verifying code using Firebase recommended approach...');
                    
                    const verificationState = promiseManager.getVerificationState();
                    let result;
                    
                    // Try Firebase's recommended PhoneAuthProvider.credential approach first
                    if (verificationState.verificationId) {
                        try {
                            console.log('üîë Using PhoneAuthProvider.credential method...');
                            result = await withTimeout(
                                CustomerAuthAPI.verifyPhoneCode(verificationState.verificationId, code),
                                20000,
                                'Code verification timed out. Please try again.'
                            );
                            console.log('‚úÖ Phone verified using credential method!');
                        } catch (credentialError) {
                            console.warn('‚ö†Ô∏è Credential method failed, trying legacy confirm method:', credentialError);
                            
                            // Fallback to legacy confirmationResult.confirm method
                            if (verificationState.confirmationResult) {
                                result = await withTimeout(
                                    CustomerAuthAPI.verifyPhoneCodeLegacy(verificationState.confirmationResult, code),
                                    20000,
                                    'Code verification timed out. Please try again.'
                                );
                                console.log('‚úÖ Phone verified using legacy confirm method!');
                            } else {
                                throw credentialError;
                            }
                        }
                    } else if (verificationState.confirmationResult) {
                        // Use legacy method if no verificationId
                        console.log('üîÑ Using legacy confirmationResult.confirm method...');
                        result = await withTimeout(
                            CustomerAuthAPI.verifyPhoneCodeLegacy(verificationState.confirmationResult, code),
                            20000,
                            'Code verification timed out. Please try again.'
                        );
                        console.log('‚úÖ Phone verified using legacy method!');
                    } else {
                        throw new Error('No verification in progress. Please request a new code.');
                    }
                    
                    const user = result.user;
                    console.log('‚úÖ Phone verified! User UID:', user.uid);
                    
                    // Clear verification state
                    promiseManager.clearVerificationState();
                    
                    // Complete phone auth sign-in
                    await completePhoneSignIn(user);
                });
                
            } catch (error) {
                console.error('‚ùå Error verifying code:', error);
                handleError(error, 'Code verification');
                
                document.getElementById('verificationCode').value = '';
                document.getElementById('verificationCode').focus();
                
            } finally {
                setLoading('code', false);
            }
        }

        // Complete phone sign-in with comprehensive error handling
        async function completePhoneSignIn(user) {
            try {
                // Save customer profile using VediAPI
                try {
                    if (typeof VediAPI !== 'undefined') {
                        await withTimeout(
                            VediAPI.saveCustomerProfile(user.uid, {
                                name: customerName,
                                phone: customerPhone,
                                phoneFormatted: CustomerAuthAPI.maskPhoneNumber(customerPhone),
                                authProvider: 'phone',
                                restaurantId: restaurantId,
                                tableNumber: tableNumber,
                                location: tableLocation
                            }),
                            10000,
                            'Failed to save customer profile'
                        );
                        console.log('‚úÖ Customer profile saved via VediAPI');
                    }
                } catch (profileError) {
                    console.warn('‚ö†Ô∏è Could not save customer profile via VediAPI:', profileError);
                    // Continue anyway - profile save is not critical
                }

                const customerSession = {
                    name: customerName,
                    phone: customerPhone,
                    phoneFormatted: CustomerAuthAPI.maskPhoneNumber(customerPhone),
                    restaurantId: restaurantId,
                    restaurantName: restaurantData?.name || 'Restaurant',
                    tableNumber: tableNumber,
                    location: tableLocation,
                    sessionStart: new Date().toISOString(),
                    firebaseUID: user.uid,
                    authProvider: 'phone',
                    isAuthenticated: true,
                    isSocialAuth: false
                };

                sessionStorage.setItem('customerSession', JSON.stringify(customerSession));

                showSuccess('Phone verified successfully! Redirecting to menu...');
                
                const urlParams = new URLSearchParams();
                urlParams.set('restaurant', restaurantId);
                if (tableNumber) urlParams.set('table', tableNumber);
                if (tableLocation) urlParams.set('location', tableLocation);
                urlParams.set('name', encodeURIComponent(customerName));
                urlParams.set('phone', customerPhone);
                urlParams.set('session', 'verified');
                
                const redirectUrl = `menu.html?${urlParams.toString()}`;
                
                console.log('üîÑ Redirecting to menu:', redirectUrl);
                
                setTimeout(() => {
                    try {
                        window.location.href = redirectUrl;
                    } catch (redirectError) {
                        console.error('‚ùå Redirect error:', redirectError);
                        showError('Failed to redirect to menu. Please try manually refreshing the page.');
                    }
                }, 1500);

            } catch (error) {
                console.error('‚ùå Error completing phone sign-in:', error);
                handleError(error, 'Complete phone sign-in');
            }
        }

        // Resend code with comprehensive error handling
        async function resendCode() {
            try {
                if (promiseManager.isOperationPending('resendCode')) {
                    console.log('üö´ Resend code already in progress');
                    return;
                }

                await promiseManager.execute('resendCode', async () => {
                    setLoading('code', true);
                    hideMessages();
                    
                    console.log('üîÑ Resending verification code...');
                    
                    // Clear stored verification data
                    promiseManager.clearVerificationState();
                    
                    document.getElementById('step3').classList.remove('active');
                    document.getElementById('step2').classList.remove('completed');
                    document.getElementById('step2').classList.add('active');
                    
                    switchToPhase('phonePhase');
                    
                    if (resendTimer) {
                        clearInterval(resendTimer);
                    }
                    
                    // Clear and reinitialize reCAPTCHA using CustomerAuthAPI
                    CustomerAuthAPI.clearRecaptcha();
                    
                    setTimeout(async () => {
                        try {
                            await withTimeout(
                                CustomerAuthAPI.initializeRecaptcha('recaptcha-container'),
                                15000,
                                'reCAPTCHA reinitialization timed out'
                            );
                            showInfo('Please solve the reCAPTCHA and send the code again.');
                        } catch (error) {
                            console.error('‚ùå reCAPTCHA reinitialization failed:', error);
                            showError('Failed to reset verification. Please refresh the page.');
                        }
                    }, 500);
                });
                
            } catch (error) {
                console.error('‚ùå Error resending code:', error);
                handleError(error, 'Resend code');
            } finally {
                setLoading('code', false);
            }
        }

        // Timer functions with error handling
        function startResendTimer() {
            try {
                resendCountdown = 60;
                const resendBtn = document.getElementById('resendBtn');
                const timerElement = document.getElementById('resendTimer');
                
                if (!resendBtn || !timerElement) {
                    console.warn('‚ö†Ô∏è Resend timer elements not found');
                    return;
                }
                
                resendBtn.disabled = true;
                
                resendTimer = setInterval(() => {
                    try {
                        resendCountdown--;
                        timerElement.textContent = `You can request a new code in ${resendCountdown} seconds`;
                        
                        if (resendCountdown <= 0) {
                            clearInterval(resendTimer);
                            resendBtn.disabled = false;
                            timerElement.textContent = 'Didn\'t receive a code? Click resend below.';
                        }
                    } catch (timerError) {
                        console.error('‚ùå Timer error:', timerError);
                        clearInterval(resendTimer);
                    }
                }, 1000);
            } catch (error) {
                console.error('‚ùå Error starting resend timer:', error);
            }
        }

        // =============================================================================
        // UTILITY FUNCTIONS WITH ERROR HANDLING
        // =============================================================================

        // Phase switching with error handling
        function switchToPhase(phaseId) {
            try {
                document.querySelectorAll('.form-phase').forEach(phase => {
                    phase.classList.remove('active');
                });
                
                const targetPhase = document.getElementById(phaseId);
                if (targetPhase) {
                    targetPhase.classList.add('active');
                } else {
                    console.error('‚ùå Phase not found:', phaseId);
                }
            } catch (error) {
                console.error('‚ùå Error switching phase:', error);
            }
        }

        // Loading states with error handling
        function setLoading(type, loading) {
            try {
                const spinners = {
                    name: 'nameSpinner',
                    phone: 'phoneSpinner',
                    code: 'codeSpinner',
                    google: 'googleSpinner',
                    facebook: 'facebookSpinner',
                    apple: 'appleSpinner',
                    phoneCollection: 'phoneCollectionSpinner'
                };
                
                const buttons = {
                    name: 'nameNextBtn',
                    phone: 'sendCodeBtn',
                    code: 'verifyCodeBtn',
                    google: 'googleSignInBtn',
                    facebook: 'facebookSignInBtn',
                    apple: 'appleSignInBtn'
                };
                
                if (spinners[type]) {
                    const spinner = document.getElementById(spinners[type]);
                    if (spinner) {
                        spinner.style.display = loading ? 'inline-block' : 'none';
                    }
                }
                
                if (buttons[type]) {
                    const button = document.getElementById(buttons[type]);
                    if (button) {
                        button.disabled = loading;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error setting loading state:', error);
            }
        }

        // Message functions with error handling
        function showError(message) {
            try {
                hideMessages();
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        if (errorDiv.style.display === 'block') {
                            errorDiv.style.display = 'none';
                        }
                    }, 8000);
                }
            } catch (error) {
                console.error('‚ùå Error showing error message:', error);
            }
        }

        function showSuccess(message) {
            try {
                hideMessages();
                const successDiv = document.getElementById('successMessage');
                if (successDiv) {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        if (successDiv.style.display === 'block') {
                            successDiv.style.display = 'none';
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('‚ùå Error showing success message:', error);
            }
        }

        function showInfo(message) {
            try {
                hideMessages();
                const infoDiv = document.getElementById('infoMessage');
                if (infoDiv) {
                    infoDiv.textContent = message;
                    infoDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        if (infoDiv.style.display === 'block') {
                            infoDiv.style.display = 'none';
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('‚ùå Error showing info message:', error);
            }
        }

        function hideMessages() {
            try {
                const messages = ['errorMessage', 'successMessage', 'infoMessage'];
                messages.forEach(messageId => {
                    const element = document.getElementById(messageId);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('‚ùå Error hiding messages:', error);
            }
        }

        // =============================================================================
        // ENHANCED EVENT LISTENERS AND ERROR BOUNDARIES
        // =============================================================================

        // Auto-submit code when 6 digits entered with error handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const codeInput = document.getElementById('verificationCode');
                if (codeInput) {
                    codeInput.addEventListener('input', function(e) {
                        try {
                            const value = e.target.value.replace(/\D/g, '');
                            e.target.value = value;
                            
                            if (value.length === 6) {
                                setTimeout(() => {
                                    verifyCode();
                                }, 500);
                            }
                        } catch (inputError) {
                            console.error('‚ùå Code input error:', inputError);
                        }
                    });
                }
            } catch (error) {
                console.error('‚ùå Error setting up code input listener:', error);
            }
        });

        // Global error handlers
        window.addEventListener('error', function(event) {
            // Ignore extension-related errors
            if (event.message.includes('message channel closed') || 
                event.message.includes('Extension context invalidated')) {
                console.log('üîå Browser extension error ignored (harmless)');
                event.preventDefault();
                return false;
            }
            
            console.error('üö® Global error:', event.error);
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('üö® Unhandled promise rejection:', event.reason);
            
            // Filter out extension errors
            if (event.reason?.message?.includes('Extension context invalidated')) {
                event.preventDefault();
                return;
            }
            
            // Show user-friendly error for authentication failures
            if (event.reason?.code?.startsWith('auth/')) {
                showError('Authentication error. Please refresh the page and try again.');
                event.preventDefault();
            } else if (event.reason?.message?.includes('timeout')) {
                showError('Operation timed out. Please check your connection and try again.');
                event.preventDefault();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            try {
                // Cancel all pending operations
                promiseManager.cancelAllOperations();
                
                // Clear timers
                if (resendTimer) {
                    clearInterval(resendTimer);
                }
                
                // Clear reCAPTCHA
                if (CustomerAuthAPI) {
                    CustomerAuthAPI.clearRecaptcha();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Cleanup error:', error);
            }
        });

        // Visibility change handler to manage state when tab becomes inactive
        document.addEventListener('visibilitychange', function() {
            try {
                if (document.hidden) {
                    console.log('üì± Tab became inactive');
                    // Pause timers when tab is inactive
                    if (resendTimer && resendCountdown > 0) {
                        clearInterval(resendTimer);
                        console.log('‚è∏Ô∏è Paused resend timer');
                    }
                } else {
                    console.log('üì± Tab became active');
                    // Resume timers when tab becomes active again
                    if (resendCountdown > 0 && !resendTimer) {
                        startResendTimer();
                        console.log('‚ñ∂Ô∏è Resumed resend timer');
                    }
                }
            } catch (error) {
                console.error('‚ùå Visibility change error:', error);
            }
        });

        // Network status monitoring
        window.addEventListener('online', function() {
            console.log('üåê Network connection restored');
            showInfo('Network connection restored. You can continue with authentication.');
        });

        window.addEventListener('offline', function() {
            console.log('üì∂ Network connection lost');
            showError('Network connection lost. Please check your internet connection.');
        });

        // =============================================================================
        // DEBUGGING AND DIAGNOSTICS (Development Mode)
        // =============================================================================

        // Debug mode detection
        const isDebugMode = window.location.hostname === 'localhost' || 
                           window.location.search.includes('debug=true');

        if (isDebugMode) {
            console.log('üêõ Debug mode enabled');
            
            // Expose debugging functions globally
            window.customerAuthDebug = {
                promiseManager: promiseManager,
                checkAuthConfig: () => CustomerAuthAPI?.checkPhoneAuthConfig?.(),
                testRecaptcha: () => CustomerAuthAPI?.testRecaptcha?.(),
                runDiagnostics: () => CustomerAuthAPI?.runDiagnostics?.(),
                clearAllState: () => {
                    promiseManager.cancelAllOperations();
                    sessionStorage.clear();
                    localStorage.clear();
                    console.log('üßπ All state cleared');
                },
                simulateError: (type) => {
                    switch(type) {
                        case 'network':
                            throw new Error('Simulated network error');
                        case 'timeout':
                            throw new Error('Simulated timeout error');
                        case 'auth':
                            const authError = new Error('Simulated auth error');
                            authError.code = 'auth/simulated-error';
                            throw authError;
                        default:
                            throw new Error('Simulated generic error');
                    }
                }
            };
            
            console.log('üîß Debug functions available via window.customerAuthDebug');
        }

        // Performance monitoring in debug mode
        if (isDebugMode && typeof performance !== 'undefined') {
            // Monitor long tasks
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.duration > 100) {
                            console.warn('‚ö†Ô∏è Long task detected:', entry.duration + 'ms');
                        }
                    });
                });
                
                try {
                    observer.observe({entryTypes: ['longtask']});
                } catch (e) {
                    console.log('üìä Long task monitoring not supported');
                }
            }
        }

        console.log('üì±üîç Enhanced customer authentication system loaded with comprehensive promise handling');
        console.log('üîó Using VediAPI for social auth and restaurant data');
        console.log('üì± Using CustomerAuthAPI for phone authentication and reCAPTCHA');
        console.log('‚úÖ Promise state management and error boundaries active');
        console.log('üõ°Ô∏è Timeout protection and retry logic enabled');
        console.log('üîÑ Network monitoring and offline handling ready');
    </script>
</body>
</html>
