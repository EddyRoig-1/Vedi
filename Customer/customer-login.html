<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>Table Order - Login</title>
    
    <!-- Performance Optimizations: Preconnect to critical domains -->
    <link rel="preconnect" href="https://www.googleapis.com">
    <link rel="preconnect" href="https://accounts.google.com">
    <link rel="preconnect" href="https://www.facebook.com">
    <link rel="preconnect" href="https://appleid.apple.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://www.google.com">
    
    <!-- DNS prefetch for faster domain resolution -->
    <link rel="dns-prefetch" href="//www.googleapis.com">
    <link rel="dns-prefetch" href="//accounts.google.com">
    <link rel="dns-prefetch" href="//www.facebook.com">
    <link rel="dns-prefetch" href="//www.google.com">
    
    <!-- Firebase Scripts with optimized loading -->
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LeO1GgrAAAAAPgklAMTBBAiy5iCdKzMWvAgaPb5"></script>
    
    <!-- Firebase Configuration (Must load first) -->
    <script defer src="../firebase-config.js"></script>
    
    <!-- Core API Modules -->
    <script defer src="../Api/core/firebase-init.js"></script>
    <script defer src="../Api/core/utilities.js"></script>
    <script defer src="../Api/core/tracking.js"></script>
    
    <!-- Authentication Modules -->
    <script defer src="../Api/auth/social-auth.js"></script>
    <!-- Use the new reCAPTCHA v2 phone auth module -->
    <script defer src="../Api/auth/phone-auth.js"></script>
    <script defer src="../Api/auth/user-management.js"></script>
    
    <!-- Business Modules -->
    <script defer src="../Api/business/restaurants.js"></script>

    <style>
        /* iOS-Focused Design System */
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #FF9500;
            --success: #34C759;
            --error: #FF3B30;
            --warning: #FF9500;
            --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --surface: #ffffff;
            --surface-2: rgba(255, 255, 255, 0.95);
            --surface-3: rgba(255, 255, 255, 0.85);
            --text-primary: #000000;
            --text-secondary: rgba(60, 60, 67, 0.6);
            --text-muted: rgba(60, 60, 67, 0.3);
            --text-on-color: rgba(255, 255, 255, 0.9);
            --border: rgba(60, 60, 67, 0.18);
            --border-light: rgba(60, 60, 67, 0.08);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --radius-sm: 10px;
            --radius-lg: 16px;
            --system-font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: var(--system-font);
            background: var(--surface);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        /* Main Container - Full Mobile Optimized */
        .container {
            background: var(--background);
            width: 100%;
            max-width: 100%;
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface);
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            z-index: -1;
        }

        .login-page {
            padding: 24px 24px 32px 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            max-height: 100vh;
            max-height: 100dvh;
            overflow-y: auto;
        }

        .login-content {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* Typography - iOS Style */
        h1 {
            font-size: clamp(28px, 6vw, 32px);
            font-weight: 700;
            color: var(--text-on-color);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 17px;
            color: var(--text-on-color);
            opacity: 0.8;
            margin-bottom: 32px;
            font-weight: 400;
            line-height: 1.4;
        }

        /* Restaurant Info Card - Enhanced with proper border animation */
        .restaurant-info {
            background: var(--surface-2);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 32px;
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            animation: cardSlideIn 0.6s ease-out;
            text-align: center;
        }

        .restaurant-info::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: conic-gradient(
                from 0deg at 50% 50%,
                rgba(255, 255, 255, 0.9) 0deg,
                rgba(255, 255, 255, 0.2) 90deg,
                rgba(255, 255, 255, 0.9) 180deg,
                rgba(255, 255, 255, 0.2) 270deg,
                rgba(255, 255, 255, 0.9) 360deg
            );
            border-radius: calc(var(--radius-lg) + 3px);
            animation: spinBorder 3s linear infinite;
            z-index: -1;
        }

        .restaurant-info::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface-2);
            border-radius: var(--radius-lg);
            z-index: -1;
        }

        @keyframes spinBorder {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .restaurant-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .restaurant-name {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 20px;
            margin: 0 0 12px 0;
            text-align: center;
        }

        .table-info-container {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .table-info {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            margin: 0;
            text-align: center;
        }

        .restaurant-status {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: statusBlink 2s ease-in-out infinite;
        }

        @keyframes statusBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Status Checking Overlay */
        .status-checking-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .status-checking-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .status-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .status-checking-text {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .status-checking-subtext {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Restaurant Offline Status */
        .restaurant-offline {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            color: #92400e;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            text-align: center;
            display: none;
            border: 2px solid #f59e0b;
        }

        .restaurant-offline h3 {
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #b45309;
        }

        .restaurant-offline p {
            margin-bottom: 6px;
            font-size: 14px;
            line-height: 1.5;
        }

        .restaurant-offline .offline-reason {
            font-style: italic;
            color: #a16207;
            font-size: 13px;
        }

        /* Form Sections */
        .form-section-disabled {
            opacity: 0.5;
            pointer-events: none;
            user-select: none;
        }

        /* Social Login Section - iOS Style */
        .social-login {
            margin-bottom: 24px;
        }

        .social-login h3 {
            color: var(--text-on-color);
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Horizontal Social Buttons - iOS Style */
        .social-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .social-btn {
            flex: 1;
            min-width: 70px;
            max-width: 100px;
            height: 50px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background: var(--surface);
            position: relative;
            font-family: var(--system-font);
            box-shadow: var(--shadow);
        }

        .social-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .social-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .social-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .social-btn.google {
            background: var(--surface);
            border: 2px solid #ea4335;
        }

        .social-btn.facebook {
            background: var(--surface);
            border: 2px solid #1877f2;
        }

        .social-btn.apple {
            background: var(--surface);
            border: 2px solid #000000;
        }

        /* Social Icon Styling */
        .social-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .social-btn:hover .social-icon {
            transform: scale(1.05);
        }

        /* Divider - iOS Style */
        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--text-on-color);
            opacity: 0.6;
            font-size: 15px;
            font-weight: 500;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
        }

        .divider span {
            padding: 0 16px;
            background: transparent;
        }

        /* Inline Phone Form */
        .phone-form-inline {
            width: 100%;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
            text-align: left;
        }

        /* Form Labels - iOS Style */
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-on-color);
            font-weight: 600;
            font-size: 15px;
            opacity: 0.9;
        }

        /* Form Inputs - iOS Style */
        input {
            width: 100%;
            height: 50px;
            padding: 0 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 17px;
            transition: all 0.2s ease;
            outline: none;
            background: var(--surface);
            font-family: var(--system-font);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }

        input:focus {
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3), var(--shadow);
            transform: translateY(-1px);
        }

        input::placeholder {
            color: var(--text-secondary);
        }

        .phone-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .country-select {
            min-width: 85px;
            height: 50px;
            padding: 0 12px;
            border: none;
            border-radius: var(--radius);
            font-size: 15px;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
            font-family: var(--system-font);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }

        .country-select:focus {
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3), var(--shadow);
            transform: translateY(-1px);
        }

        .phone-number-input {
            flex: 1;
        }

        .input-hint {
            font-size: 13px;
            color: var(--text-on-color);
            opacity: 0.7;
            margin-top: 6px;
            line-height: 1.4;
        }

        /* Primary Button - iOS Style */
        .btn {
            width: 100%;
            height: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: var(--system-font);
            box-shadow: var(--shadow);
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Messages - iOS Style */
        .error-message, .success-message, .info-message {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            font-size: 15px;
            display: none;
            font-weight: 500;
            border: none;
            box-shadow: var(--shadow);
        }

        .error-message {
            background: rgba(255, 59, 48, 0.1);
            color: var(--error);
        }

        .success-message {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .info-message {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
        }

        /* Initial Loader */
        .initial-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loader-content {
            color: white;
            text-align: center;
        }

        .loader-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loader-content div {
            font-size: 18px;
            font-weight: 600;
        }

        /* Phone Collection Section */
        .phone-collection {
            background: var(--surface-2);
            padding: 20px;
            border-radius: var(--radius);
            margin: 16px 0;
            border: 2px solid var(--border-light);
            display: none;
            animation: slideIn 0.3s ease-in-out;
        }

        .phone-collection.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .phone-collection h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 700;
        }

        .phone-collection p {
            color: var(--text-secondary);
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .skip-phone {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            margin-top: 10px;
        }

        .skip-phone:hover {
            background: var(--primary);
            color: white;
        }

        /* reCAPTCHA container - completely hidden */
        #recaptcha_container {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
            width: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            z-index: -9999 !important;
        }

        /* Hide any reCAPTCHA elements that might appear */
        .grecaptcha-badge {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        iframe[src*="recaptcha"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Responsive Design - iOS Style */
        @media (min-width: 768px) {
            .container::before {
                margin: 40px;
                border-radius: var(--radius-lg);
            }
            
            .login-page {
                min-height: auto;
                padding: 40px 32px;
            }

            .social-buttons {
                gap: 16px;
            }

            .social-btn {
                max-width: 90px;
                height: 54px;
            }

            .social-icon {
                width: 24px;
                height: 24px;
            }

            h1 {
                font-size: 34px;
            }

            .subtitle {
                font-size: 19px;
            }

            .btn {
                height: 54px;
                font-size: 18px;
            }

            input {
                height: 54px;
                font-size: 17px;
            }

            .country-select {
                height: 54px;
                min-width: 95px;
            }
        }

        /* Small Mobile Devices - iOS Optimized */
        @media (max-width: 375px) {
            .container::before {
                margin: 0;
                border-radius: 0;
            }

            .login-page {
                padding: 20px 16px;
            }

            .social-buttons {
                gap: 10px;
            }

            .social-btn {
                min-width: 65px;
                height: 46px;
            }

            .social-icon {
                width: 18px;
                height: 18px;
            }

            h1 {
                font-size: 26px;
            }

            .subtitle {
                font-size: 16px;
            }

            .restaurant-info {
                padding: 16px;
            }

            .btn {
                height: 46px;
                font-size: 16px;
            }

            input {
                height: 46px;
                font-size: 16px;
            }

            .country-select {
                height: 46px;
                min-width: 80px;
                font-size: 14px;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border: #6b7280;
                --text-secondary: #374151;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --surface: #1e293b;
                --surface-2: #334155;
                --surface-3: #475569;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-muted: #94a3b8;
                --border: #475569;
                --border-light: #374151;
            }
        }
    </style>
</head>
<body>
    <!-- Initial Loading Screen -->
    <div class="initial-loader" id="initialLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div>Loading Vedi...</div>
        </div>
    </div>

    <div class="container">
        <!-- Status Checking Overlay -->
        <div class="status-checking-overlay" id="statusCheckingOverlay">
            <div class="status-spinner"></div>
            <div class="status-checking-text">Checking restaurant availability...</div>
            <div class="status-checking-subtext">Please wait a moment</div>
        </div>

        <div class="login-page">
            <div class="login-content">
                <h1>Welcome</h1>
                <p class="subtitle">Sign in to start ordering delicious food</p>
                
                <div class="restaurant-info" id="restaurantInfo">
                    <div class="restaurant-status"></div>
                    <div class="restaurant-header">
                        <div class="restaurant-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12V7a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5M5 12l-2 5h16l-2-5M5 12h14"/>
                            </svg>
                        </div>
                        <div class="restaurant-name" id="restaurantName">Angustura</div>
                    </div>
                    <div class="table-info-container">
                        <svg class="table-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2v20"/>
                            <path d="m5 9 14 0"/>
                            <path d="m5 15 14 0"/>
                        </svg>
                        <div class="table-info" id="tableInfo">Table #1</div>
                    </div>
                </div>

                <!-- Restaurant Offline Status -->
                <div class="restaurant-offline" id="restaurantOfflineStatus">
                    <h3>Currently Unavailable</h3>
                    <p><strong id="offlineRestaurantName">This restaurant</strong> is not currently taking orders.</p>
                    <p class="offline-reason" id="offlineReason"></p>
                </div>

                <!-- Messages -->
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                <div class="info-message" id="infoMessage"></div>
                
                <!-- Main Login Forms Container -->
                <div id="loginFormsContainer">
                    <!-- Social Login Section -->
                    <div class="social-login">
                        <h3>Quick Sign In</h3>
                        <div class="social-buttons">
                            <button class="social-btn google" id="googleSignInBtn" onclick="handleGoogleSignIn()">
                                <div class="social-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                </div>
                                <div class="loading-spinner" id="googleSpinner"></div>
                            </button>
                            
                            <button class="social-btn facebook" id="facebookSignInBtn" onclick="handleFacebookSignIn()">
                                <div class="social-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24">
                                        <path fill="#1877f2" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                    </svg>
                                </div>
                                <div class="loading-spinner" id="facebookSpinner"></div>
                            </button>
                            
                            <button class="social-btn apple" id="appleSignInBtn" onclick="handleAppleSignIn()">
                                <div class="social-icon">
                                    <svg viewBox="0 0 24 24" width="26" height="26">
                                        <path fill="#000000" d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                                    </svg>
                                </div>
                                <div class="loading-spinner" id="appleSpinner"></div>
                            </button>
                        </div>
                    </div>

                    <div class="divider">
                        <span>or</span>
                    </div>

                    <!-- Inline Phone Form -->
                    <div class="phone-form-inline">
                        <form id="inlinePhoneForm">
                            <div class="form-group">
                                <input 
                                    type="text" 
                                    id="fullNameInline" 
                                    placeholder="Full Name"
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <div class="phone-input-group">
                                    <select id="countryCodeInline" class="country-select">
                                        <option value="+1">üá∫üá∏ +1</option>
                                        <option value="+1">üá®üá¶ +1</option>
                                        <option value="+44">üá¨üáß +44</option>
                                        <option value="+33">üá´üá∑ +33</option>
                                        <option value="+49">üá©üá™ +49</option>
                                        <option value="+39">üáÆüáπ +39</option>
                                        <option value="+34">üá™üá∏ +34</option>
                                        <option value="+61">üá¶üá∫ +61</option>
                                        <option value="+81">üáØüáµ +81</option>
                                        <option value="+82">üá∞üá∑ +82</option>
                                        <option value="+86">üá®üá≥ +86</option>
                                        <option value="+91">üáÆüá≥ +91</option>
                                        <option value="+55">üáßüá∑ +55</option>
                                        <option value="+52">üá≤üáΩ +52</option>
                                    </select>
                                    <input 
                                        type="tel" 
                                        id="phoneNumberInline" 
                                        class="phone-number-input" 
                                        placeholder="(555) 123-4567"
                                        required
                                    >
                                </div>
                            </div>
                            
                            <button type="submit" class="btn" id="sendCodeBtnInline">
                                <span id="sendCodeTextInline">Send Verification Code</span>
                                <div class="loading-spinner" id="sendCodeSpinnerInline"></div>
                            </button>
                        </form>
                    </div>

                    <!-- Phone Collection for Social Users -->
                    <div class="phone-collection" id="phoneCollection">
                        <h4>Add Your Phone Number</h4>
                        <p>To ensure we can reach you about your order, please add your phone number. This helps with order updates and notifications.</p>
                        
                        <div class="form-group">
                            <input type="tel" id="socialUserPhone" class="phone-number-input" placeholder="123-456-7890">
                        </div>
                        
                        <button class="btn" onclick="saveSocialUserPhone()">
                            <span class="loading-spinner" id="phoneCollectionSpinner"></span>
                            <span>Save & Continue</span>
                        </button>
                        
                        <button class="btn skip-phone" onclick="skipPhoneCollection()">
                            Skip for Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden reCAPTCHA Container -->
    <div id="recaptcha_container"></div>

    <script>
        // Global variables
        let restaurantData = null;
        let tableNumber = null;
        let restaurantId = null;
        let tableLocation = null;
        let currentSocialUser = null;
        let performanceStartTime = Date.now();
        let restaurantStatusListener = null;
        let isRestaurantOnline = false;

        // Phone auth variables
        let phoneConfirmationResult = null;
        let phoneVerificationId = null;
        let userFullName = '';
        let userPhoneNumber = '';

        // =============================================================================
        // INLINE PHONE AUTHENTICATION - NO MODAL
        // =============================================================================

        // Handle inline phone form submission with reCAPTCHA v2
        async function handleInlinePhoneSubmit(e) {
            e.preventDefault();

            const sendCodeBtn = document.getElementById('sendCodeBtnInline');
            const sendCodeText = document.getElementById('sendCodeTextInline');
            const sendCodeSpinner = document.getElementById('sendCodeSpinnerInline');
            const fullNameInput = document.getElementById('fullNameInline');
            const phoneInput = document.getElementById('phoneNumberInline');
            const countryCode = document.getElementById('countryCodeInline').value;

            sendCodeBtn.disabled = true;
            sendCodeText.style.display = 'none';
            sendCodeSpinner.style.display = 'block';

            try {
                userFullName = fullNameInput.value.trim();
                const rawPhoneNumber = phoneInput.value.replace(/\D/g, '');

                if (!userFullName || userFullName.length < 2) {
                    throw new Error('Please enter your full name');
                }

                if (!rawPhoneNumber || rawPhoneNumber.length < 10) {
                    throw new Error('Please enter a valid phone number');
                }

                userPhoneNumber = countryCode + rawPhoneNumber;
                console.log('üì± Prepared to send to:', window.maskPhoneNumber ? window.maskPhoneNumber(userPhoneNumber) : userPhoneNumber);

                // Wait for VediAPI to be ready
                if (!window.VediAPI || typeof window.VediAPI.sendPhoneVerification !== 'function') {
                    throw new Error('Authentication system not ready. Please refresh the page.');
                }

                // Use the reCAPTCHA v2 method
                phoneConfirmationResult = await window.VediAPI.sendPhoneVerification(userPhoneNumber, 'recaptcha_container');

                // Show success and prompt for verification code
                showSuccess('Verification code sent! Please check your phone and enter the 6-digit code when it arrives.');
                
                // Replace the form with verification input
                showVerificationInput();

            } catch (error) {
                console.error('‚ùå Error sending phone verification:', error);
                showError(error.message || 'Failed to send verification code. Please try again.');

                sendCodeBtn.disabled = false;
                sendCodeText.style.display = 'block';
                sendCodeSpinner.style.display = 'none';
            }
        }

        // Show verification input in place of the form
        function showVerificationInput() {
            const phoneFormContainer = document.querySelector('.phone-form-inline');
            
            phoneFormContainer.innerHTML = `
                <form id="verifyCodeFormInline">
                    <div class="form-group">
                        <input 
                            type="text" 
                            id="verificationCodeInline" 
                            placeholder="Verification Code"
                            maxlength="6"
                            required
                            style="text-align: center; font-size: 20px; letter-spacing: 0.1em; font-weight: 700;"
                        >
                        <div class="input-hint">
                            Enter the 6-digit code sent to ${userPhoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{3})(\d{4})/, '$1 $2-***-$4')}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="verifyCodeBtnInline">
                        <span id="verifyCodeTextInline">Verify & Sign In</span>
                        <div class="loading-spinner" id="verifyCodeSpinnerInline"></div>
                    </button>
                    
                    <button type="button" class="btn skip-phone" onclick="resetInlineForm()">
                        ‚Üê Back to phone number
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border-light);">
                    <p style="color: var(--text-on-color); opacity: 0.7; margin-bottom: 8px; font-size: 14px;">Didn't receive the code?</p>
                    <button type="button" onclick="resendCodeInline()" style="background: none; border: none; color: var(--text-on-color); opacity: 0.9; font-weight: 600; cursor: pointer; text-decoration: underline; font-size: 14px;">
                        Resend Code
                    </button>
                </div>
            `;

            // Setup verification form listener
            document.getElementById('verifyCodeFormInline').addEventListener('submit', handleVerifySubmitInline);
            
            // Auto-submit when 6 digits entered
            const codeInput = document.getElementById('verificationCodeInline');
            codeInput.addEventListener('input', function(e) {
                // Only allow digits
                e.target.value = e.target.value.replace(/\D/g, '');
                
                // Auto-submit when 6 digits entered
                if (e.target.value.length === 6) {
                    setTimeout(() => {
                        handleVerifySubmitInline(e);
                    }, 500);
                }
            });

            // Focus on the input
            setTimeout(() => {
                codeInput.focus();
            }, 300);
        }

        // Handle verification code submission (inline)
        async function handleVerifySubmitInline(e) {
            e.preventDefault();
            
            const verifyCodeBtn = document.getElementById('verifyCodeBtnInline');
            const verifyCodeText = document.getElementById('verifyCodeTextInline');
            const verifyCodeSpinner = document.getElementById('verifyCodeSpinnerInline');
            const codeInput = document.getElementById('verificationCodeInline');
            
            // Disable button and show loading
            verifyCodeBtn.disabled = true;
            verifyCodeText.style.display = 'none';
            verifyCodeSpinner.style.display = 'block';
            
            try {
                const code = codeInput.value.trim();
                
                // Validate code
                if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
                    throw new Error('Please enter a valid 6-digit verification code');
                }
                
                console.log('üîê Verifying phone code...');
                
                // Verify the SMS code using the new method
                const result = await window.VediAPI.verifyPhoneCode(phoneConfirmationResult, code);
                
                console.log('‚úÖ Phone verification successful:', result);
                
                // Update user profile with name if it's a new user
                if (result.user && userFullName) {
                    try {
                        await updateUserProfileName(result.user, userFullName);
                    } catch (nameError) {
                        console.warn('‚ö†Ô∏è Could not update user name:', nameError);
                    }
                }
                
                // Create customer session
                const customerSession = {
                    firebaseUID: result.user.uid,
                    phoneNumber: userPhoneNumber,
                    name: userFullName,
                    authMethod: 'phone',
                    isVerified: true,
                    restaurantId: restaurantId,
                    restaurantName: restaurantData?.name || 'Restaurant',
                    tableNumber: tableNumber,
                    location: tableLocation,
                    sessionCreated: new Date().toISOString()
                };
                
                // Save session
                sessionStorage.setItem('customerSession', JSON.stringify(customerSession));
                
                // Show success and redirect
                showSuccess('Successfully signed in! Redirecting to menu...');
                
                setTimeout(() => {
                    proceedAfterAuthentication(result.user, 'phone', userFullName, userPhoneNumber);
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error verifying phone code:', error);
                showError(error.message || 'Invalid verification code. Please try again.');
                
                // Re-enable button
                verifyCodeBtn.disabled = false;
                verifyCodeText.style.display = 'block';
                verifyCodeSpinner.style.display = 'none';
            }
        }

        // Resend verification code (inline)
        async function resendCodeInline() {
            try {
                console.log('üîÑ Resending verification code...');
                
                // Use retry method that resets reCAPTCHA
                phoneConfirmationResult = await window.VediAPI.retrySendPhoneVerification(userPhoneNumber, 'recaptcha_container');
                
                showSuccess('Verification code resent!');
                
                // Clear the code input
                document.getElementById('verificationCodeInline').value = '';
                
            } catch (error) {
                console.error('‚ùå Error resending code:', error);
                showError('Failed to resend code. Please try again.');
            }
        }

        // Reset to original form
        function resetInlineForm() {
            const phoneFormContainer = document.querySelector('.phone-form-inline');
            
            phoneFormContainer.innerHTML = `
                <form id="inlinePhoneForm">
                    <div class="form-group">
                        <input 
                            type="text" 
                            id="fullNameInline" 
                            placeholder="Full Name"
                            required
                            value="${userFullName}"
                        >
                    </div>
                    
                    <div class="form-group">
                        <div class="phone-input-group">
                            <select id="countryCodeInline" class="country-select">
                                <option value="+1">üá∫üá∏ +1</option>
                                <option value="+1">üá®üá¶ +1</option>
                                <option value="+44">üá¨üáß +44</option>
                                <option value="+33">üá´üá∑ +33</option>
                                <option value="+49">üá©üá™ +49</option>
                                <option value="+39">üáÆüáπ +39</option>
                                <option value="+34">üá™üá∏ +34</option>
                                <option value="+61">üá¶üá∫ +61</option>
                                <option value="+81">üáØüáµ +81</option>
                                <option value="+82">üá∞üá∑ +82</option>
                                <option value="+86">üá®üá≥ +86</option>
                                <option value="+91">üáÆüá≥ +91</option>
                                <option value="+55">üáßüá∑ +55</option>
                                <option value="+52">üá≤üáΩ +52</option>
                            </select>
                            <input 
                                type="tel" 
                                id="phoneNumberInline" 
                                class="phone-number-input" 
                                placeholder="(555) 123-4567"
                                required
                            >
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="sendCodeBtnInline">
                        <span id="sendCodeTextInline">Send Verification Code</span>
                        <div class="loading-spinner" id="sendCodeSpinnerInline"></div>
                    </button>
                </form>
            `;

            // Re-setup event listeners
            setupInlineFormListeners();
            
            // Clear global variables
            phoneConfirmationResult = null;
            phoneVerificationId = null;
            userFullName = '';
            userPhoneNumber = '';
            
            // Clear reCAPTCHA
            if (window.VediAPI && typeof window.VediAPI.clearRecaptchaVerifier === 'function') {
                window.VediAPI.clearRecaptchaVerifier();
            }
        }

        // Setup inline form event listeners
        function setupInlineFormListeners() {
            // Phone form submission
            const phoneForm = document.getElementById('inlinePhoneForm');
            if (phoneForm) {
                phoneForm.addEventListener('submit', handleInlinePhoneSubmit);
            }
            
            // Format phone number as user types
            const phoneInput = document.getElementById('phoneNumberInline');
            if (phoneInput) {
                phoneInput.addEventListener('input', formatPhoneInputDisplay);
            }
        }

        // Format phone number display as user types
        function formatPhoneInputDisplay(e) {
            let value = e.target.value.replace(/\D/g, '');
            const countryCode = document.getElementById('countryCodeInline').value;
            
            // Format based on country code
            if (countryCode === '+1') {
                // US/Canada format: (555) 123-4567
                if (value.length >= 6) {
                    value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
                } else if (value.length >= 3) {
                    value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                }
            }
            
            e.target.value = value;
        }

        // Proceed after phone authentication
        function proceedAfterAuthentication(user, provider, name, phone) {
            try {
                console.log('üîÑ Proceeding after phone authentication...');
                
                // Build redirect URL
                const urlParams = new URLSearchParams();
                urlParams.set('restaurant', restaurantId);
                if (tableNumber) urlParams.set('table', tableNumber);
                if (tableLocation) urlParams.set('location', tableLocation);
                urlParams.set('name', encodeURIComponent(name));
                if (phone) urlParams.set('phone', phone);
                urlParams.set('session', 'authenticated');
                
                const redirectUrl = `menu.html?${urlParams.toString()}`;
                
                console.log('üîÑ Redirecting to menu:', redirectUrl);
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error proceeding after authentication:', error);
                showError('Authentication successful, but failed to redirect. Please try refreshing.');
            }
        }

        // Update user profile with name
        async function updateUserProfileName(user, displayName) {
            try {
                await user.updateProfile({
                    displayName: displayName
                });
                
                console.log('‚úÖ User profile updated with name');
            } catch (error) {
                console.error('‚ùå Error updating user profile:', error);
                throw error;
            }
        }

        // =============================================================================
        // CUSTOMER LOGIN CALLBACK SYSTEM - BRIDGES VEDIAPI WITH LOGIN PAGE
        // =============================================================================

        /**
         * Global callback function that VediAPI social auth will call
         * This is the bridge between the API and the customer login page
         */
        window.handleSocialSignInSuccess = async function(user, provider, profile) {
            console.log('üîó CALLBACK: handleSocialSignInSuccess called from VediAPI');
            console.log('- User:', user.displayName);
            console.log('- Provider:', provider);
            console.log('- Email:', user.email);
            console.log('- Phone:', user.phoneNumber);
            
            currentSocialUser = user;
            
            // Extract user information
            const userName = user.displayName || 'Guest User';
            const userEmail = user.email || '';
            const userPhone = user.phoneNumber || '';
            
            // Check if user has a phone number
            if (!userPhone) {
                console.log('üì± No phone number, showing phone collection...');
                showPhoneCollection();
                return;
            }

            console.log('üì± Phone number exists, proceeding to complete sign-in');
            // Proceed directly to menu if phone number exists
            await completeSocialSignIn(userName, userPhone, userEmail, provider);
        };

        /**
         * Complete social sign-in and redirect to menu
         */
        async function completeSocialSignIn(userName, userPhone, userEmail, provider) {
            try {
                console.log('üîÑ Completing social sign-in and redirecting...');
                
                // Create customer session data
                const customerSession = {
                    name: userName,
                    email: userEmail,
                    phone: userPhone,
                    restaurantId: restaurantId,
                    restaurantName: restaurantData?.name || 'Restaurant',
                    tableNumber: tableNumber,
                    location: tableLocation,
                    sessionStart: new Date().toISOString(),
                    firebaseUID: currentSocialUser.uid,
                    authProvider: provider,
                    isAuthenticated: true,
                    isSocialAuth: true
                };

                // Store in sessionStorage for immediate use
                sessionStorage.setItem('customerSession', JSON.stringify(customerSession));

                showSuccess(`Welcome ${userName.split(' ')[0]}! Redirecting to menu...`);
                
                // Build redirect URL
                const urlParams = new URLSearchParams();
                urlParams.set('restaurant', restaurantId);
                if (tableNumber) urlParams.set('table', tableNumber);
                if (tableLocation) urlParams.set('location', tableLocation);
                urlParams.set('name', encodeURIComponent(userName));
                if (userPhone) urlParams.set('phone', userPhone);
                urlParams.set('session', 'social');
                
                const redirectUrl = `menu.html?${urlParams.toString()}`;
                
                console.log('üîÑ Redirecting to menu:', redirectUrl);
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error completing social sign-in:', error);
                showError('Failed to complete sign-in. Please try again.');
            }
        }

        // =============================================================================
        // SOCIAL AUTHENTICATION HANDLERS - SIMPLIFIED
        // =============================================================================

        /**
         * Handle Google sign-in button click
         */
        async function handleGoogleSignIn() {
            console.log('üîç Google sign-in button clicked');
            
            if (!isRestaurantOnline) {
                showError('Cannot sign in while restaurant is unavailable. Please wait for restaurant to come online.');
                return;
            }

            if (typeof VediAPI === 'undefined' || typeof VediAPI.signInWithGoogle !== 'function') {
                showError('Authentication system not ready. Please refresh the page.');
                return;
            }

            try {
                setLoading('google', true);
                hideMessages();
                
                console.log('üîç Calling VediAPI.signInWithGoogle...');
                
                // The VediAPI will handle everything and call our callback
                await VediAPI.signInWithGoogle();
                
            } catch (error) {
                console.error('‚ùå Google sign-in error:', error);
                showError(error.message || 'Google sign-in failed. Please try again.');
            } finally {
                setLoading('google', false);
            }
        }

        /**
         * Handle Facebook sign-in button click
         */
        async function handleFacebookSignIn() {
            console.log('üìò Facebook sign-in button clicked');
            
            if (!isRestaurantOnline) {
                showError('Cannot sign in while restaurant is unavailable. Please wait for restaurant to come online.');
                return;
            }

            if (typeof VediAPI === 'undefined' || typeof VediAPI.signInWithFacebook !== 'function') {
                showError('Authentication system not ready. Please refresh the page.');
                return;
            }

            try {
                setLoading('facebook', true);
                hideMessages();
                
                console.log('üìò Calling VediAPI.signInWithFacebook...');
                
                // The VediAPI will handle everything and call our callback
                await VediAPI.signInWithFacebook();
                
            } catch (error) {
                console.error('‚ùå Facebook sign-in error:', error);
                showError(error.message || 'Facebook sign-in failed. Please try again.');
            } finally {
                setLoading('facebook', false);
            }
        }

        /**
         * Handle Apple sign-in button click
         */
        async function handleAppleSignIn() {
            console.log('üçé Apple sign-in button clicked');
            
            if (!isRestaurantOnline) {
                showError('Cannot sign in while restaurant is unavailable. Please wait for restaurant to come online.');
                return;
            }

            if (typeof VediAPI === 'undefined' || typeof VediAPI.signInWithApple !== 'function') {
                showError('Authentication system not ready. Please refresh the page.');
                return;
            }

            try {
                setLoading('apple', true);
                hideMessages();
                
                console.log('üçé Calling VediAPI.signInWithApple...');
                
                // The VediAPI will handle everything and call our callback
                await VediAPI.signInWithApple();
                
            } catch (error) {
                console.error('‚ùå Apple sign-in error:', error);
                showError(error.message || 'Apple sign-in failed. Please try again.');
            } finally {
                setLoading('apple', false);
            }
        }

        // =============================================================================
        // PHONE COLLECTION FOR SOCIAL USERS
        // =============================================================================

        /**
         * Show phone collection form
         */
        function showPhoneCollection() {
            console.log('üì± DEBUG: showPhoneCollection() called');
            const phoneCollection = document.getElementById('phoneCollection');
            if (phoneCollection) {
                phoneCollection.classList.add('show');
                console.log('‚úÖ DEBUG: Phone collection form should now be visible');
            } else {
                console.error('‚ùå DEBUG: phoneCollection element not found!');
            }
        }

        /**
         * Hide phone collection form
         */
        function hidePhoneCollection() {
            document.getElementById('phoneCollection').classList.remove('show');
        }

        /**
         * Save phone number for social user
         */
        async function saveSocialUserPhone() {
            if (!isRestaurantOnline) {
                showError('Cannot complete sign-in while restaurant is unavailable. Please wait for restaurant to come online.');
                return;
            }

            const phoneNumber = document.getElementById('socialUserPhone').value.trim();
            
            if (!phoneNumber) {
                showError('Please enter your phone number');
                return;
            }

            try {
                setLoading('phoneCollection', true);
                
                const userName = currentSocialUser.displayName || 'Guest User';
                const userEmail = currentSocialUser.email || '';
                
                // Format phone number
                const rawPhone = phoneNumber.replace(/\D/g, '');
                const fullPhoneNumber = '+1' + rawPhone;
                
                await completeSocialSignIn(userName, fullPhoneNumber, userEmail, 'social');
                
            } catch (error) {
                console.error('‚ùå Error saving phone number:', error);
                showError('Failed to save phone number. Please try again.');
            } finally {
                setLoading('phoneCollection', false);
            }
        }

        /**
         * Skip phone collection
         */
        async function skipPhoneCollection() {
            if (!isRestaurantOnline) {
                showError('Cannot complete sign-in while restaurant is unavailable. Please wait for restaurant to come online.');
                return;
            }

            try {
                const userName = currentSocialUser.displayName || 'Guest User';
                const userEmail = currentSocialUser.email || '';
                
                await completeSocialSignIn(userName, '', userEmail, 'social');
                
            } catch (error) {
                console.error('‚ùå Error completing sign-in without phone:', error);
                showError('Failed to complete sign-in. Please try again.');
            }
        }

        // =============================================================================
        // RESTAURANT STATUS AND INITIALIZATION
        // =============================================================================

        // Wait for APIs to load
        function waitForAPIs() {
            return new Promise((resolve) => {
                const checkAPIs = () => {
                    if (typeof VediAPI !== 'undefined') {
                        console.log('‚úÖ VediAPI loaded successfully');
                        resolve();
                    } else {
                        console.log('‚è≥ Waiting for VediAPI to load...');
                        setTimeout(checkAPIs, 100);
                    }
                };
                checkAPIs();
            });
        }

        // Check restaurant status using direct Firestore access
        async function checkRestaurantStatusDirect(restaurantId) {
            try {
                console.log('üîç Checking restaurant status directly...');
                const db = firebase.firestore();
                const doc = await db.collection('restaurants').doc(restaurantId).get();
                
                if (!doc.exists) {
                    throw new Error('Restaurant not found');
                }
                
                const restaurant = doc.data();
                
                return {
                    isOnline: restaurant.isOnline !== false, // Default to true if not set
                    offlineReason: restaurant.offlineReason || '',
                    restaurantName: restaurant.name,
                    success: true
                };
                
            } catch (error) {
                console.error('‚ùå Failed to check restaurant status:', error);
                // Return default online status if there's an error
                return {
                    isOnline: true,
                    offlineReason: '',
                    success: false,
                    error: error.message
                };
            }
        }

        // Listen to restaurant status changes using direct Firestore listener
        function listenToRestaurantStatusDirect(restaurantId, callback) {
            try {
                const db = firebase.firestore();
                
                console.log('üîÑ Starting direct status listener for restaurant:', restaurantId);
                
                return db.collection('restaurants').doc(restaurantId)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            const status = {
                                isOnline: data.isOnline !== false,
                                offlineReason: data.offlineReason || '',
                                restaurantName: data.name,
                                restaurantId: restaurantId,
                                timestamp: new Date().toISOString()
                            };
                            
                            console.log('üì° Direct status update:', {
                                restaurant: data.name,
                                status: status.isOnline ? 'ONLINE' : 'OFFLINE',
                                reason: status.offlineReason || 'N/A'
                            });
                            
                            callback(status);
                        } else {
                            console.warn('‚ö†Ô∏è Restaurant document not found:', restaurantId);
                            callback({
                                isOnline: false,
                                offlineReason: 'Restaurant not found',
                                error: 'Restaurant document not found'
                            });
                        }
                    }, error => {
                        console.error('‚ùå Status listener error:', error);
                        callback({
                            isOnline: true, // Default to online on error to avoid blocking customers
                            offlineReason: '',
                            error: error.message
                        });
                    });
                    
            } catch (error) {
                console.error('‚ùå Failed to setup status listener:', error);
                return () => {};
            }
        }

        // Enhanced initialization with redirect result handling
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Customer login initializing...');
            
            try {
                // Wait for APIs to load
                await waitForAPIs();
                
                // Setup inline phone form event listeners
                setupInlineFormListeners();
                
                // Check for redirect result first (for social auth)
                try {
                    const redirectResult = await firebase.auth().getRedirectResult();
                    if (redirectResult && redirectResult.user) {
                        console.log('‚úÖ Redirect sign-in successful:', redirectResult.user.displayName);
                        hideInitialLoader();
                        await window.handleSocialSignInSuccess(redirectResult.user, 'redirect');
                        return;
                    }
                } catch (redirectError) {
                    console.warn('‚ö†Ô∏è Redirect result error (normal if no redirect):', redirectError);
                }

                // Normal initialization
                parseURLParameters();
                updateTableDisplay();
                
                if (restaurantId) {
                    await loadRestaurantInfoWithStatusCheck();
                } else {
                    showError('Restaurant not found. Please scan a valid QR code.');
                    hideInitialLoader();
                    hideStatusChecking();
                    return;
                }

                setupPhoneFormatting();
                
                // Hide loader after successful initialization
                setTimeout(hideInitialLoader, 500);

                console.log('‚úÖ Customer login loaded successfully - inline phone auth enabled');

            } catch (error) {
                console.error('‚ùå Page initialization error:', error);
                showError('Failed to load page');
                hideInitialLoader();
                hideStatusChecking();
            }
        });

        // Parse URL parameters
        function parseURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            restaurantId = urlParams.get('restaurant') || urlParams.get('r');
            tableNumber = urlParams.get('table');
            tableLocation = urlParams.get('location');
            
            console.log('üìç URL Parameters:', {
                restaurant: restaurantId,
                table: tableNumber,
                location: tableLocation
            });
        }

        // Load restaurant information with status checking
        async function loadRestaurantInfoWithStatusCheck() {
            try {
                console.log('üè™ Loading restaurant data for ID:', restaurantId);
                showStatusChecking();
                document.getElementById('restaurantName').textContent = 'Loading...';
                
                // Load restaurant data using VediAPI
                console.log('üìã Loading restaurant information...');
                restaurantData = await VediAPI.getRestaurant(restaurantId);
                document.getElementById('restaurantName').textContent = restaurantData.name || 'Restaurant';
                
                // Check restaurant online status using direct Firestore access
                console.log('üîç Checking restaurant availability status...');
                const status = await checkRestaurantStatusDirect(restaurantId);
                
                console.log('üìä Restaurant status:', status);
                
                // Update global status
                isRestaurantOnline = status.isOnline;
                
                // If restaurant is offline, show offline status
                if (!status.isOnline) {
                    console.log('üî¥ Restaurant is OFFLINE - showing offline status');
                    hideStatusChecking();
                    showRestaurantOffline(restaurantData.name, status.offlineReason);
                } else {
                    // Restaurant is online, proceed normally
                    console.log('üü¢ Restaurant is ONLINE, proceeding with login...');
                    hideStatusChecking();
                    hideRestaurantOffline();
                }
                
                // Start monitoring restaurant status for real-time updates
                startRestaurantStatusMonitoring();
                
            } catch (error) {
                console.error('‚ùå Failed to load restaurant or check status:', error);
                hideStatusChecking();
                
                // Show error but don't block login completely
                document.getElementById('restaurantName').textContent = 'Restaurant';
                showError('Unable to verify restaurant status. You can still proceed with login.');
                isRestaurantOnline = true; // Default to online on error
            }
        }

        // Monitor restaurant status in real-time
        function startRestaurantStatusMonitoring() {
            if (restaurantId) {
                console.log('üì° Starting real-time restaurant status monitoring...');
                
                // Listen for real-time status changes using direct Firestore
                restaurantStatusListener = listenToRestaurantStatusDirect(restaurantId, (status) => {
                    console.log('üì° Real-time status update:', status);
                    
                    const previousStatus = isRestaurantOnline;
                    isRestaurantOnline = status.isOnline;
                    
                    if (!status.isOnline && previousStatus) {
                        // Restaurant went offline
                        console.log('üî¥ Restaurant went OFFLINE during login session');
                        showRestaurantOffline(status.restaurantName || restaurantData?.name, status.offlineReason);
                        showInfo(`${status.restaurantName || restaurantData?.name || 'Restaurant'} is now unavailable for orders. Please wait for it to come back online.`);
                        
                    } else if (status.isOnline && !previousStatus) {
                        // Restaurant came back online
                        console.log('üü¢ Restaurant came ONLINE during login session');
                        hideRestaurantOffline();
                        showSuccess(`${status.restaurantName || restaurantData?.name || 'Restaurant'} is now available for orders! You can sign in.`);
                    }
                });
                
                console.log('‚úÖ Real-time status monitoring started');
            }
        }

        // Update table display
        function updateTableDisplay() {
            const tableInfoElement = document.getElementById('tableInfo');
            
            if (tableLocation === 'counter' || tableNumber === 'counter') {
                tableInfoElement.textContent = 'Counter Order';
            } else if (tableNumber) {
                tableInfoElement.textContent = `Table #${tableNumber}`;
            } else {
                tableInfoElement.textContent = 'Restaurant Order';
            }
        }

        // Setup phone formatting
        function setupPhoneFormatting() {
            const phoneInput = document.getElementById('socialUserPhone');
            
            if (phoneInput) {
                // Format phone number input
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    // US formatting: (123) 456-7890
                    if (value.length >= 7) {
                        value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
                    } else if (value.length >= 4) {
                        value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                    } else if (value.length >= 1) {
                        value = `(${value}`;
                    }
                    
                    e.target.value = value;
                });
            }
        }

        // =============================================================================
        // UI UTILITY FUNCTIONS
        // =============================================================================

        // Show/hide restaurant offline status
        function showRestaurantOffline(restaurantName, reason) {
            const offlineStatus = document.getElementById('restaurantOfflineStatus');
            const offlineNameElement = document.getElementById('offlineRestaurantName');
            const offlineReasonElement = document.getElementById('offlineReason');
            const loginContainer = document.getElementById('loginFormsContainer');
            
            if (offlineStatus && loginContainer) {
                offlineNameElement.textContent = restaurantName || 'This restaurant';
                offlineReasonElement.textContent = reason || '';
                
                offlineStatus.style.display = 'block';
                loginContainer.classList.add('form-section-disabled');
                
                console.log('üî¥ Restaurant offline UI shown');
            }
        }

        function hideRestaurantOffline() {
            const offlineStatus = document.getElementById('restaurantOfflineStatus');
            const loginContainer = document.getElementById('loginFormsContainer');
            
            if (offlineStatus && loginContainer) {
                offlineStatus.style.display = 'none';
                loginContainer.classList.remove('form-section-disabled');
                
                console.log('üü¢ Restaurant online UI restored');
            }
        }

        // Hide initial loader
        function hideInitialLoader() {
            const loader = document.getElementById('initialLoader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 300);
            }
        }

        // Show/hide status checking overlay
        function showStatusChecking() {
            const overlay = document.getElementById('statusCheckingOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        }

        function hideStatusChecking() {
            const overlay = document.getElementById('statusCheckingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Loading states
        function setLoading(type, loading) {
            const spinners = {
                google: 'googleSpinner',
                facebook: 'facebookSpinner',
                apple: 'appleSpinner',
                phoneCollection: 'phoneCollectionSpinner'
            };
            
            const buttons = {
                google: 'googleSignInBtn',
                facebook: 'facebookSignInBtn',
                apple: 'appleSignInBtn'
            };
            
            if (spinners[type]) {
                const spinner = document.getElementById(spinners[type]);
                if (spinner) spinner.style.display = loading ? 'inline-block' : 'none';
            }
            
            if (buttons[type]) {
                const button = document.getElementById(buttons[type]);
                if (button) button.disabled = loading;
            }
        }

        // Message functions
        function showError(message) {
            hideMessages();
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                if (errorDiv.style.display === 'block') {
                    errorDiv.style.display = 'none';
                }
            }, 8000);
        }

        function showSuccess(message) {
            hideMessages();
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                if (successDiv.style.display === 'block') {
                    successDiv.style.display = 'none';
                }
            }, 5000);
        }

        function showInfo(message) {
            hideMessages();
            const infoDiv = document.getElementById('infoMessage');
            infoDiv.textContent = message;
            infoDiv.style.display = 'block';
            
            setTimeout(() => {
                if (infoDiv.style.display === 'block') {
                    infoDiv.style.display = 'none';
                }
            }, 5000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('infoMessage').style.display = 'none';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            // Cleanup restaurant status listener
            if (restaurantStatusListener) {
                restaurantStatusListener();
            }
            
            // Cleanup reCAPTCHA
            if (window.VediAPI && typeof window.VediAPI.clearRecaptchaVerifier === 'function') {
                window.VediAPI.clearRecaptchaVerifier();
            }
        });

        // Global error handler for extension errors
        window.addEventListener('error', function(event) {
            // Ignore extension-related errors
            if (event.message.includes('message channel closed') || 
                event.message.includes('Extension context invalidated')) {
                console.log('üîå Browser extension error ignored (harmless)');
                event.preventDefault();
                return false;
            }
        });

        console.log('üì±üîí Customer authentication system loaded with inline phone form');
        console.log('üîó Using VediAPI social auth with callback integration');
        console.log('üì± Phone authentication: Firebase SMS with reCAPTCHA v2 inline (NO MODAL)');
        console.log('üü¢üî¥ Restaurant status monitoring: ENABLED');
        console.log('‚úÖ Ready for inline phone verification');
    </script>
</body>
</html>
