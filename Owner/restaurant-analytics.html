<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Restaurant Management</title>
    
    <!-- SECURE INITIALIZATION - ONLY THIS SCRIPT NEEDED -->
    <script src="../Api/core/secure-iframe-init.js"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #F8F9FA;
            min-height: 100vh;
            color: #1D1D1F;
            line-height: 1.5;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Loading State */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 80px 32px;
            color: #8E8E93;
        }

        .loading-spinner.show {
            display: block;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid #E5E5E7;
            border-top: 2px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background: #FFEBEE;
            color: #C62828;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #FFCDD2;
            display: none;
            font-weight: 500;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 34px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 17px;
            color: #8E8E93;
            font-weight: 400;
        }

        /* Controls Section */
        .controls-section {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #E5E5E7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .time-period-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-label {
            font-size: 15px;
            font-weight: 600;
            color: #1D1D1F;
        }

        .time-period-selector {
            padding: 12px 16px;
            border: 1px solid #E5E5E7;
            border-radius: 22px;
            font-size: 15px;
            background: #FFFFFF;
            color: #1D1D1F;
            min-height: 44px;
            font-family: inherit;
            transition: border-color 0.2s ease;
            font-weight: 500;
        }

        .time-period-selector:focus {
            outline: none;
            border-color: #007AFF;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            background: #007AFF;
            color: #FFFFFF;
            border: none;
            padding: 12px 20px;
            border-radius: 22px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-secondary {
            background: #F2F2F7;
            color: #1D1D1F;
            border: none;
            padding: 12px 20px;
            border-radius: 22px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #E5E5EA;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: #FFFFFF;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #E5E5E7;
            text-align: center;
            transition: all 0.2s ease;
        }

        .kpi-card:hover {
            border-color: #007AFF;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.1);
        }

        .kpi-title {
            font-size: 13px;
            font-weight: 600;
            color: #8E8E93;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 8px;
        }

        .kpi-change {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .kpi-change.positive {
            color: #34C759;
        }

        .kpi-change.negative {
            color: #FF3B30;
        }

        .kpi-change.neutral {
            color: #8E8E93;
        }

        /* Chart Sections */
        .chart-section {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #E5E5E7;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #F2F2F7;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #000000;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 16px;
        }

        .chart-small {
            height: 300px;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Insights Section */
        .insights-section {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #E5E5E7;
        }

        .insight-item {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #007AFF;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-item.positive {
            border-left-color: #34C759;
            background: #F0FDF4;
        }

        .insight-item.warning {
            border-left-color: #FF9500;
            background: #FFF8F0;
        }

        .insight-item.negative {
            border-left-color: #FF3B30;
            background: #FFF0F0;
        }

        .insight-title {
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .insight-description {
            color: #8E8E93;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Tables */
        .table-container {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #E5E5E7;
            margin-bottom: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #F2F2F7;
        }

        .data-table th {
            background: #F8F9FA;
            color: #1D1D1F;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: #1D1D1F;
            font-size: 15px;
        }

        .data-table tr:hover {
            background: #F8F9FA;
        }

        .metric-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-badge.high {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .metric-badge.medium {
            background: #FFF3E0;
            color: #E65100;
        }

        .metric-badge.low {
            background: #FFEBEE;
            color: #C62828;
        }

        /* Customer Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .metric-card {
            background: #F8F9FA;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #E5E5E7;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 4px;
        }

        .metric-label {
            color: #8E8E93;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 32px;
            color: #8E8E93;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1D1D1F;
        }

        .empty-description {
            font-size: 15px;
            line-height: 1.4;
        }

        /* Filter Select in Charts */
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #E5E5E7;
            border-radius: 8px;
            font-size: 13px;
            background: #FFFFFF;
            color: #1D1D1F;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #007AFF;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .action-buttons {
                justify-content: center;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .page-title {
                font-size: 28px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: #34C759;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateX(100%);
            font-size: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: #FF3B30;
        }

        .notification.info {
            background: #007AFF;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading analytics...</p>
    </div>

    <!-- Error State -->
    <div id="errorMessage" class="error-message">
        <strong>Error:</strong> <span id="errorText"></span>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title" id="restaurantTitle">Analytics</h1>
                <p class="page-subtitle" id="analyticsSubtitle">Comprehensive performance insights</p>
            </div>

            <!-- Controls -->
            <div class="controls-section">
                <div class="time-period-group">
                    <span class="control-label">Time Period</span>
                    <select class="time-period-selector" id="timePeriodSelect">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn-secondary" onclick="refreshAnalytics()">Refresh</button>
                    <button class="btn-primary" onclick="exportAnalytics()">Export</button>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">Total Revenue</div>
                    <div class="kpi-value" id="totalRevenue">$0</div>
                    <div class="kpi-change" id="revenueChange">
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-title">Total Orders</div>
                    <div class="kpi-value" id="totalOrders">0</div>
                    <div class="kpi-change" id="ordersChange">
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-title">Unique Customers</div>
                    <div class="kpi-value" id="uniqueCustomers">0</div>
                    <div class="kpi-change" id="customersChange">
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-title">Avg Order Value</div>
                    <div class="kpi-value" id="avgOrderValue">$0</div>
                    <div class="kpi-change" id="aovChange">
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-title">Total Losses</div>
                    <div class="kpi-value" id="totalLosses">$0</div>
                    <div class="kpi-change" id="lossesChange">
                        <span>0 incidents</span>
                    </div>
                </div>
            </div>

            <!-- Main Analytics Section -->
            <div class="analytics-grid">
                <!-- Revenue Trends Chart -->
                <div class="chart-section">
                    <div class="section-header">
                        <h3 class="section-title">Revenue & Order Trends</h3>
                        <select class="filter-select" id="revenueChartType">
                            <option value="revenue">Revenue</option>
                            <option value="orders">Order Count</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Key Insights -->
                <div class="insights-section">
                    <div class="section-header">
                        <h3 class="section-title">Key Insights</h3>
                    </div>
                    <div id="insightsContainer">
                        <div class="insight-item">
                            <div class="insight-title">Loading insights...</div>
                            <div class="insight-description">Analyzing your data to provide actionable insights.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Popular Items -->
            <div class="table-container">
                <div class="section-header">
                    <h3 class="section-title">Popular Menu Items</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Orders</th>
                            <th>Revenue</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="popularItemsTable">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Customer Analytics -->
            <div class="table-container">
                <div class="section-header">
                    <h3 class="section-title">Customer Insights</h3>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="repeatCustomers">0%</div>
                        <div class="metric-label">Repeat Customers</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgOrdersPerCustomer">0</div>
                        <div class="metric-label">Avg Orders/Customer</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="peakHour">12 PM</div>
                        <div class="metric-label">Peak Hour</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgPrepTime">15 min</div>
                        <div class="metric-label">Avg Prep Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let currentRestaurant = null;
        let currentTimePeriod = 'month';
        let analyticsData = {};
        let charts = {};

        // Initialize analytics dashboard using secure initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📊 Analytics Dashboard initializing...');
            
            try {
                await initializeAnalytics();
            } catch (error) {
                console.error('❌ Failed to initialize analytics:', error);
                showSecurityError(error);
            }
        });

        async function initializeAnalytics() {
            try {
                showLoading(true);
                
                // Use the secure initialization function
                const { user, restaurant } = await initializeRestaurantPage('Analytics');
                
                currentUser = user;
                currentRestaurant = restaurant;

                console.log('✅ Secure initialization complete');
                console.log('✅ User authenticated:', currentUser.name);
                console.log('✅ Restaurant loaded:', currentRestaurant.name);

                // Update header
                document.getElementById('restaurantTitle').textContent = `${currentRestaurant.name} Analytics`;
                
                // Setup event listeners
                setupEventListeners();
                
                // Load analytics data
                await loadAnalyticsData();
                
                showLoading(false);
                showMainContent(true);

            } catch (error) {
                console.error('❌ Analytics initialization error:', error);
                showError(error.message);
                showLoading(false);
            }
        }

        function setupEventListeners() {
            document.getElementById('timePeriodSelect').addEventListener('change', function(e) {
                currentTimePeriod = e.target.value;
                loadAnalyticsData();
            });
            
            // Setup chart type selector event listener
            document.getElementById('revenueChartType').addEventListener('change', function() {
                if (analyticsData.orders) {
                    const timeData = generateTimeSeriesData(analyticsData.orders, currentTimePeriod);
                    updateRevenueChart(timeData);
                }
            });
        }

        async function loadAnalyticsData() {
            try {
                console.log('📊 Loading analytics data for period:', currentTimePeriod);
                
                showLoading(true);
                
                // Load all data in parallel
                const [orders, lossIncidents, menuItems] = await Promise.all([
                    loadOrdersData(),
                    loadLossData(),
                    loadMenuData()
                ]);

                analyticsData = {
                    orders,
                    lossIncidents,
                    menuItems,
                    timePeriod: currentTimePeriod
                };

                // Calculate analytics
                const analytics = calculateAnalytics(analyticsData);
                
                // Update UI
                updateKPIs(analytics);
                updateCharts(analytics);
                updateInsights(analytics);
                updateTables(analytics, analyticsData.orders);
                
                showLoading(false);
                
            } catch (error) {
                console.error('❌ Error loading analytics data:', error);
                showError('Failed to load analytics data: ' + error.message);
                showLoading(false);
            }
        }

        async function loadOrdersData() {
            try {
                console.log('📦 Loading orders data...');
                
                // Debug: Check what VediAPI functions are available
                console.log('🔍 Available VediAPI functions in iframe:', Object.keys(window.VediAPI || {}));
                console.log('🔍 VediAPI.getOrders available:', typeof window.VediAPI?.getOrders);
                
                // Try multiple ways to get orders
                let orders = [];
                
                if (typeof VediAPI?.getOrders === 'function') {
                    console.log('✅ Using iframe VediAPI.getOrders');
                    orders = await VediAPI.getOrders(currentRestaurant.id, {
                        limit: 1000,
                        orderBy: 'createdAt',
                        orderDirection: 'desc'
                    });
                } else if (window.parent?.VediAPI?.getOrders) {
                    console.log('🔧 Using parent window VediAPI.getOrders');
                    orders = await window.parent.VediAPI.getOrders(currentRestaurant.id, {
                        limit: 1000,
                        orderBy: 'createdAt',
                        orderDirection: 'desc'
                    });
                } else if (window.parent?.getOrders) {
                    console.log('🔧 Using parent window getOrders');
                    orders = await window.parent.getOrders(currentRestaurant.id, {
                        limit: 1000,
                        orderBy: 'createdAt',
                        orderDirection: 'desc'
                    });
                } else {
                    console.warn('⚠️ No getOrders function available');
                    console.log('🔍 Parent VediAPI keys:', Object.keys(window.parent?.VediAPI || {}));
                    return [];
                }
                
                console.log('📦 Raw orders from Firebase:', orders);
                
                // Debug: Check structure of first order
                if (orders.length > 0) {
                    console.log('🔍 First order structure:', orders[0]);
                    console.log('🔍 Order keys:', Object.keys(orders[0]));
                    if (orders[0].items) {
                        console.log('🔍 First order items:', orders[0].items);
                    }
                }
                
                // Filter by time period
                const filteredOrders = filterByTimePeriod(orders, currentTimePeriod);
                console.log('📦 Filtered orders for', currentTimePeriod, ':', filteredOrders.length);
                
                return filteredOrders;
            } catch (error) {
                console.error('❌ Error loading orders:', error);
                return [];
            }
        }

        async function loadLossData() {
            try {
                const incidents = await VediAPI.getLossIncidents(currentRestaurant.id, {
                    timePeriod: currentTimePeriod,
                    limit: 500
                });
                
                console.log('📉 Loaded loss incidents:', incidents.length);
                return incidents;
            } catch (error) {
                console.error('❌ Error loading loss data:', error);
                return [];
            }
        }

        async function loadMenuData() {
            try {
                const menuItems = await VediAPI.getMenuItems(currentRestaurant.id);
                console.log('🍽️ Loaded menu items:', menuItems.length);
                return menuItems;
            } catch (error) {
                console.error('❌ Error loading menu data:', error);
                return [];
            }
        }

        function filterByTimePeriod(data, period) {
            const now = new Date();
            let startDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarterMonth = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), quarterMonth, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    return data;
            }

            return data.filter(item => {
                const itemDate = VediAPI.timestampToDate(item.createdAt);
                return itemDate >= startDate;
            });
        }

        function calculateAnalytics(data) {
            console.log('🔢 Calculating analytics with data:', data);
            const { orders, lossIncidents, menuItems } = data;
            
            console.log('📊 Processing orders:', orders.length);
            console.log('📉 Processing loss incidents:', lossIncidents.length);
            console.log('🍽️ Processing menu items:', menuItems.length);
            
            // Basic KPIs
            const totalRevenue = orders.reduce((sum, order) => {
                const orderTotal = order.total || 0;
                console.log(`Order ${order.orderNumber || 'unknown'}: ${orderTotal}`);
                return sum + orderTotal;
            }, 0);
            
            const totalOrders = orders.length;
            const completedOrders = orders.filter(order => order.status === 'completed');
            const totalLosses = lossIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);
            
            console.log('💰 Total revenue calculated:', totalRevenue);
            console.log('📦 Total orders:', totalOrders);
            console.log('✅ Completed orders:', completedOrders.length);
            console.log('📉 Total losses:', totalLosses);
            
            // Customer analytics
            const uniqueCustomers = new Set(orders.map(order => order.customerPhone)).size;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            console.log('👥 Unique customers:', uniqueCustomers);
            console.log('🎯 Average order value:', avgOrderValue);
            
            // Popular items analysis
            const itemStats = {};
            orders.forEach(order => {
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        if (!itemStats[item.name]) {
                            itemStats[item.name] = { count: 0, revenue: 0 };
                        }
                        itemStats[item.name].count += item.quantity || 1;
                        itemStats[item.name].revenue += (item.price || 0) * (item.quantity || 1);
                    });
                } else {
                    console.warn('⚠️ Order missing items:', order.orderNumber);
                }
            });
            
            const popularItems = Object.entries(itemStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
                
            console.log('🍽️ Popular items calculated:', popularItems);

            // Time-based data for charts
            const timeData = generateTimeSeriesData(orders, data.timePeriod);
            console.log('📈 Time series data:', timeData);

            // Calculate customer metrics
            const customerMetrics = calculateRealCustomerMetrics(orders);
            console.log('👥 Customer metrics:', customerMetrics);

            const analytics = {
                kpis: {
                    totalRevenue,
                    totalOrders,
                    uniqueCustomers,
                    avgOrderValue,
                    totalLosses,
                    completedOrders: completedOrders.length
                },
                popularItems,
                timeData,
                customerMetrics,
                insights: generateInsights({ orders, lossIncidents, menuItems })
            };
            
            console.log('✅ Final analytics calculated:', analytics);
            return analytics;
        }

        function generateTimeSeriesData(orders, period) {
            const data = {};
            const now = new Date();
            
            // Generate labels based on period
            let labels = [];
            let groupBy = 'day';
            
            switch (period) {
                case 'today':
                    // Hourly data for today
                    for (let i = 0; i < 24; i++) {
                        labels.push(`${i}:00`);
                        data[`${i}:00`] = { revenue: 0, orders: 0 };
                    }
                    groupBy = 'hour';
                    break;
                case 'week':
                    // Daily data for the week
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                        const label = date.toLocaleDateString('en-US', { weekday: 'short' });
                        labels.push(label);
                        data[label] = { revenue: 0, orders: 0 };
                    }
                    break;
                case 'month':
                    // Daily data for the month
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    for (let i = 1; i <= daysInMonth; i++) {
                        labels.push(i.toString());
                        data[i.toString()] = { revenue: 0, orders: 0 };
                    }
                    break;
                case 'quarter':
                case 'year':
                    // Monthly data
                    const months = period === 'quarter' ? 3 : 12;
                    for (let i = months - 1; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const label = date.toLocaleDateString('en-US', { month: 'short' });
                        labels.push(label);
                        data[label] = { revenue: 0, orders: 0 };
                    }
                    break;
            }

            // Group orders by time period
            orders.forEach(order => {
                const orderDate = VediAPI.timestampToDate(order.createdAt);
                let key;

                switch (period) {
                    case 'today':
                        key = `${orderDate.getHours()}:00`;
                        break;
                    case 'week':
                        key = orderDate.toLocaleDateString('en-US', { weekday: 'short' });
                        break;
                    case 'month':
                        key = orderDate.getDate().toString();
                        break;
                    case 'quarter':
                    case 'year':
                        key = orderDate.toLocaleDateString('en-US', { month: 'short' });
                        break;
                }

                if (data[key]) {
                    data[key].revenue += order.total || 0;
                    data[key].orders += 1;
                }
            });

            return {
                labels,
                revenue: labels.map(label => data[label].revenue),
                orders: labels.map(label => data[label].orders)
            };
        }

        function calculateRealCustomerMetrics(orders) {
            // Calculate actual average preparation time
            const completedOrders = orders.filter(order => order.status === 'completed');
            let totalPrepTime = 0;
            let ordersWithPrepTime = 0;
            
            completedOrders.forEach(order => {
                if (order.createdAt && order.updatedAt) {
                    const created = VediAPI.timestampToDate(order.createdAt);
                    const updated = VediAPI.timestampToDate(order.updatedAt);
                    const prepTime = (updated - created) / (1000 * 60); // minutes
                    
                    if (prepTime > 0 && prepTime < 180) { // Reasonable prep time (under 3 hours)
                        totalPrepTime += prepTime;
                        ordersWithPrepTime++;
                    }
                }
            });
            
            const avgPrepTime = ordersWithPrepTime > 0 ? 
                `${Math.round(totalPrepTime / ordersWithPrepTime)} min` : 
                'No data';

            // Calculate real customer data
            const customerData = {};
            orders.forEach(order => {
                const phone = order.customerPhone;
                if (!customerData[phone]) {
                    customerData[phone] = { orders: 0, revenue: 0, firstOrder: order.createdAt };
                }
                customerData[phone].orders += 1;
                customerData[phone].revenue += order.total || 0;
            });

            const totalCustomers = Object.keys(customerData).length;
            const repeatCustomers = Object.values(customerData).filter(customer => customer.orders > 1).length;
            const repeatRate = totalCustomers > 0 ? (repeatCustomers / totalCustomers) * 100 : 0;
            
            const avgOrdersPerCustomer = totalCustomers > 0 ? 
                Object.values(customerData).reduce((sum, customer) => sum + customer.orders, 0) / totalCustomers : 0;

            // Calculate actual peak hour from real data
            const hourlyOrders = {};
            orders.forEach(order => {
                const hour = VediAPI.timestampToDate(order.createdAt).getHours();
                hourlyOrders[hour] = (hourlyOrders[hour] || 0) + 1;
            });
            
            let peakHour = 12; // default
            let maxOrders = 0;
            
            Object.entries(hourlyOrders).forEach(([hour, count]) => {
                if (count > maxOrders) {
                    maxOrders = count;
                    peakHour = parseInt(hour);
                }
            });
            
            const peakHourFormatted = peakHour === 0 ? '12 AM' :
                                    peakHour < 12 ? `${peakHour} AM` :
                                    peakHour === 12 ? '12 PM' :
                                    `${peakHour - 12} PM`;

            return {
                repeatRate,
                avgOrdersPerCustomer,
                peakHour: maxOrders > 0 ? peakHourFormatted : 'No data',
                avgPrepTime
            };
        }

        function generateInsights(data) {
            const insights = [];
            const { orders, lossIncidents } = data;

            // Revenue insights
            const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
            if (totalRevenue > 0) {
                insights.push({
                    type: 'positive',
                    title: 'Revenue Performance',
                    description: `Generated ${formatCurrency(totalRevenue)} in revenue with ${orders.length} orders.`
                });
            }

            // Loss insights
            const totalLoss = lossIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);
            if (totalLoss > 0) {
                const lossPercentage = totalRevenue > 0 ? (totalLoss / totalRevenue) * 100 : 0;
                insights.push({
                    type: lossPercentage > 5 ? 'negative' : 'warning',
                    title: 'Loss Management',
                    description: `${lossIncidents.length} incidents resulted in ${formatCurrency(totalLoss)} in losses (${lossPercentage.toFixed(1)}% of revenue).`
                });
            }

            // Performance insights
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            const completionRate = orders.length > 0 ? (completedOrders / orders.length) * 100 : 0;
            
            if (completionRate >= 95) {
                insights.push({
                    type: 'positive',
                    title: 'Excellent Order Completion',
                    description: `${completionRate.toFixed(1)}% order completion rate shows excellent operational efficiency.`
                });
            } else if (completionRate < 85) {
                insights.push({
                    type: 'warning',
                    title: 'Order Completion Needs Attention',
                    description: `${completionRate.toFixed(1)}% completion rate is below optimal. Consider reviewing processes.`
                });
            }

            return insights;
        }

        function updateKPIs(analytics) {
            const { kpis } = analytics;
            const currency = currentRestaurant.currency || { symbol: '$' };

            document.getElementById('totalRevenue').textContent = formatCurrency(kpis.totalRevenue);
            document.getElementById('totalOrders').textContent = kpis.totalOrders.toLocaleString();
            document.getElementById('uniqueCustomers').textContent = kpis.uniqueCustomers.toLocaleString();
            document.getElementById('avgOrderValue').textContent = formatCurrency(kpis.avgOrderValue);
            document.getElementById('totalLosses').textContent = formatCurrency(kpis.totalLosses);

            // Calculate real period-over-period changes
            calculateAndUpdateChanges(analytics);
        }

        async function calculateAndUpdateChanges(analytics) {
            try {
                // Get previous period data for comparison
                const previousPeriodData = await getPreviousPeriodData();
                
                if (previousPeriodData.orders.length > 0) {
                    const currentRevenue = analytics.kpis.totalRevenue;
                    const previousRevenue = previousPeriodData.revenue;
                    const revenueChange = calculatePercentageChange(currentRevenue, previousRevenue);
                    updateChangeIndicator('revenueChange', revenueChange);
                    
                    const currentOrders = analytics.kpis.totalOrders;
                    const previousOrders = previousPeriodData.orders.length;
                    const ordersChange = calculatePercentageChange(currentOrders, previousOrders);
                    updateChangeIndicator('ordersChange', ordersChange);
                    
                    const currentCustomers = analytics.kpis.uniqueCustomers;
                    const previousCustomers = new Set(previousPeriodData.orders.map(o => o.customerPhone)).size;
                    const customersChange = calculatePercentageChange(currentCustomers, previousCustomers);
                    updateChangeIndicator('customersChange', customersChange);
                    
                    const currentAOV = analytics.kpis.avgOrderValue;
                    const previousAOV = previousOrders > 0 ? previousRevenue / previousOrders : 0;
                    const aovChange = calculatePercentageChange(currentAOV, previousAOV);
                    updateChangeIndicator('aovChange', aovChange);
                } else {
                    // No previous data available
                    updateChangeIndicator('revenueChange', 'No comparison data');
                    updateChangeIndicator('ordersChange', 'No comparison data');
                    updateChangeIndicator('customersChange', 'No comparison data');
                    updateChangeIndicator('aovChange', 'No comparison data');
                }
                
                const lossCount = analyticsData.lossIncidents.length;
                const lossText = lossCount === 0 ? 'No incidents' : `${lossCount} incident${lossCount > 1 ? 's' : ''}`;
                updateChangeIndicator('lossesChange', lossText, lossCount > 0 ? 'negative' : 'neutral');
                
            } catch (error) {
                console.error('Error calculating changes:', error);
                // Show neutral indicators if calculation fails
                updateChangeIndicator('revenueChange', 'Data unavailable');
                updateChangeIndicator('ordersChange', 'Data unavailable'); 
                updateChangeIndicator('customersChange', 'Data unavailable');
                updateChangeIndicator('aovChange', 'Data unavailable');
                updateChangeIndicator('lossesChange', 'Data unavailable');
            }
        }

        async function getPreviousPeriodData() {
            try {
                const now = new Date();
                let startDate, endDate;
                
                // Calculate previous period dates
                switch (currentTimePeriod) {
                    case 'today':
                        startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
                        endDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        startDate = lastMonth;
                        endDate = lastMonthEnd;
                        break;
                    case 'quarter':
                        const lastQuarter = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                        const currentQuarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                        startDate = lastQuarter;
                        endDate = currentQuarterStart;
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear() - 1, 0, 1);
                        endDate = new Date(now.getFullYear() - 1, 11, 31);
                        break;
                    default:
                        return { orders: [], revenue: 0 };
                }
                
                // Get orders from previous period using multiple fallback options
                let allOrders = [];
                
                if (typeof VediAPI?.getOrders === 'function') {
                    allOrders = await VediAPI.getOrders(currentRestaurant.id, {
                        limit: 2000,
                        orderBy: 'createdAt',
                        orderDirection: 'desc'
                    });
                } else if (window.parent?.VediAPI?.getOrders) {
                    allOrders = await window.parent.VediAPI.getOrders(currentRestaurant.id, {
                        limit: 2000,
                        orderBy: 'createdAt',
                        orderDirection: 'desc'
                    });
                } else if (window.parent?.getOrders) {
                    allOrders = await window.parent.getOrders(currentRestaurant.id, {
                        limit: 2000,
                        orderBy: 'createdAt',
                        orderDirection: 'desc'
                    });
                } else {
                    console.warn('⚠️ No getOrders function available for previous period data');
                    return { orders: [], revenue: 0 };
                }
                
                const previousOrders = allOrders.filter(order => {
                    const orderDate = VediAPI.timestampToDate(order.createdAt);
                    return orderDate >= startDate && orderDate <= endDate;
                });
                
                const previousRevenue = previousOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                
                return { orders: previousOrders, revenue: previousRevenue };
                
            } catch (error) {
                console.error('Error getting previous period data:', error);
                return { orders: [], revenue: 0 };
            }
        }

        function calculatePercentageChange(current, previous) {
            if (previous === 0) {
                return current > 0 ? '+∞%' : '0%';
            }
            
            const change = ((current - previous) / previous) * 100;
            const sign = change >= 0 ? '+' : '';
            return `${sign}${change.toFixed(1)}%`;
        }

        function updateChangeIndicator(elementId, text, type = null) {
            const element = document.getElementById(elementId);
            
            // Auto-determine type from text if not provided
            if (!type) {
                if (text.includes('+') && !text.includes('∞')) {
                    type = 'positive';
                } else if (text.includes('-')) {
                    type = 'negative';
                } else {
                    type = 'neutral';
                }
            }
            
            element.className = `kpi-change ${type}`;
            element.innerHTML = `<span>${text}</span>`;
        }

        function updateCharts(analytics) {
            updateRevenueChart(analytics.timeData);
        }

        function updateRevenueChart(timeData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }

            const chartType = document.getElementById('revenueChartType').value;
            let datasets = [];

            if (chartType === 'revenue' || chartType === 'both') {
                datasets.push({
                    label: 'Revenue',
                    data: timeData.revenue,
                    borderColor: '#34C759',
                    backgroundColor: 'rgba(52, 199, 89, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                });
            }

            if (chartType === 'orders' || chartType === 'both') {
                datasets.push({
                    label: 'Orders',
                    data: timeData.orders,
                    borderColor: '#007AFF',
                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                    tension: 0.4,
                    yAxisID: chartType === 'both' ? 'y1' : 'y'
                });
            }

            const scales = {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: chartType === 'orders' ? 'Number of Orders' : 'Revenue ($)'
                    },
                    beginAtZero: true
                }
            };

            if (chartType === 'both') {
                scales.y1 = {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Number of Orders'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    beginAtZero: true
                };
            }

            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: scales,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    
                                    if (label === 'Revenue') {
                                        return `${label}: ${formatCurrency(value)}`;
                                    } else {
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateInsights(analytics) {
            const container = document.getElementById('insightsContainer');
            
            if (analytics.insights.length === 0) {
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-title">No insights available</div>
                        <div class="insight-description">More data is needed to generate insights.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = analytics.insights.map(insight => `
                <div class="insight-item ${insight.type}">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-description">${insight.description}</div>
                </div>
            `).join('');
        }

        function updateTables(analytics, orders) {
            // Popular Items Table
            const popularItemsTable = document.getElementById('popularItemsTable');
            
            if (analytics.popularItems.length === 0) {
                popularItemsTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">No order data available for this period</td>
                    </tr>
                `;
            } else {
                popularItemsTable.innerHTML = analytics.popularItems.map((item, index) => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.count}</td>
                        <td>${formatCurrency(item.revenue)}</td>
                        <td>
                            <span class="metric-badge ${index < 3 ? 'high' : index < 7 ? 'medium' : 'low'}">
                                ${index < 3 ? 'Top' : index < 7 ? 'Good' : 'Low'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            // Calculate real customer metrics from actual data
            const realCustomerMetrics = calculateRealCustomerMetrics(orders);
            
            document.getElementById('repeatCustomers').textContent = `${realCustomerMetrics.repeatRate.toFixed(1)}%`;
            document.getElementById('avgOrdersPerCustomer').textContent = realCustomerMetrics.avgOrdersPerCustomer.toFixed(1);
            document.getElementById('peakHour').textContent = realCustomerMetrics.peakHour;
            document.getElementById('avgPrepTime').textContent = realCustomerMetrics.avgPrepTime;
        }

        function formatCurrency(amount) {
            const currency = currentRestaurant?.currency || { symbol: '$' };
            return `${currency.symbol}${Number(amount).toFixed(2)}`;
        }

        async function refreshAnalytics() {
            showNotification('Refreshing analytics data...', 'info');
            await loadAnalyticsData();
            showNotification('Analytics refreshed successfully!');
        }

        function exportAnalytics() {
            try {
                const exportData = {
                    restaurant: currentRestaurant.name,
                    period: currentTimePeriod,
                    exportDate: new Date().toISOString(),
                    analytics: analyticsData
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${currentRestaurant.name}-analytics-${currentTimePeriod}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                showNotification('Analytics exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Failed to export analytics', 'error');
            }
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').classList.toggle('show', show);
        }

        function showMainContent(show) {
            document.getElementById('mainContent').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSecurityError(error) {
            console.error('Security error:', error);
            showError('Authentication failed. Please refresh the page.');
        }

        console.log('📊 iOS-Style Analytics Dashboard loaded successfully');
    </script>
</body>
</html>
