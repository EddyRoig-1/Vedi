<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Restaurant Management</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../firebase-api.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #1a202c;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading-spinner.show {
            display: block;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #feb2b2;
            display: none;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .time-period-selector {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-period-selector:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
        }

        .time-period-selector option {
            background: #2d3748;
            color: white;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .kpi-card.revenue {
            border-left-color: #10b981;
        }

        .kpi-card.orders {
            border-left-color: #3b82f6;
        }

        .kpi-card.customers {
            border-left-color: #8b5cf6;
        }

        .kpi-card.performance {
            border-left-color: #f59e0b;
        }

        .kpi-card.loss {
            border-left-color: #ef4444;
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .kpi-title {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            font-size: 1.5rem;
            opacity: 0.7;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .kpi-change {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .kpi-change.positive {
            color: #10b981;
        }

        .kpi-change.negative {
            color: #ef4444;
        }

        .kpi-change.neutral {
            color: #6b7280;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .chart-small {
            height: 300px;
        }

        .insights-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .insight-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .insight-item.positive {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .insight-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .insight-item.negative {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .insight-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .insight-description {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .detailed-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f8fafc;
            color: #374151;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: #6b7280;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .metric-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .metric-badge.high {
            background: #dcfce7;
            color: #166534;
        }

        .metric-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .metric-badge.low {
            background: #fee2e2;
            color: #991b1b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9rem;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .performance-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e5e7eb;
        }

        .performance-metric {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .performance-label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
        }

        @media (max-width: 1200px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .header-actions {
                flex-direction: column;
                width: 100%;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .detailed-analytics {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .performance-grid {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateX(100%);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading analytics...</p>
    </div>

    <!-- Error State -->
    <div id="errorMessage" class="error-message">
        <strong>Error:</strong> <span id="errorText"></span>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="header-content">
                    <div>
                        <h1 class="header-title" id="restaurantTitle">Restaurant Analytics</h1>
                        <p class="header-subtitle" id="analyticsSubtitle">Comprehensive performance insights</p>
                    </div>
                    <div class="header-actions">
                        <select class="time-period-selector" id="timePeriodSelect">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                        <button class="btn" onclick="refreshAnalytics()">
                            üîÑ Refresh
                        </button>
                        <button class="btn" onclick="exportAnalytics()">
                            üìä Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div class="kpi-grid">
                <div class="kpi-card revenue">
                    <div class="kpi-header">
                        <span class="kpi-title">Total Revenue</span>
                        <span class="kpi-icon">üí∞</span>
                    </div>
                    <div class="kpi-value" id="totalRevenue">$0</div>
                    <div class="kpi-change" id="revenueChange">
                        <span>üìà</span>
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card orders">
                    <div class="kpi-header">
                        <span class="kpi-title">Total Orders</span>
                        <span class="kpi-icon">üì¶</span>
                    </div>
                    <div class="kpi-value" id="totalOrders">0</div>
                    <div class="kpi-change" id="ordersChange">
                        <span>üìà</span>
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card customers">
                    <div class="kpi-header">
                        <span class="kpi-title">Unique Customers</span>
                        <span class="kpi-icon">üë•</span>
                    </div>
                    <div class="kpi-value" id="uniqueCustomers">0</div>
                    <div class="kpi-change" id="customersChange">
                        <span>üìà</span>
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card performance">
                    <div class="kpi-header">
                        <span class="kpi-title">Avg Order Value</span>
                        <span class="kpi-icon">üéØ</span>
                    </div>
                    <div class="kpi-value" id="avgOrderValue">$0</div>
                    <div class="kpi-change" id="aovChange">
                        <span>üìà</span>
                        <span>+0% from last period</span>
                    </div>
                </div>

                <div class="kpi-card loss">
                    <div class="kpi-header">
                        <span class="kpi-title">Total Losses</span>
                        <span class="kpi-icon">üìâ</span>
                    </div>
                    <div class="kpi-value" id="totalLosses">$0</div>
                    <div class="kpi-change" id="lossesChange">
                        <span>üìâ</span>
                        <span>0 incidents</span>
                    </div>
                </div>
            </div>

            <!-- Main Analytics Section -->
            <div class="analytics-grid">
                <!-- Revenue Trends Chart -->
                <div class="chart-section">
                    <div class="section-header">
                        <h3 class="section-title">Revenue & Order Trends</h3>
                        <select class="filter-select" id="revenueChartType">
                            <option value="revenue">Revenue</option>
                            <option value="orders">Order Count</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Key Insights -->
                <div class="insights-section">
                    <div class="section-header">
                        <h3 class="section-title">üìä Key Insights</h3>
                    </div>
                    <div id="insightsContainer">
                        <div class="insight-item">
                            <div class="insight-title">Loading insights...</div>
                            <div class="insight-description">Analyzing your data to provide actionable insights.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Analytics -->
            <div class="detailed-analytics">
                <!-- Popular Items -->
                <div class="table-container">
                    <div class="section-header">
                        <h3 class="section-title">üçΩÔ∏è Popular Menu Items</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody id="popularItemsTable">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Customer Analytics -->
                <div class="table-container">
                    <div class="section-header">
                        <h3 class="section-title">üë• Customer Insights</h3>
                    </div>
                    <div class="performance-grid">
                        <div class="performance-card">
                            <div class="performance-metric" id="repeatCustomers">0%</div>
                            <div class="performance-label">Repeat Customers</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-metric" id="avgOrdersPerCustomer">0</div>
                            <div class="performance-label">Avg Orders/Customer</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-metric" id="peakHour">12 PM</div>
                            <div class="performance-label">Peak Hour</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-metric" id="avgPrepTime">15 min</div>
                            <div class="performance-label">Avg Prep Time</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Charts - REMOVED Order Status and Loss Breakdown -->
            <div class="analytics-grid" style="display: none;">
                <!-- Sections removed per user request -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let currentRestaurant = null;
        let currentTimePeriod = 'month';
        let analyticsData = {};
        let charts = {};

        // Initialize analytics dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìä Analytics Dashboard initializing...');
            
            try {
                await initializeAnalytics();
            } catch (error) {
                console.error('‚ùå Failed to initialize analytics:', error);
                showError('Failed to load analytics. Please refresh the page.');
            }
        });

        async function initializeAnalytics() {
            try {
                showLoading(true);
                
                // Check if VediAPI is available
                if (typeof VediAPI === 'undefined') {
                    if (window.parent && window.parent.VediAPI) {
                        window.VediAPI = window.parent.VediAPI;
                        window.firebase = window.parent.firebase;
                    } else {
                        throw new Error('VediAPI not available. Please check Firebase configuration.');
                    }
                }
                
                // Get current user
                currentUser = await VediAPI.getCurrentUser();
                if (!currentUser) {
                    throw new Error('Please log in to access analytics');
                }

                console.log('‚úÖ User authenticated:', currentUser.name);

                // Get restaurant data
                currentRestaurant = await VediAPI.getRestaurantByOwner(currentUser.id);
                if (!currentRestaurant) {
                    throw new Error('No restaurant found for this owner');
                }

                console.log('‚úÖ Restaurant loaded:', currentRestaurant.name);

                // Update header
                document.getElementById('restaurantTitle').textContent = `${currentRestaurant.name} Analytics`;
                
                // Setup event listeners
                setupEventListeners();
                
                // Load analytics data
                await loadAnalyticsData();
                
                showLoading(false);
                showMainContent(true);

            } catch (error) {
                console.error('‚ùå Analytics initialization error:', error);
                showError(error.message);
                showLoading(false);
            }
        }

        function setupEventListeners() {
            document.getElementById('timePeriodSelect').addEventListener('change', function(e) {
                currentTimePeriod = e.target.value;
                loadAnalyticsData();
            });
            
            // Setup chart type selector event listener
            document.getElementById('revenueChartType').addEventListener('change', function() {
                if (analyticsData.orders) {
                    const timeData = generateTimeSeriesData(analyticsData.orders, currentTimePeriod);
                    updateRevenueChart(timeData);
                }
            });
        }

        async function loadAnalyticsData() {
            try {
                console.log('üìä Loading analytics data for period:', currentTimePeriod);
                
                showLoading(true);
                
                // Load all data in parallel
                const [orders, lossIncidents, menuItems] = await Promise.all([
                    loadOrdersData(),
                    loadLossData(),
                    loadMenuData()
                ]);

                analyticsData = {
                    orders,
                    lossIncidents,
                    menuItems,
                    timePeriod: currentTimePeriod
                };

                // Calculate analytics
                const analytics = calculateAnalytics(analyticsData);
                
                // Update UI
                updateKPIs(analytics);
                updateCharts(analytics);
                updateInsights(analytics);
                // Update tables with real analytics data
            updateTables(analytics, analyticsData.orders);
                
                showLoading(false);
                
            } catch (error) {
                console.error('‚ùå Error loading analytics data:', error);
                showError('Failed to load analytics data: ' + error.message);
                showLoading(false);
            }
        }

        async function loadOrdersData() {
            try {
                console.log('üì¶ Loading orders data...');
                const orders = await VediAPI.getOrders(currentRestaurant.id, {
                    limit: 1000,
                    orderBy: 'createdAt',
                    orderDirection: 'desc'
                });
                
                console.log('üì¶ Raw orders from Firebase:', orders);
                
                // Debug: Check structure of first order
                if (orders.length > 0) {
                    console.log('üîç First order structure:', orders[0]);
                    console.log('üîç Order keys:', Object.keys(orders[0]));
                    if (orders[0].items) {
                        console.log('üîç First order items:', orders[0].items);
                    }
                }
                
                // Filter by time period
                const filteredOrders = filterByTimePeriod(orders, currentTimePeriod);
                console.log('üì¶ Filtered orders for', currentTimePeriod, ':', filteredOrders.length);
                
                return filteredOrders;
            } catch (error) {
                console.error('‚ùå Error loading orders:', error);
                return [];
            }
        }

        async function loadLossData() {
            try {
                const incidents = await VediAPI.getLossIncidents(currentRestaurant.id, {
                    timePeriod: currentTimePeriod,
                    limit: 500
                });
                
                console.log('üìâ Loaded loss incidents:', incidents.length);
                return incidents;
            } catch (error) {
                console.error('‚ùå Error loading loss data:', error);
                return [];
            }
        }

        async function loadMenuData() {
            try {
                const menuItems = await VediAPI.getMenuItems(currentRestaurant.id);
                console.log('üçΩÔ∏è Loaded menu items:', menuItems.length);
                return menuItems;
            } catch (error) {
                console.error('‚ùå Error loading menu data:', error);
                return [];
            }
        }

        function filterByTimePeriod(data, period) {
            const now = new Date();
            let startDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarterMonth = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), quarterMonth, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    return data;
            }

            return data.filter(item => {
                const itemDate = VediAPI.timestampToDate(item.createdAt);
                return itemDate >= startDate;
            });
        }

        function calculateAnalytics(data) {
            console.log('üî¢ Calculating analytics with data:', data);
            const { orders, lossIncidents, menuItems } = data;
            
            console.log('üìä Processing orders:', orders.length);
            console.log('üìâ Processing loss incidents:', lossIncidents.length);
            console.log('üçΩÔ∏è Processing menu items:', menuItems.length);
            
            // Basic KPIs
            const totalRevenue = orders.reduce((sum, order) => {
                const orderTotal = order.total || 0;
                console.log(`Order ${order.orderNumber || 'unknown'}: ${orderTotal}`);
                return sum + orderTotal;
            }, 0);
            
            const totalOrders = orders.length;
            const completedOrders = orders.filter(order => order.status === 'completed');
            const totalLosses = lossIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);
            
            console.log('üí∞ Total revenue calculated:', totalRevenue);
            console.log('üì¶ Total orders:', totalOrders);
            console.log('‚úÖ Completed orders:', completedOrders.length);
            console.log('üìâ Total losses:', totalLosses);
            
            // Customer analytics
            const uniqueCustomers = new Set(orders.map(order => order.customerPhone)).size;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            console.log('üë• Unique customers:', uniqueCustomers);
            console.log('üéØ Average order value:', avgOrderValue);
            
            // Popular items analysis
            const itemStats = {};
            orders.forEach(order => {
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        if (!itemStats[item.name]) {
                            itemStats[item.name] = { count: 0, revenue: 0 };
                        }
                        itemStats[item.name].count += item.quantity || 1;
                        itemStats[item.name].revenue += (item.price || 0) * (item.quantity || 1);
                    });
                } else {
                    console.warn('‚ö†Ô∏è Order missing items:', order.orderNumber);
                }
            });
            
            const popularItems = Object.entries(itemStats)
                .map(([name, stats]) => ({ name, ...stats }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
                
            console.log('üçΩÔ∏è Popular items calculated:', popularItems);

            // Time-based data for charts
            const timeData = generateTimeSeriesData(orders, data.timePeriod);
            console.log('üìà Time series data:', timeData);

            // Calculate customer metrics
            const customerMetrics = calculateRealCustomerMetrics(orders);
            console.log('üë• Customer metrics:', customerMetrics);

            const analytics = {
                kpis: {
                    totalRevenue,
                    totalOrders,
                    uniqueCustomers,
                    avgOrderValue,
                    totalLosses,
                    completedOrders: completedOrders.length
                },
                popularItems,
                timeData,
                customerMetrics,
                insights: generateInsights({ orders, lossIncidents, menuItems })
            };
            
            console.log('‚úÖ Final analytics calculated:', analytics);
            return analytics;
        }

        function generateTimeSeriesData(orders, period) {
            const data = {};
            const now = new Date();
            
            // Generate labels based on period
            let labels = [];
            let groupBy = 'day';
            
            switch (period) {
                case 'today':
                    // Hourly data for today
                    for (let i = 0; i < 24; i++) {
                        labels.push(`${i}:00`);
                        data[`${i}:00`] = { revenue: 0, orders: 0 };
                    }
                    groupBy = 'hour';
                    break;
                case 'week':
                    // Daily data for the week
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                        const label = date.toLocaleDateString('en-US', { weekday: 'short' });
                        labels.push(label);
                        data[label] = { revenue: 0, orders: 0 };
                    }
                    break;
                case 'month':
                    // Daily data for the month
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    for (let i = 1; i <= daysInMonth; i++) {
                        labels.push(i.toString());
                        data[i.toString()] = { revenue: 0, orders: 0 };
                    }
                    break;
                case 'quarter':
                case 'year':
                    // Monthly data
                    const months = period === 'quarter' ? 3 : 12;
                    for (let i = months - 1; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const label = date.toLocaleDateString('en-US', { month: 'short' });
                        labels.push(label);
                        data[label] = { revenue: 0, orders: 0 };
                    }
                    break;
            }

            // Group orders by time period
            orders.forEach(order => {
                const orderDate = VediAPI.timestampToDate(order.createdAt);
                let key;

                switch (period) {
                    case 'today':
                        key = `${orderDate.getHours()}:00`;
                        break;
                    case 'week':
                        key = orderDate.toLocaleDateString('en-US', { weekday: 'short' });
                        break;
                    case 'month':
                        key = orderDate.getDate().toString();
                        break;
                    case 'quarter':
                    case 'year':
                        key = orderDate.toLocaleDateString('en-US', { month: 'short' });
                        break;
                }

                if (data[key]) {
                    data[key].revenue += order.total || 0;
                    data[key].orders += 1;
                }
            });

            return {
                labels,
                revenue: labels.map(label => data[label].revenue),
                orders: labels.map(label => data[label].orders)
            };
        }

        function calculateRealCustomerMetrics(orders) {
            // Calculate actual average preparation time
            const completedOrders = orders.filter(order => order.status === 'completed');
            let totalPrepTime = 0;
            let ordersWithPrepTime = 0;
            
            completedOrders.forEach(order => {
                if (order.createdAt && order.updatedAt) {
                    const created = VediAPI.timestampToDate(order.createdAt);
                    const updated = VediAPI.timestampToDate(order.updatedAt);
                    const prepTime = (updated - created) / (1000 * 60); // minutes
                    
                    if (prepTime > 0 && prepTime < 180) { // Reasonable prep time (under 3 hours)
                        totalPrepTime += prepTime;
                        ordersWithPrepTime++;
                    }
                }
            });
            
            const avgPrepTime = ordersWithPrepTime > 0 ? 
                `${Math.round(totalPrepTime / ordersWithPrepTime)} min` : 
                'No data';

            // Calculate real customer data
            const customerData = {};
            orders.forEach(order => {
                const phone = order.customerPhone;
                if (!customerData[phone]) {
                    customerData[phone] = { orders: 0, revenue: 0, firstOrder: order.createdAt };
                }
                customerData[phone].orders += 1;
                customerData[phone].revenue += order.total || 0;
            });

            const totalCustomers = Object.keys(customerData).length;
            const repeatCustomers = Object.values(customerData).filter(customer => customer.orders > 1).length;
            const repeatRate = totalCustomers > 0 ? (repeatCustomers / totalCustomers) * 100 : 0;
            
            const avgOrdersPerCustomer = totalCustomers > 0 ? 
                Object.values(customerData).reduce((sum, customer) => sum + customer.orders, 0) / totalCustomers : 0;

            // Calculate actual peak hour from real data
            const hourlyOrders = {};
            orders.forEach(order => {
                const hour = VediAPI.timestampToDate(order.createdAt).getHours();
                hourlyOrders[hour] = (hourlyOrders[hour] || 0) + 1;
            });
            
            let peakHour = 12; // default
            let maxOrders = 0;
            
            Object.entries(hourlyOrders).forEach(([hour, count]) => {
                if (count > maxOrders) {
                    maxOrders = count;
                    peakHour = parseInt(hour);
                }
            });
            
            const peakHourFormatted = peakHour === 0 ? '12 AM' :
                                    peakHour < 12 ? `${peakHour} AM` :
                                    peakHour === 12 ? '12 PM' :
                                    `${peakHour - 12} PM`;

            return {
                repeatRate,
                avgOrdersPerCustomer,
                peakHour: maxOrders > 0 ? peakHourFormatted : 'No data',
                avgPrepTime
            };
        }

        function generateInsights(data) {
            const insights = [];
            const { orders, lossIncidents } = data;

            // Revenue insights
            const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
            if (totalRevenue > 0) {
                insights.push({
                    type: 'positive',
                    title: 'Revenue Performance',
                    description: `Generated ${formatCurrency(totalRevenue)} in revenue with ${orders.length} orders.`
                });
            }

            // Loss insights
            const totalLoss = lossIncidents.reduce((sum, incident) => sum + (incident.amount || 0), 0);
            if (totalLoss > 0) {
                const lossPercentage = totalRevenue > 0 ? (totalLoss / totalRevenue) * 100 : 0;
                insights.push({
                    type: lossPercentage > 5 ? 'negative' : 'warning',
                    title: 'Loss Management',
                    description: `${lossIncidents.length} incidents resulted in ${formatCurrency(totalLoss)} in losses (${lossPercentage.toFixed(1)}% of revenue).`
                });
            }

            // Performance insights
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            const completionRate = orders.length > 0 ? (completedOrders / orders.length) * 100 : 0;
            
            if (completionRate >= 95) {
                insights.push({
                    type: 'positive',
                    title: 'Excellent Order Completion',
                    description: `${completionRate.toFixed(1)}% order completion rate shows excellent operational efficiency.`
                });
            } else if (completionRate < 85) {
                insights.push({
                    type: 'warning',
                    title: 'Order Completion Needs Attention',
                    description: `${completionRate.toFixed(1)}% completion rate is below optimal. Consider reviewing processes.`
                });
            }

            return insights;
        }

        function updateKPIs(analytics) {
            const { kpis } = analytics;
            const currency = currentRestaurant.currency || { symbol: '$' };

            document.getElementById('totalRevenue').textContent = formatCurrency(kpis.totalRevenue);
            document.getElementById('totalOrders').textContent = kpis.totalOrders.toLocaleString();
            document.getElementById('uniqueCustomers').textContent = kpis.uniqueCustomers.toLocaleString();
            document.getElementById('avgOrderValue').textContent = formatCurrency(kpis.avgOrderValue);
            document.getElementById('totalLosses').textContent = formatCurrency(kpis.totalLosses);

            // Calculate real period-over-period changes
            calculateAndUpdateChanges(analytics);
        }

        async function calculateAndUpdateChanges(analytics) {
            try {
                // Get previous period data for comparison
                const previousPeriodData = await getPreviousPeriodData();
                
                if (previousPeriodData.orders.length > 0) {
                    const currentRevenue = analytics.kpis.totalRevenue;
                    const previousRevenue = previousPeriodData.revenue;
                    const revenueChange = calculatePercentageChange(currentRevenue, previousRevenue);
                    updateChangeIndicator('revenueChange', revenueChange);
                    
                    const currentOrders = analytics.kpis.totalOrders;
                    const previousOrders = previousPeriodData.orders.length;
                    const ordersChange = calculatePercentageChange(currentOrders, previousOrders);
                    updateChangeIndicator('ordersChange', ordersChange);
                    
                    const currentCustomers = analytics.kpis.uniqueCustomers;
                    const previousCustomers = new Set(previousPeriodData.orders.map(o => o.customerPhone)).size;
                    const customersChange = calculatePercentageChange(currentCustomers, previousCustomers);
                    updateChangeIndicator('customersChange', customersChange);
                    
                    const currentAOV = analytics.kpis.avgOrderValue;
                    const previousAOV = previousOrders > 0 ? previousRevenue / previousOrders : 0;
                    const aovChange = calculatePercentageChange(currentAOV, previousAOV);
                    updateChangeIndicator('aovChange', aovChange);
                } else {
                    // No previous data available
                    updateChangeIndicator('revenueChange', 'No comparison data');
                    updateChangeIndicator('ordersChange', 'No comparison data');
                    updateChangeIndicator('customersChange', 'No comparison data');
                    updateChangeIndicator('aovChange', 'No comparison data');
                }
                
                const lossCount = analyticsData.lossIncidents.length;
                const lossText = lossCount === 0 ? 'No incidents' : `${lossCount} incident${lossCount > 1 ? 's' : ''}`;
                updateChangeIndicator('lossesChange', lossText, lossCount > 0 ? 'negative' : 'neutral');
                
            } catch (error) {
                console.error('Error calculating changes:', error);
                // Show neutral indicators if calculation fails
                updateChangeIndicator('revenueChange', 'Data unavailable');
                updateChangeIndicator('ordersChange', 'Data unavailable'); 
                updateChangeIndicator('customersChange', 'Data unavailable');
                updateChangeIndicator('aovChange', 'Data unavailable');
                updateChangeIndicator('lossesChange', 'Data unavailable');
            }
        }

        async function getPreviousPeriodData() {
            try {
                const now = new Date();
                let startDate, endDate;
                
                // Calculate previous period dates
                switch (currentTimePeriod) {
                    case 'today':
                        startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
                        endDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        startDate = lastMonth;
                        endDate = lastMonthEnd;
                        break;
                    case 'quarter':
                        const lastQuarter = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                        const currentQuarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                        startDate = lastQuarter;
                        endDate = currentQuarterStart;
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear() - 1, 0, 1);
                        endDate = new Date(now.getFullYear() - 1, 11, 31);
                        break;
                    default:
                        return { orders: [], revenue: 0 };
                }
                
                // Get orders from previous period
                const allOrders = await VediAPI.getOrders(currentRestaurant.id, {
                    limit: 2000,
                    orderBy: 'createdAt',
                    orderDirection: 'desc'
                });
                
                const previousOrders = allOrders.filter(order => {
                    const orderDate = VediAPI.timestampToDate(order.createdAt);
                    return orderDate >= startDate && orderDate <= endDate;
                });
                
                const previousRevenue = previousOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                
                return { orders: previousOrders, revenue: previousRevenue };
                
            } catch (error) {
                console.error('Error getting previous period data:', error);
                return { orders: [], revenue: 0 };
            }
        }

        function calculatePercentageChange(current, previous) {
            if (previous === 0) {
                return current > 0 ? '+‚àû%' : '0%';
            }
            
            const change = ((current - previous) / previous) * 100;
            const sign = change >= 0 ? '+' : '';
            return `${sign}${change.toFixed(1)}%`;
        }

        function updateChangeIndicator(elementId, text, type = null) {
            const element = document.getElementById(elementId);
            
            // Auto-determine type from text if not provided
            if (!type) {
                if (text.includes('+') && !text.includes('‚àû')) {
                    type = 'positive';
                } else if (text.includes('-')) {
                    type = 'negative';
                } else {
                    type = 'neutral';
                }
            }
            
            element.className = `kpi-change ${type}`;
            
            let icon = 'üìä';
            if (type === 'positive') icon = 'üìà';
            else if (type === 'negative') icon = 'üìâ';
            else if (type === 'neutral') icon = '‚ûñ';
            
            element.innerHTML = `<span>${icon}</span><span>${text}</span>`;
        }

        function updateCharts(analytics) {
            // Only Revenue Chart - removed order status and loss charts
            updateRevenueChart(analytics.timeData);
        }

        function updateRevenueChart(timeData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }

            const chartType = document.getElementById('revenueChartType').value;
            let datasets = [];

            if (chartType === 'revenue' || chartType === 'both') {
                datasets.push({
                    label: 'Revenue',
                    data: timeData.revenue,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                });
            }

            if (chartType === 'orders' || chartType === 'both') {
                datasets.push({
                    label: 'Orders',
                    data: timeData.orders,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    yAxisID: chartType === 'both' ? 'y1' : 'y'
                });
            }

            const scales = {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: chartType === 'orders' ? 'Number of Orders' : 'Revenue ($)'
                    },
                    beginAtZero: true
                }
            };

            if (chartType === 'both') {
                scales.y1 = {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Number of Orders'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    beginAtZero: true
                };
            }

            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: scales,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    
                                    if (label === 'Revenue') {
                                        return `${label}: ${formatCurrency(value)}`;
                                    } else {
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // Removed updateOrderStatusChart and updateLossChart functions per user request

        function updateInsights(analytics) {
            const container = document.getElementById('insightsContainer');
            
            if (analytics.insights.length === 0) {
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-title">No insights available</div>
                        <div class="insight-description">More data is needed to generate insights.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = analytics.insights.map(insight => `
                <div class="insight-item ${insight.type}">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-description">${insight.description}</div>
                </div>
            `).join('');
        }

        function updateTables(analytics, orders) {
            // Popular Items Table
            const popularItemsTable = document.getElementById('popularItemsTable');
            
            if (analytics.popularItems.length === 0) {
                popularItemsTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">No order data available for this period</td>
                    </tr>
                `;
            } else {
                popularItemsTable.innerHTML = analytics.popularItems.map((item, index) => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.count}</td>
                        <td>${formatCurrency(item.revenue)}</td>
                        <td>
                            <span class="metric-badge ${index < 3 ? 'high' : index < 7 ? 'medium' : 'low'}">
                                ${index < 3 ? 'Top' : index < 7 ? 'Good' : 'Low'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            // Calculate real customer metrics from actual data
            const realCustomerMetrics = calculateRealCustomerMetrics(orders);
            
            document.getElementById('repeatCustomers').textContent = `${realCustomerMetrics.repeatRate.toFixed(1)}%`;
            document.getElementById('avgOrdersPerCustomer').textContent = realCustomerMetrics.avgOrdersPerCustomer.toFixed(1);
            document.getElementById('peakHour').textContent = realCustomerMetrics.peakHour;
            document.getElementById('avgPrepTime').textContent = realCustomerMetrics.avgPrepTime;
        }

        function formatCurrency(amount) {
            const currency = currentRestaurant?.currency || { symbol: '$' };
            return `${currency.symbol}${Number(amount).toFixed(2)}`;
        }

        async function refreshAnalytics() {
            showNotification('Refreshing analytics data...', 'info');
            await loadAnalyticsData();
            showNotification('Analytics refreshed successfully!');
        }

        function exportAnalytics() {
            try {
                const exportData = {
                    restaurant: currentRestaurant.name,
                    period: currentTimePeriod,
                    exportDate: new Date().toISOString(),
                    analytics: analyticsData
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${currentRestaurant.name}-analytics-${currentTimePeriod}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                showNotification('Analytics exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Failed to export analytics', 'error');
            }
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').classList.toggle('show', show);
        }

        function showMainContent(show) {
            document.getElementById('mainContent').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        console.log('üìä Restaurant Analytics Dashboard loaded successfully');
    </script>
</body>
</html>
